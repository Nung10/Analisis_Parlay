<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Football Analyzer Pro v50B ‚Äî Auto CSV & Session Cache (Dark)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#07121a;--panel:#0b2230;--card:#092431;--accent:#06b6d4;--muted:#9fd6ee;--text:#e6f9ff;--danger:#ff6b6b;}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:12px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
h1{font-size:20px;margin:0}
.small{font-size:13px;color:var(--muted)}
.block{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.02)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
label{display:block;font-size:13px;color:var(--muted);margin:6px 0}
input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#062428;color:var(--text)}
button{background:var(--accent);border:0;color:#022;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn-muted{background:#0f3942;color:var(--text);border:1px solid rgba(255,255,255,0.02)}
.pre{background:#02131a;padding:10px;border-radius:8px;font-family:ui-monospace,monospace;margin-top:8px;white-space:pre-wrap}
.canvas-wrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;margin-top:8px}
canvas{background:#02121a;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}
.card{background:var(--card);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.kv{font-size:13px;color:var(--muted)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px;text-align:center}
.corner{position:fixed;right:16px;top:14px;z-index:999}
.small-btn{padding:6px 8px;border-radius:6px;background:#08323a;border:1px solid rgba(255,255,255,0.02);color:var(--text);cursor:pointer}
.footer{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
</style>
</head>
<body>
<div class="corner"><div id="geoStatus" class="kv">Geo: Local DB</div></div>

<div class="container">
  <div class="header">
    <div>
      <h1>Football Analyzer Pro v50B ‚Äî Auto CSV & Session Cache</h1>
      <div class="small">Mode: Desktop ‚Ä¢ Tema: Gelap ‚Ä¢ Cache: sessionStorage (otomatis hilang saat tutup)</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnClearCache" class="small-btn">üßπ Hapus Cache Sesi</button>
      <button id="btnDownloadLast" class="small-btn">üì• Download CSV Terakhir</button>
    </div>
  </div>

  <div class="block">
    <h3>Match & Geo (Quick Filter)</h3>
    <div class="row">
      <div class="col"><label>League Home: <select id="leagueHome"></select></label></div>
      <div class="col"><label>Team Home: <select id="teamHome"></select></label></div>
      <div class="col"><label>League Away: <select id="leagueAway"></select></label></div>
      <div class="col"><label>Team Away: <select id="teamAway"></select></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Stadium Home: <input id="stadHome" readonly></label></div>
      <div class="col"><label>Lat Home: <input id="latHome" type="number" step="0.0001"></label></div>
      <div class="col"><label>Lon Home: <input id="lonHome" type="number" step="0.0001"></label></div>
      <div class="col"><label>Country Home: <input id="countryHome" readonly></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Stadium Away: <input id="stadAway" readonly></label></div>
      <div class="col"><label>Lat Away: <input id="latAway" type="number" step="0.0001"></label></div>
      <div class="col"><label>Lon Away: <input id="lonAway" type="number" step="0.0001"></label></div>
      <div class="col"><label>Country Away: <input id="countryAway" readonly></label></div>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button id="btnFillFromDB" class="btn-muted">Isi Stadion dari DB</button>
      <button id="btnStadiumOnline" class="btn-muted">üîç Cari Stadion (Online)</button>
      <button id="btnFillExample" class="btn-muted">Isi Contoh</button>
      <div style="margin-left:auto" class="kv">Travel (km): <span id="travelKm">‚Äî</span> ‚Ä¢ Impact: <span id="travelImpact">‚Äî</span></div>
    </div>
  </div>

  <div class="block">
    <h3>Attack & Defense (Ringkas)</h3>
    <div class="row">
      <div class="col"><label>xG Home: <input id="xgHome" type="number" step="0.01" value="1.6"></label></div>
      <div class="col"><label>xG Away: <input id="xgAway" type="number" step="0.01" value="1.1"></label></div>
      <div class="col"><label>SOT Home: <input id="sotHome" type="number" value="5"></label></div>
      <div class="col"><label>SOT Away: <input id="sotAway" type="number" value="3"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Tackles Home: <input id="tackleHome" type="number" value="18"></label></div>
      <div class="col"><label>Inter Home: <input id="interHome" type="number" value="8"></label></div>
      <div class="col"><label>TI Home (auto): <input id="tiHome" readonly></label></div>
      <div class="col"><label>CS Home: <input id="csHome" type="number" step="0.01" value="0.28"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Tackles Away: <input id="tackleAway" type="number" value="16"></label></div>
      <div class="col"><label>Inter Away: <input id="interAway" type="number" value="6"></label></div>
      <div class="col"><label>TI Away (auto): <input id="tiAway" readonly></label></div>
      <div class="col"><label>CS Away: <input id="csAway" type="number" step="0.01" value="0.22"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Errors‚Üígoal H (est/season): <input id="errHome" type="number" value="6"></label></div>
      <div class="col"><label>Errors‚Üígoal A (est/season): <input id="errAway" type="number" value="7"></label></div>
      <div class="col"><label>Form H (W/D/L): <input id="formHome" type="text" placeholder="W,W,D,L,W"></label></div>
      <div class="col"><label>Form A (W/D/L): <input id="formAway" type="text" placeholder="L,D,W,L,D"></label></div>
    </div>
  </div>

  <div class="block">
    <h3>Controls</h3>
    <div class="row">
      <div class="col"><label>ELO Home: <input id="eloHome" type="number" value="1500"></label></div>
      <div class="col"><label>ELO Away: <input id="eloAway" type="number" value="1500"></label></div>
      <div class="col"><label>Days rest Home: <input id="daysRestHome" type="number" value="5"></label></div>
      <div class="col"><label>Days rest Away: <input id="daysRestAway" type="number" value="3"></label></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="btnAnalyze" class="btn-muted">Analisis & Download CSV</button>
      <button id="btnReset" class="btn-muted">Reset</button>
      <div class="kv" style="margin-left:auto">Session Cache: <span id="cacheCount">0</span> entri</div>
    </div>
  </div>

  <div class="block">
    <h3>Output & Visual</h3>
    <div class="canvas-wrap">
      <div style="flex:2">
        <div class="card"><strong id="matchTitle">-</strong><div class="small" id="matchMeta">-</div></div>
        <div class="card" style="margin-top:8px"><canvas id="hist" width="720" height="140"></canvas></div>
      </div>
      <div style="flex:1">
        <div class="card"><h4 class="small">Summary</h4><pre id="summary" class="pre">‚Äî</pre></div>
        <div class="card" style="margin-top:8px"><h4 class="small">Recommendations</h4><div id="valueList"></div></div>
      </div>
    </div>
  </div>

  <div class="footer">v50B ‚Ä¢ Hybrid Geo ‚Ä¢ Session Cache ‚Ä¢ Auto CSV (.csv)</div>
</div>

<script>
/* ---------- Utilities ---------- */
function safe(v,d=0){const x=parseFloat(v);return isNaN(x)?d:x;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function nowISO(){const d=new Date(); return d.toISOString().replace(/[:]/g,'-').split('.')[0];}
function percent(x){return (100*x).toFixed(1)+'%';}
function poisson(lambda){let L=Math.exp(-lambda),p=1,k=0; while(p> L){k++; p*=Math.random(); if(k>2000)break;} return Math.max(0,k-1);}

/* ---------- Embedded Stadium DB (sample global ‚Äî extensible) ---------- */
const STADIUM_DB = [
  {league:'Premier League', team:'Manchester City', stadium:'Etihad Stadium', lat:53.4831, lon:-2.2004, country:'England'},
  {league:'Premier League', team:'Manchester United', stadium:'Old Trafford', lat:53.4631, lon:-2.2913, country:'England'},
  {league:'Premier League', team:'Liverpool', stadium:'Anfield', lat:53.4308, lon:-2.9608, country:'England'},
  {league:'LaLiga', team:'Real Madrid', stadium:'Santiago Bernab√©u', lat:40.4531, lon:-3.6883, country:'Spain'},
  {league:'LaLiga', team:'Barcelona', stadium:'Camp Nou', lat:41.3809, lon:2.1228, country:'Spain'},
  {league:'Serie A', team:'Juventus', stadium:'Allianz Stadium', lat:45.1096, lon:7.6413, country:'Italy'},
  {league:'Bundesliga', team:'Bayern Munich', stadium:'Allianz Arena', lat:48.2188, lon:11.6247, country:'Germany'},
  {league:'Ligue 1', team:'Paris Saint-Germain', stadium:'Parc des Princes', lat:48.8414, lon:2.2530, country:'France'},
  {league:'MLS', team:'LA Galaxy', stadium:'Dignity Health Sports Park', lat:33.8642, lon:-118.2617, country:'USA'},
  {league:'J1', team:'Urawa Red Diamonds', stadium:'Saitama Stadium 2002', lat:35.9050, lon:139.7170, country:'Japan'},
  {league:'Indonesia', team:'Persija Jakarta', stadium:'Gelora Bung Karno', lat:-6.2187, lon:106.8020, country:'Indonesia'},
  {league:'National', team:'England', stadium:'Wembley Stadium', lat:51.5560, lon:-0.2796, country:'England'},
  {league:'National', team:'Brazil', stadium:'Maracan√£', lat:-22.9121, lon:-43.2302, country:'Brazil'},
  {league:'National', team:'Argentina', stadium:'Estadio Monumental', lat:-34.5453, lon:-58.4494, country:'Argentina'},
  {league:'National', team:'Japan', stadium:'Saitama Stadium 2002', lat:35.9050, lon:139.7170, country:'Japan'},
  // (Extendable)
];

/* ---------- Session Cache: stadiums saved during session ---------- */
const CACHE_KEY = 'v50b_session_cache';
function getSessionCache(){ try{ return JSON.parse(sessionStorage.getItem(CACHE_KEY)||'[]'); }catch(e){ return []; } }
function saveSessionCache(items){ sessionStorage.setItem(CACHE_KEY, JSON.stringify(items)); updateCacheCount(); }
function addToCache(entry){
  const arr = getSessionCache();
  // avoid duplicates by team
  const exists = arr.find(i=>i.team===entry.team && i.league===entry.league);
  if(exists) return;
  arr.push(entry); saveSessionCache(arr);
}
function clearSessionCache(){ sessionStorage.removeItem(CACHE_KEY); updateCacheCount(); }
function updateCacheCount(){ document.getElementById('cacheCount').textContent = getSessionCache().length; }

/* ---------- Build league/team dropdowns ---------- */
function unique(arr, key){ return Array.from(new Set(arr.map(x=>x[key]))).sort(); }
const leagues = unique(STADIUM_DB,'league');
function populateLeague(selId){
  const sel = document.getElementById(selId); sel.innerHTML=''; const o=document.createElement('option'); o.value=''; o.textContent='-- pilih liga --'; sel.appendChild(o);
  leagues.forEach(l=>{ const opt=document.createElement('option'); opt.value=l; opt.textContent=l; sel.appendChild(opt); });
}
function populateTeams(league, teamSelId){
  const sel = document.getElementById(teamSelId); sel.innerHTML=''; const teams = STADIUM_DB.filter(s=>s.league===league).map(s=>s.team).sort();
  if(teams.length===0){ sel.innerHTML='<option value="">(kosong)</option>'; return; }
  const o=document.createElement('option'); o.value=''; o.textContent='-- pilih tim --'; sel.appendChild(o);
  teams.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; sel.appendChild(opt); });
}
populateLeague('leagueHome'); populateLeague('leagueAway');
document.getElementById('leagueHome').addEventListener('change', ()=> populateTeams(document.getElementById('leagueHome').value,'teamHome'));
document.getElementById('leagueAway').addEventListener('change', ()=> populateTeams(document.getElementById('leagueAway').value,'teamAway'));

/* ---------- Fill stadium from DB or session cache ---------- */
function findInDB(team){
  return STADIUM_DB.find(s=>s.team.toLowerCase()===team.toLowerCase());
}
function findInCache(team){
  const arr = getSessionCache(); return arr.find(s=>s.team.toLowerCase()===team.toLowerCase());
}
function fillStadiumFromDB(side){
  const team = (side==='Home')? document.getElementById('teamHome').value : document.getElementById('teamAway').value;
  if(!team){ alert('Pilih tim terlebih dahulu (dari dropdown atau ketik nama).'); return; }
  // check session cache first
  const cacheRec = findInCache(team);
  if(cacheRec){
    applyStadium(side, cacheRec.stadium, cacheRec.lat, cacheRec.lon, cacheRec.league, cacheRec.country, 'Cached (session)');
    return;
  }
  const rec = findInDB(team);
  if(rec){ applyStadium(side, rec.stadium, rec.lat, rec.lon, rec.league, rec.country, 'Local DB'); return; }
  alert('Tim tidak ditemukan di DB lokal. Gunakan Cari Stadion (Online).');
}
function applyStadium(side, stadium, lat, lon, league, country, source){
  if(side==='Home'){ document.getElementById('stadHome').value=stadium; document.getElementById('latHome').value=lat; document.getElementById('lonHome').value=lon; document.getElementById('countryHome').value=country; document.getElementById('geoStatus').textContent='Geo: '+source; }
  else { document.getElementById('stadAway').value=stadium; document.getElementById('latAway').value=lat; document.getElementById('lonAway').value=lon; document.getElementById('countryAway').value=country; document.getElementById('geoStatus').textContent='Geo: '+source; }
  calcTravel();
}

/* ---------- Online geocode fallback (OSM Nominatim) ---------- */
async function geocode(query){
  try{
    const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(query)+'&limit=5');
    if(!res.ok) return null;
    const data = await res.json(); return data;
  }catch(e){ return null; }
}
document.getElementById('btnStadiumOnline').addEventListener('click', async ()=>{
  const teamH = document.getElementById('teamHome').value || document.getElementById('leagueHome').value;
  const teamA = document.getElementById('teamAway').value || document.getElementById('leagueAway').value;
  if(teamH){
    document.getElementById('geoStatus').textContent='Geo: Searching online...';
    const r = await geocode(teamH + ' stadium');
    if(r && r.length>0){
      const top=r[0]; applyStadium('Home', top.display_name, parseFloat(top.lat).toFixed(4), parseFloat(top.lon).toFixed(4), '', '', 'Online'); addToCache({team:teamH, stadium: top.display_name, lat: parseFloat(top.lat), lon: parseFloat(top.lon), league: document.getElementById('leagueHome').value || '', country: ''}); updateCacheCount();
    } else { alert('Pencarian online Home gagal.'); document.getElementById('geoStatus').textContent='Geo: Online failed'; }
  }
  if(teamA){
    document.getElementById('geoStatus').textContent='Geo: Searching online...';
    const r2 = await geocode(teamA + ' stadium');
    if(r2 && r2.length>0){
      const top2=r2[0]; applyStadium('Away', top2.display_name, parseFloat(top2.lat).toFixed(4), parseFloat(top2.lon).toFixed(4), '', '', 'Online'); addToCache({team:teamA, stadium: top2.display_name, lat: parseFloat(top2.lat), lon: parseFloat(top2.lon), league: document.getElementById('leagueAway').value || '', country: ''}); updateCacheCount();
    } else { alert('Pencarian online Away gagal.'); document.getElementById('geoStatus').textContent='Geo: Online failed'; }
  }
});

/* ---------- Auto TI (tackles+interceptions) ---------- */
function autoTI(){ document.getElementById('tiHome').value = (safe(document.getElementById('tackleHome').value)+safe(document.getElementById('interHome').value)).toFixed(1); document.getElementById('tiAway').value = (safe(document.getElementById('tackleAway').value)+safe(document.getElementById('interAway').value)).toFixed(1); }
['tackleHome','interHome','tackleAway','interAway'].forEach(id=>document.getElementById(id).addEventListener('input',autoTI));

/* ---------- Travel calculation ---------- */
function calcTravel(){
  const latH = safe(document.getElementById('latHome').value, NaN), lonH = safe(document.getElementById('lonHome').value, NaN);
  const latA = safe(document.getElementById('latAway').value, NaN), lonA = safe(document.getElementById('lonAway').value, NaN);
  if(isNaN(latH)||isNaN(lonH)||isNaN(latA)||isNaN(lonA)){ document.getElementById('travelKm').textContent='‚Äî'; document.getElementById('travelImpact').textContent='‚Äî'; return null; }
  const R=6371; const toRad=x=>x*Math.PI/180; const dLat=toRad(latA-latH), dLon=toRad(lonA-lonH);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(latH))*Math.cos(toRad(latA))*Math.sin(dLon/2)**2; const km=Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
  document.getElementById('travelKm').textContent = km;
  const impact=(km<50)? 'Negligible' : (km<500? '-2% stamina' : (km<1000? '-4% stamina' : (km<3000? '-7% stamina' : '-10% stamina')));
  document.getElementById('travelImpact').textContent = impact;
  return km;
}
['latHome','lonHome','latAway','lonAway'].forEach(id=>document.getElementById(id).addEventListener('input',calcTravel));

/* ---------- Analysis & Auto CSV Export ---------- */
function computeAttack(xg,sot,conv){ return Math.max(0.15, 0.35*xg + 0.22*(sot/5) + 0.12*(conv*100||12)); }
function computeDefense(cs,gc,saves,ti,err,absDf){ const errPerGame = err/38.0; return clamp(1 + (0.28*Math.log(Math.max(1,gc)+1)) - 0.22*cs - 0.09*(ti/25) + 0.05*errPerGame + 0.04*absDf - 0.08*(Math.log(1+Math.max(0,saves))/Math.log(7)), 0.45, 2.8); }

function analyzeAndExport(){
  // verify stadium coords
  const latH = safe(document.getElementById('latHome').value, NaN), lonH = safe(document.getElementById('lonHome').value, NaN);
  const latA = safe(document.getElementById('latAway').value, NaN), lonA = safe(document.getElementById('lonAway').value, NaN);
  if(isNaN(latH)||isNaN(lonH)||isNaN(latA)||isNaN(lonA)){ alert('Isi koordinat stadion (pakai DB atau Cari Online) sebelum analisis.'); return; }
  // gather inputs
  const teamH = document.getElementById('teamHome').value || 'Home'; const teamA = document.getElementById('teamAway').value || 'Away';
  const xgH = safe(document.getElementById('xgHome').value,1.2), xgA = safe(document.getElementById('xgAway').value,1.0);
  const sotH = safe(document.getElementById('sotHome').value,4), sotA = safe(document.getElementById('sotAway').value,3);
  const convH = safe(document.getElementById('convHome')?.value,0.14), convA = safe(document.getElementById('convAway')?.value,0.12);
  const errH = safe(document.getElementById('errHome').value,6), errA = safe(document.getElementById('errAway').value,7);
  const tiH = safe(document.getElementById('tiHome').value,20), tiA = safe(document.getElementById('tiAway').value,18);
  const csH = safe(document.getElementById('csHome').value,0.28), csA = safe(document.getElementById('csAway').value,0.22);
  const eloH = safe(document.getElementById('eloHome').value,1500), eloA = safe(document.getElementById('eloAway').value,1500);
  const daysH = safe(document.getElementById('daysRestHome').value,4), daysA = safe(document.getElementById('daysRestAway').value,3);
  // attack/defense
  const atkH = computeAttack(xgH,sotH,convH), atkA = computeAttack(xgA,sotA,convA);
  const defH = computeDefense(csH, safe(document.getElementById('gcHome')?.value,1.1), safe(document.getElementById('saveHome')?.value,3.4), tiH, errH, safe(document.getElementById('absDfHome')?.value,0));
  const defA = computeDefense(csA, safe(document.getElementById('gcAway')?.value,1.3), safe(document.getElementById('saveAway')?.value,3.2), tiA, errA, safe(document.getElementById('absDfAway')?.value,0));
  // travel/stamina
  const km = calcTravel()||0;
  const stamH = clamp(1 - Math.max(0,(3-daysH))*0.035 - Math.max(0,(km-200))*0.00016, 0.65, 1.06);
  const stamA = clamp(1 - Math.max(0,(3-daysA))*0.035 - Math.max(0,(km-200))*0.00016, 0.65, 1.06);
  // elo factor
  const efH = clamp(1 + (eloH-eloA)/1400, 0.75, 1.25), efA = clamp(1 + (eloA-eloH)/1400, 0.75, 1.25);
  // lambdas
  let lambdaH = Math.max(0.03, 1.05 * (atkH / Math.max(0.3, defA)) * efH * stamH);
  let lambdaA = Math.max(0.03, 0.95 * (atkA / Math.max(0.3, defH)) * efA * stamA);
  const avgLam = (lambdaH + lambdaA)/2; if(avgLam>3.0){ lambdaH *= 0.86; lambdaA *= 0.86; } else if(avgLam>2.0){ lambdaH *= 0.94; lambdaA *= 0.94; }
  // MC
  const runs = 4000;
  const scoreFreq = {}; let h=0,d=0,a=0; const totals={};
  for(let i=0;i<runs;i++){ const gh=poisson(lambdaH); const ga=poisson(lambdaA); scoreFreq[`${gh}-${ga}`]=(scoreFreq[`${gh}-${ga}`]||0)+1; totals[gh+ga]=(totals[gh+ga]||0)+1; if(gh>ga) h++; else if(gh===ga) d++; else a++; }
  const pHome = h/runs, pDraw=d/runs, pAway=a/runs;
  // OU & HDP
  const ouLine = 2.5; let over=0; let total=0; for(const t in totals){ total += totals[t]; if(parseInt(t)>ouLine) over += totals[t]; } const overProb = over/total; const coverHome = (function(){ let win=0,push=0; for(const sc in scoreFreq){ const v=scoreFreq[sc]; const [gh,ga]=sc.split('-').map(x=>parseInt(x)); const diff = gh-ga-0.25; if(diff>0) win+=v; else if(diff===0) push+=v; } return (win + 0.5*push)/runs; })();
  // confidence (simple)
  let mean=0,cnt=0; for(const t in totals){ mean += parseInt(t)*totals[t]; cnt += totals[t]; } mean/=cnt; let varv=0; for(const t in totals){ varv += ((parseInt(t)-mean)**2)*totals[t]; } varv/=cnt; let conf = clamp(1 - Math.min(1,varv/8), 0.12, 0.97);
  const confLabel = conf>0.8? 'High' : (conf>0.55? 'Medium':'Low');
  // render summary
  document.getElementById('matchTitle').textContent = `${teamH} vs ${teamA}`;
  document.getElementById('matchMeta').textContent = `${document.getElementById('stadHome').value||''} ‚Äî ${document.getElementById('stadAway').value||''}`;
  const summaryTxt = `Œª H:${lambdaH.toFixed(2)} | Œª A:${lambdaA.toFixed(2)}
Exp Goals H:${(Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[0])*v,0)/runs).toFixed(2)} A:${(Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[1])*v,0)/runs).toFixed(2)}
Prob 1X2 ‚Äî Home ${percent(pHome)} Draw ${percent(pDraw)} Away ${percent(pAway)}
OU(${ouLine}) Over ${percent(overProb)} | HDP Home(-0.25) ${percent(coverHome)}
Confidence: ${confLabel} (${(conf*100).toFixed(1)}%)
Travel: ${km} km ‚Ä¢ Impact: ${document.getElementById('travelImpact').textContent}
Runs: ${runs}
`;
  document.getElementById('summary').textContent = summaryTxt;
  // histogram draw
  drawHistogram(totals,'hist');
  // recommendations
  const candidates = [
    {tag:`OU Over ${ouLine}`, prob: overProb},
    {tag:`HDP Home -0.25`, prob: coverHome},
    {tag:`1X2 Home`, prob: pHome},
    {tag:`1X2 Draw`, prob: pDraw},
    {tag:`1X2 Away`, prob: pAway}
  ];
  candidates.sort((a,b)=>b.prob - a.prob);
  const best = candidates.slice(0,2);
  let valHTML=''; best.forEach(bc=> valHTML += `<div class="card" style="margin-bottom:6px"><strong>${bc.tag}</strong><div class="kv">Prob: ${percent(bc.prob)}</div></div>`);
  document.getElementById('valueList').innerHTML = valHTML;
  // save last CSV data in session (for manual download)
  const csvData = {
    time: nowISO(),
    home: teamH, away: teamA,
    stadiumHome: document.getElementById('stadHome').value, stadiumAway: document.getElementById('stadAway').value,
    lambdaH: lambdaH, lambdaA: lambdaA,
    expGoalsH: (Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[0])*v,0)/runs),
    expGoalsA: (Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[1])*v,0)/runs),
    pHome: pHome, pDraw: pDraw, pAway: pAway,
    overProb: overProb, hdpHomeProb: coverHome,
    confidence: conf, confidenceLabel: confLabel,
    travelKm: km, impact: document.getElementById('travelImpact').textContent
  };
  sessionStorage.setItem('v50b_last_csv', JSON.stringify(csvData));
  // auto download CSV
  downloadCSV(csvData);
  // save cache entries (team+stadium+league+country) in session store
  const leagueH = document.getElementById('leagueHome').value || ''; const leagueA = document.getElementById('leagueAway').value || '';
  const countryH = document.getElementById('countryHome').value || ''; const countryA = document.getElementById('countryAway').value || '';
  addToCache({team: teamH, stadium: document.getElementById('stadHome').value, lat: parseFloat(document.getElementById('latHome').value), lon: parseFloat(document.getElementById('lonHome').value), league: leagueH, country: countryH});
  addToCache({team: teamA, stadium: document.getElementById('stadAway').value, lat: parseFloat(document.getElementById('latAway').value), lon: parseFloat(document.getElementById('lonAway').value), league: leagueA, country: countryA});
  updateCacheCount();
}

function downloadCSV(data){
  const rows = [
    ['Match','Date','Home','Away','StadiumHome','StadiumAway','LatHome','LonHome','LatAway','LonAway','Œª_H','Œª_A','ExpGoalsH','ExpGoalsA','P_Home','P_Draw','P_Away','Over2.5','HDP_Home','Confidence','ConfidenceLabel','Travel_km','Impact']
  ];
  rows.push([
    `${data.home} vs ${data.away}`, data.time, data.home, data.away,
    document.getElementById('stadHome').value, document.getElementById('stadAway').value,
    document.getElementById('latHome').value, document.getElementById('lonHome').value,
    document.getElementById('latAway').value, document.getElementById('lonAway').value,
    data.lambdaH.toFixed(3), data.lambdaA.toFixed(3), data.expGoalsH.toFixed(3), data.expGoalsA.toFixed(3),
    (data.pHome).toFixed(4), (data.pDraw).toFixed(4), (data.pAway).toFixed(4),
    data.overProb.toFixed(4), data.hdpHomeProb.toFixed(4), data.confidence.toFixed(4), data.confidenceLabel, data.travelKm, data.impact
  ]);
  const csvContent = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  const filename = `analysis_${nowISO()}_${document.getElementById('teamHome').value.replace(/\s+/g,'')}_vs_${document.getElementById('teamAway').value.replace(/\s+/g,'')}.csv`;
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Draw histogram ---------- */
function drawHistogram(totals, canvasId){
  const c = document.getElementById(canvasId); const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle='#02121a'; ctx.fillRect(0,0,c.width,c.height);
  const keys = Object.keys(totals).map(k=>parseInt(k)).sort((a,b)=>a-b); const maxV = Math.max(...keys.map(k=>totals[k]||0),1);
  const left=20, right=c.width-20; const w=(right-left)/Math.max(1,keys.length);
  keys.forEach((k,i)=>{ const v = totals[k]||0; const h = (v/maxV)*(c.height-30); ctx.fillStyle='#0b74de'; ctx.fillRect(left + i*w, c.height-10-h, w*0.8, h); ctx.fillStyle='#9fd6ee'; ctx.font='10px Arial'; ctx.fillText(String(k), left + i*w + 2, c.height-2); });
}

/* ---------- Buttons & events ---------- */
document.getElementById('btnFillFromDB').addEventListener('click', ()=>{ fillStadiumFromDB('Home'); setTimeout(()=> fillStadiumFromDB('Away'),250); });
document.getElementById('btnFillExample').addEventListener('click', ()=>{ document.getElementById('leagueHome').value='Premier League'; populateTeams('Premier League','teamHome'); document.getElementById('teamHome').value='Manchester City'; document.getElementById('leagueAway').value='LaLiga'; populateTeams('LaLiga','teamAway'); document.getElementById('teamAway').value='Barcelona'; fillStadiumFromDB('Home'); setTimeout(()=> fillStadiumFromDB('Away'),300); alert('Contoh terisi: Manchester City vs Barcelona. Klik Analisis & Download CSV.'); });
document.getElementById('btnClearCache').addEventListener('click', ()=>{ if(confirm('Hapus semua cache sesi sekarang?')){ clearSessionCache(); alert('Cache sesi dihapus.'); }});
document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('Reset semua input?')) return; document.querySelectorAll('input,select').forEach(i=>{ if(i.type!=='button') i.value=''; }); document.getElementById('summary').textContent='‚Äî'; document.getElementById('matchTitle').textContent='-'; document.getElementById('matchMeta').textContent='-'; document.getElementById('hist').getContext('2d').clearRect(0,0,720,140); updateCacheCount(); });
document.getElementById('btnAnalyze').addEventListener('click', analyzeAndExport);
document.getElementById('btnDownloadLast').addEventListener('click', ()=>{ const d = sessionStorage.getItem('v50b_last_csv'); if(!d){ alert('Belum ada hasil analisis untuk diunduh.'); return; } const obj = JSON.parse(d); downloadCSV(obj); });

updateCacheCount();

/* ---------- Init autoTI and open defaults ---------- */
autoTI();
document.addEventListener('DOMContentLoaded', ()=>{ /* nothing extra */ });
</script>
</body>
</html>
