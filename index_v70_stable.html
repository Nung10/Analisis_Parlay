<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prediksi Odds & Lines — v70 Stable</title>
<style>
:root{
  --bg:#041018; --panel:#071826; --card:#0b1a22; --muted:#9fb3c5; --accent:#0b74de;
  --accent-2:#ffd166; --good:#2ecc71; --warn:#f1c40f; --bad:#ef476f; --text:#dff3ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:980px;margin:18px auto;padding:18px}
h1{margin:0 0 8px;font-size:22px;color:#cfe9ff}
.panel{background:var(--panel);border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input[type="text"], input[type="number"], input[type="date"], select, textarea {width:100%;padding:8px;border-radius:8px;border:1px solid #22333f;background:#08131a;color:#fff;font-size:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1 1 260px;min-width:220px}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
button.ghost{background:transparent;border:1px solid #233645;color:#cfe9ff;padding:6px 8px;border-radius:6px;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.result{background:#06121a;padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.03);font-family:monospace;white-space:pre-wrap}
.card{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:#061922;margin-bottom:8px}
canvas{background:transparent;border-radius:6px}
.status-green{color:var(--good)} .status-yellow{color:var(--warn)} .status-red{color:var(--bad)}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.muted{color:var(--muted);font-size:13px}
.label-pill{padding:4px 8px;border-radius:999px;background:#062634;color:#cfe9ff;font-size:12px}
.progress-wrap{background:#07202a;border-radius:10px;padding:6px;margin-top:8px}
.progress-fill{height:18px;border-radius:8px;width:0%;transition:width .6s ease}
.accordion-btn { background:#082032; color:#fff; border:none; width:100%; text-align:left; padding:10px; border-radius:6px; margin-top:10px; cursor:pointer; font-weight:bold; }
.accordion-content { background:#0b1c2b; padding:12px; border-radius:6px; margin-top:6px; }
.input-dark { width:100%; background:#162436; border:none; color:#eee; padding:8px; border-radius:6px; margin-top:4px; margin-bottom:8px; }
.btn-mini { background:#0077b6; border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; margin-top:6px; }
.strength-bar { height:14px;border-radius:8px;background:#0a2230;overflow:hidden; }
.strength-fill { height:14px;border-radius:8px 0 0 8px;background:var(--accent);width:0%;transition:width .6s ease; }
.map-row{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
.kv{font-size:13px;color:var(--muted)}
.small-note{font-size:12px;color:#9eb9c9;margin-top:6px}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:6px;border-bottom:1px solid #0f2a33;text-align:left;font-size:13px}
.box-trap{padding:10px;border-radius:8px;margin-top:8px}
@media (max-width:720px){.col{flex-basis:100%}}
</style>
</head>
<body>
<div class="container">
  <h1>Prediksi Odds & Lines — v70 Stable</h1>
  <p class="small">Versi v70 — 1 column, dark solid. Bahasa: campuran Indonesia & technical English. Model: Monte Carlo adaptive, alpha shrink, rho, fatigue & home advantage.</p>

  <!-- Match -->
  <div class="panel">
    <div class="row">
      <div class="col"><label>Competition</label>
        <select id="competition"><option>League</option><option>Cup</option><option>Friendly</option></select></div>
      <div class="col"><label>Date</label><input id="matchDate" type="date"></div>
    </div>
    <label>Match (Home vs Away)</label>
    <input id="matchName" type="text" placeholder="Contoh: Atalanta vs Lazio">
  </div>

  <!-- Teams -->
  <div class="panel">
    <h3 style="margin:0">Team Data (minimal, satu nilai per tim)</h3>
    <div class="row">
      <div class="col">
        <label>Home Team</label><input id="teamHome" type="text" placeholder="Home FC">
        <label>Average Sofascore (Home)</label><input id="ratingHome" type="number" step="0.01" placeholder="6.85">
        <label>Form Last5 (0-1)</label><input id="formHome" type="number" step="0.01" placeholder="0.72">
        <label>H2H (W,D,L,..) — kosong jika tidak ada</label><input id="h2hInput" type="text" placeholder="W,D,L,W,D">
      </div>
      <div class="col">
        <label>Away Team</label><input id="teamAway" type="text" placeholder="Away FC">
        <label>Average Sofascore (Away)</label><input id="ratingAway" type="number" step="0.01" placeholder="6.70">
        <label>Form Last5 (0-1)</label><input id="formAway" type="number" step="0.01" placeholder="0.58">
        <label>H2H home-win rate (optional)</label><input id="h2hRate" type="number" step="0.01" placeholder="">
      </div>
    </div>

    <button class="accordion-btn" onclick="toggleAccordion('autoBox')">📊 Auto Form & H2H tools</button>
    <div id="autoBox" class="accordion-content" style="display:none;">
      <label>Last5 Home (W D L)</label><input id="miniFormHome" class="input-dark" placeholder="W W D W L">
      <label>Last5 Away (W D L)</label><input id="miniFormAway" class="input-dark" placeholder="D L W L D">
      <button class="btn-mini" onclick="calcMiniForm()">Auto Form → Fill</button>
      <div class="small-note">H2H: use mini H2H box to compute h2hRate automatically</div>
      <label>Mini H2H (H/A/D)</label><input id="miniH2H" class="input-dark" placeholder="H A H D H">
      <button class="btn-mini" onclick="calcMiniH2H()">Auto H2H → Fill</button>
      <div id="miniRes" class="mini-result" style="display:none"></div>
    </div>

    <h4 style="margin-top:10px">Optional stats (isi untuk akurasi lebih baik)</h4>
    <div class="row">
      <div class="col"><label>xG per game (Home)</label><input id="xgHome" type="number" step="0.01" placeholder="1.25"></div>
      <div class="col"><label>xG per game (Away)</label><input id="xgAway" type="number" step="0.01" placeholder="1.05"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>SOT / game (Home)</label><input id="sotHome" type="number" step="0.01" placeholder="4.2"></div>
      <div class="col"><label>SOT / game (Away)</label><input id="sotAway" type="number" step="0.01" placeholder="3.4"></div>
    </div>

    <h4 style="margin-top:10px">Absences (isi jumlah, tanpa nama)</h4>
    <div class="row">
      <div class="col">
        <label>Home — DF absent</label><input id="absDfHome" type="number" step="1" value="0">
        <label>Home — MF absent</label><input id="absMfHome" type="number" step="1" value="0">
        <label>Home — FW absent</label><input id="absFwHome" type="number" step="1" value="0">
      </div>
      <div class="col">
        <label>Away — DF absent</label><input id="absDfAway" type="number" step="1" value="0">
        <label>Away — MF absent</label><input id="absMfAway" type="number" step="1" value="0">
        <label>Away — FW absent</label><input id="absFwAway" type="number" step="1" value="0">
      </div>
    </div>

    <h4 style="margin-top:10px">Clean Sheet Ratio & GA (auto)</h4>
    <div class="row">
      <div class="col">
        <label>CS count (Home)</label><input id="csCountHome" type="number" step="1" placeholder="3">
        <label>Matches (Home)</label><input id="csMatchesHome" type="number" step="1" placeholder="10">
        <label>CSR (Home) (0-1)</label><input id="csHome" type="number" step="0.01" readonly>
        <button id="btnCalcCSHome" class="ghost">Hitung CSR Home</button>
      </div>
      <div class="col">
        <label>CS count (Away)</label><input id="csCountAway" type="number" step="1" placeholder="2">
        <label>Matches (Away)</label><input id="csMatchesAway" type="number" step="1" placeholder="10">
        <label>CSR (Away) (0-1)</label><input id="csAway" type="number" step="0.01" readonly>
        <button id="btnCalcCSAway" class="ghost">Hitung CSR Away</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>Goals conceded (Home)</label><input id="gcHomeCount" type="number" placeholder="12">
        <label>Matches (Home) for GA</label><input id="gcMatchesHome" type="number" placeholder="10">
        <label>GA / game (Home)</label><input id="gcHome" type="number" readonly>
        <button id="btnCalcGAHome" class="ghost">Hitung GA Home</button>
      </div>
      <div class="col">
        <label>Goals conceded (Away)</label><input id="gcAwayCount" type="number" placeholder="14">
        <label>Matches (Away) for GA</label><input id="gcMatchesAway" type="number" placeholder="10">
        <label>GA / game (Away)</label><input id="gcAway" type="number" readonly>
        <button id="btnCalcGAAway" class="ghost">Hitung GA Away</button>
      </div>
    </div>

  </div>

  <!-- Fatigue / Home advantage -->
  <div class="panel">
    <h3 style="margin:0">Fatigue & Home Advantage</h3>
    <div class="row">
      <div class="col">
        <label>Days rest Home (days since last match)</label><input id="restHome" type="number" step="0.5" value="4">
        <label>Days rest Away</label><input id="restAway" type="number" step="0.5" value="3">
        <label>Travel distance Away (km) — optional</label><input id="travelAway" type="number" step="1" placeholder="420">
      </div>
      <div class="col">
        <label>International break recently? (toggle 0/1)</label><input id="intlBreak" type="number" step="1" value="0">
        <label>Home advantage base (%)</label><input id="homeAdvBase" type="number" step="0.01" value="0.02">
        <label>Fatigue threshold (hours)</label><input id="fatigueHours" type="number" step="1" value="72">
      </div>
    </div>
    <div class="small-note">Catatan: model akan menambah pengaruh home advantage dan mengurangi lambda away bila rest rendah/fatigue besar.</div>
  </div>

  <!-- Odds & params -->
  <div class="panel">
    <h3 style="margin:0">Odds & Model Parameters</h3>
    <div class="row">
      <div class="col"><label>HDP Line</label><input id="hdpLine" type="number" step="0.25" value="0.25"></div>
      <div class="col"><label>OU Line</label><input id="ouLine" type="number" step="0.25" value="2.5"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>HDP Home Open (odds)</label><input id="hdpHomeOpen" type="number" step="0.01"></div>
      <div class="col"><label>HDP Home Now (odds)</label><input id="hdpHomeNow" type="number" step="0.01"></div>
      <div class="col"><label>HDP Away Open</label><input id="hdpAwayOpen" type="number" step="0.01"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>HDP Away Now</label><input id="hdpAwayNow" type="number" step="0.01"></div>
      <div class="col"><label>OU Over Open</label><input id="ouOverOpen" type="number" step="0.01"></div>
      <div class="col"><label>OU Over Now</label><input id="ouOverNow" type="number" step="0.01"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>OU Under Open</label><input id="ouUnderOpen" type="number" step="0.01"></div>
      <div class="col"><label>OU Under Now</label><input id="ouUnderNow" type="number" step="0.01"></div>
      <div class="col"><label>MC runs</label><input id="mcRuns" type="number" step="1000" value="40000"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>ρ (rho)</label><input id="rho" type="number" step="0.01" value="0.12"></div>
      <div class="col"><label>Alpha shrink</label><input id="alpha" type="number" step="0.01" value="0.12"></div>
      <div class="col"><label>Mode</label>
        <select id="modeSelect"><option value="league">League</option><option value="cup">Cup</option><option value="custom">Custom</option></select>
      </div>
    </div>
    <div style="margin-top:10px">
      <button id="btnAnalyze">Analisis</button>
      <button id="btnExample" class="ghost">Contoh</button>
      <button id="btnReset" class="ghost">Reset</button>
      <button id="btnDownload" class="ghost">Download CSV</button>
    </div>
  </div>

  <!-- Results -->
  <div class="panel">
    <h3 style="margin:0">Results & Recommendations</h3>
    <div id="summary" class="result" style="margin-top:8px">Klik "Analisis" untuk menjalankan model.</div>

    <!-- Strength map -->
    <div style="margin-top:10px">
      <h4 style="margin:0">Strength Map (Attack / Defense)</h4>
      <div class="map-row"><div><b>Home Attack</b></div><div class="kv" id="atkHomeVal">-</div></div>
      <div class="strength-bar"><div id="atkHomeBar" class="strength-fill" style="width:0%"></div></div>
      <div class="map-row"><div><b>Home Defense</b></div><div class="kv" id="defHomeVal">-</div></div>
      <div class="strength-bar"><div id="defHomeBar" class="strength-fill" style="width:0%"></div></div>

      <div style="height:8px"></div>

      <div class="map-row"><div><b>Away Attack</b></div><div class="kv" id="atkAwayVal">-</div></div>
      <div class="strength-bar"><div id="atkAwayBar" class="strength-fill" style="width:0%"></div></div>
      <div class="map-row"><div><b>Away Defense</b></div><div class="kv" id="defAwayVal">-</div></div>
      <div class="strength-bar"><div id="defAwayBar" class="strength-fill" style="width:0%"></div></div>
    </div>

    <!-- Confidence + trap -->
    <div style="margin-top:12px">
      <label class="small">Confidence</label>
      <div class="progress-wrap"><div id="confFill" class="progress-fill" style="width:0%"></div></div>
      <div id="confText" class="small" style="text-align:right">Confidence: 0%</div>
    </div>

    <div id="trapBox" class="box-trap" style="margin-top:10px;background:#05141a;border-radius:8px;display:none"></div>

    <div id="recs" style="margin-top:8px"></div>

    <canvas id="hist" width="640" height="160" style="margin-top:12px"></canvas>

    <div id="debug" class="result" style="margin-top:8px;background:#07121b"></div>
  </div>

  <p class="small muted">Tip: isi xG/SOT/CSR/GA untuk akurasi lebih baik. Semua input manual — simpan file HTML lokal untuk penggunaan offline.</p>
</div>

<script>
/* ===== Utilities ===== */
function safe(v,d=NaN){ const x=parseFloat(v); return (isNaN(x)?d:x); }
function pct(x){ if(isNaN(x)) return '-'; return (100*x).toFixed(1)+'%'; }
function clamp(v,a,b){ if(v<a) return a; if(v>b) return b; return v; }
function randNormal(mu=0,sigma=1){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return mu+sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }
function poisson(lambda){ let L=Math.exp(-lambda), p=1, k=0; while(p>L){ k++; p*=Math.random(); if(k>10000) break; } return k-1; }

/* ===== Init handlers ===== */
document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('btnCalcCSHome').addEventListener('click', calcCSHome);
  document.getElementById('btnCalcCSAway').addEventListener('click', calcCSAway);
  document.getElementById('btnCalcGAHome').addEventListener('click', calcGAHome);
  document.getElementById('btnCalcGAAway').addEventListener('click', calcGAAway);
  document.getElementById('btnExample').addEventListener('click', fillExample);
  document.getElementById('btnReset').addEventListener('click', resetAll);
  document.getElementById('btnAnalyze').addEventListener('click', analyzeMatch);
  document.getElementById('btnDownload').addEventListener('click', downloadCSVLast);
  document.getElementById('modeSelect').addEventListener('change', modePreset);
});

/* ===== Auto calculators ===== */
function calcCSHome(){ const cs=safe(dom('csCountHome').value,0), m=safe(dom('csMatchesHome').value,0); if(m<=0){alert('Masukkan Matches Home');return;} dom('csHome').value=(clamp(cs/m,0,1)).toFixed(2); }
function calcCSAway(){ const cs=safe(dom('csCountAway').value,0), m=safe(dom('csMatchesAway').value,0); if(m<=0){alert('Masukkan Matches Away');return;} dom('csAway').value=(clamp(cs/m,0,1)).toFixed(2); }
function calcGAHome(){ const g=safe(dom('gcHomeCount').value,0), m=safe(dom('gcMatchesHome').value,0); if(m<=0){alert('Masukkan Matches Home');return;} dom('gcHome').value=(g/m).toFixed(2); }
function calcGAAway(){ const g=safe(dom('gcAwayCount').value,0), m=safe(dom('gcMatchesAway').value,0); if(m<=0){alert('Masukkan Matches Away');return;} dom('gcAway').value=(g/m).toFixed(2); }

function dom(id){ return document.getElementById(id); }

/* ===== Mini auto form/h2h ===== */
function toggleAccordion(id){ const el=dom(id); el.style.display=(el.style.display==='none'||el.style.display==='')?'block':'none'; }
function calcMiniForm(){ const fh=(dom('miniFormHome').value||'').toUpperCase().split(/\s+/).filter(Boolean); const fa=(dom('miniFormAway').value||'').toUpperCase().split(/\s+/).filter(Boolean); function val(a){ let s=0; a.forEach(v=>{ if(v==='W') s+=3; else if(v==='D') s+=1; }); return a.length? (s/(a.length*3)).toFixed(2):'0.50'; } const rH=val(fh), rA=val(fa); dom('formHome').value=rH; dom('formAway').value=rA; dom('miniRes').style.display='block'; dom('miniRes').textContent=`Form → Home:${rH} Away:${rA}`; }
function calcMiniH2H(){ const arr=(dom('miniH2H').value||'').toUpperCase().split(/\s+/).filter(Boolean); const t=arr.length||1; const home=arr.filter(x=>x==='H').length; const rate=(home/t).toFixed(2); if(!dom('h2hRate').value) dom('h2hRate').value=rate; dom('miniRes').style.display='block'; dom('miniRes').textContent=`H2H Home-win rate: ${rate}`; }

/* ===== Core model helpers ===== */
function computeAttackIndex(xg,sot,form,rating,absFw,absMf){
  const base = 0.45*(xg||1.0) + 0.20*((sot||3)/5) + 0.12*(form||0.5) + 0.08*(rating?((rating-6)/1.5):0);
  const penalty = Math.max(0.6, 1 - 0.06*(absFw||0) - 0.03*(absMf||0));
  return Math.max(0.12, base * penalty);
}
function computeDefenseIndex(cs,ga,absDf){
  const csAdj = 1 - clamp((cs||0)*0.35, 0, 0.6);
  const gaAdj = 1 + 0.22*(ga||1.2);
  const absAdj = 1 + 0.08*(absDf||0);
  return clamp(csAdj * gaAdj * absAdj, 0.45, 3.0);
}

/* ===== Bivariate sampling ===== */
function sampleBivariateAdaptive(lambdaH,lambdaA,rho){
  const shared = Math.max(0, rho * Math.min(lambdaH, lambdaA));
  const hPart = Math.max(0, lambdaH - shared);
  const aPart = Math.max(0, lambdaA - shared);
  const sh = poisson(shared);
  return [sh + poisson(hPart), sh + poisson(aPart)];
}

/* ===== Prob helpers ===== */
function probCoverFromScores(scoreFreq,handicap,runs){
  let win=0,push=0,lose=0;
  for(const sc in scoreFreq){
    const v=scoreFreq[sc]; const [gh,ga]=sc.split('-').map(x=>parseInt(x));
    const diff = gh - ga - handicap;
    if(diff>0) win+=v; else if(diff===0) push+=v; else lose+=v;
  }
  return (win + 0.5*push)/runs;
}
function probOUFromTotals(totals,line,runs){
  let over=0,under=0; const isInt=Number.isInteger(line);
  for(const t in totals){ const g=parseInt(t), v=totals[t];
    if(isInt){ if(g>line) over+=v; else if(g<line) under+=v; else {over+=0.5*v; under+=0.5*v;} }
    else { if(g>line) over+=v; else under+=v; }
  }
  return {over: over/runs, under: under/runs};
}
function impliedProb(odds){ if(!odds||odds<=0) return null; return 1/odds; }
function parseH2HToRate(s){
  if(!s) return NaN;
  const parts = s.toUpperCase().replace(/[^WDL, ]/g,'').split(/[, ]+/).filter(Boolean);
  if(parts.length===0) return NaN;
  let wins = parts.filter(p=>p==='W').length;
  return wins / parts.length;
}

/* ===== Analyze ===== */

let lastCSV='';

function analyzeMatch(){

  // read inputs

  const teamH = dom('teamHome').value || 'Home';

  const teamA = dom('teamAway').value || 'Away';

  const ratingH = safe(dom('ratingHome').value,6.5);

  const ratingA = safe(dom('ratingAway').value,6.3);

  let formH = safe(dom('formHome').value,NaN), formA = safe(dom('formAway').value,NaN);

  if(!Number.isFinite(formH)) formH = 0.5; if(!Number.isFinite(formA)) formA = 0.5;

  let h2hRate = safe(dom('h2hRate').value,NaN);

  if(!Number.isFinite(h2hRate)){ const parsed = parseH2HToRate(dom('h2hInput').value); if(Number.isFinite(parsed)) h2hRate = parsed; }

  if(!Number.isFinite(h2hRate)) h2hRate = 0.5;

  const xgH = safe(dom('xgHome').value, ratingH/5), xgA = safe(dom('xgAway').value, ratingA/5);

  const sotH = safe(dom('sotHome').value,4.0), sotA = safe(dom('sotAway').value,3.0);

  const csH = safe(dom('csHome').value,0.28), csA = safe(dom('csAway').value,0.26);

  const gaH = safe(dom('gcHome').value,1.15), gaA = safe(dom('gcAway').value,1.30);

  const absDfH = Math.max(0, safe(dom('absDfHome').value,0)), absMfH = Math.max(0,safe(dom('absMfHome').value,0)), absFwH = Math.max(0,safe(dom('absFwHome').value,0));

  const absDfA = Math.max(0, safe(dom('absDfAway').value,0)), absMfA = Math.max(0,safe(dom('absMfAway').value,0)), absFwA = Math.max(0,safe(dom('absFwAway').value,0));

  const restH = safe(dom('restHome').value,3), restA = safe(dom('restAway').value,3), travelA = safe(dom('travelAway').value,0);

  const intl = safe(dom('intlBreak').value,0), homeAdvBase = safe(dom('homeAdvBase').value,0.02), fatigueHours = safe(dom('fatigueHours').value,72);

  const alpha = clamp(safe(dom('alpha').value,0.12),0,0.5), rho = clamp(safe(dom('rho').value,0.12),-0.5,0.8), runs = Math.max(2000, parseInt(dom('mcRuns').value||40000));

  // compute attack/def

  const atkH = computeAttackIndex(xgH,sotH,formH,ratingH,absFwH,absMfH);

  const atkA = computeAttackIndex(xgA,sotA,formA,ratingA,absFwA,absMfA);

  const defH = computeDefenseIndex(csH,gaH,absDfH);

  const defA = computeDefenseIndex(csA,gaA,absDfA);

  // league avg

  const leagueAvg = Math.max(0.6, (xgH + xgA)/2);

  // baseline lambdas

  let lambdaH = leagueAvg * (atkH / Math.max(0.3, leagueAvg)) * (1/defA);

  let lambdaA = leagueAvg * (atkA / Math.max(0.3, leagueAvg)) * (1/defH);

  // rating shrink

  const ratingBaselineH = (ratingH/5) * leagueAvg;

  const ratingBaselineA = (ratingA/5) * leagueAvg;

  lambdaH = alpha * ratingBaselineH + (1-alpha) * lambdaH;

  lambdaA = alpha * ratingBaselineA + (1-alpha) * lambdaA;

  // h2h boost (home)

  const h2hBoost = clamp((h2hRate - 0.5) * 0.18, -0.12, 0.12);

  lambdaH = Math.max(0.05, lambdaH * (1 + h2hBoost));

  lambdaA = Math.max(0.05, lambdaA * (1 - h2hBoost));

  // fatigue & home advantage adjustments

  // If home rest >=2 days, small positive; if away rest low or long travel, penalize away

  let homeAdv = homeAdvBase;

  if(restH >= 2) homeAdv += 0.02; // extra boost

  if(intl>=1) { homeAdv -= 0.01; } // international break reduces certainty

  // travel: penalize away lambda by factor

  let travelPenalty = 1.0;

  if(travelA >= 800) travelPenalty -= 0.06;

  else if(travelA >= 400) travelPenalty -= 0.035;

  else if(travelA >= 200) travelPenalty -= 0.02;

  // restA small

  if(restA < 2) travelPenalty -= 0.03;

  travelPenalty = clamp(travelPenalty, 0.80, 1.0);

  lambdaH *= (1 + homeAdv);

  lambdaA *= travelPenalty;

  // shrink extreme avg goals

  const avgLam = (lambdaH + lambdaA)/2;

  if(avgLam > 3.2){ lambdaH *= 0.88; lambdaA *= 0.88; }

  else if(avgLam > 2.4){ lambdaH *= 0.94; lambdaA *= 0.94; }

  // Monte Carlo

  const scoreFreq = {}; const totals = {}; let homeWins=0, draws=0, awayWins=0;

  for(let i=0;i<runs;i++){

    const [gh,ga] = sampleBivariateAdaptive(lambdaH,lambdaA,rho);

    const k = `${gh}-${ga}`;

    scoreFreq[k] = (scoreFreq[k]||0) + 1;

    totals[gh+ga] = (totals[gh+ga]||0) + 1;

    if(gh>ga) homeWins++; else if(gh===ga) draws++; else awayWins++;

  }

  const pHome = homeWins / runs, pDraw = draws / runs, pAway = awayWins / runs;

  const avgH = Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[0])*v,0)/runs;

  const avgA = Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[1])*v,0)/runs;

  // OU/HDP

  const ouLine = safe(dom('ouLine').value,2.5);

  const ouProbs = probOUFromTotals(totals,ouLine,runs);

  const hdpLine = safe(dom('hdpLine').value,0.25);

  const coverHome = probCoverFromScores(scoreFreq, hdpLine, runs);

  const coverAway = 1 - coverHome;

  // market implied

  const imp = {

    hdpHome: impliedProb(safe(dom('hdpHomeNow').value,NaN)),

    hdpAway: impliedProb(safe(dom('hdpAwayNow').value,NaN)),

    ouOver: impliedProb(safe(dom('ouOverNow').value,NaN)),

    ouUnder: impliedProb(safe(dom('ouUnderNow').value,NaN))

  };

  function compareLabel(mProb, impProb){

    if(!impProb) return {label:'Market missing',flag:'neutral'};

    const diff = (mProb - impProb) * 100;

    if(Math.abs(diff) < 5) return {label:'Sejalan',flag:'ok'};

    if(diff > 8) return {label:'Model > Market (value)',flag:'model'};

    if(diff < -8) return {label:'Potential Trap',flag:'trap'};

    return {label:'Perbedaan kecil',flag:'neutral'};

  }

  const cmpH = compareLabel(coverHome, imp.hdpHome);

  const cmpO = compareLabel(ouProbs.over, imp.ouOver);

  // confidence

  const topProb = Math.max(pHome, pAway, ouProbs.over, ouProbs.under);

  const conf = Math.round(topProb * 100);

  dom('confFill').style.width = conf + '%';

  dom('confFill').style.background = conf < 45 ? '#ef476f' : (conf < 65 ? '#ffd166' : '#00ff9d');

  dom('confText').textContent = 'Confidence: ' + conf + '%';

  // summary

  let summary = `Match: ${teamH} vs ${teamA}\n`;

  summary += `λ (sharp): Home ${lambdaH.toFixed(2)} | Away ${lambdaA.toFixed(2)}\n`;

  summary += `Attack idx H:${atkH.toFixed(2)} A:${atkA.toFixed(2)} | Def idx H:${defH.toFixed(2)} A:${defA.toFixed(2)}\n`;

  summary += `Expected (sim): H ${avgH.toFixed(2)} | A ${avgA.toFixed(2)}\n`;

  summary += `1X2 Model → Home ${pct(pHome)} Draw ${pct(pDraw)} Away ${pct(pAway)}\n`;

  summary += `OU(${ouLine}) → Over ${pct(ouProbs.over)} | Under ${pct(ouProbs.under)}\n`;

  summary += `HDP(${hdpLine}) → Home cover ${pct(coverHome)} | Away cover ${pct(coverAway)}\n`;

  summary += `Market vs Model: HDP: ${cmpH.label} • OU: ${cmpO.label}\n`;

  summary += `Absent Home (DF/MF/FW): ${absDfH}/${absMfH}/${absFwH} • Away: ${absDfA}/${absMfA}/${absFwA}\n`;

  summary += `Confidence: ${conf}%`;

  dom('summary').textContent = summary;

  // strength map display

  updateStrength('atkHomeBar', 'atkHomeVal', atkH);

  updateStrength('defHomeBar', 'defHomeVal', (1/defH)*10);

  updateStrength('atkAwayBar', 'atkAwayVal', atkA);

  updateStrength('defAwayBar', 'defAwayVal', (1/defA)*10);

  // trap box

  const trapBox = dom('trapBox'); trapBox.style.display='block'; trapBox.innerHTML='';

  const trapHtml = `<div style="font-weight:700">Market Diagnostic</div>

    <div class="small-note">HDP: Model ${pct(coverHome)} vs Market ${imp.hdpHome? pct(imp.hdpHome): 'N/A'} → ${cmpH.label}</div>

    <div class="small-note">OU: Model Over ${pct(ouProbs.over)} vs Market ${imp.ouOver? pct(imp.ouOver): 'N/A'} → ${cmpO.label}</div>`;

  trapBox.innerHTML = trapHtml;

  if(cmpH.flag==='trap' || cmpO.flag==='trap'){ trapBox.style.background='#2a0710'; trapBox.style.border='1px solid #7f2130'; }

  else if(cmpH.flag==='model' || cmpO.flag==='model'){ trapBox.style.background='#072012'; trapBox.style.border='1px solid #0b5f3a'; }

  else { trapBox.style.background='#05141a'; trapBox.style.border='1px solid rgba(255,255,255,0.03)'; }

  // recommendations: top 2 by custom score

  const candidates=[];

  function edgeProb(mProb, impProb){ if(!impProb) return null; return mProb - impProb; }

  candidates.push({tag:`HDP Home ${hdpLine}`,prob:coverHome,edge:edgeProb(coverHome,imp.hdpHome),market:'HDP'});

  candidates.push({tag:`HDP Away ${-hdpLine}`,prob:coverAway,edge:edgeProb(coverAway,imp.hdpAway),market:'HDP'});

  candidates.push({tag:`OU Over ${ouLine}`,prob:ouProbs.over,edge:edgeProb(ouProbs.over,imp.ouOver),market:'OU'});

  candidates.push({tag:`OU Under ${ouLine}`,prob:ouProbs.under,edge:edgeProb(ouProbs.under,imp.ouUnder),market:'OU'});

  candidates.forEach(c=>{ c.score = (c.prob * 0.7) + ((c.edge!==null)?(c.edge * 0.3):0); });

candidates.sort((a,b)=>b.score - a.score);

  const top = candidates.slice(0,2);

  let recHtml='';

  top.forEach(t=>{ const edgeTxt = (t.edge===null)? 'No market odds' : ('edge '+((t.edge*100).toFixed(2)+'%')); recHtml += `<div class="card"><div style="font-weight:700">${t.tag}</div><div style="text-align:right">${pct(t.prob)}<div class="small">${edgeTxt}</div></div></div>`; });

  dom('recs').innerHTML = recHtml;

  // histogram render

  renderHistogram(totals);

  // debug

  dom('debug').textContent = `runs:${runs} | rho:${rho} | alpha:${alpha}\navgGoals H:${avgH.toFixed(2)} A:${avgA.toFixed(2)}`;

  // csv

  let csv='score,count,prob\n';

  Object.keys(scoreFreq).sort().forEach(sc=>{ const c=scoreFreq[sc]; csv += `${sc},${c},${(c/runs).toFixed(6)}\n`; });

  lastCSV = csv;

}



/* ===== Helpers UI ===== */

function updateStrength(barId,valId,score){

  const pctv = Math.max(4, Math.min(95, (score / 2.5) * 100)); // normalize roughly

  dom(barId).style.width = pctv + '%';

  dom(valId).textContent = score.toFixed(2);

}



/* ===== Histogram rendering ===== */

function renderHistogram(totals){

  const ctx = dom('hist').getContext('2d'); ctx.clearRect(0,0,640,160);

  const keys = Object.keys(totals).map(x=>parseInt(x)).sort((a,b)=>a-b);

  if(keys.length===0) return;

  const maxV = Math.max(...Object.values(totals));

  const padLeft=30, barW = Math.max(12, (580/keys.length)-6);

  keys.forEach((k,i)=>{

    const v = totals[k];

    const h = (v / maxV) * 110;

    ctx.fillStyle = '#0b74de';

    ctx.fillRect(padLeft + i*(barW+6), 120 - h, barW, h);

    ctx.fillStyle = '#9fb3c5'; ctx.font='11px Arial'; ctx.fillText(String(k), padLeft + i*(barW+6), 136);

  });

}



/* ===== Download CSV ===== */

function downloadCSVLast(){ if(!lastCSV){ alert('Jalankan Analisis dulu.'); return; } const match=(dom('matchName').value||'match').replace(/\s+/g,'_'); const filename=`${match}_mc_v70.csv`; const blob=new Blob([lastCSV],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }



/* ===== Mode preset ===== */

function modePreset(){ const m=dom('modeSelect').value; if(m==='league'){ dom('alpha').value='0.12'; dom('rho').value='0.12'; dom('mcRuns').value='40000'; } else if(m==='cup'){ dom('alpha').value='0.14'; dom('rho').value='0.18'; dom('mcRuns').value='80000'; } }



/* ===== Example & Reset ===== */

function fillExample(){

  dom('matchName').value='Atalanta vs Lazio';

  dom('teamHome').value='Atalanta'; dom('teamAway').value='Lazio';

  dom('ratingHome').value='6.9'; dom('ratingAway').value='6.4';

  dom('formHome').value='0.72'; dom('formAway').value='0.35';

  dom('xgHome').value='1.25'; dom('xgAway').value='0.95';

  dom('sotHome').value='5.1'; dom('sotAway').value='3.2';

  dom('csHome').value='0.48'; dom('csAway').value='0.28';

  dom('gcHome').value='0.88'; dom('gcAway').value='1.25';

  dom('hdpHomeNow').value='1.90'; dom('hdpAwayNow').value='2.00';

  dom('ouOverNow').value='1.95'; dom('ouUnderNow').value='1.95';

  dom('absDfHome').value='0'; dom('absMfHome').value='0'; dom('absFwHome').value='0';

  dom('absDfAway').value='0'; dom('absMfAway').value='0'; dom('absFwAway').value='0';

  dom('h2hInput').value='W,D,L,W,D';

  dom('restHome').value='4'; dom('restAway').value='3';

  alert('Contoh terisi. Tekan Analisis.');

}

function resetAll(){

  document.querySelectorAll('input').forEach(i=>{ if(i.type!=='button') i.value=''; });

  dom('summary').textContent='Klik "Analisis" untuk menjalankan model.'; dom('recs').innerHTML=''; dom('confFill').style.width='0%'; dom('confText').textContent='Confidence: 0%'; dom('trapBox').style.display='none'; const ctx=dom('hist').getContext('2d'); ctx.clearRect(0,0,640,160); lastCSV=''; dom('debug').textContent='';

}

</script>

</body>

</html>

