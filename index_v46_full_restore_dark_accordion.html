<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Football Analyzer Pro Dark v46</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#030617;--panel:#071826;--card:#071a26;--accent:#06b6d4;--muted:#9fd6ee;--text:#eaf6ff;--danger:#ff6b6b;}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);line-height:1.45}
.container{max-width:1200px;margin:12px auto;padding:18px}
h1{font-size:22px;margin:2px 0 6px}
.small{font-size:13px;color:var(--muted)}
.block{background:var(--panel);border:1px solid rgba(11,78,94,0.18);padding:12px;border-radius:10px;margin-bottom:10px}
.accordion{width:100%;border-radius:8px;overflow:hidden}
.ac-item{border-bottom:1px solid rgba(255,255,255,0.03)}
.ac-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));}
.ac-head h3{margin:0;font-size:15px}
.ac-body{max-height:0;overflow:hidden;transition:max-height .28s ease;padding:0 12px}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.col{flex:1;min-width:160px}
label{display:block;font-size:13px;color:var(--muted);margin:6px 0}
input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(11,78,94,0.2);background:#031821;color:var(--text)}
button{background:var(--accent);border:0;color:#022;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn-muted{background:#0b2f3a;color:var(--text);border:1px solid rgba(255,255,255,0.02)}
.pre{background:#021425;padding:10px;border-radius:8px;border:1px dashed rgba(11,78,94,0.2);font-family:ui-monospace,monospace;margin-top:8px;white-space:pre-wrap}
.canvas-wrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;margin-top:8px}
canvas{background:#02121a;border-radius:6px;border:1px solid rgba(11,78,94,0.2);}
.kv{font-size:13px;color:var(--muted)}
.legend{display:flex;gap:8px;align-items:center;margin-top:6px}
.legend > span{display:inline-block;padding:6px 8px;border-radius:6px;background:#041a22;color:var(--muted);font-size:12px}
.card{background:var(--card);padding:10px;border-radius:8px;border:1px solid rgba(11,78,94,0.12);}
.note{font-size:12px;color:#9fd6ee;margin-top:6px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:center}
.value-item{padding:8px;border-radius:8px;margin-bottom:6px;background:#021425;border:1px solid rgba(11,78,94,0.2)}
.status-green{color:#2dd36f} .status-yellow{color:#f7b731} .status-red{color:#ff6b6b}
.footer{font-size:13px;color:var(--muted);margin-top:6px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <h1>Football Analyzer Pro Dark v46</h1>
  <div class="small">Versi v46 â€” Accordion full layout â€¢ Tema gelap â€¢ ELO manual (default 1500) â€¢ Contoh data otomatis dimuat</div>

  <div class="block accordion" id="mainAccordion">
    <!-- Match Info -->
    <div class="ac-item">
      <div class="ac-head" data-target="matchBody"><h3>1. Match Info & Manual ELO</h3><div class="kv">Klik untuk buka/tutup</div></div>
      <div class="ac-body" id="matchBody">
        <div class="row">
          <div class="col"><label>Home Team: <input id="teamHome" type="text" value=""></label></div>
          <div class="col"><label>Away Team: <input id="teamAway" type="text" value=""></label></div>
          <div class="col"><label>Competition: <input id="comp" type="text" placeholder="e.g. League / World Cup"></label></div>
        </div>
        <div class="row">
          <div class="col"><label>Country Home: <input id="countryHome" list="countries" type="text" placeholder="optional"></label></div>
          <div class="col"><label>Country Away: <input id="countryAway" list="countries" type="text" placeholder="optional"></label></div>
          <div class="col"><label>ELO Home (manual): <input id="eloHome" type="number" placeholder="1500"></label></div>
        </div>
        <div class="row">
          <div class="col"></div>
          <div class="col"><label>ELO Away (manual): <input id="eloAway" type="number" placeholder="1500"></label></div>
          <div class="col"><div class="note">ðŸ›ˆ Jika dikosongkan, <strong>ELO default = 1500</strong></div></div>
        </div>
      </div>
    </div>

    <!-- Attack Inputs -->
    <div class="ac-item">
      <div class="ac-head" data-target="attackBody"><h3>2. Attack â€” xG, Shots, Finishing, Tempo</h3><div class="kv">AutoIndex tersedia</div></div>
      <div class="ac-body" id="attackBody">
        <div class="row">
          <div class="col"><label>xG Home: <input id="xgHome" type="number" step="0.01"></label></div>
          <div class="col"><label>xG Away: <input id="xgAway" type="number" step="0.01"></label></div>
          <div class="col"><label>SOT Home: <input id="sotHome" type="number" step="0.1"></label></div>
          <div class="col"><label>SOT Away: <input id="sotAway" type="number" step="0.1"></label></div>
        </div>
        <div class="row">
          <div class="col"><label>Total Shots Home: <input id="shotsHome" type="number"></label></div>
          <div class="col"><label>Total Shots Away: <input id="shotsAway" type="number"></label></div>
          <div class="col"><label>Conversion Rate Home: <input id="convHome" type="number" step="0.01"></label></div>
          <div class="col"><label>Conversion Rate Away: <input id="convAway" type="number" step="0.01"></label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Shot Index / Finishing / Tempo (auto)</label></div>
          <div class="col"><button id="btnAutoIndexHome" class="btn-muted">AutoIndex Home</button></div>
          <div class="col"><button id="btnAutoIndexAway" class="btn-muted">AutoIndex Away</button></div>
          <div class="col"><button id="btnCR" class="btn-muted">Hitung CR Otomatis</button></div>
        </div>
      </div>
    </div>

    <!-- Defense Inputs -->
    <div class="ac-item">
      <div class="ac-head" data-target="defBody"><h3>3. Defense â€” Tackles + Interceptions (otomatis), CS, GC, Saves</h3><div class="kv"></div></div>
      <div class="ac-body" id="defBody">
        <div class="row">
          <div class="col"><label>Tackles Home: <input id="tackleHome" type="number"></label></div>
          <div class="col"><label>Inter Home: <input id="interHome" type="number"></label></div>
          <div class="col"><label>Total TI Home (auto): <input id="tiHome" type="number" readonly></label></div>
          <div class="col"><label>CS Home: <input id="csHome" type="number" step="0.01"></label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Tackles Away: <input id="tackleAway" type="number"></label></div>
          <div class="col"><label>Inter Away: <input id="interAway" type="number"></label></div>
          <div class="col"><label>Total TI Away (auto): <input id="tiAway" type="number" readonly></label></div>
          <div class="col"><label>CS Away: <input id="csAway" type="number" step="0.01"></label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Goals Conceded Home (avg): <input id="gcHome" type="number" step="0.1"></label></div>
          <div class="col"><label>Goals Conceded Away (avg): <input id="gcAway" type="number" step="0.1"></label></div>
          <div class="col"><label>Saves Home: <input id="saveHome" type="number" step="0.1"></label></div>
          <div class="col"><label>Saves Away: <input id="saveAway" type="number" step="0.1"></label></div>
        </div>
      </div>
    </div>

    <!-- Absences & Errors -->
    <div class="ac-item">
      <div class="ac-head" data-target="absBody"><h3>4. Absensi Pemain & Errors</h3><div class="kv">Isi posisi absensi (DF/MF/FW/GK)</div></div>
      <div class="ac-body" id="absBody">
        <div class="row">
          <div class="col"><label>DF abs Home: <input id="absDfHome" type="number" value="0"></label></div>
          <div class="col"><label>MF abs Home: <input id="absMfHome" type="number" value="0"></label></div>
          <div class="col"><label>FW abs Home: <input id="absFwHome" type="number" value="0"></label></div>
          <div class="col"><label>GK abs Home: <input id="absGkHome" type="number" value="0"></label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>DF abs Away: <input id="absDfAway" type="number" value="0"></label></div>
          <div class="col"><label>MF abs Away: <input id="absMfAway" type="number" value="0"></label></div>
          <div class="col"><label>FW abs Away: <input id="absFwAway" type="number" value="0"></label></div>
          <div class="col"><label>GK abs Away: <input id="absGkAway" type="number" value="0"></label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Errorsâ†’goal Home (est/season): <input id="errHome" type="number" step="0.1" value="6"></label></div>
          <div class="col"><label>Errorsâ†’goal Away (est/season): <input id="errAway" type="number" step="0.1" value="7"></label></div>
          <div class="col"><label>H2H recent (e.g. W,D,L,W): <input id="h2hResults" type="text" placeholder="optional"></label></div>
          <div class="col"><label>Form 5 matches (W/D/L csv): <input id="formRaw" type="text" placeholder="e.g. W,W,D,L,W"></label></div>
        </div>
      </div>
    </div>

    <!-- Travel & Controls -->
    <div class="ac-item">
      <div class="ac-head" data-target="travelBody"><h3>5. Travel, Fatigue & Controls</h3><div class="kv"></div></div>
      <div class="ac-body" id="travelBody">
        <div class="row">
          <div class="col"><label>Lat Home: <input id="latHome" type="number" step="0.0001"></label></div>
          <div class="col"><label>Lon Home: <input id="lonHome" type="number" step="0.0001"></label></div>
          <div class="col"><label>Lat Away: <input id="latAway" type="number" step="0.0001"></label></div>
          <div class="col"><label>Lon Away: <input id="lonAway" type="number" step="0.0001"></label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Days rest Home: <input id="daysRestHome" type="number" value="4"></label></div>
          <div class="col"><label>Days rest Away: <input id="daysRestAway" type="number" value="3"></label></div>
          <div class="col"><label>Bench Home: <input id="benchHome" type="number" value="6"></label></div>
          <div class="col"><label>Bench Away: <input id="benchAway" type="number" value="6"></label></div>
        </div>
        <div style="margin-top:8px"><button id="btnAnalyze" style="background:var(--accent);padding:10px 14px;border-radius:8px">Analisis v46</button> <button id="btnExample" class="btn-muted">Isi Contoh</button> <button id="btnReset" class="btn-muted">Reset</button></div>
      </div>
    </div>

    <!-- Output -->
    <div class="ac-item">
      <div class="ac-head" data-target="outputBody"><h3>6. Output â€” Summary, Recs, Graphs</h3><div class="kv"></div></div>
      <div class="ac-body" id="outputBody">
        <div class="canvas-wrap">
          <div style="flex:2">
            <div class="card" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong id="matchTitle">-</strong><div class="small" id="matchMeta">-</div></div><div><canvas id="gauge" width="160" height="120"></canvas></div></div></div>
            <div class="card" style="margin-bottom:8px"><canvas id="momentum" width="740" height="200"></canvas><div class="legend"><span>Home Prob</span><span>Draw Prob</span><span>Away Prob</span></div></div>
            <div class="card"><h4 class="small">Histogram Total Goals</h4><canvas id="hist" width="740" height="140"></canvas></div>
          </div>
          <div style="flex:1;">
            <div class="card"><h4 class="small">Summary & Best Recs</h4><pre id="summary" class="pre">â€”</pre></div>
            <div class="card" style="margin-top:8px"><h4 class="small">Value Bets</h4><div id="valueList"></div></div>
            <div class="card" style="margin-top:8px"><h4 class="small">Trap Table</h4><table class="table" id="trapTable"><tr><th>Pasar</th><th>Open</th><th>Now</th><th>Î”%</th><th>Arah</th><th>Prob</th><th>Edge</th><th>Status</th></tr></table></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="ac-item">
      <div class="ac-head" data-target="logBody"><h3>7. Log Evaluasi & Export</h3><div class="kv"></div></div>
      <div class="ac-body" id="logBody">
        <div style="display:flex;gap:8px"><button id="btnExportCSV" class="btn-muted">Export CSV</button><button id="btnExportJSON" class="btn-muted">Export JSON</button><button id="btnShowLogs" class="btn-muted">Show Logs</button></div>
        <div id="evalLog" class="card small" style="margin-top:8px;max-height:260px;overflow:auto">Log evaluasi kosong.</div>
      </div>
    </div>

  </div>

  <div class="footer">Football Analyzer Pro Dark v46 â€¢ Accordion â€¢ Manual ELO (default 1500)</div>
</div>

<script>
// Utilities
function safe(v,d=0){ const x=parseFloat(v); return isNaN(x)?d:x; }
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }
function poisson(lambda){ let L=Math.exp(-lambda), p=1, k=0; while(p> L){ k++; p *= Math.random(); if(k>2000) break; } return Math.max(0,k-1); }
function percent(x){ return (100*x).toFixed(1)+'%'; }
function nowISO(){ return new Date().toISOString(); }

// Accordion behavior
document.querySelectorAll('.ac-head').forEach(h=>{ h.addEventListener('click', ()=>{ const id=h.getAttribute('data-target'); const body=document.getElementById(id); // close others
    document.querySelectorAll('.ac-body').forEach(b=>{ if(b!==body) b.style.maxHeight='0px'; });
    if(body.style.maxHeight && body.style.maxHeight!=='0px') body.style.maxHeight='0px'; else { body.style.maxHeight = body.scrollHeight + 'px'; }
  }); });

// Auto TI (tackles+inter)
function autoTI(){ document.getElementById('tiHome').value = (safe(document.getElementById('tackleHome').value)+safe(document.getElementById('interHome').value)).toFixed(1); document.getElementById('tiAway').value = (safe(document.getElementById('tackleAway').value)+safe(document.getElementById('interAway').value)).toFixed(1); }
['tackleHome','interHome','tackleAway','interAway'].forEach(id=>document.getElementById(id).addEventListener('input',autoTI));

// Auto CR
document.getElementById('btnCR').addEventListener('click', ()=>{
  const gh = safe(document.getElementById('goalsHome')?.value, NaN), sh = safe(document.getElementById('sotHome')?.value, NaN);
  const ga = safe(document.getElementById('goalsAway')?.value, NaN), sa = safe(document.getElementById('sotAway')?.value, NaN);
  if(sh>0) document.getElementById('convHome').value = (gh/sh).toFixed(2);
  if(sa>0) document.getElementById('convAway').value = (ga/sa).toFixed(2);
  alert('Conversion Rate otomatis terisi jika data tersedia.');
});

// Compute indexes (simple but effective)
function computeAttackIndex(xg,sot,conv,shots,poss){ return Math.max(0.15, 0.35*xg + 0.22*(sot/5) + 0.12*(conv*100||12) + 0.05*(shots/10) + 0.06*(poss/50)); }
function computeDefenseIndex(cs,gc,saves,ti,err,absDf){ const errPerGame = err/38.0; return clamp(1 + (0.28*Math.log(Math.max(1,gc)+1)) - 0.22*cs - 0.09*(ti/25) + 0.05*errPerGame + 0.04*absDf - 0.08*(Math.log(1+Math.max(0,saves))/Math.log(7)), 0.45, 2.8); }

// Map helper (simple)
const capitals = {"Latvia":{lat:56.9496,lon:24.1052,city:'Riga'},"Andorra":{lat:42.5063,lon:1.5218,city:'Andorra la Vella'},"France":{lat:48.8566,lon:2.3522,city:'Paris'}, "Japan":{lat:35.6895,lon:139.6917,city:'Tokyo'}};
function haversine(lat1, lon1, lat2, lon2){ const R=6371; const toRad=x=>x*Math.PI/180; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }

// Monte Carlo & helpers
function monteCarlo(lambdaH, lambdaA, runs){
  const scoreFreq={}, totals={}; let h=0,d=0,a=0;
  for(let i=0;i<runs;i++){ const gh=poisson(lambdaH); const ga=poisson(lambdaA); scoreFreq[`${gh}-${ga}`] = (scoreFreq[`${gh}-${ga}`]||0)+1; totals[gh+ga] = (totals[gh+ga]||0)+1; if(gh>ga) h++; else if(gh===ga) d++; else a++; }
  return {scoreFreq, totals, pHome:h/runs, pDraw:d/runs, pAway:a/runs};
}
function probOUFromTotals(totals,line,runs){ let over=0,under=0; const isInt=Number.isInteger(line); for(const t in totals){ const g=parseInt(t), v=totals[t]; if(isInt){ if(g>line) over+=v; else if(g<line) under+=v; else {over+=0.5*v; under+=0.5*v;} } else { if(g>line) over+=v; else under+=v; } } return {over: over/runs, under: under/runs}; }
function probCoverFromScores(scoreFreq, handicap, runs){ let win=0,push=0,lose=0; for(const sc in scoreFreq){ const v=scoreFreq[sc]; const [gh,ga] = sc.split('-').map(x=>parseInt(x)); const diff = gh - ga - handicap; if(diff>0) win+=v; else if(diff===0) push+=v; else lose+=v; } return (win + 0.5*push)/runs; }

function computeConfidence(totals, travelFactor){ let mean=0,count=0; for(const t in totals){ mean += parseInt(t)*totals[t]; count+=totals[t]; } if(count===0) return {score:0.5,label:'Low'}; mean/=count; let varv=0; for(const t in totals){ varv += ((parseInt(t)-mean)**2)*totals[t]; } varv/=count; let conf = clamp(1 - Math.min(1, varv/8), 0.12, 0.97); conf *= clamp(1 - (1-travelFactor)*0.25, 0.6, 1.02); const label = conf>0.8? 'High': (conf>0.55? 'Medium':'Low'); return {score:conf,label}; }

function drawGauge(conf){ const c=document.getElementById('gauge'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const cx=c.width/2, cy=c.height*0.8, r=50; ctx.lineWidth=10; ctx.beginPath(); ctx.strokeStyle='#04202a'; ctx.arc(cx,cy,r,Math.PI,2*Math.PI); ctx.stroke(); const val=clamp(conf.score,0,1); const end=Math.PI + val*Math.PI; ctx.beginPath(); ctx.strokeStyle = val>0.8? '#2dd36f' : (val>0.55? '#f7b731' : '#ff6b6b'); ctx.lineWidth=10; ctx.arc(cx,cy,r,Math.PI,end); ctx.stroke(); ctx.fillStyle='#cfe8ff'; ctx.font='14px Arial'; ctx.textAlign='center'; ctx.fillText((val*100).toFixed(1)+'%',cx,cy-10); ctx.font='11px Arial'; ctx.fillText(conf.label, cx, cy+14); }

function drawMomentum(mins, homeArr, drawArr, awayArr){ const c=document.getElementById('momentum'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#041220'; ctx.fillRect(0,0,c.width,c.height); const left=40, right=c.width-10, top=10, bottom=c.height-20; const w=right-left; function x(i){ return left + (i/(mins-1))*w; } function y(v){ return bottom - v*(bottom-top); } ctx.beginPath(); ctx.strokeStyle='#0b74de'; ctx.lineWidth=2; ctx.moveTo(x(0), y(homeArr[0])); for(let i=1;i<mins;i++) ctx.lineTo(x(i), y(homeArr[i])); ctx.stroke(); ctx.globalAlpha=0.08; ctx.fillStyle='#0b74de'; ctx.beginPath(); ctx.moveTo(x(0), y(homeArr[0])); for(let i=1;i<mins;i++) ctx.lineTo(x(i), y(homeArr[i])); ctx.lineTo(x(mins-1), bottom); ctx.lineTo(x(0), bottom); ctx.fill(); ctx.globalAlpha=1; ctx.beginPath(); ctx.strokeStyle='#9aa8b2'; ctx.lineWidth=2; ctx.moveTo(x(0), y(drawArr[0])); for(let i=1;i<mins;i++) ctx.lineTo(x(i), y(drawArr[i])); ctx.stroke(); ctx.beginPath(); ctx.strokeStyle='#ff7b7b'; ctx.lineWidth=2; ctx.moveTo(x(0), y(awayArr[0])); for(let i=1;i<mins;i++) ctx.lineTo(x(i), y(awayArr[i])); ctx.stroke(); ctx.fillStyle='#9fd6ee'; ctx.font='10px Arial'; ctx.fillText('0', left-8, bottom+12); ctx.fillText('90', right-10, bottom+12); ctx.fillText('Probability', left, top+10); }

function drawHistogram(totals, canvasId){ const c=document.getElementById(canvasId); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#02121a'; ctx.fillRect(0,0,c.width,c.height); const keys = Object.keys(totals).map(k=>parseInt(k)).sort((a,b)=>a-b); const maxV = Math.max(...keys.map(k=>totals[k]||0),1); const left = 20, right = c.width-20; const w = (right-left)/Math.max(1, keys.length); keys.forEach((k,i)=>{ const v = totals[k]||0; const h = (v/maxV)*(c.height-30); ctx.fillStyle='#0b74de'; ctx.fillRect(left + i*w, c.height-10-h, w*0.8, h); ctx.fillStyle='#9fd6ee'; ctx.font='10px Arial'; ctx.fillText(String(k), left + i*w, c.height-2); }); }

// logs and storage
const LOG_KEY = 'v46_full_logs';
function getLogs(){ return JSON.parse(localStorage.getItem(LOG_KEY)||'[]'); }
function saveLog(pred){ const logs=getLogs(); logs.unshift(pred); if(logs.length>1500) logs.pop(); localStorage.setItem(LOG_KEY, JSON.stringify(logs)); renderLogs(); }
function renderLogs(){ const logs=getLogs(); const el=document.getElementById('evalLog'); if(!logs||logs.length===0){ el.innerHTML='Belum ada log.'; return; } let html='<table style="width:100%;border-collapse:collapse"><tr><th>Waktu</th><th>Match</th><th>Î»H</th><th>Î»A</th><th>Best</th></tr>'; logs.forEach(l=>{ html += `<tr><td style="font-size:12px">${l.time}</td><td style="font-size:12px">${l.match}</td><td style="font-size:12px">${l.lambdaH.toFixed(2)}</td><td style="font-size:12px">${l.lambdaA.toFixed(2)}</td><td style="font-size:12px">${l.best}</td></tr>`; }); html += '</table>'; el.innerHTML=html; }

// main analyze
document.getElementById('btnAnalyze').addEventListener('click', ()=>{
  try{
    // coords and travel
    const latH = safe(document.getElementById('latHome').value, NaN), lonH = safe(document.getElementById('lonHome').value, NaN);
    const latA = safe(document.getElementById('latAway').value, NaN), lonA = safe(document.getElementById('lonAway').value, NaN);
    const cHome = document.getElementById('countryHome').value.trim(), cAway = document.getElementById('countryAway').value.trim();
    const coordsH = (!isNaN(latH) && !isNaN(lonH))? {lat:latH,lon:lonH,city:cHome||'Home'} : (capitals[cHome] || null);
    const coordsA = (!isNaN(latA) && !isNaN(lonA))? {lat:latA,lon:lonA,city:cAway||'Away'} : (capitals[cAway] || null);
    if(!coordsH || !coordsA){ alert('Isi koordinat manual atau pilih negara sample.'); return; }
    const km = Math.round(haversine(coordsH.lat, coordsH.lon, coordsA.lat, coordsA.lon));
    const travelFactor = (km<5)?1.0:(km<300?0.99:(km<800?0.97:(km<2000?0.94:0.88)));
    const impactLabel = (km<5)? 'Negligible': (km<300? 'Short': (km<800? 'Medium': (km<2000? 'Long':'Intercontinental')));
    document.getElementById('matchMeta').textContent = `${cHome} â€” ${cAway} â€¢ Travel:${km}km (${impactLabel})`;

    // inputs & defaults
    const eloH = safe(document.getElementById('eloHome').value,1500), eloA = safe(document.getElementById('eloAway').value,1500);
    const h = { xg: safe(document.getElementById('xgHome').value,1.2), sot: safe(document.getElementById('sotHome').value,3.5), conv: safe(document.getElementById('convHome').value,0.12), shots: safe(document.getElementById('shotsHome').value,8), poss: safe(document.getElementById('possHome')?.value,52), gc: safe(document.getElementById('gcHome').value,1.1), cs: safe(document.getElementById('csHome').value,0.3), ti: safe(document.getElementById('tiHome').value,20), saves: safe(document.getElementById('saveHome').value,3.5), err: safe(document.getElementById('errHome').value,6), absDf: safe(document.getElementById('absDfHome').value,0), elo: eloH };
    const a = { xg: safe(document.getElementById('xgAway').value,1.0), sot: safe(document.getElementById('sotAway').value,3.0), conv: safe(document.getElementById('convAway').value,0.11), shots: safe(document.getElementById('shotsAway').value,6), poss: safe(document.getElementById('possAway')?.value,48), gc: safe(document.getElementById('gcAway').value,1.3), cs: safe(document.getElementById('csAway').value,0.25), ti: safe(document.getElementById('tiAway').value,18), saves: safe(document.getElementById('saveAway').value,3.2), err: safe(document.getElementById('errAway').value,7), absDf: safe(document.getElementById('absDfAway').value,0), elo: eloA };

    // stamina
    const restH = safe(document.getElementById('daysRestHome').value,4), restA = safe(document.getElementById('daysRestAway').value,3);
    const benchH = safe(document.getElementById('benchHome').value,6), benchA = safe(document.getElementById('benchAway').value,6);
    function stamina(days, km, bench){ const restPenalty = Math.max(0,(3-days))*0.035; const travelPenalty = Math.max(0,(km-200))*0.00016; const benchBonus = Math.max(0,(bench-5))*0.006; return clamp(1 - restPenalty - travelPenalty + benchBonus,0.65,1.06); }
    const stamH = stamina(restH,0,benchH), stamA = stamina(restA,km,benchA);

    // compute indexes & lambda
    const atkH = computeAttackIndex(h.xg,h.sot,h.conv,h.shots,h.poss||52);
    const atkA = computeAttackIndex(a.xg,a.sot,a.conv,a.shots,a.poss||48);
    const defH = computeDefenseIndex(h.cs,h.gc,h.saves,h.ti,h.err,h.absDf);
    const defA = computeDefenseIndex(a.cs,a.gc,a.saves,a.ti,a.err,a.absDf);
    // incorporate ELO spread
    const eloFactorH = clamp(1 + (h.elo - a.elo)/1400, 0.75, 1.25);
    const eloFactorA = clamp(1 + (a.elo - h.elo)/1400, 0.75, 1.25);
    let lambdaH = Math.max(0.03, 1.05 * (atkH / Math.max(0.3, defA)) * eloFactorH * stamH / travelFactor);
    let lambdaA = Math.max(0.03, 0.95 * (atkA / Math.max(0.3, defH)) * eloFactorA * stamA * travelFactor);
    // shrink extremes
    const avgLam = (lambdaH + lambdaA)/2; if(avgLam>3.0){ lambdaH *= 0.86; lambdaA *= 0.86; } else if(avgLam>2.0){ lambdaH *= 0.94; lambdaA *= 0.94; }

    // Monte Carlo
    const runs = Math.max(2000, safe(document.getElementById('mcRuns')?.value,8000));
    const mc = monteCarlo(lambdaH, lambdaA, runs);
    const avgH = Object.entries(mc.scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[0])*v,0)/runs;
    const avgA = Object.entries(mc.scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[1])*v,0)/runs;

    // OU and HDP
    const ouLine = 2.5; const ouProb = probOUFromTotals(mc.totals, ouLine, runs);
    const hdpLine = 0.25; const coverHome = probCoverFromScores(mc.scoreFreq, hdpLine, runs); const coverAway = probCoverFromScores(mc.scoreFreq, -hdpLine, runs);

    // confidence & recs
    const conf = computeConfidence(mc.totals, travelFactor);
    drawGauge(conf);
    // momentum (smaller runs)
    const mRuns = Math.min(3000, Math.max(500, Math.floor(runs/2)));
    const momentum = (function(){ const mins=91; const homeCounts=new Array(mins).fill(0), drawCounts=new Array(mins).fill(0), awayCounts=new Array(mins).fill(0); for(let r=0;r<mRuns;r++){ const gh=poisson(lambdaH), ga=poisson(lambdaA); const mh=[]; for(let i=0;i<gh;i++) mh.push(Math.floor(Math.random()*91)); const ma=[]; for(let i=0;i<ga;i++) ma.push(Math.floor(Math.random()*91)); const events=new Array(mins).fill(0).map(()=>({h:0,a:0})); mh.forEach(m=> events[m].h++); ma.forEach(m=> events[m].a++); let sh=0, sa=0; for(let m=0;m<mins;m++){ sh+=events[m].h; sa+=events[m].a; if(sh>sa) homeCounts[m]++; else if(sh===sa) drawCounts[m]++; else awayCounts[m]++; } } return {mins, homeProb: homeCounts.map(c=>c/mRuns), drawProb: drawCounts.map(c=>c/mRuns), awayProb: awayCounts.map(c=>c/mRuns)}; })();
    drawMomentum(momentum.mins, momentum.homeProb, momentum.drawProb, momentum.awayProb);
    drawHistogram(mc.totals, 'hist');

    // recommendations (value detection basic)
    const candidates = [
      {tag:`OU Over ${ouLine}`, prob:ouProb.over, market:'OU'}, {tag:`OU Under ${ouLine}`, prob:ouProb.under, market:'OU'},
      {tag:`HDP Home ${hdpLine}`, prob:coverHome, market:'HDP'}, {tag:`HDP Away ${-hdpLine}`, prob:coverAway, market:'HDP'}
    ];
    candidates.forEach(c=> c.score = c.prob);
    candidates.sort((a,b)=>b.score - a.score);
    const best = candidates.slice(0,2);

    // render output summary
    document.getElementById('matchTitle').textContent = `${document.getElementById('teamHome').value} vs ${document.getElementById('teamAway').value}`;
    document.getElementById('summary').textContent = `ELO H:${eloH} | ELO A:${eloA}\nÎ» H:${lambdaH.toFixed(2)} | Î» A:${lambdaA.toFixed(2)}\nExp Goals H:${avgH.toFixed(2)} A:${avgA.toFixed(2)}\n1X2 â€” Home ${(100*mc.pHome).toFixed(1)}% Draw ${(100*mc.pDraw).toFixed(1)}% Away ${(100*mc.pAway).toFixed(1)}%\nOU(${ouLine}) Over ${(100*ouProb.over).toFixed(1)}% | Under ${(100*ouProb.under).toFixed(1)}%\nHDP(${hdpLine}) Home ${(100*coverHome).toFixed(1)}% | Away ${(100*coverAway).toFixed(1)}%\nConfidence: ${conf.label} (${(100*conf.score).toFixed(1)}%)\nStamina H:${stamH.toFixed(3)} A:${stamA.toFixed(3)} â€¢ Runs:${runs}`;

    // value list
    let valHTML=''; candidates.forEach(c=> valHTML += `<div class="value-item"><div style="font-weight:700">${c.tag}</div><div class="kv">Prob: ${(100*c.prob).toFixed(1)}%</div></div>`); document.getElementById('valueList').innerHTML = valHTML;

    // trap table
    let table = '<tr><th>Pasar</th><th>Prob</th><th>Status</th></tr>'; candidates.forEach(c=>{ const st = c.prob>0.6? 'Strong': (c.prob>0.53? 'Moderate':'Weak'); table += `<tr><td>${c.tag}</td><td>${(100*c.prob).toFixed(1)}%</td><td>${st}</td></tr>`; }); document.getElementById('trapTable').innerHTML = table;

    // save log
    saveLog({time: nowISO(), match: `${document.getElementById('teamHome').value} vs ${document.getElementById('teamAway').value}`, lambdaH: lambdaH, lambdaA: lambdaA, best: best[0].tag, conf: (100*conf.score).toFixed(1)+'%'});
    renderLogs();

  }catch(e){ alert('Error saat analisis: '+e.message); }
});

// example auto-fill on load and button
function fillExample(){ document.getElementById('teamHome').value='Manchester City'; document.getElementById('teamAway').value='Tottenham'; document.getElementById('countryHome').value='England'; document.getElementById('countryAway').value='England'; document.getElementById('latHome').value='53.4808'; document.getElementById('lonHome').value='-2.2426'; document.getElementById('latAway').value='51.5072'; document.getElementById('lonAway').value='-0.1276'; document.getElementById('xgHome').value='2.10'; document.getElementById('xgAway').value='1.40'; document.getElementById('sotHome').value='7'; document.getElementById('sotAway').value='4'; document.getElementById('goalsHome').value='8'; document.getElementById('goalsAway').value='6'; document.getElementById('tackleHome').value='22'; document.getElementById('interHome').value='9'; document.getElementById('tackleAway').value='17'; document.getElementById('interAway').value='7'; autoTI(); document.getElementById('csHome').value='0.48'; document.getElementById('csAway').value='0.30'; document.getElementById('gcHome').value='0.8'; document.getElementById('gcAway').value='1.3'; document.getElementById('saveHome').value='3.6'; document.getElementById('saveAway').value='3.2'; document.getElementById('errHome').value='5'; document.getElementById('errAway').value='9'; document.getElementById('daysRestHome').value='5'; document.getElementById('daysRestAway').value='3'; document.getElementById('benchHome').value='7'; document.getElementById('benchAway').value='6'; document.getElementById('eloHome').value='1880'; document.getElementById('eloAway').value='1700'; document.getElementById('mcRuns')?.remove(); alert('Contoh otomatis terisi. Klik Analisis v46.'); }
document.getElementById('btnExample').addEventListener('click', fillExample);

// reset and exports
document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('Reset semua input?')) return; document.querySelectorAll('input').forEach(i=>{ if(i.type==='checkbox') i.checked=false; else if(i.type!=='button') i.value=''; }); document.getElementById('summary').textContent='-'; document.getElementById('matchTitle').textContent='-'; document.getElementById('matchMeta').textContent='-'; document.getElementById('momentum').getContext('2d').clearRect(0,0,740,200); document.getElementById('hist').getContext('2d').clearRect(0,0,740,140); document.getElementById('gauge').getContext('2d').clearRect(0,0,160,120); renderLogs(); });
document.getElementById('btnExportCSV').addEventListener('click', ()=>{ const logs=getLogs(); if(!logs||logs.length===0){ alert('Tidak ada log'); return; } const header=['time','match','lambdaH','lambdaA','best','conf']; const rows = logs.map(l=>[l.time,l.match,l.lambdaH,l.lambdaA,l.best,l.conf]); const csv=[header.join(','), ...rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(','))].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='v46_logs_'+(new Date()).toISOString().replace(/[:.]/g,'')+'.csv'; a.click(); });
document.getElementById('btnExportJSON').addEventListener('click', ()=>{ const logs=getLogs(); const blob=new Blob([JSON.stringify(logs,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='v46_logs_'+(new Date()).toISOString().replace(/[:.]/g,'')+'.json'; a.click(); });
document.getElementById('btnShowLogs').addEventListener('click', ()=>{ renderLogs(); alert('Logs ditampilkan di panel bawah.'); });

// init auto-open first two sections and example fill
window.addEventListener('load', ()=>{ document.getElementById('matchBody').style.maxHeight = document.getElementById('matchBody').scrollHeight + 'px'; document.getElementById('attackBody').style.maxHeight = document.getElementById('attackBody').scrollHeight + 'px'; fillExample(); });
renderLogs();
</script>
</body>
</html>
