<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PrediksiBola — v64 Final (1 kolom, Dark, Balanced)</title>
<style>
:root{
  --bg:#041018; --panel:#071826; --card:#0e1a24; --muted:#9fb3c5; --accent:#0b74de;
  --good:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --text:#dff3ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:980px;margin:18px auto;padding:18px}
h1{margin:0 0 8px;font-size:22px;color:#cfe9ff}
.panel{background:var(--panel);border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input[type="text"], input[type="number"], select, textarea {width:100%;padding:8px;border-radius:6px;border:1px solid #22333f;background:#08131a;color:#fff;font-size:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1 1 260px;min-width:220px}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid #233645;color:#cfe9ff;padding:6px 8px;border-radius:6px;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.result{background:#06131a;padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.03);font-family:monospace;white-space:pre-wrap}
.card{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:#061922;margin-bottom:8px}
canvas{background:transparent;border-radius:6px}
.status-green{color:var(--good)} .status-yellow{color:var(--warn)} .status-red{color:var(--bad)}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.muted{color:var(--muted);font-size:13px}
.label-pill{padding:4px 8px;border-radius:999px;background:#062634;color:#cfe9ff;font-size:12px}
.btn-mode { background-color: #222; color: #ccc; border: 1px solid #444; padding: 6px 14px; border-radius: 6px; cursor: pointer; }
.btn-mode.active { background-color: #1db954; color: white; border-color: #1db954; }
@media (max-width:720px){.col{flex-basis:100%}}
</style>
</head>
<body>
<div class="container">
  <h1>⚽ PrediksiBola — v64 Final (Balanced)</h1>
  <p class="small">1 kolom fokus • Tema gelap • Defensive Ratio • Mode Liga/Cup • Penyesuaian anti-bias Over • Bahasa: Indonesia</p>

  <!-- Mode Toggle -->
  <div style="display:flex;justify-content:center;gap:10px;margin:8px 0 12px;">
    <button id="btnLeague" class="btn-mode active">Mode Liga</button>
    <button id="btnCup" class="btn-mode">Mode Cup</button>
  </div>

  <!-- Header / Match -->
  <div class="panel">
    <div class="flex-between">
      <div>
        <strong>Informasi Pertandingan</strong><div class="small muted">Isi nama tim & liga, lalu gunakan tombol contoh atau isi manual</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnExample" class="btn-ghost">Contoh Otomatis</button>
        <button id="btnResetAll" class="btn-ghost">Reset Semua</button>
      </div>
    </div>

    <label>Nama Pertandingan</label><input id="matchName" type="text" value="Home FC vs Away FC">
    <div class="row">
      <div class="col"><label>Home Team</label><input id="teamHome" type="text" value="Home FC"></div>
      <div class="col"><label>Away Team</label><input id="teamAway" type="text" value="Away FC"></div>
    </div>
    <div class="row">
      <div class="col"><label>Liga / Kompetisi</label><input id="league" type="text" value=""></div>
      <div class="col"><label>Tanggal (YYYY-MM-DD)</label><input id="matchDate" type="text" value=""></div>
    </div>
  </div>

  <!-- Attack & Finishing -->
  <div class="panel">
    <strong>Attack & Finishing</strong>
    <div class="row">
      <div class="col"><label>xG per Game (Home)</label><input id="xgHome" type="number" step="0.01"></div>
      <div class="col"><label>xG per Game (Away)</label><input id="xgAway" type="number" step="0.01"></div>
    </div>
    <div class="row">
      <div class="col"><label>SOT (Home)</label><input id="sotHome" type="number" step="0.1"></div>
      <div class="col"><label>SOT (Away)</label><input id="sotAway" type="number" step="0.1"></div>
    </div>
    <div class="row">
      <div class="col"><label>Shots Total (Home)</label><input id="shotsHome" type="number" step="0.1"></div>
      <div class="col"><label>Shots Total (Away)</label><input id="shotsAway" type="number" step="0.1"></div>
    </div>
    <div class="row">
      <div class="col"><label>Goals season (Home) — est</label><input id="goalsHome" type="number" step="1"></div>
      <div class="col"><label>Goals season (Away) — est</label><input id="goalsAway" type="number" step="1"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button id="btnAutoCR" class="btn-ghost">Auto Conversion Rate</button>
      <button id="btnFEI" class="btn-ghost">Hitung FEI</button>
      <button id="btnAutoShotIndex" class="btn-ghost">Auto Shot Index</button>
      <button id="btnAutoTempo" class="btn-ghost">Auto Tempo</button>
    </div>
    <div id="attackNotes" class="small muted" style="margin-top:6px"></div>
  </div>

  <!-- Defense & DSI -->
  <div class="panel">
    <strong>Defense & DSI</strong>
    <div class="row">
      <div class="col"><label>Clean Sheet Ratio (Home)</label><input id="csHome" type="number" step="0.01"></div>
      <div class="col"><label>Clean Sheet Ratio (Away)</label><input id="csAway" type="number" step="0.01"></div>
    </div>
    <div class="row">
      <div class="col"><label>Goals Conceded per Game (Home)</label><input id="gcHome" type="number" step="0.1"></div>
      <div class="col"><label>Goals Conceded per Game (Away)</label><input id="gcAway" type="number" step="0.1"></div>
    </div>
    <div class="row">
      <div class="col"><label>Saves per Game (Home)</label><input id="saveHome" type="number" step="0.1"></div>
      <div class="col"><label>Saves per Game (Away)</label><input id="saveAway" type="number" step="0.1"></div>
    </div>

    <div class="row" style="margin-top:6px">
      <div class="col"><label>Tackles Home</label><input id="tackleHome" type="number" step="0.1"></div>
      <div class="col"><label>Interceptions Home</label><input id="interHome" type="number" step="0.1"></div>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="col"><label>Tackles Away</label><input id="tackleAway" type="number" step="0.1"></div>
      <div class="col"><label>Interceptions Away</label><input id="interAway" type="number" step="0.1"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap">
      <button id="btnAutoTIHome" class="btn-ghost">Auto TI Home</button>
      <button id="btnAutoTIAway" class="btn-ghost">Auto TI Away</button>
      <button id="btnDSI" class="btn-ghost">Hitung DSI</button>
      <div class="small muted" style="align-self:center">TI = Tackles + Interceptions</div>
    </div>
    <div id="defNotes" class="small muted" style="margin-top:6px"></div>
  </div>

  <!-- Defensive Ratio (NEW) -->
  <div class="panel" id="defRatioPanel">
    <strong>Perbandingan Pertahanan — Defensive Ratio (Terintegrasi)</strong>
    <div class="small muted">Isi total kebobolan tim & jumlah laga, serta total kebobolan liga & total laga. Klik "Hitung Defensive Ratio".</div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>GA Tim (Home) — total kebobolan season</label><input id="gaTeamHome" type="number" step="1"></div>
      <div class="col"><label>Match Tim (Home)</label><input id="matchTeamHome" type="number" step="1" value="38"></div>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="col"><label>GA Tim (Away)</label><input id="gaTeamAway" type="number" step="1"></div>
      <div class="col"><label>Match Tim (Away)</label><input id="matchTeamAway" type="number" step="1" value="38"></div>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="col"><label>Total GA Liga (semua tim)</label><input id="gaLeague" type="number" step="1"></div>
      <div class="col"><label>Total Matches Liga (total)</label><input id="matchLeague" type="number" step="1"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnComputeDefRatio" class="btn-ghost">Hitung Defensive Ratio</button>
      <button id="btnApplyDefRatio" class="btn-ghost">Terapkan ke Model</button>
    </div>
    <div id="defRatioResult" style="margin-top:8px" class="small muted"></div>
  </div>

  <!-- Form, H2H, Absensi, ELO -->
  <div class="panel">
    <strong>Form, H2H, Absensi & ELO</strong>
    <label>Form 5 laga terakhir Home (W,D,L,...)</label><input id="formRawHome" type="text" placeholder="W,D,W,L,W">
    <label>Form 5 laga terakhir Away</label><input id="formRawAway" type="text" placeholder="W,D,L,W,L">
    <label>H2H (max 5 recent results Home vs Away) — kosong jika belum pernah</label><input id="h2hResults" type="text" placeholder="W,D,W">
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Absensi DF (Home) — jumlah posisi</label><input id="absDfHome" type="number" step="1"></div>
      <div class="col"><label>Absensi DF (Away)</label><input id="absDfAway" type="number" step="1"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>ELO Home</label><input id="eloHome" type="number" value="1500"></div>
      <div class="col"><label>ELO Away</label><input id="eloAway" type="number" value="1500"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <label style="margin:0"><input id="momentumToggle" type="checkbox"> Aktifkan Momentum (form weight)</label>
      <div class="small muted" style="margin-left:6px">Jika aktif, form 3 laga terakhir diberi bobot lebih</div>
    </div>
  </div>

  <!-- Stadium / Travel / Fatigue -->
  <div class="panel">
    <strong>Stadion, Koordinat & Travel</strong>
    <div class="small muted">Isi nama stadion (opsional) atau koordinat. Klik "Hitung Travel".</div>
    <label>Stadion Home (nama)</label><input id="stadiumHomeName" type="text">
    <label>Lat Home (decimal)</label><input id="latHome" type="number" step="0.000001">
    <label>Lon Home (decimal)</label><input id="lonHome" type="number" step="0.000001">
    <label>Stadion Away (nama)</label><input id="stadiumAwayName" type="text">
    <label>Lat Away (decimal)</label><input id="latAway" type="number" step="0.000001">
    <label>Lon Away (decimal)</label><input id="lonAway" type="number" step="0.000001">

    <div class="row" style="margin-top:8px;align-items:center">
      <div class="col"><label>Day Rest (hari)</label><input id="dayRest" type="number" step="1" value="3"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnCalcTravel" class="btn-ghost">Hitung Travel (Km)</button>
        <button id="btnSaveCoords" class="btn-ghost">Simpan Koordinat</button>
      </div>
      <div style="min-width:120px">
        <label>Travel Km</label><input id="travelKm" readonly type="text"></div>
    </div>
    <div id="coordMsg" class="small muted" style="margin-top:6px"></div>
  </div>

  <!-- Odds & Model Parameter -->
  <div class="panel">
    <strong>Odds & Parameter Model</strong>
    <div class="row">
      <div class="col"><label>HDP Line</label><input id="hdpLine" type="number" step="0.25" value="0.25"></div>
      <div class="col"><label>HDP Home (Open)</label><input id="hdpHomeOpen" type="number" step="0.01"></div>
      <div class="col"><label>HDP Home (Now)</label><input id="hdpHomeNow" type="number" step="0.01"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>HDP Away (Open)</label><input id="hdpAwayOpen" type="number" step="0.01"></div>
      <div class="col"><label>HDP Away (Now)</label><input id="hdpAwayNow" type="number" step="0.01"></div>
      <div class="col"><label>OU Line</label><input id="ouLine" type="number" step="0.25" value="2.5"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>OU Over (Open)</label><input id="ouOverOpen" type="number" step="0.01"></div>
      <div class="col"><label>OU Over (Now)</label><input id="ouOverNow" type="number" step="0.01"></div>
      <div class="col"><label>OU Under (Open)</label><input id="ouUnderOpen" type="number" step="0.01"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>OU Under (Now)</label><input id="ouUnderNow" type="number" step="0.01"></div>
      <div class="col"><label>MC Runs</label><input id="mcRuns" type="number" value="30000"></div>
      <div class="col"><label>ρ (rho)</label><input id="rho" type="number" step="0.01" value="0.12"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <button id="btnAnalyze" class="">Analisis</button>
      <button id="btnDetectTrap" class="btn-ghost">Detect Odds Trap</button>
      <button id="btnDownloadCSV" class="btn-ghost">Download CSV</button>
    </div>
  </div>

  <!-- Result -->
  <div class="panel">
    <strong>Hasil Analisis & Rekomendasi</strong>
    <div id="summary" class="result" style="margin-top:8px">Klik "Analisis" untuk menjalankan.</div>
    <div id="bestRec" style="margin-top:8px"></div>
    <div style="margin-top:8px;overflow:auto"><table id="trapTable"><tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Arah</th><th>Prob Model</th><th>Edge%</th><th>Status</th></tr></table></div>

    <div style="display:flex;gap:12px;margin-top:10px;align-items:center;flex-wrap:wrap">
      <canvas id="hist" width="520" height="140"></canvas>
      <canvas id="gauge" width="140" height="140"></canvas>
    </div>

    <div id="debug" class="result" style="margin-top:8px;background:#07121b"></div>
  </div>

  <p class="small muted">Tip: MC Runs 10k–60k. Jika komputer lambat, gunakan 10k–20k untuk uji cepat.</p>
</div>

<script>
/* ============================
   Utilities
   ============================ */
function safe(v,d=0){const x=parseFloat(v);return isNaN(x)?d:x;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function percent(v){return (100*v).toFixed(1)+'%'}
function toRad(d){return d*Math.PI/180}
function haversineKm(lat1,lon1,lat2,lon2){ const R=6371; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function poisson(lambda){ let L=Math.exp(-lambda),p=1,k=0; while(p>L){k++; p*=Math.random(); if(k>10000) break;} return k-1;}
function randNormal(mu=0,sigma=1){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return mu+sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}

/* ============================
   Mode (Liga / Cup)
   ============================ */
let MODE = 'LIGA'; // default
let MODE_PARAMS = { LIGA: {alpha:0.15, rho:0.12, mc:40000}, CUP: {alpha:0.24, rho:0.20, mc:80000} };
document.getElementById('btnLeague').addEventListener('click', ()=>{
  MODE='LIGA'; document.getElementById('btnLeague').classList.add('active'); document.getElementById('btnCup').classList.remove('active');
  const p=MODE_PARAMS.LIGA; document.getElementById('rho').value = p.rho; document.getElementById('mcRuns').value = p.mc;
});
document.getElementById('btnCup').addEventListener('click', ()=>{
  MODE='CUP'; document.getElementById('btnCup').classList.add('active'); document.getElementById('btnLeague').classList.remove('active');
  const p=MODE_PARAMS.CUP; document.getElementById('rho').value = p.rho; document.getElementById('mcRuns').value = p.mc;
});

/* ============================
   Coord & Travel
   ============================ */
document.getElementById('btnCalcTravel')?.addEventListener('click', ()=>{
  const latH = safe(document.getElementById('latHome').value, NaN);
  const lonH = safe(document.getElementById('lonHome').value, NaN);
  const latA = safe(document.getElementById('latAway').value, NaN);
  const lonA = safe(document.getElementById('lonAway').value, NaN);
  if(isNaN(latH) || isNaN(lonH) || isNaN(latA) || isNaN(lonA)){ alert('Isi koordinat Home & Away terlebih dahulu.'); return; }
  const km = haversineKm(latH,lonH,latA,lonA);
  document.getElementById('travelKm').value = km.toFixed(1);
  document.getElementById('coordMsg').textContent = 'Jarak dihitung: ' + km.toFixed(1) + ' km';
});
document.getElementById('btnSaveCoords')?.addEventListener('click', ()=>{
  const key = `coords__${(document.getElementById('teamHome').value||'home')}_vs_${(document.getElementById('teamAway').value||'away')}`;
  const payload = {
    stadiumHome: document.getElementById('stadiumHomeName').value||'',
    latHome: document.getElementById('latHome').value||'',
    lonHome: document.getElementById('lonHome').value||'',
    stadiumAway: document.getElementById('stadiumAwayName').value||'',
    latAway: document.getElementById('latAway').value||'',
    lonAway: document.getElementById('lonAway').value||''
  };
  try{ localStorage.setItem(key, JSON.stringify(payload)); document.getElementById('coordMsg').textContent='Koordinat tersimpan (lokal).'; }
  catch(e){ document.getElementById('coordMsg').textContent='Gagal simpan koordinat.'; }
});

/* ============================
   Auto calculators & example
   ============================ */
document.getElementById('btnAutoCR').addEventListener('click', ()=>{
  const gh = safe(document.getElementById('goalsHome').value, NaN);
  const sh = safe(document.getElementById('sotHome').value, NaN);
  const ga = safe(document.getElementById('goalsAway').value, NaN);
  const sa = safe(document.getElementById('sotAway').value, NaN);
  if(sh>0) alert('Conversion Rate Home ≈ ' + (gh/sh).toFixed(2)); else alert('SOT Home kosong');
  if(sa>0) alert('Conversion Rate Away ≈ ' + (ga/sa).toFixed(2)); else alert('SOT Away kosong');
});

document.getElementById('btnAutoShotIndex').addEventListener('click', ()=>{
  const s = safe(document.getElementById('shotsHome').value,10);
  const sot = safe(document.getElementById('sotHome').value,4);
  alert('Shot Index Home ≈ ' + ((0.6*sot + 0.4*(s/2)).toFixed(2)));
});
document.getElementById('btnAutoTempo').addEventListener('click', ()=>{
  const sH = safe(document.getElementById('shotsHome').value,10);
  const sA = safe(document.getElementById('shotsAway').value,10);
  alert('Tempo Index (est) ≈ ' + ((((sH+sA)/2)/12).toFixed(2)));
});
document.getElementById('btnAutoTIHome').addEventListener('click', ()=> {
  const t = safe(document.getElementById('tackleHome').value,0);
  const i = safe(document.getElementById('interHome').value,0);
  alert('TI Home = ' + (t+i).toFixed(1));
});
document.getElementById('btnAutoTIAway').addEventListener('click', ()=> {
  const t = safe(document.getElementById('tackleAway').value,0);
  const i = safe(document.getElementById('interAway').value,0);
  alert('TI Away = ' + (t+i).toFixed(1));
});
document.getElementById('btnFEI').addEventListener('click', ()=> {
  const xgH = safe(document.getElementById('xgHome').value,0);
  const gH = safe(document.getElementById('goalsHome').value,0);
  const xgA = safe(document.getElementById('xgAway').value,0);
  const gA = safe(document.getElementById('goalsAway').value,0);
  const feiH = xgH>0 ? (gH/xgH) : null;
  const feiA = xgA>0 ? (gA/xgA) : null;
  alert('FEI Home: ' + (feiH? feiH.toFixed(2):'N/A') + ' | FEI Away: ' + (feiA? feiA.toFixed(2):'N/A'));
});
document.getElementById('btnDSI').addEventListener('click', ()=>{

  const savesH = safe(document.getElementById('saveHome').value,0);

  const tacklesH = safe(document.getElementById('tackleHome').value,0);

  const interH = safe(document.getElementById('interHome').value,0);

  const shotsFacedH = safe(document.getElementById('shotsAway').value,10); // proxy

  const dsiH = (savesH + tacklesH + interH) / Math.max(1, shotsFacedH);

  alert('DSI Home ≈ ' + dsiH.toFixed(2));

});



/* Example fill */

document.getElementById('btnExample').addEventListener('click', ()=>{

  document.getElementById('teamHome').value='Atalanta';

  document.getElementById('teamAway').value='Lazio';

  document.getElementById('xgHome').value=1.35; document.getElementById('xgAway').value=1.12;

  document.getElementById('sotHome').value=5; document.getElementById('sotAway').value=4;

  document.getElementById('shotsHome').value=12; document.getElementById('shotsAway').value=9;

  document.getElementById('goalsHome').value=8; document.getElementById('goalsAway').value=6;

  document.getElementById('csHome').value=0.44; document.getElementById('csAway').value=0.30;

  document.getElementById('gcHome').value=0.9; document.getElementById('gcAway').value=1.3;

  document.getElementById('saveHome').value=3.4; document.getElementById('saveAway').value=3.1;

  document.getElementById('tackleHome').value=18; document.getElementById('interHome').value=8;

  document.getElementById('tackleAway').value=16; document.getElementById('interAway').value=6;

  document.getElementById('gaTeamHome').value=12; document.getElementById('matchTeamHome').value=8;

  document.getElementById('gaTeamAway').value=14; document.getElementById('matchTeamAway').value=8;

  document.getElementById('gaLeague').value=420; document.getElementById('matchLeague').value=380;

  document.getElementById('formRawHome').value='W,D,W,W,L'; document.getElementById('formRawAway').value='D,L,W,L,D'; document.getElementById('h2hResults').value='D,W,W';

  document.getElementById('eloHome').value=1720; document.getElementById('eloAway').value=1680;

  document.getElementById('stadiumHomeName').value="Stadio Atleti Azzurri d'Italia"; document.getElementById('latHome').value=45.743; document.getElementById('lonHome').value=9.666;

  document.getElementById('stadiumAwayName').value="Stadio Olimpico"; document.getElementById('latAway').value=41.929; document.getElementById('lonAway').value=12.454;

  document.getElementById('hdpLine').value=0.25; document.getElementById('ouLine').value=2.5;

  document.getElementById('ouOverOpen').value=1.95; document.getElementById('ouOverNow').value=1.88; document.getElementById('ouUnderOpen').value=1.90; document.getElementById('ouUnderNow').value=2.00;

  document.getElementById('hdpHomeOpen').value=1.95; document.getElementById('hdpHomeNow').value=1.88; document.getElementById('hdpAwayOpen').value=1.95; document.getElementById('hdpAwayNow').value=2.05;

  document.getElementById('mcRuns').value=20000; document.getElementById('rho').value=0.12;

  alert('Contoh otomatis terisi. Klik Analisis untuk menjalankan.');

});



/* ============================

   Defensive Ratio handlers

   ============================ */

function computeDefensiveRatioValues(){

  const gaH = safe(document.getElementById('gaTeamHome').value, NaN);

  const mH = safe(document.getElementById('matchTeamHome').value, NaN);

  const gaA = safe(document.getElementById('gaTeamAway').value, NaN);

  const mA = safe(document.getElementById('matchTeamAway').value, NaN);

  const gaL = safe(document.getElementById('gaLeague').value, NaN);

  const mL = safe(document.getElementById('matchLeague').value, NaN);

  if(!gaL || !mL){ alert('Isi GA Liga dan Match Liga untuk perhitungan ratio liga.'); return null; }

  const leagueGAperMatch = gaL / mL;

  const teamH_gaPerMatch = (Number.isFinite(gaH) && Number.isFinite(mH) && mH>0) ? (gaH / mH) : null;

  const teamA_gaPerMatch = (Number.isFinite(gaA) && Number.isFinite(mA) && mA>0) ? (gaA / mA) : null;

  const ratioH = teamH_gaPerMatch !== null ? (teamH_gaPerMatch / leagueGAperMatch) : null;

  const ratioA = teamA_gaPerMatch !== null ? (teamA_gaPerMatch / leagueGAperMatch) : null;

  return {leagueGAperMatch, teamH_gaPerMatch, teamA_gaPerMatch, ratioH, ratioA};

}

document.getElementById('btnComputeDefRatio').addEventListener('click', ()=>{

  const r = computeDefensiveRatioValues();

  if(!r) return;

  let txt='';

  if(r.ratioH!==null){

    const lbl = r.ratioH < 0.8 ? 'Kuat' : (r.ratioH > 1.2 ? 'Rapuh' : 'Normal');

    const cls = r.ratioH < 0.8 ? 'status-green' : (r.ratioH>1.2 ? 'status-red' : 'status-yellow');

    txt += `Home — GA/match: ${r.teamH_gaPerMatch.toFixed(2)} | League GA/match: ${r.leagueGAperMatch.toFixed(2)} → Ratio: ${r.ratioH.toFixed(2)} → `;

    txt += `<span class="${cls}">${lbl}</span><br>`;

  } else txt += 'Home — data tim tidak lengkap.<br>';

  if(r.ratioA!==null){

    const lbl2 = r.ratioA < 0.8 ? 'Kuat' : (r.ratioA > 1.2 ? 'Rapuh' : 'Normal');

    const cls2 = r.ratioA < 0.8 ? 'status-green' : (r.ratioA>1.2 ? 'status-red' : 'status-yellow');

    txt += `Away — GA/match: ${r.teamA_gaPerMatch.toFixed(2)} | League GA/match: ${r.leagueGAperMatch.toFixed(2)} → Ratio: ${r.ratioA.toFixed(2)} → `;

    txt += `<span class="${cls2}">${lbl2}</span>`;

  } else txt += 'Away — data tim tidak lengkap.';

  document.getElementById('defRatioResult').innerHTML = txt;

});

/* Apply to model: store into globals for apply during analyze */

let __defRatioApply = {h: null, a: null};

document.getElementById('btnApplyDefRatio').addEventListener('click', ()=>{

  const r = computeDefensiveRatioValues();

  if(!r){ alert('Hitung Defensive Ratio terlebih dahulu.'); return; }

  __defRatioApply.h = r.ratioH; __defRatioApply.a = r.ratioA;

  alert('Defensive Ratio diterapkan ke model (akan digunakan pada analisis berikutnya).');

});



/* ============================

   Model helpers (attack/def/FEI/DSI)

   ============================ */

function parseFormScore(raw){

  if(!raw) return 0.5;

  const parts = raw.toUpperCase().split(',').map(s=>s.trim()).filter(Boolean).slice(0,5);

  if(parts.length===0) return 0.5;

  const weights=[5,4,3,2,1];

  let s=0,tot=0;

  for(let i=0;i<parts.length;i++){

    const p=parts[i]; let v=0;

    if(p==='W') v=1; else if(p==='D') v=0.5; else v=0;

    s += v*weights[i]; tot += weights[i];

  }

  return s/tot;

}

function computeMomentum(formRaw){

  if(!formRaw) return 0;

  const p = formRaw.toUpperCase().replace(/[^WDL,]/g,'').split(',').filter(Boolean);

  if(p.length<2) return 0;

  const recent = p.slice(0,3).map(x=> x==='W'?1:(x==='D'?0.5:0));

  const weighted = recent.reduce((a,v,i)=> a + v*(3-i),0) / (3+2+1);

  return (weighted - 0.5) * 0.12;

}

function computeFinishingEfficiency(goals,xg){

  if(!xg || xg<=0) return 1.0;

  return goals / xg;

}

function computeDSI(saves,tackles,inter,shotsFaced){

  return (saves + tackles + inter) / Math.max(1, shotsFaced);

}

function computeAttackIndex(team, momentum=0, fatigue=0, fei=1){

  const base = 0.45 * (team.xg || 0.9) + 0.25*( (team.sot||4)/5 ) + 0.10*((team.shots||10)/10);

  let atk = base * fei;

  atk *= (1 + momentum);

  atk *= (1 - Math.min(0.35, fatigue*0.4));

  return Math.max(0.08, atk);

}

function computeDefenseIndex(team, dsi=1, ti=10, cs=0.3){

  const csAdj = 1 - (cs*0.4);

  const gcAdj = 1 + 0.22 * (team.gc || 1.2);

  const saveAdj = 1 - 0.06 * ((team.saves || 3.2)/5);

  const tiAdj = 1 - 0.05 * (ti/30);

  let val = csAdj * gcAdj * saveAdj * tiAdj * (1 + 0.04*(safe(team.err,7)/38));

  val *= (1 + 0.07*(dsi-1));

  return clamp(val, 0.45, 2.8);

}



/* adaptive bivariate sampling */

function sampleBivar(lambdaH,lambdaA,rho,sigmaFactor){

  const sigma = 0.12 + sigmaFactor*0.08; // reduced volatility to avoid over-extremes

  const z1 = randNormal(0,sigma); const z2 = rho*z1 + Math.sqrt(Math.max(0,1-rho*rho))*randNormal(0,sigma);

  const lamH = Math.max(0.01, lambdaH * Math.exp(z1 - 0.5*sigma*sigma));

  const lamA = Math.max(0.01, lambdaA * Math.exp(z2 - 0.5*sigma*sigma));

  return [poisson(lamH), poisson(lamA)];

}

function monteCarlo(lambdaH,lambdaA,rho,sigmaFactor,runs){

  const scoreFreq={}, totals={}; let h=0,d=0,a=0;

  for(let i=0;i<runs;i++){

    const [gh,ga] = sampleBivar(lambdaH,lambdaA,rho,sigmaFactor);

    const key = `${gh}-${ga}`; scoreFreq[key] = (scoreFreq[key]||0)+1; totals[gh+ga] = (totals[gh+ga]||0)+1;

    if(gh>ga) h++; else if(gh===ga) d++; else a++;

  }

  return {scoreFreq,totals,pHome:h/runs,pDraw:d/runs,pAway:a/runs};

}



/* OU and HDP helpers */

function computeOUFromTotals(totals,line,runs){

  let over=0,under=0,isInt=Number.isInteger(line);

  for(const k in totals){ const g=parseInt(k), v=totals[k];

    if(isInt){ if(g>line) over+=v; else if(g<line) under+=v; else {over+=0.5*v; under+=0.5*v;} }

    else { if(g>line) over+=v; else under+=v; }

  }

  return {over: over/runs, under: under/runs};

}

function probCoverFromScores(scoreFreq,handicap,runs){

  let win=0,push=0,lose=0;

  for(const sc in scoreFreq){ const v=scoreFreq[sc]; const [gh,ga] = sc.split('-').map(x=>parseInt(x)); const diff = gh - ga - handicap;

    if(diff>0) win+=v; else if(diff===0) push+=v; else lose+=v;

  }

  return (win + 0.5*push)/runs;

}

function impliedProb(odds){ if(!odds || odds<=0) return null; return 1/odds; }

function deltaPercent(open,now){ if(!open || !now) return null; return ((now-open)/open*100); }

function directionLabel(open,now,market){

  if(!open||!now) return '';

  const diff = now-open;

  if(market==='OU'){ if(diff< -0.03) return 'Uang → Over'; if(diff>0.03) return 'Uang → Under'; return 'Stabil'; }

  if(market==='HDP'){ if(diff< -0.03) return 'Uang → Home'; if(diff>0.03) return 'Uang → Away'; return 'Stabil'; }

  return '';

}

function statusFromDelta(d){ if(d===null) return {label:'N/A'}; const ad=Math.abs(d); if(ad>=15) return {label:'Trap'}; if(ad>=5) return {label:'Warning'}; return {label:'Stable'}; }



/* ============================

   Main analyze flow

   ============================ */

let lastCSV = null;

document.getElementById('btnAnalyze').addEventListener('click', ()=> {

  // read inputs

  const h = {

    xg: safe(document.getElementById('xgHome').value,1.0),

    sot: safe(document.getElementById('sotHome').value,4),

    shots: safe(document.getElementById('shotsHome').value,10),

    goals: safe(document.getElementById('goalsHome').value,0),

    cs: safe(document.getElementById('csHome').value,0.32),

    gc: safe(document.getElementById('gcHome').value,1.2),

    saves: safe(document.getElementById('saveHome').value,3.2),

    tackle: safe(document.getElementById('tackleHome').value,0),

    inter: safe(document.getElementById('interHome').value,0),

    ti: (safe(document.getElementById('tackleHome').value,0) + safe(document.getElementById('interHome').value,0)),

    err: safe(document.getElementById('errHome')?document.getElementById('errHome').value:0,7),

    formRaw: document.getElementById('formRawHome').value||'',

    absDf: safe(document.getElementById('absDfHome').value,0),

    elo: safe(document.getElementById('eloHome').value,1500)

  };

  const a = {

    xg: safe(document.getElementById('xgAway').value,0.95),

    sot: safe(document.getElementById('sotAway').value,3),

    shots: safe(document.getElementById('shotsAway').value,9),

    goals: safe(document.getElementById('goalsAway').value,0),

    cs: safe(document.getElementById('csAway').value,0.28),

    gc: safe(document.getElementById('gcAway').value,1.3),

    saves: safe(document.getElementById('saveAway').value,3.2),

    tackle: safe(document.getElementById('tackleAway').value,0),

    inter: safe(document.getElementById('interAway').value,0),

    ti: (safe(document.getElementById('tackleAway').value,0) + safe(document.getElementById('interAway').value,0)),

    err: safe(document.getElementById('errAway')?document.getElementById('errAway').value:0,8),

    formRaw: document.getElementById('formRawAway')?document.getElementById('formRawAway').value:'',

    absDf: safe(document.getElementById('absDfAway').value,0),

    elo: safe(document.getElementById('eloAway').value,1500)

  };



  // derived

  const travelKm = safe(document.getElementById('travelKm').value,0);

  const dayRest = safe(document.getElementById('dayRest').value,3);

  const tempoIndex = (((h.shots||10)+(a.shots||10))/2)/12;

  const momentumOn = document.getElementById('momentumToggle').checked;

  const momH = momentumOn ? computeMomentum(h.formRaw) : 0;

  const momA = momentumOn ? computeMomentum(a.formRaw) : 0;



  // FEI & DSI

  const feiH = computeFinishingEfficiency(h.goals,h.xg);

  const feiA = computeFinishingEfficiency(a.goals,a.xg);

  const dsiH = computeDSI(h.saves,h.tackle,h.inter,a.shots);

  const dsiA = computeDSI(a.saves,a.tackle,a.inter,h.shots);



  // fatigue

  const fatigueH = (travelKm && travelKm>1) ? clamp((travelKm/900) + Math.max(0,3-dayRest)/3,0,1) : 0;

  const fatigueA = fatigueH;



  // attack / defense indices

  const atkH = computeAttackIndex(h, momH, fatigueH, feiH);

  const atkA = computeAttackIndex(a, momA, fatigueA, feiA);



  // defense indices, include defensive ratio adjustment if applied

  const baseDefH = computeDefenseIndex(h, dsiH, h.ti, h.cs);

  const baseDefA = computeDefenseIndex(a, dsiA, a.ti, a.cs);

  let defH = baseDefH, defA = baseDefA;

  if(__defRatioApply.h !== null){

    if(__defRatioApply.h < 0.8) defH *= 0.92; else if(__defRatioApply.h > 1.2) defH *= 1.08;

  }

  if(__defRatioApply.a !== null){

    if(__defRatioApply.a < 0.8) defA *= 0.92; else if(__defRatioApply.a > 1.2) defA *= 1.08;

  }

  defH = clamp(defH,0.45,2.8); defA = clamp(defA,0.45,2.8);



  // league avg baseline

  const leagueAvg = Math.max(0.5, (h.xg + a.xg)/2);



  // elo scale

  const sfH = clamp(1 + (h.elo - a.elo)/1400,0.75,1.25);

  const sfA = clamp(1 + (a.elo - h.elo)/1400,0.75,1.25);



  // lambdas (raw)

  let lamH = leagueAvg * (atkH / Math.max(0.3, leagueAvg)) * (1/defA) * sfH;

  let lamA = leagueAvg * (atkA / Math.max(0.3, leagueAvg)) * (1/defH) * sfA;



  // adjust by errors & penalty conceded (small)

  lamH *= (1 - 0.02*(h.err/38));

  lamA *= (1 - 0.02*(a.err/38));



  // stronger shrink toward xG baseline to avoid over-weighting dynamic factors

  lamH = 0.65*lamH + 0.35*h.xg;

  lamA = 0.65*lamA + 0.35*a.xg;



  // defense suppression if both defenses strong

  const defenseFactor = clamp(((defH + defA)/2 - 1.0) * 0.10, -0.08, 0.20);

  if(defenseFactor > 0){

    lamH *= (1 - defenseFactor);

    lamA *= (1 - defenseFactor);

  }



  // cap per-team lambda (avoid extreme over predictions)

  lamH = Math.max(0.12, Math.min(lamH, 2.4));

  lamA = Math.max(0.12, Math.min(lamA, 2.4));



  // rho adaptive

  let rhoBase = clamp(safe(document.getElementById('rho').value,0.12), -0.5, 0.8);

  const tempoDelta = Math.abs(h.shots - a.shots) / Math.max(1, h.shots + a.shots);

  let rhoAdaptive = clamp(rhoBase + (1 - Math.abs(tempoIndex - 1.0))*0.03 - (Math.abs((fatigueH+fatigueA)/2)/2)*0.01, -0.3, 0.6);



  // sigma factor

  const formSpread = Math.abs(momH - momA);

  const xgSpread = Math.abs(h.xg - a.xg);

  const sigmaFactor = clamp((formSpread + xgSpread)/4, 0, 1);



  // Monte Carlo runs

  const runs = Math.max(1000, safe(document.getElementById('mcRuns').value,20000));

  const mc = monteCarlo(lamH, lamA, rhoAdaptive, sigmaFactor, runs);



  // aggregations & outputs

  const sorted = Object.entries(mc.scoreFreq).sort((a,b)=>b[1]-a[1]);

  const top = sorted.slice(0,6).map(([sc,v])=>`${sc} (${(100*v/runs).toFixed(1)}%)`).join(', ');

  const avgH = (Object.entries(mc.scoreFreq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[0])*v,0)/runs).toFixed(2);

  const avgA = (Object.entries(mc.scoreFreq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[1])*v,0)/runs).toFixed(2);



  // OU & HDP

  const ouLine = safe(document.getElementById('ouLine').value,2.5);

  const ouProb = computeOUFromTotals(mc.totals, ouLine, runs);

  const hdpLine = safe(document.getElementById('hdpLine').value,0.25);

  const coverHome = probCoverFromScores(mc.scoreFreq, hdpLine, runs);

  const coverAway = probCoverFromScores(mc.scoreFreq, -hdpLine, runs);



  // implied and edges

  const implied = {

    ouOver: impliedProb(safe(document.getElementById('ouOverNow').value,NaN)),

    ouUnder: impliedProb(safe(document.getElementById('ouUnderNow').value,NaN)),

    hdpHome: impliedProb(safe(document.getElementById('hdpHomeNow').value,NaN)),

    hdpAway: impliedProb(safe(document.getElementById('hdpAwayNow').value,NaN))

  };

  const edges = {

    ouOver: (implied.ouOver ? ouProb.over - implied.ouOver : null),

    ouUnder: (implied.ouUnder ? ouProb.under - implied.ouUnder : null),

    hdpHome: (implied.hdpHome ? coverHome - implied.hdpHome : null),

    hdpAway: (implied.hdpAway ? coverAway - implied.hdpAway : null)

  };



  const candidates = [

    {tag:`OU Over ${ouLine}`, prob:ouProb.over, edge:edges.ouOver, market:'OU', open:safe(document.getElementById('ouOverOpen').value,NaN), now:safe(document.getElementById('ouOverNow').value,NaN)},

    {tag:`OU Under ${ouLine}`, prob:ouProb.under, edge:edges.ouUnder, market:'OU', open:safe(document.getElementById('ouUnderOpen').value,NaN), now:safe(document.getElementById('ouUnderNow').value,NaN)},

    {tag:`HDP Home ${hdpLine}`, prob:coverHome, edge:edges.hdpHome, market:'HDP', open:safe(document.getElementById('hdpHomeOpen').value,NaN), now:safe(document.getElementById('hdpHomeNow').value,NaN)},

    {tag:`HDP Away ${-hdpLine}`, prob:coverAway, edge:edges.hdpAway, market:'HDP', open:safe(document.getElementById('hdpAwayOpen').value,NaN), now:safe(document.getElementById('hdpAwayNow').value,NaN)}

  ];

  candidates.forEach(c=>{ c.edgeShr = (c.edge===null? null: clamp(c.edge,-0.22,0.22)); c.score = ((c.edgeShr||0)*(c.prob||0)) + ((c.prob||0)*0.62); c.delta = deltaPercent(c.open,c.now); c.direction = directionLabel(c.open,c.now,c.market); c.status = statusFromDelta(c.delta); });

  candidates.sort((a,b)=>b.score-a.score);



  const selected = candidates.slice(0,2).map(c=>{

    let signal='Low';

    if(c.prob>=0.58 && c.edgeShr!==null && c.edgeShr>=0.015) signal='High';

    else if(c.prob>=0.54 && c.edgeShr!==null && c.edgeShr>=0.01) signal='Medium';

    return {...c,signal};

  });



  // xPTS calculation

  const pHome = mc.pHome, pDraw = mc.pDraw, pAway = mc.pAway;

  const xptsHome = 3*pHome + 1*pDraw;

  const xptsAway = 3*pAway + 1*pDraw;

  const xptsDiff = xptsHome - xptsAway;



  // confidence (variance-based)

  let mean=0,count=0,varv=0;

  for(const t in mc.totals){ mean += parseInt(t)*mc.totals[t]; count += mc.totals[t]; }

  if(count>0){ mean /= count; for(const t in mc.totals){ varv += ((parseInt(t)-mean)**2)*mc.totals[t]; } varv /= count; }

  let conf = clamp(1 - Math.min(1,varv/8),0.15,0.97);

  const confLabel = conf>0.8? 'Tinggi' : (conf>0.55? 'Sedang' : 'Rendah');



  // Summary text

  let summary = `Top skor: ${top}\nλ Home=${lamH.toFixed(2)} | λ Away=${lamA.toFixed(2)}\nExp Goals (sim): H ${avgH} | A ${avgA}\nProb 1X2 — Home ${(100*pHome).toFixed(1)}% Draw ${(100*pDraw).toFixed(1)}% Away ${(100*pAway).toFixed(1)}%\nOU (Line ${ouLine}) → Over ${percent(ouProb.over)} | Under ${percent(ouProb.under)}\nHDP (Line ${hdpLine}) → Home ${percent(coverHome)} | Away ${percent(coverAway)}\nFEI H:${feiH?feiH.toFixed(2):'N/A'} A:${feiA?feiA.toFixed(2):'N/A'} | DSI H:${dsiH.toFixed(2)} A:${dsiA.toFixed(2)}\nxPTS H:${xptsHome.toFixed(2)} A:${xptsAway.toFixed(2)} | xPTS diff:${xptsDiff.toFixed(2)}\nMomentum H:${(momH*100).toFixed(1)}% A:${(momA*100).toFixed(1)}% | Fatigue:${(fatigueH*100).toFixed(1)}% | Confidence:${confLabel} (${(conf*100).toFixed(1)}%)`;

  document.getElementById('summary').textContent = summary;



  // recommendations

  let recHtml='';

  selected.forEach(s=>{

    recHtml += `<div class="card"><div style="text-align:left"><strong>${s.tag}</strong><div class="small">${s.direction} • Δ ${s.delta? s.delta.toFixed(1):''}%</div></div><div style="text-align:right"><div style="font-weight:700">${percent(s.prob)}</div><div class="small">${s.edgeShr!==null?((s.edgeShr*100).toFixed(2)+'% edge'):'No odds'}</div><div style="margin-top:6px">${s.signal}</div></div></div>`;

  });

  document.getElementById('bestRec').innerHTML = recHtml || '<div class="small muted">Tidak ada rekomendasi kuat</div>';



  // trap table

  let table = '<tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Arah</th><th>Prob Model</th><th>Edge%</th><th>Status</th></tr>';

  candidates.forEach(c=>{

    const delta = c.delta===null?'':c.delta.toFixed(1)+'%';

    const edgeTxt = c.edgeShr===null?'-':((c.edgeShr*100).toFixed(2)+'%');

    table += `<tr><td>${c.tag}</td><td>${c.open||''}</td><td>${c.now||''}</td><td>${delta}</td><td>${c.direction}</td><td>${percent(c.prob)}</td><td>${edgeTxt}</td><td>${c.status.label}</td></tr>`;

  });

  document.getElementById('trapTable').innerHTML = table;



  // histogram

  const ctx = document.getElementById('hist').getContext('2d'); ctx.clearRect(0,0,520,140);

  const keys = Object.keys(mc.totals).map(x=>parseInt(x)).sort((a,b)=>a-b);

  const maxV = Math.max(1, ...keys.map(k=>mc.totals[k]||0));

  const margin = 10, totalW = 500, w = Math.max(18, (totalW-margin)/Math.max(1,keys.length));

  keys.forEach((k,i)=>{ const hgt = (mc.totals[k]/maxV)*110; ctx.fillStyle = '#0b74de'; ctx.fillRect(margin + i*w, 120 - hgt, w-6, hgt); ctx.fillStyle='#9fb3c5'; ctx.font='10px Arial'; ctx.fillText(String(k), margin + i*w, 136); });



  // gauge

  const gctx = document.getElementById('gauge').getContext('2d'); gctx.clearRect(0,0,140,140);

  gctx.beginPath(); gctx.lineWidth=12; gctx.strokeStyle='#12343f'; gctx.arc(70,70,50,Math.PI,2*Math.PI); gctx.stroke();

  const angle = Math.PI + (Math.PI * conf); gctx.beginPath(); gctx.lineWidth=12; gctx.strokeStyle= conf>0.8? '#2ecc71' : (conf>0.55? '#f1c40f' : '#e74c3c'); gctx.arc(70,70,50,Math.PI, angle); gctx.stroke();

  gctx.font='12px Arial'; gctx.fillStyle='#cfe9ff'; gctx.fillText(confLabel + ' (' + (conf*100).toFixed(0) + '%)', 10, 70);



  // debug

  document.getElementById('debug').textContent = `MODE:${MODE} Runs:${runs} ρ:${rhoAdaptive.toFixed(3)} | lamH:${lamH.toFixed(2)} lamA:${lamA.toFixed(2)} | TravelKm:${travelKm}`;



  // prepare CSV

  lastCSV = [];

  for(const sc in mc.scoreFreq){ lastCSV.push({score:sc,count:mc.scoreFreq[sc],prob:(mc.scoreFreq[sc]/runs)}); }

});



/* ============================

   Detect Trap / Download CSV / Reset

   ============================ */

document.getElementById('btnDetectTrap').addEventListener('click', ()=>{ document.getElementById('btnAnalyze').click(); alert('Deteksi Trap selesai — periksa tabel.'); });



document.getElementById('btnDownloadCSV').addEventListener('click', ()=>{

  if(!lastCSV || lastCSV.length===0){ alert('Jalankan Analisis terlebih dahulu.'); return; }

  const fn = `${(document.getElementById('teamHome').value||'home')}_vs_${(document.getElementById('teamAway').value||'away')}_mc.csv`.replace(/\s+/g,'_');

  let csv = 'score,count,prob\n'; lastCSV.forEach(r=> csv += `${r.score},${r.count},${r.prob}\n`);

  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=fn; a.click(); URL.revokeObjectURL(url);

});



document.getElementById('btnResetAll').addEventListener('click', ()=>{

  document.querySelectorAll('input,textarea').forEach(i=>{ if(i.type!=='button') i.value=''; if(i.type==='checkbox') i.checked=false; });

  document.getElementById('summary').textContent='Direset.'; document.getElementById('bestRec').innerHTML=''; document.getElementById('trapTable').innerHTML = '<tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Arah</th><th>Prob Model</th><th>Edge%</th><th>Status</th></tr>';

  const ctx=document.getElementById('hist').getContext('2d'); ctx.clearRect(0,0,520,140); const gctx=document.getElementById('gauge').getContext('2d'); gctx.clearRect(0,0,140,140);

  lastCSV = null; __defRatioApply = {h:null,a:null};

});



/* ============================

   Sanity check on load

   ============================ */

window.addEventListener('load', ()=>{

  ['btnAnalyze','btnDownloadCSV','btnResetAll','btnExample','btnAutoCR'].forEach(id=>{ if(!document.getElementById(id)) console.warn('Element missing:', id); });

});

</script>

</body>

</html>
