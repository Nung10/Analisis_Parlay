<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Prediksi â€” Ultra Sharp v33 (Visual Precision)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:#071026;color:#eaf6ff;margin:18px}
    h1{font-size:20px;margin:6px 0}
    .grid{display:grid;grid-template-columns:1fr 480px;gap:14px}
    .block{padding:12px;border-radius:10px;border:1px solid #123444;background:#071a29}
    label{display:block;font-size:13px;margin:6px 0;color:#cfe8ff}
    input[type="number"],input[type="text"]{width:100%;padding:8px;border:1px solid #1f4254;border-radius:6px;background:#05121a;color:#eaf6ff}
    button{padding:8px 12px;border-radius:8px;border:0;background:#06b6d4;color:#021825;cursor:pointer;margin-right:6px}
    pre.result{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#031428;padding:12px;border-radius:8px;border:1px dashed #1b6b86;color:#dff7ff}
    .card{background:#042033;border:1px solid #165a7a;border-radius:8px;padding:10px;margin-top:8px;color:#dff7ff}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:7px;border-bottom:1px solid #0b2f42;text-align:center;font-size:13px;color:#d8f7ff}
    th{background:#052a3a}
    .small{font-size:12px;color:#9fd6ee}
    .muted{color:#88bcd3;font-size:12px}
    .visuals {margin-top:8px}
    canvas {background:#02121a;border-radius:6px;border:1px solid #123b4b}
  </style>
</head>
<body>
  <h1>âš½ Prediksi â€” Ultra Sharp v33 (Visual Precision)</h1>
  <p class="small">v33: Precision++ core + Histogram MC + Confidence Gauge (visual).</p>

  <div class="grid">
    <div class="block">
      <h3>Input Data (isi sebanyak mungkin)</h3>
      <label>Home Team: <input id="teamHome" type="text" value="Home FC"></label>
      <label>Away Team: <input id="teamAway" type="text" value="Away FC"></label>

      <label>xG: <input id="xgHome" type="number" step="0.01"> <input id="xgAway" type="number" step="0.01"></label>
      <label>SOT (shots on target): <input id="sotHome" type="number" step="0.1"> <input id="sotAway" type="number" step="0.1"></label>
      <label>Total Shots (optional): <input id="shotsHome" type="number" step="0.1"> <input id="shotsAway" type="number" step="0.1"></label>
      <label>Goals (avg recent): <input id="goalsHome" type="number"> <input id="goalsAway" type="number"></label>

      <label>Conversion Rate (0-1): <input id="convHome" type="number" step="0.01"> <input id="convAway" type="number" step="0.01"></label>
      <button id="btnAutoCR">Hitung CR Otomatis</button>

      <label>Big Chances: <input id="bigHome" type="number" step="0.1"> <input id="bigAway" type="number" step="0.1"></label>
      <label>Missed Big Chances: <input id="missHome" type="number" step="0.1"> <input id="missAway" type="number" step="0.1"></label>

      <label>Possession %: <input id="possHome" type="number" step="0.1"> <input id="possAway" type="number" step="0.1"></label>

      <h4>Defending</h4>
      <label>Tackles: <input id="tackleHome" type="number" step="0.1"> <input id="tackleAway" type="number" step="0.1"></label>
      <label>Interceptions: <input id="interHome" type="number" step="0.1"> <input id="interAway" type="number" step="0.1"></label>
      <label>Tackles + Interceptions: <input id="tiHome" type="number" readonly> <input id="tiAway" type="number" readonly></label>

      <label>Clean Sheet / game: <input id="csHome" type="number" step="0.01"> <input id="csAway" type="number" step="0.01"></label>
      <label>Goals Conceded / game: <input id="gcHome" type="number" step="0.1"> <input id="gcAway" type="number" step="0.1"></label>
      <label>Saves / game: <input id="saveHome" type="number" step="0.1"> <input id="saveAway" type="number" step="0.1"></label>
      <label>Errors leading to goal (est/season): <input id="errHome" type="number" step="0.1"> <input id="errAway" type="number" step="0.1"></label>

      <h4>Absensi (jumlah pemain per posisi)</h4>
      <label>DF abs <input id="absDfHome" type="number"> <input id="absDfAway" type="number"></label>
      <label>MF abs <input id="absMfHome" type="number"> <input id="absMfAway" type="number"></label>
      <label>FW abs <input id="absFwHome" type="number"> <input id="absFwAway" type="number"></label>

      <h4>Form / H2H / ELO</h4>
      <label>Form 5 (W,D,L comma): <input id="formRawHome" type="text" placeholder="W,W,D,W,L"> <input id="formRawAway" type="text"></label>
      <label>H2H (single field up to 5): <input id="h2hResults" type="text" placeholder="W,D,L,W"></label>
      <label>ELO Home / Away: <input id="eloHome" type="number" value="1500"> <input id="eloAway" type="number" value="1480"></label>

      <h4>Odds & Market</h4>
      <label>HDP Line <input id="hdpLine" type="number" step="0.25" value="0.25"></label>
      <label>HDP Home Open / Now <input id="hdpHomeOpen" type="number" step="0.01"> <input id="hdpHomeNow" type="number" step="0.01"></label>
      <label>HDP Away Open / Now <input id="hdpAwayOpen" type="number" step="0.01"> <input id="hdpAwayNow" type="number" step="0.01"></label>

      <label>O/U Line <input id="ouLine" type="number" step="0.25" value="2.5"></label>
      <label>Over Open / Now <input id="ouOverOpen" type="number" step="0.01"> <input id="ouOverNow" type="number" step="0.01"></label>
      <label>Under Open / Now <input id="ouUnderOpen" type="number" step="0.01"> <input id="ouUnderNow" type="number" step="0.01"></label>

      <h4>Run settings</h4>
      <label>Monte Carlo runs (default 20000): <input id="mcRuns" type="number" value="20000"></label>

      <div style="margin-top:10px">
        <button id="btnExample">Isi Contoh</button>
        <button id="btnAnalyze">Analisis Ultra Sharp v33</button>
        <button id="btnReset">Reset</button>
      </div>
      <p class="muted">Tip: isi xG, SOT, CS, GC, dan saves untuk prediksi paling tajam.</p>
    </div>

    <div class="block">
      <h3>Ringkasan & Rekomendasi</h3>
      <pre id="summary" class="result">Klik "Analisis Ultra Sharp v33" untuk hasil...</pre>

      <h3>Rekomendasi Terbaik</h3>
      <div id="bestRec" class="card">Hasil rekomendasi akan tampil di sini.</div>

      <h3>Trap / Market Table</h3>
      <table id="trapTable">
        <tr><th>Pasar</th><th>Prob</th><th>Edge%</th><th>Status</th></tr>
      </table>

      <div class="visuals">
        <h3>ðŸ“‰ Distribusi Skor (Monte Carlo)</h3>
        <canvas id="histMC" width="440" height="140"></canvas>

        <h3>ðŸ§  Confidence Meter</h3>
        <canvas id="confGauge" width="220" height="120"></canvas>
      </div>
    </div>
  </div>

<!-- SCRIPTS: utils, preprocess, model, mc, market, ui -->
<script>
/* ======= UTILS ======= */
function safe(v,d=0){ const x=parseFloat(v); return isNaN(x)?d:x; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function randNormal(mu=0,sigma=1){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return mu + sigma * Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v); }
function poisson(lambda){ let L=Math.exp(-lambda), k=0, p=1; while(p> L){ k++; p *= Math.random(); if(k>2000) break; } return Math.max(0, k-1); }
function percent(x){ return (100*x).toFixed(1) + '%'; }
</script>

<script>
/* ======= PREPROCESS ======= */
// Auto TI
function autoTI(){ tiHome.value = (safe(tackleHome.value)+safe(interHome.value)).toFixed(1); tiAway.value = (safe(tackleAway.value)+safe(interAway.value)).toFixed(1); }
['tackleHome','interHome','tackleAway','interAway'].forEach(id => document.getElementById(id).addEventListener('input', autoTI));
// Auto CR
function autoCR(){ const gh=safe(goalsHome.value,NaN), sh=safe(sotHome.value,NaN); const ga=safe(goalsAway.value,NaN), sa=safe(sotAway.value,NaN); if(sh>0) convHome.value = (gh/sh).toFixed(2); if(sa>0) convAway.value = (ga/sa).toFixed(2); alert('Conversion Rate otomatis diisi (Goals Ã· SOT).'); }
// Form parser
function formScoreFromRaw(raw){ if(!raw) return 0.5; const parts = raw.toUpperCase().split(',').map(s=>s.trim()).filter(Boolean).slice(0,5); const weights = [0.35,0.25,0.2,0.12,0.08]; let score=0, tot=0; for(let i=0;i<parts.length;i++){ const p=parts[i]; let val=0; if(p==='W') val=1; else if(p==='D') val=0.5; score += val*weights[i]; tot += weights[i]; } return tot?score/tot:0.5; }
</script>

<script>
/* ======= MODEL ======= */
const LEAGUE_PRIOR = 1.25;
const LEAGUE_SAVES = 3.5;
const HOME_ADV_DEFAULT = 1.06;

function shotQuality(team){ if(team.shots && team.shots>0) return clamp(team.sot / team.shots, 0.05, 0.95); return 0.45; }

function computeAttackSharp(team){
  const sq = shotQuality(team);
  let base = 0.50 * safe(team.xg,0) + 0.18 * (safe(team.sot,0)/5) + 0.14 * (safe(team.conv,0)*100) + 0.08 * (team.form||0.5) + 0.05*(safe(team.poss,50)/100);
  const bigEffect = 1 + (Math.max(0, safe(team.big,0) - safe(team.miss,0)) * 0.055);
  const qualityAdj = 1 + (sq - 0.45) * 0.6;
  const gkAdj = 1 - 0.06 * ((safe(team.saves, LEAGUE_SAVES) - LEAGUE_SAVES)/Math.max(1, LEAGUE_SAVES));
  const attack = clamp(base * bigEffect * qualityAdj * gkAdj, 0.06, 8.0);
  return { attack, shotQuality: sq };
}

function computeDefenseSharp(team){
  const tiNorm = clamp(safe(team.ti,0) / 28, 0, 1.8);
  const savesNorm = Math.log(1 + Math.max(0, safe(team.saves,0))) / Math.log(1+6);
  const errAdj = 1 + safe(team.err,7) / 40;
  let val = 1 + 0.32 * Math.log(Math.max(1, safe(team.gc,0)) + 1) - 0.30 * (safe(team.cs,0)) - 0.14 * tiNorm + 0.09 * errAdj - 0.12 * savesNorm;
  val = val * (1 + 0.02 * (safe(team.absDf,0)));
  return clamp(val, 0.30, 4.0);
}

function computeLambdasSharp(h,a){
  const H = computeAttackSharp(h), A = computeAttackSharp(a);
  const defH = computeDefenseSharp(h), defA = computeDefenseSharp(a);
  const eloFactorH = clamp(1 + (safe(h.elo,1500) - safe(a.elo,1480)) / 2400, 0.78, 1.22);
  const eloFactorA = clamp(1 + (safe(a.elo,1480) - safe(h.elo,1500)) / 2400, 0.78, 1.22);
  const homeAdv = HOME_ADV_DEFAULT * (1 + (clamp((safe(h.elo,1500)-safe(a.elo,1480))/8000, -0.02, 0.02)));
  let rawH = ((safe(h.xg, LEAGUE_PRIOR) + (safe(h.sot,0)/6)) / 2) * (H.attack / Math.max(0.45, defA)) * eloFactorH * homeAdv;
  let rawA = ((safe(a.xg, LEAGUE_PRIOR) + (safe(a.sot,0)/6)) / 2) * (A.attack / Math.max(0.45, defH)) * eloFactorA;
  rawH *= (1 - 0.05*(safe(h.absDf,0)) - 0.035*(safe(h.absMf,0)) - 0.06*(safe(h.absFw,0)));
  rawA *= (1 - 0.05*(safe(a.absDf,0)) - 0.035*(safe(a.absMf,0)) - 0.06*(safe(a.absFw,0)));
  const h2hRaw = (h2hResults.value||'').toUpperCase().replace(/[^WDL]/g,'').slice(0,5);
  const h2hScore = h2hRaw ? ((h2hRaw.match(/W/g)||[]).length - (h2hRaw.match(/L/g)||[]).length)/Math.max(1,h2hRaw.length) : 0;
  const momentum = 0.14*(h.form - a.form) + 0.06*h2hScore;
  rawH *= (1 + momentum); rawA *= (1 - momentum);
  let quality = 0; [h.xg,a.xg,h.sot,a.sot,h.cs,a.cs].forEach(v => { if(v && v>0) quality += 1; }); quality = quality/6;
  const shrinkW = clamp(0.55 + 0.4 * quality, 0.45, 0.95);
  let lambdaH = shrinkW * rawH + (1 - shrinkW) * LEAGUE_PRIOR;
  let lambdaA = shrinkW * rawA + (1 - shrinkW) * LEAGUE_PRIOR;
  const avg = (lambdaH + lambdaA) / 2;
  if(avg > 3.5){ lambdaH *= 0.86; lambdaA *= 0.86; } else if(avg > 2.4){ lambdaH *= 0.94; lambdaA *= 0.94; }
  lambdaH *= 0.995; lambdaA *= 0.995;
  return { lambdaH: Math.max(0.01, lambdaH), lambdaA: Math.max(0.01, lambdaA), atkH: H.attack, atkA: A.attack, defH, defA, shotQualityH: H.shotQuality, shotQualityA: A.shotQuality };
}
</script>

<script>
/* ======= MONTE CARLO & VISUALS ======= */
function samplePoissonLognormal(lambdaH, lambdaA, rho, sigma){
  const z1 = randNormal(0, sigma);
  const z2 = rho * z1 + Math.sqrt(Math.max(0,1-rho*rho)) * randNormal(0, sigma);
  const lH = Math.max(0.01, lambdaH * Math.exp(z1 - 0.5 * sigma*sigma));
  const lA = Math.max(0.01, lambdaA * Math.exp(z2 - 0.5 * sigma*sigma));
  return [poisson(lH), poisson(lA)];
}

function monteCarloSharp(lambdaH, lambdaA, rho, sigmaFactor, volFactor, runs){
  const freq = {}, totals = {}; let homeWins=0, draws=0, awayWins=0;
  const sigma = clamp(0.12 + sigmaFactor*0.28 + volFactor*0.12, 0.06, 1.2);
  for(let i=0;i<runs;i++){
    const [gh,ga] = samplePoissonLognormal(lambdaH, lambdaA, rho, sigma);
    const k = `${gh}-${ga}`;
    freq[k] = (freq[k]||0) + 1;
    totals[gh+ga] = (totals[gh+ga]||0) + 1;
    if(gh>ga) homeWins++; else if(gh===ga) draws++; else awayWins++;
  }
  return { freq, totals, pHome: homeWins/runs, pDraw: draws/runs, pAway: awayWins/runs };
}

// draw histogram of total goals distribution (color by OU line)
function drawHistogram(mcTotals, ouLine){
  const canvas = document.getElementById('histMC');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const keys = Object.keys(mcTotals).map(x=>parseInt(x)).sort((a,b)=>a-b);
  if(keys.length===0) return;
  const maxV = Math.max(...keys.map(k=>mcTotals[k]||0),1);
  const padding = 20;
  const w = (canvas.width - padding*2) / Math.max(1, keys.length);
  keys.forEach((k,i)=>{
    const v = mcTotals[k] || 0;
    const barH = (v / maxV) * (canvas.height - 50);
    ctx.fillStyle = (k <= ouLine) ? '#3fa34d' : '#de3f3f';
    ctx.fillRect(padding + i*w, canvas.height - 30 - barH, Math.max(6, w-6), barH);
    ctx.fillStyle = '#9fd6ee';
    ctx.font = '11px Arial';
    ctx.fillText(String(k), padding + i*w, canvas.height - 10);
  });
}

// draw confidence gauge semicircle
function drawGauge(conf){
  const canvas = document.getElementById('confGauge');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const centerX = canvas.width/2;
  const centerY = canvas.height*0.85;
  const radius = Math.min(canvas.width, canvas.height) * 0.35;
  ctx.beginPath();
  ctx.lineWidth = 14;
  ctx.strokeStyle = '#082733';
  ctx.arc(centerX, centerY, radius, Math.PI, 2*Math.PI, false);
  ctx.stroke();
  const val = clamp(conf.score, 0, 1);
  const endAngle = Math.PI + val * Math.PI;
  ctx.beginPath();
  ctx.lineWidth = 14;
  ctx.strokeStyle = val>0.8 ? '#2dd36f' : (val>0.55? '#f7b731' : '#eb3b5a');
  ctx.arc(centerX, centerY, radius, Math.PI, endAngle, false);
  ctx.stroke();
  ctx.font = '16px Arial';
  ctx.fillStyle = '#cfe8ff';
  ctx.textAlign = 'center';
  ctx.fillText((val*100).toFixed(1)+'%', centerX, centerY - radius - 6);
  ctx.font = '12px Arial';
  ctx.fillText(conf.label, centerX, centerY - radius + 12);
}
</script>

<script>
/* ======= MARKET & RECOMMENDATION HELPERS ======= */
function impliedProb(odds){ if(!odds || odds<=0) return null; return 1/odds; }
function probOUFromTotals(totals, line, runs){
  let over=0, under=0; const isInt = Number.isInteger(line);
  for(const t in totals){ const g=parseInt(t), v=totals[t]; if(isInt){ if(g>line) over+=v; else if(g<line) under+=v; else { over+=0.5*v; under+=0.5*v; } } else { if(g>line) over+=v; else under+=v; } }
  return { over: over/runs, under: under/runs };
}
function probCoverFromScores(freq, handicap, runs){
  let win=0,push=0,lose=0;
  for(const k in freq){ const v=freq[k]; const [gh,ga] = k.split('-').map(x=>parseInt(x)); const diff = gh - ga - handicap; if(diff>0) win+=v; else if(diff===0) push+=v; else lose+=v; }
  return (win + 0.5*push)/runs;
}
function computeVolatility(){
  const vals = [
    (hdpHomeOpen.value && hdpHomeNow.value) ? Math.abs((safe(hdpHomeNow.value)-safe(hdpHomeOpen.value))/safe(hdpHomeOpen.value)*100) : 0,
    (hdpAwayOpen.value && hdpAwayNow.value) ? Math.abs((safe(hdpAwayNow.value)-safe(hdpAwayOpen.value))/safe(hdpAwayOpen.value)*100) : 0,
    (ouOverOpen.value && ouOverNow.value) ? Math.abs((safe(ouOverNow.value)-safe(ouOverOpen.value))/safe(ouOverOpen.value)*100) : 0,
    (ouUnderOpen.value && ouUnderNow.value) ? Math.abs((safe(ouUnderNow.value)-safe(ouUnderOpen.value))/safe(ouUnderOpen.value)*100) : 0
  ].filter(x=>x>0);
  if(vals.length===0) return 0;
  return clamp(vals.reduce((a,b)=>a+b,0)/vals.length,0,100);
}
function computeConfidenceFromTotals(totals, candidates){
  let mean=0,count=0;
  for(const k in totals){ mean += parseInt(k)*totals[k]; count += totals[k]; }
  if(count===0) return { score: 0.45, label: 'Low' };
  mean /= count;
  let varv=0;
  for(const k in totals){ varv += ((parseInt(k)-mean)**2) * totals[k]; }
  varv /= count;
  let conf = clamp(1 - Math.min(1, varv / 9), 0.12, 0.99);
  const trapCount = candidates.filter(c => Math.abs(c.deltaPct||0) >= 18).length;
  if(trapCount >= 2) conf *= 0.72;
  const label = conf > 0.82 ? 'High' : conf > 0.60 ? 'Medium' : 'Low';
  return { score: conf, label };
}
</script>

<script>
/* ======= UI + MAIN ANALYZE (v33) ======= */
function analyzeV33(){
  const runs = Math.max(1000, parseInt(safe(mcRuns.value,20000)));
  const rho = 0.12;

  const h = {
    xg: safe(xgHome.value,1.1), sot: safe(sotHome.value,3.2), shots: safe(shotsHome.value,8), conv: clamp(safe(convHome.value,0.12),0,1),
    big: safe(bigHome.value,0), miss: safe(missHome.value,0), poss: safe(possHome.value,52),
    ti: safe(tiHome.value,25), cs: safe(csHome.value,0.32), gc: safe(gcHome.value,1.2), saves: safe(saveHome.value,3.5),
    err: safe(errHome.value,7), absDf: safe(absDfHome.value,0), absMf: safe(absMfHome.value,0), absFw: safe(absFwHome.value,0),
    elo: safe(eloHome.value,1500), form: formScoreFromRaw(formRawHome.value)
  };
  const a = {
    xg: safe(xgAway.value,1.0), sot: safe(sotAway.value,3.0), shots: safe(shotsAway.value,7), conv: clamp(safe(convAway.value,0.11),0,1),
    big: safe(bigAway.value,0), miss: safe(missAway.value,0), poss: safe(possAway.value,48),
    ti: safe(tiAway.value,20), cs: safe(csAway.value,0.28), gc: safe(gcAway.value,1.3), saves: safe(saveAway.value,3.6),
    err: safe(errAway.value,8), absDf: safe(absDfAway.value,0), absMf: safe(absMfAway.value,0), absFw: safe(absFwAway.value,0),
    elo: safe(eloAway.value,1480), form: formScoreFromRaw(formRawAway.value)
  };

  if(!h.ti || h.ti===0) h.ti = safe(tackleHome.value)+safe(interHome.value);
  if(!a.ti || a.ti===0) a.ti = safe(tackleAway.value)+safe(interAway.value);

  const lamb = computeLambdasSharp(h,a);
  const lambdaH = lamb.lambdaH, lambdaA = lamb.lambdaA;
  const atkH = lamb.atkH, atkA = lamb.atkA, defH = lamb.defH, defA = lamb.defA;

  const sigmaFactor = clamp((Math.abs(h.form - a.form) + Math.abs(h.xg - a.xg))/3, 0, 1);
  const volScore = computeVolatility();
  const volFactor = clamp(volScore/30, 0, 1);

  const mc = monteCarloSharp(lambdaH, lambdaA, rho, sigmaFactor, volFactor, runs);

  const avgH = Object.entries(mc.freq).reduce((s,[k,v])=>s + parseInt(k.split('-')[0])*v,0)/runs;
  const avgA = Object.entries(mc.freq).reduce((s,[k,v])=>s + parseInt(k.split('-')[1])*v,0)/runs;

  const ouLineVal = safe(ouLine.value,2.5);
  const ouProb = probOUFromTotals(mc.totals, ouLineVal, runs);
  const hdpLineVal = safe(hdpLine.value,0.25);
  const coverHome = probCoverFromScores(mc.freq, hdpLineVal, runs);
  const coverAway = probCoverFromScores(mc.freq, -hdpLineVal, runs);

  const implied = {
    ouOver: impliedProb(safe(ouOverNow.value,NaN)),
    ouUnder: impliedProb(safe(ouUnderNow.value,NaN)),
    hdpHome: impliedProb(safe(hdpHomeNow.value,NaN)),
    hdpAway: impliedProb(safe(hdpAwayNow.value,NaN))
  };
  const edges = {
    ouOver: implied.ouOver ? (ouProb.over - implied.ouOver) : null,
    ouUnder: implied.ouUnder ? (ouProb.under - implied.ouUnder) : null,
    hdpHome: implied.hdpHome ? (coverHome - implied.hdpHome) : null,
    hdpAway: implied.hdpAway ? (coverAway - implied.hdpAway) : null
  };

  const candidates = [
    { tag:`OU Over ${ouLineVal}`, prob:ouProb.over, edge:edges.ouOver, market:'OU', open: safe(ouOverOpen.value,NaN), now: safe(ouOverNow.value,NaN) },
    { tag:`OU Under ${ouLineVal}`, prob:ouProb.under, edge:edges.ouUnder, market:'OU', open: safe(ouUnderOpen.value,NaN), now: safe(ouUnderNow.value,NaN) },
    { tag:`HDP Home ${hdpLineVal}`, prob:coverHome, edge:edges.hdpHome, market:'HDP', open: safe(hdpHomeOpen.value,NaN), now: safe(hdpHomeNow.value,NaN) },
    { tag:`HDP Away ${-hdpLineVal}`, prob:coverAway, edge:edges.hdpAway, market:'HDP', open: safe(hdpAwayOpen.value,NaN), now: safe(hdpAwayNow.value,NaN) }
  ];

  candidates.forEach(c=>{
    c.deltaPct = (c.open && c.now) ? Math.abs((c.now - c.open)/c.open*100) : 0;
    c.direction = (c.market==='OU') ? ((c.now && c.open && c.now>c.open)? 'Money â†’ Under' : (c.now && c.open && c.now<c.open? 'Money â†’ Over' : 'Stable')) : ((c.now && c.open && c.now>c.open)? 'Money â†’ Away' : (c.now && c.open && c.now<c.open? 'Money â†’ Home' : 'Stable'));
    c.status = c.deltaPct>=18 ? 'Trap' : c.deltaPct>=5 ? 'Warning' : 'Stable';
    c.impliedEdge = c.edge===null ? null : clamp(c.edge, -0.99, 0.99);
  });

  candidates.forEach(c=>{
    const edgeScore = (c.impliedEdge===null) ? 0 : c.impliedEdge * 0.66;
    c.score = (c.prob * 0.72) + edgeScore;
  });
  candidates.sort((a,b)=>b.score - a.score);

  const selected = candidates.slice(0,2).map(c=>{
    let signal = 'Low';
    if(c.prob >= 0.63 && c.impliedEdge !== null && c.impliedEdge >= 0.015) signal = 'High';
    else if(c.prob >= 0.56 && c.impliedEdge !== null && c.impliedEdge >= 0.007) signal = 'Medium';
    return {...c, signal};
  });

  const conf = computeConfidenceFromTotals(mc.totals, candidates);

  let summary = `Î» (sharp): Home ${lambdaH.toFixed(2)} | Away ${lambdaA.toFixed(2)}\n`;
  summary += `Sim Exp Goals: H ${avgH.toFixed(2)} | A ${avgA.toFixed(2)}\n`;
  summary += `1X2 Prob: Home ${percent(mc.pHome)} Draw ${percent(mc.pDraw)} Away ${percent(mc.pAway)}\n`;
  summary += `OU(${ouLineVal}): Over ${percent(ouProb.over)} / Under ${percent(ouProb.under)}\n`;
  summary += `HDP(${hdpLineVal}): Home ${percent(coverHome)} / Away ${percent(coverAway)}\n`;
  summary += `Model Confidence: ${conf.label} (${(conf.score*100).toFixed(1)}%)\n`;
  summary += `Volatility Score: ${volScore.toFixed(1)}\n`;

  document.getElementById('summary').textContent = summary;

  function colorBy(label){ return label==='High'? '#16a34a' : label==='Medium'? '#f59e0b' : '#ef4444'; }
  let recHtml = '';
  selected.forEach(s=>{
    const color = colorBy(s.signal);
    const pct = (s.prob*100).toFixed(1);
    const edgeTxt = s.impliedEdge===null? '-' : (s.impliedEdge*100).toFixed(2) + '%';
    recHtml += `<div style="margin-bottom:10px;padding:10px;border-radius:8px;background:#021827;border:1px solid rgba(255,255,255,0.03)">
      <div style="font-weight:700">${s.tag} â€¢ ${s.signal}</div>
      <div class="small" style="margin-top:6px">${s.direction} â€¢ Prob ${pct}% â€¢ Edge ${edgeTxt}</div>
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
        <div style="flex:1;height:10px;background:#022233;border-radius:6px;overflow:hidden">
          <div style="width:${(s.prob*100).toFixed(1)}%;height:100%;background:${color}"></div>
        </div>
        <div style="min-width:56px;text-align:right;font-weight:700;color:#cfe8ff">${(s.prob*100).toFixed(1)}%</div>
      </div>
      <div class="small" style="margin-top:6px">Model Conf ${(conf.score*100).toFixed(1)}% â€¢ Status: ${s.status}</div>
    </div>`;
  });
  document.getElementById('bestRec').innerHTML = recHtml || '<div class="card">Tidak ada rekomendasi kuat.</div>';

  let table = '<tr><th>Pasar</th><th>Prob</th><th>Edge%</th><th>Status</th></tr>';
  candidates.forEach(c=>{
    table += `<tr><td style="text-align:left;padding-left:8px">${c.tag}</td><td>${percent(c.prob)}</td><td>${c.impliedEdge===null?'-':(c.impliedEdge*100).toFixed(2)+'%'}</td><td>${c.status}</td></tr>`;
  });
  document.getElementById('trapTable').innerHTML = table;

  // visuals
  drawHistogram(mc.totals, ouLineVal);
  drawGauge(conf);
  console.log('V33 analysis done', {lambdaH,lambdaA,avgH,avgA,conf});
}

// UI helpers
function fillExample(){
  teamHome.value='Man City'; teamAway.value='Tottenham';
  xgHome.value=2.05; xgAway.value=1.45; sotHome.value=6.4; sotAway.value=4.2;
  shotsHome.value=14; shotsAway.value=9;
  goalsHome.value=9; goalsAway.value=5;
  convHome.value=''; convAway.value='';
  bigHome.value=4; missHome.value=1; bigAway.value=2; missAway.value=3;
  possHome.value=63; possAway.value=37;
  tackleHome.value=24; interHome.value=8; tackleAway.value=17; interAway.value=7; autoTI();
  csHome.value=0.52; csAway.value=0.28; gcHome.value=0.78; gcAway.value=1.32; saveHome.value=3.9; saveAway.value=3.2;
  errHome.value=5; errAway.value=9;
  absDfHome.value=1; absMfHome.value=0; absFwHome.value=1; absDfAway.value=0; absMfAway.value=2; absFwAway.value=0;
  formRawHome.value='W,W,D,W,L'; formRawAway.value='L,D,W,L,D'; h2hResults.value='WDWLW';
  eloHome.value=1820; eloAway.value=1690;
  hdpLine.value=0.25; hdpHomeOpen.value=1.95; hdpHomeNow.value=1.88; hdpAwayOpen.value=1.95; hdpAwayNow.value=2.05;
  ouLine.value=2.5; ouOverOpen.value=1.95; ouOverNow.value=1.88; ouUnderOpen.value=1.90; ouUnderNow.value=2.00;
  mcRuns.value=20000;
  alert('Contoh terisi â€” klik Analisis Ultra Sharp v33.');
}
function resetAll(){ document.querySelectorAll('input').forEach(i=>{ if(i.type!=='button') i.value=''; }); document.getElementById('summary').textContent='Direset'; document.getElementById('bestRec').innerHTML=''; document.getElementById('trapTable').innerHTML='<tr><th>Pasar</th><th>Prob</th><th>Edge%</th><th>Status</th></tr>'; const c1=document.getElementById('histMC').getContext('2d'); c1.clearRect(0,0,440,140); const c2=document.getElementById('confGauge').getContext('2d'); c2.clearRect(0,0,220,120); }

// bind
document.getElementById('btnExample').addEventListener('click', fillExample);
document.getElementById('btnReset').addEventListener('click', resetAll);
document.getElementById('btnAutoCR').addEventListener('click', autoCR);
document.getElementById('btnAnalyze').addEventListener('click', analyzeV33);
</script>

</body>
</html>
