<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Prediksi Pertandingan - v29.3 Sharp+ Explain Mode</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#121212;color:#f5f5f5}
  h1{font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 520px;gap:12px}
  .block{padding:12px;border-radius:8px;border:1px solid #333;background:#1e1e1e}
  label{display:block;font-size:13px;margin:6px 0}
  input[type="number"],input[type="text"],select{width:100%;padding:7px;border:1px solid #555;border-radius:6px;background:#222;color:#fff}
  button{padding:8px 12px;border-radius:8px;border:0;background:#0b74de;color:#fff;cursor:pointer;margin:3px}
  .small{font-size:12px;color:#aaa}
  .result{white-space:pre-wrap;font-family:monospace;background:#181818;padding:10px;border-radius:8px;border:1px dashed #444}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
  th,td{padding:6px;border-bottom:1px solid #333;text-align:center}
  th{background:#222}
  .bar{display:inline-block;height:10px;border-radius:3px;margin-left:6px;vertical-align:middle}
  .bar.over{background:#1e90ff}
  .bar.under{background:#ff4040}
  .bar.neutral{background:#777}
  .tooltip{position:relative;display:inline-block}
  .tooltip .tooltiptext{visibility:hidden;width:260px;background:#222;color:#fff;text-align:left;border-radius:6px;padding:8px;position:absolute;z-index:1;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .15s}
  .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
  .explain{background:#0f1720;border-left:4px solid #0b74de;padding:10px;border-radius:6px;margin-top:8px;color:#dfeffd}
  .collapsible{background:#161616;padding:8px;border-radius:6px;border:1px solid #2b2b2b;color:#ddd;cursor:pointer}
  canvas{background:#0f0f0f;border-radius:6px}
  .muted{color:#9aa3ad;font-size:12px}
</style>
</head>
<body>
<h1>⚽ Prediksi — v29.3 Sharp+ Explain Mode</h1>
<p class="small">Model: xG + attack/defense indices + TI & errors + H2H safe + form + ELO + Monte Carlo lognormal + Bayesian blend dengan odds pasar — sekarang dengan Explain Mode</p>

<div class="grid">
  <div>
    <div class="block">
      <h3>Input (Isi seminimal mungkin; ada contoh otomatis)</h3>
      <label>Home Team: <input id="teamHome" type="text" value="Home FC"></label>
      <label>Away Team: <input id="teamAway" type="text" value="Away FC"></label>

      <label>H2H Last 5 (Home perspective):
        <span class="tooltip"><input id="h2hResults" type="text" maxlength="5" placeholder="WDLWL" title="Isi 5 hasil terakhir (contoh: WDLWL). Biarkan kosong jika belum pernah bertemu."></span>
        <span class="muted"> — kosong = diabaikan (SafeMode)</span>
      </label>

      <label>xG per Game: <input id="xgHome" type="number" step="0.01"> <input id="xgAway" type="number" step="0.01"></label>
      <label>Shots on Target per Game: <input id="sotHome" type="number" step="0.1"> <input id="sotAway" type="number" step="0.1"></label>
      <label>Conversion Rate (0-1): <input id="convHome" type="number" step="0.01"> <input id="convAway" type="number" step="0.01"></label>
      <label>Big chances / Missed per game: <input id="bigHome" type="number" step="0.1"> <input id="missHome" type="number" step="0.1"><br><input id="bigAway" type="number" step="0.1"> <input id="missAway" type="number" step="0.1"></label>

      <h4>Defensive & Other</h4>
      <label>Clean Sheet per Game: <input id="csHome" type="number" step="0.01"> <input id="csAway" type="number" step="0.01"></label>
      <label>Goals Conceded per Game: <input id="gcHome" type="number" step="0.1"> <input id="gcAway" type="number" step="0.1"></label>
      <label>Saves per Game: <input id="saveHome" type="number" step="0.1"> <input id="saveAway" type="number" step="0.1"></label>
      <label>Tackles per Game: <input id="tackleHome" type="number" step="0.1"> <input id="tackleAway" type="number" step="0.1"></label>
      <label>Interceptions per Game: <input id="interHome" type="number" step="0.1"> <input id="interAway" type="number" step="0.1"></label>

      <label>Errors leading to goal per season (est): <input id="errSeasonHome" type="number" step="1" title="Perkiraan kesalahan berujung gol per musim"> <input id="errSeasonAway" type="number" step="1"></label>
      <label>Liga Match Count: 
        <select id="matchCount">
          <option value="38">38</option><option value="34">34</option><option value="30">30</option><option value="26">26</option>
        </select>
      </label>

      <label>Possession %: <input id="possHome" type="number" step="0.1"> <input id="possAway" type="number" step="0.1"></label>

      <label>Form Last 5 (Home): <input id="formHome" type="text" placeholder="W,D,W,L,D"></label>
      <label>Form Last 5 (Away): <input id="formAway" type="text" placeholder="L,D,L,W,D"></label>

      <label>Pemain absen (posisi, pisah koma): <input id="injHome" type="text" placeholder="GK, DF"> <input id="injAway" type="text" placeholder="MF, FW"></label>

      <label>ELO Rating: <input id="eloHome" type="number" value="1500"> <input id="eloAway" type="number" value="1480"></label>

      <label>Monte Carlo runs: <input id="mcRuns" type="number" value="3000" step="100"> Correlation rho: <input id="rho" type="number" value="0.12" step="0.01"></label>
      <label>Dispersion sigma (0.18–0.6): <input id="dispersionSigma" type="number" value="0.30" step="0.01"></label>

      <h4>Odds (Open & Now)</h4>
      <label>HDP1 Line <input id="hdp1Line" type="text" value="-0.5"></label>
      <label>HDP1 Home Open <input id="hdp1HomeOpen" type="number" step="0.01"> Now <input id="hdp1HomeNow" type="number" step="0.01"> | Away Open <input id="hdp1AwayOpen" type="number" step="0.01"> Now <input id="hdp1AwayNow" type="number" step="0.01"></label>

      <label>HDP2 Line <input id="hdp2Line" type="text" value="-0.75"></label>
      <label>HDP2 Home Open <input id="hdp2HomeOpen" type="number" step="0.01"> Now <input id="hdp2HomeNow" type="number" step="0.01"> | Away Open <input id="hdp2AwayOpen" type="number" step="0.01"> Now <input id="hdp2AwayNow" type="number" step="0.01"></label>

      <label>OU1 Line <input id="ou1Line" type="number" step="0.25" value="2.5"></label>
      <label>Over Open <input id="oddOver10" type="number" step="0.01"> Over Now <input id="oddOver11" type="number" step="0.01"> | Under Open <input id="oddUnder10" type="number" step="0.01"> Under Now <input id="oddUnder11" type="number" step="0.01"></label>

      <label>OU2 Line <input id="ou2Line" type="number" step="0.25" value="3.0"></label>
      <label>Over Open <input id="oddOver20" type="number" step="0.01"> Over Now <input id="oddOver21" type="number" step="0.01"> | Under Open <input id="oddUnder20" type="number" step="0.01"> Under Now <input id="oddUnder21" type="number" step="0.01"></label>

      <div style="margin-top:8px">
        <button id="btnSample">Isi Contoh Otomatis</button>
        <button id="btnReset">Reset</button>
        <button id="btnAnalyze">Analisis</button>
      </div>
    </div>
  </div>

  <div>
    <div class="block">
      <h3>Ringkasan Cepat</h3>
      <div id="summary" class="result">Klik Analisis untuk hasil.</div>
      <h3>Rekomendasi & Odds Trap</h3>
      <div id="rekom" class="result">--</div>

      <div style="margin-top:8px">
        <div class="collapsible" id="explainToggle">Lihat Penjelasan Rekomendasi ▾</div>
        <div id="explainBox" class="explain" style="display:none"></div>
      </div>

      <table id="trapTable"><tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Prob Model</th><th>Edge%</th><th>Sinyal</th></tr></table>
      <h3>Histogram Total Gol</h3>
      <canvas id="hist" width="460" height="140"></canvas>
      <h3>Debug</h3>
      <div id="debug" class="result">--</div>
    </div>
  </div>
</div>

<script>
// ---- Utilities (same as previous sharp) ----
function safe(v,d=0){const x=parseFloat(v);return isNaN(x)?d:x;}
function trimArr(s){if(!s) return [];return s.toString().split(',').map(x=>x.trim().toUpperCase()).filter(Boolean);}
function randNormal(mu=0,sigma=1){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return mu+sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}
function poissonRand(lambda){let L=Math.exp(-lambda),k=0,p=1;while(p>L){k++;p*=Math.random();if(k>1000)break;}return k-1;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function sampleBivariateLognormal(lambdaH,lambdaA,rho,sigma){
  const z1 = randNormal(0,sigma);
  const z2 = rho*z1 + Math.sqrt(Math.max(0,1-rho*rho))*randNormal(0,sigma);
  const lamH = Math.max(0.01, lambdaH * Math.exp(z1 - 0.5*sigma*sigma));
  const lamA = Math.max(0.01, lambdaA * Math.exp(z2 - 0.5*sigma*sigma));
  return [poissonRand(lamH), poissonRand(lamA)];
}
function monteCarlo(lambdaH,lambdaA,rho,runs,sigma){
  const scoreFreq = {}, totals = {};
  let h=0,d=0,a=0;
  for(let i=0;i<runs;i++){
    const [gh,ga] = sampleBivariateLognormal(lambdaH,lambdaA,rho,sigma);
    scoreFreq[`${gh}-${ga}`] = (scoreFreq[`${gh}-${ga}`]||0) + 1;
    totals[gh+ga] = (totals[gh+ga]||0) + 1;
    if(gh>ga) h++; else if(gh===ga) d++; else a++;
  }
  return {scoreFreq, totals, pHome: h/runs, pDraw: d/runs, pAway: a/runs};
}
function computeOU(totals,line,runs){
  let over=0,under=0; const isInt = Number.isInteger(line);
  for(const k in totals){ const g = parseInt(k), v = totals[k];
    if(isInt){
      if(g>line) over+=v; else if(g<line) under+=v; else { over+=0.5*v; under+=0.5*v; }
    } else {
      if(g>line) over+=v; else under+=v;
    }
  }
  return {over: over/runs, under: under/runs};
}
function impliedProb(odds){return odds && odds>0 ? 1/odds : null;}
function deltaPercent(open,now){ if(!open||!now) return null; return ((now-open)/open*100).toFixed(1); }
const POS_WEIGHT = {GK:25, DF:15, MF:10, FW:20, OTHER:8};
function calcInjuryImpact(posStr){
  const arr = trimArr(posStr); let total=0;
  arr.forEach(p=> total += (POS_WEIGHT[p]||POS_WEIGHT.OTHER));
  const impactPercent = clamp(total/2, 0, 60);
  return {count: arr.length, total, impactPercent};
}
function computeTotalTI(tackle, inter, injList){
  const base = safe(tackle,0) + safe(inter,0);
  const arr = trimArr(injList);
  const dfCount = arr.filter(x=>x==='DF').length;
  let adjusted = base; let note = '';
  if(dfCount>=2){ adjusted *= 0.85; note = `⚠️ ${dfCount} DF absen — total dikurangi 15%`; }
  return {base, adjusted, dfCount, note};
}
function parseFormScore(formStr){
  if(!formStr) return 0.5;
  const parts = formStr.toString().split(',').map(s=>s.trim().toUpperCase()).filter(Boolean).slice(0,5);
  let W=0,D=0;
  parts.forEach(p=>{ if(p==='W') W++; else if(p==='D') D++; });
  return (3*W + 1*D)/15;
}
function calcH2HRate(results){
  const s = (results||'').toString().trim().toUpperCase().replace(/[^WDL]/g,'').slice(0,5);
  if(!s || !/^[WDL]{1,5}$/.test(s)) return {homeWinRate:0, awayWinRate:0, valid:false, raw:s};
  let win=0,lose=0;
  for(let c of s){ if(c==='W') win++; else if(c==='L') lose++; }
  const homeWinRate = (win/5); const awayWinRate = (lose/5);
  return {homeWinRate, awayWinRate, valid:true, raw:s};
}
function computeAttack(h){
  return 0.32*h.xg + 0.22*(h.sot/5) + 0.12*(h.conv*100) + 0.10*(h.big/2) - 0.06*(h.miss/2)
    + 0.04*(h.shots/10) + 0.04*(h.corners/3) + 0.04*(h.drib/6) + 0.03*(h.counters/5) + 0.03*(h.poss/50);
}
function computeDefense(cs,gc,saves,ti,clear,recover,errPerGame,pen){
  return 1 + (-0.25*cs + 0.28*gc - 0.10*(saves/4) - 0.09*(ti/25) - 0.04*(clear/30) - 0.04*(recover/50) + 0.12*errPerGame + 0.08*pen);
}
function shrinkEdge(edge){
  const cap = 0.18; const e = Math.sign(edge) * Math.min(Math.abs(edge), cap);
  return e * 0.82;
}

// ---- Main analyze (full + explain) ----
function analyze(){
  try{
    const runs = Math.max(1000, safe(document.getElementById('mcRuns')?.value, 3000));
    const rho = clamp(safe(document.getElementById('rho')?.value, 0.12), -0.9, 0.9);
    let sigma = clamp(safe(document.getElementById('dispersionSigma')?.value, 0.30), 0.18, 0.6);

    const h = {
      name: document.getElementById('teamHome')?.value || 'Home',
      xg: safe(document.getElementById('xgHome')?.value, 1.0),
      sot: safe(document.getElementById('sotHome')?.value, 3.5),
      conv: clamp(safe(document.getElementById('convHome')?.value, 0.12), 0,1),
      big: safe(document.getElementById('bigHome')?.value, 1.0),
      miss: safe(document.getElementById('missHome')?.value, 0.6),
      shots: safe(document.getElementById('shotsHome')?.value, 10),
      corners: safe(document.getElementById('cornHome')?.value, 4),
      drib: safe(document.getElementById('dribHome')?.value, 3),
      counters: safe(document.getElementById('countHome')?.value, 1),
      poss: safe(document.getElementById('possHome')?.value, 52),
      cs: safe(document.getElementById('csHome')?.value, 0.35),
      gc: safe(document.getElementById('gcHome')?.value, 1.1),
      saves: safe(document.getElementById('saveHome')?.value, 3.5),
      tackle: safe(document.getElementById('tackleHome')?.value, 16),
      inter: safe(document.getElementById('interHome')?.value, 7),
      clear: safe(document.getElementById('clearHome')?.value, 18),
      recover: safe(document.getElementById('recoverHome')?.value, 22),
      errSeason: safe(document.getElementById('errSeasonHome')?.value, 6),
      pen: safe(document.getElementById('penHome')?.value, 0),
      elo: safe(document.getElementById('eloHome')?.value, 1500)
    };
    const a = {
      name: document.getElementById('teamAway')?.value || 'Away',
      xg: safe(document.getElementById('xgAway')?.value, 1.0),
      sot: safe(document.getElementById('sotAway')?.value, 3.2),
      conv: clamp(safe(document.getElementById('convAway')?.value, 0.10),0,1),
      big: safe(document.getElementById('bigAway')?.value, 1.0),
      miss: safe(document.getElementById('missAway')?.value, 0.7),
      shots: safe(document.getElementById('shotsAway')?.value, 9),
      corners: safe(document.getElementById('cornAway')?.value, 3),
      drib: safe(document.getElementById('dribAway')?.value, 2.5),
      counters: safe(document.getElementById('countAway')?.value, 1),
      poss: safe(document.getElementById('possAway')?.value, 48),
      cs: safe(document.getElementById('csAway')?.value, 0.28),
      gc: safe(document.getElementById('gcAway')?.value, 1.3),
      saves: safe(document.getElementById('saveAway')?.value, 3.8),
      tackle: safe(document.getElementById('tackleAway')?.value, 15),
      inter: safe(document.getElementById('interAway')?.value, 6.8),
      clear: safe(document.getElementById('clearAway')?.value, 16),
      recover: safe(document.getElementById('recoverAway')?.value, 18),
      errSeason: safe(document.getElementById('errSeasonAway')?.value, 8),
      pen: safe(document.getElementById('penAway')?.value, 0),
      elo: safe(document.getElementById('eloAway')?.value, 1480)
    };

    const tiHomeObj = computeTotalTI(h.tackle, h.inter, document.getElementById('injHome')?.value || '');
    const tiAwayObj = computeTotalTI(a.tackle, a.inter, document.getElementById('injAway')?.value || '');
    const tiH = tiHomeObj.adjusted;
    const tiA = tiAwayObj.adjusted;

    const matchCount = Math.max(1, safe(document.getElementById('matchCount')?.value, 38));
    const errPerGameH = h.errSeason / matchCount;
    const errPerGameA = a.errSeason / matchCount;

    const h2hParsed = calcH2HRate(document.getElementById('h2hResults')?.value);
    const h2hHome = h2hParsed.homeWinRate; const h2hAway = h2hParsed.awayWinRate;
    const h2hValid = h2hParsed.valid;

    const formScoreH = parseFormScore(document.getElementById('formHome')?.value);
    const formScoreA = parseFormScore(document.getElementById('formAway')?.value);

    const injH = calcInjuryImpact(document.getElementById('injHome')?.value);
    const injA = calcInjuryImpact(document.getElementById('injAway')?.value);
    const injFactorH = 1 - (injH.impactPercent/100)*0.8;
    const injFactorA = 1 - (injA.impactPercent/100)*0.8;
    const defPenaltyH = 1 + (injH.impactPercent/100)*0.6;
    const defPenaltyA = 1 + (injA.impactPercent/100)*0.6;

    const attH = computeAttack({xg:h.xg, sot:h.sot, conv:h.conv, big:h.big, miss:h.miss, shots:h.shots, corners:h.corners, drib:h.drib, counters:h.counters, poss:h.poss);
