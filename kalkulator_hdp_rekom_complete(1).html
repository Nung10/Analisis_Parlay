<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kalkulator HDP Advanced + Rekomendasi</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;padding:16px}
.container{max-width:980px;margin:auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
h2{text-align:center;margin:6px 0 12px}
label{display:block;margin-top:10px;font-weight:600}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.row>div{flex:1 1 140px}
select,input,button,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
button{margin-top:16px;background:#1976d2;color:#fff;border:none;border-radius:6px;font-size:16px;cursor:pointer}
.result{margin-top:12px;padding:12px;background:#f1f8e9;border-radius:6px;white-space:pre-wrap}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table td,.table th{border:1px solid #eee;padding:6px;text-align:center}
.reco-box{background:#fff7e6;border-left:4px solid #ffb300;padding:10px;margin-top:10px;border-radius:6px}
.reco-strong{background:#e8f5e9;color:#2e7d32;padding:8px;border-radius:6px;margin-top:8px}
.reco-good{background:#e3f2fd;color:#0d47a1;padding:8px;border-radius:6px;margin-top:8px}
.small{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>
<div class="container">
  <h2>Kalkulator HDP Advanced + Rekomendasi Terbaik</h2>

  <label>Odds 1X2 (Home / Draw / Away)</label>
  <div class="row">
    <div><select id="oddsHome"></select></div>
    <div><select id="oddsDraw"></select></div>
    <div><select id="oddsAway"></select></div>
  </div>

  <label>Odds HDP (Home / Away)</label>
  <div class="row">
    <div><select id="hdpHome"></select></div>
    <div><select id="hdpAway"></select></div>
  </div>

  <label>Odds Over/Under (Over / Under)</label>
  <div class="row">
    <div><select id="over"></select></div>
    <div><select id="under"></select></div>
  </div>

  <label>Total Gol & Kebobolan (jumlah gol di X laga terakhir)</label>
  <div class="row">
    <div><input id="golHome" type="number" placeholder="Total gol Home (mis. 8)"></div>
    <div><input id="kebHome" type="number" placeholder="Total kebobolan Home"></div>
    <div><input id="golAway" type="number" placeholder="Total gol Away"></div>
    <div><input id="kebAway" type="number" placeholder="Total kebobolan Away"></div>
  </div>
  <div class="row">
    <div><input id="matchCount" type="number" value="5" min="1" placeholder="Jumlah laga (mis.5)"></div>
    <div style="flex:2"><input id="bankroll" type="number" value="100" min="1" placeholder="Bankroll (untuk Kelly)"></div>
  </div>

  <label>Head-to-Head (H2H) — tulis manual, contoh: Home 2-1 Away, Away 1-1 Home</label>
  <textarea id="h2hText" rows="3" placeholder="Contoh: Home 2-1 Away, Away 1-1 Home"></textarea>

  <div class="small">Blending weight: Model Poisson 0.6, Market fair 0.4 (ubah di kode bila perlu)</div>

  <button id="btnAnalisis">Analisis & Rekomendasi</button>

  <div id="hasil" class="result">Hasil akan tampil di sini</div>

  <table class="table" id="tbl" style="display:none">
    <thead><tr><th>Metode</th><th>Home</th><th>Draw</th><th>Away</th><th>Over</th><th>Under</th><th>BTTS</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="rekomContainer" class="reco-box" style="display:none">
    <strong>Rekomendasi Terbaik</strong>
    <div id="rekom1"></div>
    <div id="rekom2"></div>
    <div id="rekom3"></div>
    <div id="rekomAll" style="margin-top:8px;font-size:13px;color:#444"></div>
  </div>

  <canvas id="chart" height="160" style="margin-top:12px"></canvas>
</div>

<script>
/* ---------------- UI init ---------------- */
function fill(sel,start,end,step){
  const s=document.getElementById(sel); s.innerHTML='';
  const def=document.createElement('option'); def.value=''; def.text='-- Pilih --'; s.appendChild(def);
  for(let v=start; v<=end+1e-9; v+=step){
    const o=document.createElement('option'); o.value=v.toFixed(2); o.text=v.toFixed(2); s.appendChild(o);
  }
}
document.addEventListener('DOMContentLoaded', ()=>{
  fill('oddsHome',1,20,0.01);
  fill('oddsDraw',1,20,0.01);
  fill('oddsAway',1,20,0.01);
  fill('hdpHome',1,5,0.01);
  fill('hdpAway',1,5,0.01);
  fill('over',1,3,0.01);
  fill('under',1,3,0.01);
  document.getElementById('btnAnalisis').addEventListener('click', analyzeAll);
});

/* ---------------- Math & model helpers ---------------- */
function factorial(n){ if(n<=1) return 1; let f=1; for(let i=2;i<=n;i++) f*=i; return f; }
function poissonP(k, lambda){ return Math.exp(-lambda)*Math.pow(lambda,k)/factorial(k); }
function goalDist(lambda, maxGoals=10){
  const arr=[]; let sum=0;
  for(let k=0;k<=maxGoals;k++){ const p=poissonP(k, lambda); arr.push(p); sum+=p; }
  if(sum<1) arr[arr.length-1] += 1-sum;
  return arr;
}
function computeMatchProbs(lambdaHome, lambdaAway, maxG=10){
  const distH = goalDist(lambdaHome, maxG);
  const distA = goalDist(lambdaAway, maxG);
  let pHome=0,pDraw=0,pAway=0,pBoth=0;
  const totalDist = Array(maxG*2+1).fill(0);
  for(let i=0;i<=maxG;i++){
    for(let j=0;j<=maxG;j++){
      const p = distH[i]*distA[j];
      if(i>j) pHome += p;
      else if(i===j) pDraw += p;
      else pAway += p;
      if(i>0 && j>0) pBoth += p;
      totalDist[i+j] += p;
    }
  }
  return {pHome,pDraw,pAway,pBoth,totalDist};
}
function fairifyOddsArray(oddsArr){
  const imps = oddsArr.map(o => 1/parseFloat(o));
  const sum = imps.reduce((a,b)=>a+b,0);
  return imps.map(i => i/sum);
}
function fairifyTwo(a,b){
  const ia = 1/parseFloat(a), ib = 1/parseFloat(b);
  const s = ia + ib;
  return [ia/s, ib/s];
}
function kellyFraction(p, odd){
  if(!p || !odd) return 0;
  const b = odd - 1;
  const k = (b*p - (1-p))/b;
  return Math.max(0, k);
}
function valuePP(blend, marketFair){
  if(blend==null || marketFair==null) return null;
  return (blend - marketFair) * 100;
}

/* computeRecommendations integrated (from previous plan) */
function computeRecommendations(market, blended, oddsObj){
  const candidates = [];
  function pushCandidate(key,label,blendVal,marketFair,odd){
    if(blendVal==null) return;
    const val = (marketFair!=null) ? valuePP(blendVal, marketFair) : null;
    const kelly = odd? kellyFraction(blendVal, odd) : 0;
    candidates.push({key,label,blend:blendVal,marketFair,odd,val,kelly});
  }
  pushCandidate('home','1X2 Home', blended.home, market.home, oddsObj.home);
  pushCandidate('draw','1X2 Draw', blended.draw, market.draw, oddsObj.draw);
  pushCandidate('away','1X2 Away', blended.away, market.away, oddsObj.away);
  pushCandidate('over','Over', blended.over, market.over, oddsObj.over);
  pushCandidate('under','Under', blended.under, market.under, oddsObj.under);
  pushCandidate('hdpHome','HDP Home', blended.hdpHome ?? market.hdpHome, market.hdpHome, oddsObj.hdpHome);
  pushCandidate('hdpAway','HDP Away', blended.hdpAway ?? market.hdpAway, market.hdpAway, oddsObj.hdpAway);

  candidates.forEach(c=>{
    let score=0;
    if(c.val !== null && c.val >= 5) score += 100;
    if(c.blend !== null && c.blend > 0.55) score += 60;
    score += (c.kelly || 0) * 100;
    score += (c.blend || 0) * 10;
    c.score = score;
  });

  function bestIn(keys){ const list = candidates.filter(c=>keys.includes(c.key)); if(list.length===0) return null; list.sort((a,b)=>b.score-a.score); return list[0]; }
  const best1x2 = bestIn(['home','draw','away']);
  const bestHdp = bestIn(['hdpHome','hdpAway']);
  const bestOu = bestIn(['over','under']);

  function formatRec(c){
    if(!c) return null;
    const reasonParts=[];
    if(c.val !== null && c.val >=5) reasonParts.push(`Value +${c.val.toFixed(1)}pp`);
    if(c.blend !== null && c.blend > 0.55) reasonParts.push(`Blended ${(c.blend*100).toFixed(1)}%`);
    if(reasonParts.length===0) reasonParts.push(`Blended ${(c.blend*100).toFixed(1)}%`);
    const kellyPct = (c.kelly*100).toFixed(1) + '%';
    return { pick: c.label, odds: c.odd || '--', prob: (c.blend*100).toFixed(1)+'%', valuePP: c.val!==null?c.val.toFixed(1)+' pp':'--', kelly: kellyPct, reason: reasonParts.join(' & ') };
  }

  return {
    best1x2: formatRec(best1x2),
    bestHdp: formatRec(bestHdp),
    bestOu: formatRec(bestOu),
    all: candidates.sort((a,b)=>b.score-a.score).map(c=>({label:c.label, prob:(c.blend*100).toFixed(1)+'%', valuePP: c.val!==null?c.val.toFixed(1)+' pp':'--', kelly:(c.kelly*100).toFixed(1)+'%'}))
  };
}

/* ---------------- main analysis ---------------- */
let chart=null;
function analyzeAll(){
  // read inputs
  const oh = parseFloat(document.getElementById('oddsHome').value);
  const od = parseFloat(document.getElementById('oddsDraw').value);
  const oa = parseFloat(document.getElementById('oddsAway').value);
  const hh = parseFloat(document.getElementById('hdpHome').value);
  const ha = parseFloat(document.getElementById('hdpAway').value);
  const ov = parseFloat(document.getElementById('over').value);
  const un = parseFloat(document.getElementById('under').value);
  const golHome = parseFloat(document.getElementById('golHome').value) || 0;
  const kebHome = parseFloat(document.getElementById('kebHome').value) || 0;
  const golAway = parseFloat(document.getElementById('golAway').value) || 0;
  const kebAway = parseFloat(document.getElementById('kebAway').value) || 0;
  let matches = parseInt(document.getElementById('matchCount').value) || 5;
  const bankroll = parseFloat(document.getElementById('bankroll').value) || 100;

  if(matches <= 0) matches = 5;

  // model lambdas
  const avgGoalsHome = golHome / matches;
  const avgConcedeAway = kebAway / matches;
  const avgGoalsAway = golAway / matches;
  const avgConcedeHome = kebHome / matches;
  let lambdaHome = (avgGoalsHome + avgConcedeAway) / 2;
  let lambdaAway = (avgGoalsAway + avgConcedeHome) / 2;
  lambdaHome = Math.max(0.2, lambdaHome);
  lambdaAway = Math.max(0.2, lambdaAway);

  const match = computeMatchProbs(lambdaHome, lambdaAway, 10);
  const model = {
    home: match.pHome,
    draw: match.pDraw,
    away: match.pAway,
    overProb: (function(){ if(isNaN(ov)) return null; let p=0; for(let t=Math.round(ov)+1;t<match.totalDist.length;t++) p+=match.totalDist[t]; return p; })(),
    underProb: (function(){ if(isNaN(un)) return null; let p=0; for(let t=0;t<=Math.round(un);t++) p+=match.totalDist[t]; return p; })(),
    btts: match.pBoth
  };

  // market fair
  const market = {};
  if(!isNaN(oh) && !isNaN(od) && !isNaN(oa)){
    const fair = fairifyOddsArray([oh,od,oa]);
    market.home = fair[0]; market.draw = fair[1]; market.away = fair[2];
  }
  if(!isNaN(ov) && !isNaN(un)){
    const f = fairifyTwo(ov,un);
    market.over = f[0]; market.under = f[1];
  }
  if(!isNaN(hh) && !isNaN(ha)){
    const f2 = fairifyTwo(hh,ha);
    market.hdpHome = f2[0]; market.hdpAway = f2[1];
  }

  // blend
  const wm = 0.6, wk = 0.4;
  function blend(mkt, mdl){ return (mkt==null)?mdl:(mdl==null)?mkt: wm*mdl + wk*mkt; }
  const blended = {
    home: blend(market.home, model.home),
    draw: blend(market.draw, model.draw),
    away: blend(market.away, model.away),
    over: blend(market.over, model.overProb),
    under: blend(market.under, model.underProb),
    hdpHome: market.hdpHome,
    hdpAway: market.hdpAway,
    btts: model.btts
  };

  // populate table
  const body = document.getElementById('tbody'); body.innerHTML = '';
  function pct(x){ return x==null ? '--' : (x*100).toFixed(1)+'%'; }
  body.innerHTML += `<tr><td>Model</td><td>${pct(model.home)}</td><td>${pct(model.draw)}</td><td>${pct(model.away)}</td>
    <td>${pct(model.overProb)}</td><td>${pct(model.underProb)}</td><td>${pct(model.btts)}</td></tr>`;
  body.innerHTML += `<tr><td>Market (fair)</td><td>${pct(market.home)}</td><td>${pct(market.draw)}</td><td>${pct(market.away)}</td>
    <td>${pct(market.over)}</td><td>${pct(market.under)}</td><td>--</td></tr>`;
  body.innerHTML += `<tr><td>Blended</td><td>${pct(blended.home)}</td><td>${pct(blended.draw)}</td><td>${pct(blended.away)}</td>
    <td>${pct(blended.over)}</td><td>${pct(blended.under)}</td><td>${pct(blended.btts)}</td></tr>`;
  document.getElementById('tbl').style.display = 'table';

  // odds object for rec function
  const oddsObj = { home: oh, draw: od, away: oa, over: ov, under: un, hdpHome: hh, hdpAway: ha };

  const recs = computeRecommendations(market, blended, oddsObj);

  // display recommendations
  const rcont = document.getElementById('rekomContainer'); rcont.style.display = 'block';
  function showRec(slotId, recObj){
    const el = document.getElementById(slotId);
    if(!recObj){ el.innerHTML = '<div style="color:#666">Tidak ada rekomendasi</div>'; return; }
    // determine label class
    const valNum = parseFloat(recObj.valuePP) || 0;
    const probNum = parseFloat(recObj.prob) || 0;
    const scoreType = (valNum >= 5) ? 'Strong' : (probNum > 55 ? 'Good' : 'Watch');
    const cls = scoreType==='Strong' ? 'reco-strong' : 'reco-good';
    el.innerHTML = `<div class="${cls}"><b>${recObj.pick}</b> — Prob ${recObj.prob} — Odds ${recObj.odds} — Kelly ${recObj.kelly} — ${recObj.reason}</div>`;
  }

  showRec('rekom1', recs.best1x2);
  showRec('rekom2', recs.bestHdp);
  showRec('rekom3', recs.bestOu);

  document.getElementById('rekomAll').textContent = 'All candidates: ' + recs.all.map(a=>`${a.label} ${a.prob} (${a.valuePP})`).join(' | ');

  // chart
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type: 'bar',
    data: {
      labels: ['Home','Draw','Away'],
      datasets: [
        { label: 'Market', data: [market.home||0, market.draw||0, market.away||0], backgroundColor: '#FFC107' },
        { label: 'Model', data: [model.home, model.draw, model.away], backgroundColor: '#4CAF50' },
        { label: 'Blended', data: [blended.home, blended.draw, blended.away], backgroundColor: '#1976D2' }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}} }
  });

  // summary
  document.getElementById('hasil').textContent =
    `Lambda Home: ${lambdaHome.toFixed(2)} | Lambda Away: ${lambdaAway.toFixed(2)}
H2H Manual:
${document.getElementById('h2hText').value || '-'}
(Blended = 0.6×Model + 0.4×Market)`;
}
</script>
</body>
</html>
