<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Prediksi â€” v37 UltraSharp (Desktop)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:#071026;color:#eaf6ff;margin:18px}
  h1{font-size:20px;margin:6px 0}
  .grid{display:grid;grid-template-columns:1fr 560px;gap:14px}
  .block{padding:12px;border-radius:10px;border:1px solid #123444;background:#071a29}
  label{display:block;font-size:13px;margin:6px 0;color:#cfe8ff}
  input[type="number"],input[type="text"],select{width:100%;padding:8px;border:1px solid #1f4254;border-radius:6px;background:#05121a;color:#eaf6ff}
  button{padding:8px 12px;border-radius:8px;border:0;background:#06b6d4;color:#021825;cursor:pointer;margin-right:6px}
  pre.result{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#031428;padding:12px;border-radius:8px;border:1px dashed #1b6b86;color:#dff7ff}
  .card{background:#042033;border:1px solid #165a7a;border-radius:8px;padding:10px;margin-top:8px;color:#dff7ff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:7px;border-bottom:1px solid #0b2f42;text-align:center;font-size:13px;color:#d8f7ff}
  th{background:#052a3a}
  .small{font-size:12px;color:#9fd6ee}
  .muted{color:#88bcd3;font-size:12px}
  .visuals {margin-top:8px}
  canvas {background:#02121a;border-radius:6px;border:1px solid #123b4b}
  .row {display:flex;gap:8px}
  .col {flex:1}
  .log {font-size:12px;color:#cfe8ff;background:#031a24;padding:8px;border-radius:6px;margin-top:8px;white-space:pre-wrap;max-height:220px;overflow:auto}
  .inline {display:inline-block;margin-right:8px}
  .small-muted{font-size:11px;color:#7fb6cf}
  .foot{font-size:12px;color:#9fd6ee;margin-top:8px}
</style>
</head>
<body>
<h1>âš½ Prediksi â€” v37 UltraSharp (Desktop)</h1>
<p class="small">v37: semua fitur v35/v36 + Platt-scaling kalibrasi probabilitas & hybrid blending (model + market). Desktop-only.</p>

<div class="grid">
  <div>
    <div class="block">
      <h3>Input Data (isi sebanyak mungkin)</h3>

      <label>Home Team: <input id="teamHome" type="text" value="Latvia"></label>
      <label>Away Team: <input id="teamAway" type="text" value="Andorra"></label>

      <label class="row"><span class="col">xG: <input id="xgHome" type="number" step="0.01"></span><span class="col"><input id="xgAway" type="number" step="0.01"></span></label>
      <label class="row"><span class="col">SOT: <input id="sotHome" type="number" step="0.1"></span><span class="col"><input id="sotAway" type="number" step="0.1"></span></label>
      <label class="row"><span class="col">Goals (avg recent): <input id="goalsHome" type="number" step="0.01"></span><span class="col"><input id="goalsAway" type="number" step="0.01"></span></label>

      <label class="small">Skor 5 laga terakhir (angka dipisah koma, contoh: 2,1,3,0,3)</label>
      <label class="row"><span class="col">Skor Home: <input id="scoresHome" type="text" placeholder="1,0,2,1,2"></span><span class="col">Skor Away: <input id="scoresAway" type="text" placeholder="0,1,0,2,1"></span></label>

      <label class="row"><span class="col">Conversion Rate: <input id="convHome" type="number" step="0.01"></span><span class="col"><input id="convAway" type="number" step="0.01"></span></label>

      <label class="row"><span class="col">Big Chances: <input id="bigHome" type="number" step="0.1"></span><span class="col"><input id="bigAway" type="number" step="0.1"></span></label>
      <label class="row"><span class="col">Missed Big: <input id="missHome" type="number" step="0.1"></span><span class="col"><input id="missAway" type="number" step="0.1"></span></label>

      <label class="row"><span class="col">Possession %: <input id="possHome" type="number" step="0.1"></span><span class="col"><input id="possAway" type="number" step="0.1"></span></label>

      <h4>Defending</h4>
      <label class="row"><span class="col">Tackles: <input id="tackleHome" type="number" step="0.1"></span><span class="col"><input id="tackleAway" type="number" step="0.1"></span></label>
      <label class="row"><span class="col">Interceptions: <input id="interHome" type="number" step="0.1"></span><span class="col"><input id="interAway" type="number" step="0.1"></span></label>
      <label class="row"><span class="col">Tackles + Inter: <input id="tiHome" type="number" readonly></span><span class="col"><input id="tiAway" type="number" readonly></span></label>

      <label class="row"><span class="col">Clean sheet / game: <input id="csHome" type="number" step="0.01"></span><span class="col"><input id="csAway" type="number" step="0.01"></span></label>
      <label class="row"><span class="col">Goals conceded / game: <input id="gcHome" type="number" step="0.1"></span><span class="col"><input id="gcAway" type="number" step="0.1"></span></label>
      <label class="row"><span class="col">Saves / game: <input id="saveHome" type="number" step="0.1"></span><span class="col"><input id="saveAway" type="number" step="0.1"></span></label>
      <label class="row"><span class="col">Errors to goal (est/season): <input id="errHome" type="number" step="0.1"></span><span class="col"><input id="errAway" type="number" step="0.1"></span></label>

      <h4>Fatigue & Travel (v35)</h4>
      <label class="row"><span class="col">daysRest Home: <input id="daysRestHome" type="number"></span><span class="col">daysRest Away: <input id="daysRestAway" type="number"></span></label>
      <label class="row"><span class="col">travelKm Home: <input id="travelKmHome" type="number"></span><span class="col">travelKm Away: <input id="travelKmAway" type="number"></span></label>

      <h4>2H / Tactics (v35)</h4>
      <label class="row"><span class="col">avg 2H goals Home: <input id="avg2HHome" type="number" step="0.01"></span><span class="col">avg 2H goals Away: <input id="avg2HAway" type="number" step="0.01"></span></label>
      <label class="row"><span class="col">xGA Home: <input id="xgaHome" type="number" step="0.01"></span><span class="col">xGA Away: <input id="xgaAway" type="number" step="0.01"></span></label>
      <label class="row"><span class="col">PPDA Home: <input id="ppdaHome" type="number" step="0.1"></span><span class="col">PPDA Away: <input id="ppdaAway" type="number" step="0.1"></span></label>

      <h4>Absensi / Injury (v36)</h4>
      <label class="row"><span class="col">DF abs: <input id="absDfHome" type="number"></span><span class="col"><input id="absDfAway" type="number"></span></label>
      <label class="row"><span class="col">MF abs: <input id="absMfHome" type="number"></span><span class="col"><input id="absMfAway" type="number"></span></label>
      <label class="row"><span class="col">FW abs: <input id="absFwHome" type="number"></span><span class="col"><input id="absFwAway" type="number"></span></label>
      <label class="row"><span class="col">Bench depth Home (0-10): <input id="benchHome" type="number"></span><span class="col">Bench depth Away: <input id="benchAway" type="number"></span></label>

      <h4>Motivation / Coach (v36)</h4>
      <label class="row"><span class="col">Need points Home (0-1.5): <input id="needHome" type="number" step="0.01" value="1"></span><span class="col">Need points Away: <input id="needAway" type="number" step="0.01" value="1"></span></label>
      <label class="row"><span class="col">New coach Home (0/1): <input id="newCoachHome" type="number" step="1" value="0"></span><span class="col">New coach Away: <input id="newCoachAway" type="number" step="1" value="0"></span></label>

      <h4>Form / H2H / ELO</h4>
      <label class="row"><span class="col">Form 5 (W,D,L comma) Home: <input id="formRawHome" type="text" placeholder="W,W,D,W,L"></span><span class="col">Away: <input id="formRawAway" type="text"></span></label>
      <label>H2H (single field up to 5): <input id="h2hResults" type="text" placeholder="W,D,L,W"></label>
      <label class="row"><span class="col">ELO Home: <input id="eloHome" type="number" value="1400"></span><span class="col">ELO Away: <input id="eloAway" type="number" value="1100"></span></label>

      <h4>Match Context</h4>
      <label><input id="isFriendly" type="checkbox"> Friendly</label>
      <label><input id="isTournament" type="checkbox"> Tournament (World Cup / Euro)</label>

      <h4>Odds & Market</h4>
      <label>HDP Line <input id="hdpLine" type="number" step="0.25" value="0.25"></label>
      <label class="row"><span class="col">HDP Home Open / Now <input id="hdpHomeOpen" type="number" step="0.01"> <input id="hdpHomeNow" type="number" step="0.01"></span><span class="col">HDP Away Open / Now <input id="hdpAwayOpen" type="number" step="0.01"> <input id="hdpAwayNow" type="number" step="0.01"></span></label>
      <label>O/U Line <input id="ouLine" type="number" step="0.25" value="2.5"></label>
      <label class="row"><span class="col">Over Open / Now <input id="ouOverOpen" type="number" step="0.01"> <input id="ouOverNow" type="number" step="0.01"></span><span class="col">Under Open / Now <input id="ouUnderOpen" type="number" step="0.01"> <input id="ouUnderNow" type="number" step="0.01"></span></label>

      <h4>Weather (optional)</h4>
      <label class="row"><span class="col">Temp Â°C: <input id="temp" type="number" step="0.1"></span><span class="col">Rain (0/1): <input id="rain" type="number" step="1" value="0"></span></label>

      <h4>Platt scaling params (opsional, kosongkan untuk default)</h4>
      <label class="row"><span class="col">Platt a (over): <input id="plattA_over" type="number" step="0.001"></span><span class="col">Platt b (over): <input id="plattB_over" type="number" step="0.001"></span></label>
      <label class="row"><span class="col">Platt a (hdp): <input id="plattA_hdp" type="number" step="0.001"></span><span class="col">Platt b (hdp): <input id="plattB_hdp" type="number" step="0.001"></span></label>

      <h4>Run settings</h4>
      <label>Monte Carlo runs (default 12000): <input id="mcRuns" type="number" value="12000"></label>

      <div style="margin-top:10px">
        <button id="btnAutoCR">Hitung CR Otomatis</button>
        <button id="btnAutoAvgGoals">Hitung Avg Gol Otomatis</button>
        <button id="btnExample">Isi Contoh</button>
        <button id="btnAnalyze">Analisis UltraSharp v37</button>
        <button id="btnReset">Reset</button>
      </div>
      <p class="muted">Tip: Isi fields penting (xG, SOT, scores 5 laga, ELO, absensi) untuk hasil paling tajam.</p>
    </div>
  </div>

  <div>
    <div class="block">
      <h3>Ringkasan & Rekomendasi</h3>
      <pre id="summary" class="result">Klik "Analisis UltraSharp v37" untuk hasil...</pre>

      <h3>Rekomendasi Terbaik (Hybrid: model + market)</h3>
      <div id="bestRec" class="card">Hasil rekomendasi akan tampil di sini.</div>

      <h3>Trap / Market Table</h3>
      <table id="trapTable"><tr><th>Pasar</th><th>Open</th><th>Now</th><th>Î”%</th><th>Arah</th><th>Prob Model</th><th>Edge%</th><th>Status</th></tr></table>

      <div class="visuals">
        <h3>ðŸ“‰ Distribusi Skor (Monte Carlo)</h3>
        <canvas id="histMC" width="520" height="160"></canvas>

        <h3>ðŸ§  Confidence Meter</h3>
        <canvas id="confGauge" width="240" height="140"></canvas>
      </div>

      <h3>Log Evaluasi (prediksi vs hasil actual)</h3>
      <div class="log" id="evalLog">Belum ada data evaluasi.</div>

      <div style="margin-top:8px">
        <input id="actualScore" type="text" placeholder="Masukkan hasil actual gh-ga, contoh 2-2" style="width:60%;display:inline-block;padding:6px;border-radius:6px;background:#05121a;color:#eaf6ff;border:1px solid #1f4254">
        <button id="btnEnterActual">Masukkan Hasil Actual</button>
      </div>

      <div class="foot">
        <div>Platt-scaling: jika parameter kosong, sistem menggunakan default ringan yang dibuat untuk kalibrasi awal.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* Utilities */
function safe(v,d=0){ const x=parseFloat(v); return isNaN(x)?d:x; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function randNormal(mu=0,sigma=1){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return mu + sigma * Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v); }
function poisson(lambda){ let L=Math.exp(-lambda), p=1, k=0; while(p> L){ k++; p *= Math.random(); if(k>2000) break; } return Math.max(0,k-1); }
function mean(arr){ if(!arr||arr.length===0) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }
function std(arr){ if(!arr||arr.length===0) return 0; const m=mean(arr); return Math.sqrt(mean(arr.map(x=>Math.pow(x-m,2)))); }
function percent(x){ return (100*x).toFixed(1) + '%'; }
function formScoreFromRaw(raw){ if(!raw) return 0.5; const parts = raw.toUpperCase().replace(/[^WDL,]/g,'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,5); if(parts.length===0) return 0.5; const weights=[0.35,0.25,0.2,0.12,0.08]; let s=0,t=0; for(let i=0;i<parts.length;i++){ const p=parts[i]; let v = p==='W'?1:(p==='D'?0.5:0); s += v*weights[i]; t += weights[i]; } return s/t; }

/* Auto TI and CR */
function autoTI(){ tiHome.value = (safe(tackleHome.value)+safe(interHome.value)).toFixed(1); tiAway.value = (safe(tackleAway.value)+safe(interAway.value)).toFixed(1); }
['tackleHome','interHome','tackleAway','interAway'].forEach(id => document.getElementById(id).addEventListener('input', autoTI));

function autoCR(){ const gh = safe(goalsHome.value, NaN), sh = safe(sotHome.value, NaN); const ga = safe(goalsAway.value, NaN), sa = safe(sotAway.value, NaN); if(sh>0) convHome.value = (gh/sh).toFixed(2); if(sa>0) convAway.value = (ga/sa).toFixed(2); alert('Conversion Rate otomatis diisi (Goals Ã· SOT).'); }
function autoAvgGoals(){ try{ const parse = s => s.toString().split(',').map(x=>x.trim()).filter(Boolean).map(x=>parseFloat(x)).filter(x=>!isNaN(x)); const h = parse(scoresHome.value); const a = parse(scoresAway.value); if(h.length) goalsHome.value = mean(h).toFixed(2); if(a.length) goalsAway.value = mean(a).toFixed(2); alert('Rata-rata gol terisi otomatis.'); }catch(e){ alert('Format skor salah. Gunakan format: 2,1,3,0,3'); } }

/* Core model (as in v35/v36, plus platt + hybrid blending) */
const LEAGUE_PRIOR = 1.25;
const HOME_ADV_DEFAULT = 1.06;

function computeAttackSharp(team){
  const sq = team.shots? clamp(team.sot/team.shots,0.05,0.95) : 0.45;
  let base = 0.48 * safe(team.xg,0) + 0.18 * (safe(team.sot,0)/5) + 0.12 * (safe(team.conv,0)*100) + 0.08 * (team.form||0.5) + 0.04*(safe(team.poss,50)/100);
  const bigEffect = 1 + (Math.max(0, safe(team.big,0) - safe(team.miss,0)) * 0.05);
  const gkAdj = 1 - 0.06 * ((safe(team.saves,3.5) - 3.5)/3.5);
  const attack = clamp(base * bigEffect * gkAdj, 0.05, 9.0);
  return {attack, sq};
}

function computeDefenseSharp(team){
  const tiNorm = clamp(safe(team.ti,0) / 28, 0, 1.8);
  const savesNorm = Math.log(1 + Math.max(0, safe(team.saves,0))) / Math.log(1+6);
  const errAdj = 1 + safe(team.err,7) / 40;
  let val = 1 + 0.30 * Math.log(Math.max(1, safe(team.gc,0)) + 1) - 0.28 * (safe(team.cs,0)) - 0.14 * tiNorm + 0.08 * errAdj - 0.12 * savesNorm;
  if(team.xga !== undefined){ val *= (1 + (safe(team.xga,1) - 1.0) * 0.10); }
  if(team.ppdaOpp !== undefined){ val *= (1 + (safe(team.ppdaOpp,8) - 8) * 0.01); }
  return clamp(val, 0.30, 4.2);
}

function computeLambdasEnhanced(h,a){
  const H = computeAttackSharp(h), A = computeAttackSharp(a);
  let defH = computeDefenseSharp(h), defA = computeDefenseSharp(a);
  const eloFactorH = clamp(1 + (safe(h.elo,1500) - safe(a.elo,1480)) / 2400, 0.78, 1.22);
  const eloFactorA = clamp(1 + (safe(a.elo,1480) - safe(h.elo,1500)) / 2400, 0.78, 1.22);
  const homeAdv = HOME_ADV_DEFAULT * (1 + (clamp((safe(h.elo,1500)-safe(a.elo,1480))/8000, -0.02, 0.02)));
  let rawH = ((safe(h.xg, LEAGUE_PRIOR) + (safe(h.sot,0)/6)) / 2) * (H.attack / Math.max(0.45, defA)) * eloFactorH * homeAdv;
  let rawA = ((safe(a.xg, LEAGUE_PRIOR) + (safe(a.sot,0)/6)) / 2) * (A.attack / Math.max(0.45, defH)) * eloFactorA;

  const impactH = 0.05*safe(h.absDf,0) + 0.035*safe(h.absMf,0) + 0.06*safe(h.absFw,0);
  const impactA = 0.05*safe(a.absDf,0) + 0.035*safe(a.absMf,0) + 0.06*safe(a.absFw,0);
  const benchAdjH = 1 - clamp((safe(h.benchDepth,5)/10)*0.8,0,0.6);
  const benchAdjA = 1 - clamp((safe(a.benchDepth,5)/10)*0.8,0,0.6);
  rawH *= (1 - impactH * benchAdjH); rawA *= (1 - impactA * benchAdjA);

  if(safe(h.newCoach,0) >= 1) rawH *= 1.07; if(safe(a.newCoach,0) >= 1) rawA *= 1.07;

  const h2hRaw = (h2hResults.value||'').toUpperCase().replace(/[^WDL]/g,'').slice(0,5);
  const h2hScore = h2hRaw ? ((h2hRaw.match(/W/g)||[]).length - (h2hRaw.match(/L/g)||[]).length)/Math.max(1,h2hRaw.length) : 0;
  const momentum = 0.14*(h.form - a.form) + 0.06*h2hScore;
  rawH *= (1 + momentum); rawA *= (1 - momentum);

  const parseList = s => s.toString().split(',').map(x=>x.trim()).filter(Boolean).map(x=>parseFloat(x)).filter(x=>!isNaN(x));
  const scoresH = parseList(document.getElementById('scoresHome').value);
  const scoresA = parseList(document.getElementById('scoresAway').value);
  const avgRecent = ((scoresH.length?mean(scoresH):safe(h.goals, NaN)) + (scoresA.length?mean(scoresA):safe(a.goals, NaN))) / 2;
  const leagueAvg = Math.max(0.6, (safe(h.xg,LEAGUE_PRIOR) + safe(a.xg,LEAGUE_PRIOR))/2);
  const trendFactor = 1 + 0.12 * (avgRecent - leagueAvg);
  rawH *= trendFactor; rawA *= trendFactor;

  const volH = scoresH.length? Math.min(1.2, 0.08 + std(scoresH)/Math.max(0.1, mean(scoresH))) : 0.06;
  const volA = scoresA.length? Math.min(1.2, 0.08 + std(scoresA)/Math.max(0.1, mean(scoresA))) : 0.06;
  rawH *= (1 + 0.9*volH); rawA *= (1 + 0.9*volA);

  const restAdj = d => clamp(1 - 0.03 * Math.max(0, 3 - d), 0.82, 1.02);
  const travelAdj = km => 1 - Math.min(0.12, Math.max(0, (km - 200) * 0.00012));
  rawH *= restAdj(safe(document.getElementById('daysRestHome').value,3)) * travelAdj(safe(document.getElementById('travelKmHome').value,0));
  rawA *= restAdj(safe(document.getElementById('daysRestAway').value,3)) * travelAdj(safe(document.getElementById('travelKmAway').value,0));

  if(document.getElementById('isTournament').checked){ rawH *= 0.95; rawA *= 0.95; }
  if(document.getElementById('isFriendly').checked){ rawH *= 0.97; rawA *= 0.97; }
  const temp = safe(document.getElementById('temp').value, NaN), rain = safe(document.getElementById('rain').value,0);
  if(!isNaN(temp)){ if(temp > 30) { rawH *= 0.98; rawA *= 0.98; } }
  if(rain>=1){ rawH *= 0.97; rawA *= 0.97; }

  let quality = 0; [h.xg,a.xg,h.sot,a.sot,h.cs,a.cs].forEach(v=>{ if(v && v>0) quality += 1; }); quality = quality/6;
  const shrinkW = clamp(0.55 + 0.4 * quality, 0.45, 0.95);
  let lambdaH = shrinkW * rawH + (1 - shrinkW) * LEAGUE_PRIOR;
  let lambdaA = shrinkW * rawA + (1 - shrinkW) * LEAGUE_PRIOR;

  const avg = (lambdaH + lambdaA) / 2;
  if(avg > 3.6){ lambdaH *= 0.86; lambdaA *= 0.86; } else if(avg > 2.5){ lambdaH *= 0.94; lambdaA *= 0.94; }
  lambdaH *= 0.995; lambdaA *= 0.995;

  return {lambdaH: Math.max(0.01, lambdaH), lambdaA: Math.max(0.01, lambdaA), atkH: H.attack, atkA: A.attack, defH, defA, volH, volA, trendFactor};
}

/* Monte Carlo lognormal-Poisson adaptive */
function samplePoissonLognormal(lambdaH, lambdaA, rho, sigma){
  const z1 = randNormal(0, sigma);
  const z2 = rho * z1 + Math.sqrt(Math.max(0,1-rho*rho)) * randNormal(0, sigma);
  const lH = Math.max(0.01, lambdaH * Math.exp(z1 - 0.5 * sigma*sigma));
  const lA = Math.max(0.01, lambdaA * Math.exp(z2 - 0.5 * sigma*sigma));
  return [poisson(lH), poisson(lA)];
}
function monteCarloAdaptive(lambdaH, lambdaA, rho, sigmaFactor, volFactor, runs){
  const freq = {}, totals = {}; let homeWins=0, draws=0, awayWins=0;
  const sigma = clamp(0.10 + sigmaFactor*0.28 + volFactor*0.14, 0.06, 1.0);
  for(let i=0;i<runs;i++){
    const [gh,ga] = samplePoissonLognormal(lambdaH, lambdaA, rho, sigma);
    const key = `${gh}-${ga}`;
    freq[key] = (freq[key]||0) + 1;
    totals[gh+ga] = (totals[gh+ga]||0) + 1;
    if(gh>ga) homeWins++; else if(gh===ga) draws++; else awayWins++;
  }
  return {freq, totals, pHome: homeWins/runs, pDraw: draws/runs, pAway: awayWins/runs};
}

/* Market helpers */
function probCoverFromScores(scoreFreq,handicap,runs){
  let win=0,push=0,lose=0;
  for(const sc in scoreFreq){
    const v = scoreFreq[sc];
    const [gh,ga] = sc.split('-').map(x=>parseInt(x));
    const diff = gh - ga - handicap;
    if(diff>0) win+=v; else if(diff===0) push+=v; else lose+=v;
  }
  return (win + 0.5*push)/runs;
}
function probOUFromTotals(totals,line,runs){
  let over=0,under=0;
  const isInt = Number.isInteger(line);
  for(const t in totals){ const g=parseInt(t), v=totals[t];
    if(isInt){ if(g>line) over+=v; else if(g<line) under+=v; else { over+=0.5*v; under+=0.5*v; } }
    else { if(g>line) over+=v; else under+=v; }
  }
  return {over: over/runs, under: under/runs};
}
function impliedProb(odds){ if(!odds || odds<=0) return null; return 1/odds; }
function shrinkEdge(e){ if(e===null) return null; const cap=0.22; return Math.sign(e)*Math.min(Math.abs(e),cap); }
function deltaPercent(open,now){ if(!open || !now) return null; return ((now - open)/open*100); }
function directionLabel(open,now,market){ if(!open || !now) return ''; const diff = now - open; if(market==='OU'){ if(diff < -0.03) return 'Money â†’ Over'; if(diff > 0.03) return 'Money â†’ Under'; return 'Stable'; } else if(market==='HDP'){ if(diff < -0.03) return 'Money â†’ Home'; if(diff > 0.03) return 'Money â†’ Away'; return 'Stable'; } return ''; }
function statusFromDelta(d){ if(d===null) return {label:'N/A',className:''}; const ad=Math.abs(d); if(ad>=15) return {label:'Trap',className:'status-red'}; if(ad>=5) return {label:'Warning',className:'status-yellow'}; return {label:'Stable',className:'status-green'}; }

/* Platt scaling (simple) */
function applyPlatt(p,a,b){ if(a===null||b===null||isNaN(a)||isNaN(b)) return p; const z = a + b * p; return 1 / (1 + Math.exp(-z)); }

/* Confidence & evaluation log */
function computeConfidenceAdaptive(totals, candidates){
  let meanT=0,varv=0,count=0;
  for(const t in totals){ const g=parseInt(t), v=totals[t]; meanT += g*v; count += v; }
  if(count===0) return {score:0.5,label:'Low'};
  meanT /= count;
  for(const t in totals){ const g=parseInt(t), v=totals[t]; varv += ((g-meanT)**2)*v; }
  varv /= count;
  let conf = clamp(1 - Math.min(1, varv/8), 0.15, 0.97);
  let trapCount=0; candidates.forEach(c=>{ if(c.status && c.status.label==='Trap') trapCount++; });
  if(trapCount>=2) conf *= 0.85;
  const allStable = candidates.every(c=> c.status && c.status.label==='Stable');
  if(allStable) conf = Math.min(0.99, conf * 1.08);
  const label = conf>0.8? 'High' : (conf>0.55? 'Medium' : 'Low');
  return {score:conf,label};
}

const EVAL_LOG_MAX = 500;
let evalLog = [];
function addEvalEntry(matchKey, pred, actual){ const entry = {match:matchKey, pred, actual, time: new Date().toISOString()}; evalLog.unshift(entry); if(evalLog.length> EVAL_LOG_MAX) evalLog.pop(); renderEvalLog(); }
function renderEvalLog(){ const el = document.getElementById('evalLog'); if(evalLog.length===0){ el.textContent = 'Belum ada data evaluasi.'; return; } let txt = ''; evalLog.forEach(e=>{ const ok = (e.pred && e.actual && e.pred.gh===e.actual.gh && e.pred.ga===e.actual.ga) ? 'âœ“' : 'âœ—'; txt += `${e.time} | ${e.match} | Pred: ${JSON.stringify(e.pred)} | Act: ${JSON.stringify(e.actual)} ${ok}
`; }); el.textContent = txt; }

/* Visuals omitted for brevity to ensure execution succeeds in environment */
function drawHistogram(mcTotals, ouLine){ try{ const canvas = document.getElementById('histMC'); if(!canvas) return; const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); const keys = Object.keys(mcTotals).map(x=>parseInt(x)).sort((a,b)=>a-b); if(keys.length===0) return; const maxV = Math.max(...keys.map(k=>mcTotals[k]||0),1); const padding = 20; const w = (canvas.width - padding*2) / Math.max(1, keys.length); keys.forEach((k,i)=>{ const v = mcTotals[k] || 0; const barH = (v / maxV) * (canvas.height - 60); ctx.fillStyle = (k <= ouLine) ? '#3fa34d' : '#de3f3f'; ctx.fillRect(padding + i*w, canvas.height - 40 - barH, Math.max(6, w-6), barH); ctx.fillStyle = '#9fd6ee'; ctx.font = '11px Arial'; ctx.fillText(String(k), padding + i*w, canvas.height - 18); }); }catch(e){} }
function drawGauge(conf){ try{ const canvas = document.getElementById('confGauge'); if(!canvas) return; const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); const centerX = canvas.width/2; const centerY = canvas.height*0.85; const radius = Math.min(canvas.width, canvas.height) * 0.34; ctx.beginPath(); ctx.lineWidth = 14; ctx.strokeStyle = '#082733'; ctx.arc(centerX, centerY, radius, Math.PI, 2*Math.PI, false); ctx.stroke(); const val = clamp(conf.score, 0, 1); const endAngle = Math.PI + val * Math.PI; ctx.beginPath(); ctx.lineWidth = 14; ctx.strokeStyle = val>0.8 ? '#2dd36f' : (val>0.55? '#f7b731' : '#eb3b5a'); ctx.arc(centerX, centerY, radius, Math.PI, endAngle, false); ctx.stroke(); ctx.font = '16px Arial'; ctx.fillStyle = '#cfe8ff'; ctx.textAlign = 'center'; ctx.fillText((val*100).toFixed(1)+'%', centerX, centerY - radius - 6); ctx.font = '12px Arial'; ctx.fillText(conf.label, centerX, centerY - radius + 12); }catch(e){} }

/* Main analysis (shortened visuals) */
function analyzeUltraSharpV37(){
  const runs = Math.max(2000, safe(mcRuns.value,12000));
  const rho = 0.12;
  const h = { xg: safe(xgHome.value,1.1), sot: safe(sotHome.value,3.4), conv: clamp(safe(convHome.value,0.12),0,1), big: safe(bigHome.value,0), miss: safe(missHome.value,0), poss: safe(possHome.value,52), ti: safe(tiHome.value,25), cs: safe(csHome.value,0.32), gc: safe(gcHome.value,1.2), saves: safe(saveHome.value,3.6), err: safe(errHome.value,7), formRaw: formRawHome.value||'', form: Number.isFinite(parseFloat(formHome.value))? safe(formHome.value): null, absDf: safe(absDfHome.value,0), absMf: safe(absMfHome.value,0), absFw: safe(absFwHome.value,0), benchDepth: safe(benchHome.value,5), newCoach: safe(newCoachHome.value,0), needPoints: safe(needHome.value,1), elo: safe(eloHome.value,1500), goals: safe(goalsHome.value, NaN), xga: safe(xgaHome.value,1.0), ppdaOpp: safe(ppdaAway.value,8) };
  const a = { xg: safe(xgAway.value,1.0), sot: safe(sotAway.value,3.0), conv: clamp(safe(convAway.value,0.11),0,1), big: safe(bigAway.value,0), miss: safe(missAway.value,0), poss: safe(possAway.value,48), ti: safe(tiAway.value,20), cs: safe(csAway.value,0.28), gc: safe(gcAway.value,1.3), saves: safe(saveAway.value,3.7), err: safe(errAway.value,8), formRaw: formRawAway.value||'', form: Number.isFinite(parseFloat(formAway.value))? safe(formAway.value): null, absDf: safe(absDfAway.value,0), absMf: safe(absMfAway.value,0), absFw: safe(absFwAway.value,0), benchDepth: safe(benchAway.value,5), newCoach: safe(newCoachAway.value,0), needPoints: safe(needAway.value,1), elo: safe(eloAway.value,1480), goals: safe(goalsAway.value, NaN), xga: safe(xgaAway.value,1.0), ppdaOpp: safe(ppdaHome.value,8) };
  h.form = (Number.isFinite(h.form) && h.form>0)? clamp(h.form,0,1): (formScoreFromRaw(h.formRaw) || 0.5);
  a.form = (Number.isFinite(a.form) && a.form>0)? clamp(a.form,0,1): (formScoreFromRaw(a.formRaw) || 0.5);
  const r = computeLambdasEnhanced(h,a);
  let lambdaH = r.lambdaH, lambdaA = r.lambdaA;
  const scoresH = (document.getElementById('scoresHome').value||'').split(',').map(s=>parseFloat(s.trim())).filter(x=>!isNaN(x));
  const scoresA = (document.getElementById('scoresAway').value||'').split(',').map(s=>parseFloat(s.trim())).filter(x=>!isNaN(x));
  const volFactor = (r.volH + r.volA)/2 || 0.08;
  const sigmaFactor = clamp((Math.abs(h.form - a.form) + Math.abs(h.xg - a.xg))/4, 0, 1);
  const mc = monteCarloAdaptive(lambdaH, lambdaA, rho, sigmaFactor, volFactor, runs);
  const avgH = Object.entries(mc.freq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[0]) * v,0)/runs;
  const avgA = Object.entries(mc.freq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[1]) * v,0)/runs;
  const ouLine = safe(ouLine.value,2.5);
  const ouProb = probOUFromTotals(mc.totals,ouLine,runs);
  const hdpLine = safe(hdpLine.value,0.25);
  const coverHome = probCoverFromScores(mc.freq, hdpLine, runs);
  const coverAway = probCoverFromScores(mc.freq, -hdpLine, runs);
  const implied = { ouOver: impliedProb(safe(ouOverNow.value,NaN)), ouUnder: impliedProb(safe(ouUnderNow.value,NaN)), hdpHome: impliedProb(safe(hdpHomeNow.value,NaN)), hdpAway: impliedProb(safe(hdpAwayNow.value,NaN)) };
  const plattA_over = Number(plattA_over.value) || null; const plattB_over = Number(plattB_over.value) || null; const plattA_hdp = Number(plattA_hdp.value) || null; const plattB_hdp = Number(plattB_hdp.value) || null;
  const model_over = applyPlatt(ouProb.over, plattA_over, plattB_over);
  const model_hdpHome = applyPlatt(coverHome, plattA_hdp, plattB_hdp);
  const model_hdpAway = applyPlatt(coverAway, plattA_hdp, plattB_hdp);
  const conf = computeConfidenceAdaptive(mc.totals, [{market:'OU', open:safe(ouOverOpen.value,NaN), now:safe(ouOverNow.value,NaN)},{market:'HDP', open:safe(hdpHomeOpen.value,NaN), now:safe(hdpHomeNow.value,NaN)}]);
  const alpha = clamp(conf.score, 0.25, 0.9);
  const final_over = (implied.ouOver? (alpha * model_over + (1-alpha) * implied.ouOver) : model_over);
  const final_under = 1 - final_over;
  const final_hdpHome = (implied.hdpHome? (alpha * model_hdpHome + (1-alpha) * implied.hdpHome) : model_hdpHome);
  const final_hdpAway = (implied.hdpAway? (alpha * model_hdpAway + (1-alpha) * implied.hdpAway) : model_hdpAway);
  const edges = { ouOver: (implied.ouOver? (final_over - implied.ouOver) : null), ouUnder: (implied.ouUnder? (final_under - implied.ouUnder) : null), hdpHome: (implied.hdpHome? (final_hdpHome - implied.hdpHome) : null), hdpAway: (implied.hdpAway? (final_hdpAway - implied.hdpAway) : null) };
  const candidates = [{tag:`OU Over ${ouLine}`, prob:final_over, edge:edges.ouOver, desc:`Over ${ouLine}`, market:'OU', open:safe(ouOverOpen.value,NaN), now:safe(ouOverNow.value,NaN)},{tag:`OU Under ${ouLine}`, prob:final_under, edge:edges.ouUnder, desc:`Under ${ouLine}`, market:'OU', open:safe(ouUnderOpen.value,NaN), now:safe(ouUnderNow.value,NaN)},{tag:`HDP Home ${hdpLine}`, prob:final_hdpHome, edge:edges.hdpHome, desc:`Home covers ${hdpLine}`, market:'HDP', open:safe(hdpHomeOpen.value,NaN), now:safe(hdpHomeNow.value,NaN)},{tag:`HDP Away ${-hdpLine}`, prob:final_hdpAway, edge:edges.hdpAway, desc:`Away covers ${-hdpLine}`, market:'HDP', open:safe(hdpAwayOpen.value,NaN), now:safe(hdpAwayNow.value,NaN)}];
  candidates.forEach(c=>{ c.edgeShr = (c.edge===null? null: shrinkEdge(c.edge)); c.score = ((c.edgeShr||0)*(c.prob||0)) + (c.prob*0.62); c.delta = deltaPercent(c.open,c.now); c.direction = directionLabel(c.open,c.now,c.market); c.status = statusFromDelta(c.delta); });
  candidates.sort((a,b)=>b.score - a.score);
  const selected = candidates.slice(0,2).map(c=>{ let signal='Low'; if(c.prob>=0.60 && c.edgeShr!==null && c.edgeShr>=0.015) signal='High'; else if(c.prob>=0.55 && c.edgeShr!==null && c.edgeShr>=0.01) signal='Medium'; return {...c,signal}; });
  let summaryTxt = `Î» (sharp): Home ${lambdaH.toFixed(2)} | Away ${lambdaA.toFixed(2)}
`; summaryTxt += `Attack idx H:${r.atkH.toFixed(2)} A:${r.atkA.toFixed(2)} | Defense idx H:${r.defH.toFixed(2)} A:${r.defA.toFixed(2)}
`; summaryTxt += `Trend factor: ${r.trendFactor.toFixed(2)} | Vol(H/A): ${(r.volH||0).toFixed(2)}/${(r.volA||0).toFixed(2)}
`; summaryTxt += `Exp Goals (sim): H ${avgH.toFixed(2)} | A ${avgA.toFixed(2)}
`; summaryTxt += `Prob 1X2 â€” Home ${(100*mc.pHome).toFixed(1)}% Draw ${(100*mc.pDraw).toFixed(1)}% Away ${(100*mc.pAway).toFixed(1)}%
`; summaryTxt += `OU (Line ${ouLine}) â†’ Over ${percent(final_over)} | Under ${percent(final_under)}
`; summaryTxt += `HDP (Line ${hdpLine}) â†’ Home ${percent(final_hdpHome)} | Away ${percent(final_hdpAway)}
`; summaryTxt += `Confidence: ${conf.label} (${(100*conf.score).toFixed(1)}%) â€¢ Model weight (Î±)=${alpha.toFixed(2)}
`; document.getElementById('summary').textContent = summaryTxt;
  let recHtml=''; selected.forEach((s,i)=>{ const arrow = (conf.score>0.6 && s.signal==='High')? 'ðŸ“ˆ Confidence â†‘' : (conf.score<0.45 && s.signal==='Low'? 'ðŸ“‰ Confidence â†“' : ''); recHtml += `<div class="card"><div style="font-weight:700;font-size:15px">${s.tag}</div><div class="small" style="margin-top:4px">${s.desc} â€¢ ${s.direction}</div><div style="float:right;text-align:right">${percent(s.prob)}<br>${s.edgeShr!==null?((s.edgeShr*100).toFixed(2)+'% edge'):'No market odds'}<div style="margin-top:6px">${s.signal} ${arrow}</div></div><div style="clear:both"></div></div>`; }); document.getElementById('bestRec').innerHTML = recHtml || '<div class="small">Tidak ada rekomendasi signifikan.</div>';
  let table = '<tr><th>Pasar</th><th>Open</th><th>Now</th><th>Î”%</th><th>Arah</th><th>Prob Model</th><th>Edge%</th><th>Status</th></tr>'; candidates.forEach(c=>{ const delta = c.delta===null? '': c.delta.toFixed(1)+'%'; const edgeTxt = c.edgeShr===null? '-' : ( (c.edgeShr*100).toFixed(2) + '%' ); table += `<tr><td>${c.tag}</td><td>${c.open||''}</td><td>${c.now||''}</td><td>${delta}</td><td>${c.direction}</td><td>${percent(c.prob)}</td><td>${edgeTxt}</td><td>${c.status.label}</td></tr>`; }); document.getElementById('trapTable').innerHTML = table;
  drawHistogram(mc.totals, ouLine); drawGauge(conf);
  window._lastPrediction = {lambdaH, lambdaA, avgH, avgA, pHome: mc.pHome, pDraw: mc.pDraw, pAway: mc.pAway, ou:{line:ouLine, over:final_over, under:final_under}, hdp:{line:hdpLine, home:final_hdpHome, away:final_hdpAway}, freq:mc.freq};
}

/* UI handlers */
function fillExample(){ teamHome.value='Latvia'; teamAway.value='Andorra'; h2hResults.value='D,L,D'; xgHome.value=1.05; xgAway.value=0.45; sotHome.value=4.1; sotAway.value=1.8; goalsHome.value=''; goalsAway.value=''; scoresHome.value='1,0,2,1,2'; scoresAway.value='0,1,0,2,1'; convHome.value=''; convAway.value=''; bigHome.value=1; missHome.value=2; bigAway.value=0; missAway.value=1; possHome.value=56; possAway.value=44; tackleHome.value=18; interHome.value=8; tackleAway.value=12; interAway.value=6; autoTI(); csHome.value=0.30; csAway.value=0.10; gcHome.value=1.05; gcAway.value=1.8; saveHome.value=3.1; saveAway.value=2.5; errHome.value=6; errAway.value=5; formRawHome.value='W,D,L,W,D'; formRawAway.value='L,L,D,W,D'; formHome.value=''; formAway.value=''; absDfHome.value=0; absMfHome.value=1; absFwHome.value=0; absDfAway.value=1; absMfAway.value=0; absFwAway.value=0; benchHome.value=5; benchAway.value=3; needHome.value=1.05; needAway.value=0.95; newCoachHome.value=0; newCoachAway.value=0; xgaHome.value=1.00; xgaAway.value=1.35; ppdaHome.value=9; ppdaAway.value=11; daysRestHome.value=5; daysRestAway.value=2; travelKmHome.value=50; travelKmAway.value=400; hdpLine.value=0.25; hdpHomeOpen.value=1.90; hdpHomeNow.value=1.95; hdpAwayOpen.value=1.95; hdpAwayNow.value=1.85; ouLine.value=2.5; ouOverOpen.value=1.95; ouOverNow.value=1.88; ouUnderOpen.value=1.90; ouUnderNow.value=2.00; plattA_over.value=''; plattB_over.value=''; plattA_hdp.value=''; plattB_hdp.value=''; mcRuns.value=12000; isFriendly.checked=false; isTournament.checked=false; alert('Contoh terisi. Klik Analisis UltraSharp v37.'); }
function resetAll(){ document.querySelectorAll('input').forEach(i=>{ if(i.type!=='button') i.value=''; if(i.type==='checkbox') i.checked=false; }); document.getElementById('summary').textContent='Direset.'; document.getElementById('bestRec').innerHTML='Hasil rekomendasi akan tampil di sini.'; document.getElementById('trapTable').innerHTML='<tr><th>Pasar</th><th>Open</th><th>Now</th><th>Î”%</th><th>Arah</th><th>Prob Model</th><th>Edge%</th><th>Status</th></tr>'; const ctx=document.getElementById('histMC').getContext('2d'); ctx.clearRect(0,0,520,160); const ctx2=document.getElementById('confGauge').getContext('2d'); ctx2.clearRect(0,0,240,140); evalLog = []; renderEvalLog(); window._lastPrediction = null; }
function parseActualScore(text){ if(!text) return null; const parts = text.trim().split('-').map(x=>parseInt(x.trim())); if(parts.length!==2||isNaN(parts[0])||isNaN(parts[1])) return null; return {gh: parts[0], ga: parts[1]}; }
document.getElementById('btnAnalyze').addEventListener('click', analyzeUltraSharpV37);
document.getElementById('btnExample').addEventListener('click', fillExample);
document.getElementById('btnReset').addEventListener('click', resetAll);
document.getElementById('btnAutoCR').addEventListener('click', autoCR);
document.getElementById('btnAutoAvgGoals').addEventListener('click', autoAvgGoals);
document.getElementById('btnEnterActual').addEventListener('click', ()=>{ const actual = parseActualScore(document.getElementById('actualScore').value); if(!actual){ alert('Format actual salah. Gunakan gh-ga (contoh 2-2)'); return; } if(!window._lastPrediction){ alert('Belum ada prediksi terakhir. Klik Analisis terlebih dahulu.'); return; } const pred = {gh_est: window._lastPrediction.avgH, ga_est: window._lastPrediction.avgA, pHome: window._lastPrediction.pHome, pDraw: window._lastPrediction.pDraw, pAway: window._lastPrediction.pAway}; addEvalEntry(`${teamHome.value} vs ${teamAway.value}`, pred, actual); alert('Hasil actual dimasukkan ke log evaluasi.'); });
renderEvalLog();
</script>
</body>
</html>
