<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Prediksi — v29.6 Ultra Precision AutoCR (Full)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#0d0f10;--panel:#141618;--muted:#9aa3ad;--card-hdp:#165c35;--card-ou:#0b74de}
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:18px;background:var(--bg);color:#eef2f3}
  h1{font-size:20px;margin:0 0 6px 0}
  .grid{display:grid;grid-template-columns:1fr 640px;gap:14px}
  .block{padding:12px;border-radius:10px;border:1px solid #222;background:var(--panel)}
  label{display:block;font-size:13px;margin:8px 0}
  input[type="number"],input[type="text"],select{width:100%;padding:8px;border:1px solid #333;border-radius:6px;background:#0f1315;color:#fff;font-size:13px}
  button{padding:8px 12px;border-radius:8px;border:0;background:#0b74de;color:#fff;cursor:pointer;margin:4px;font-weight:600}
  .small{font-size:12px;color:var(--muted)}
  .result{white-space:pre-wrap;font-family:monospace;background:#0b0d0f;padding:10px;border-radius:8px;border:1px dashed #222;margin-top:8px;color:#dfeefd}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
  th,td{padding:6px;border-bottom:1px solid #1f2224;text-align:center}
  th{background:#0d0f11}
  .card{padding:12px;border-radius:10px;color:#fff;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  .card-left{max-width:68%}
  .card-hdp{background:linear-gradient(90deg,var(--card-hdp),#11512a);border:1px solid rgba(255,255,255,0.04)}
  .card-ou{background:linear-gradient(90deg,var(--card-ou),#094f9b);border:1px solid rgba(255,255,255,0.04)}
  .confidence-up{color:#a6ffb0;font-weight:700}
  .confidence-down{color:#ffb0b0;font-weight:700}
  .status-red{background:#c23a3a;color:#fff;padding:6px 8px;border-radius:6px}
  .status-yellow{background:#b79e20;color:#111;padding:6px 8px;border-radius:6px}
  .status-green{background:#1e8e3e;color:#fff;padding:6px 8px;border-radius:6px}
  .anomaly{padding:10px;border-radius:8px;background:#3b1a1a;color:#fff;margin-bottom:8px;font-weight:bold}
  canvas{background:#070809;border-radius:6px;border:1px solid #0b212f}
  .inline-note{font-size:12px;color:var(--muted);margin-left:8px}
  .controls{display:flex;gap:6px;flex-wrap:wrap}
  .mini-bar{height:8px;background:#111;border-radius:4px;overflow:hidden;width:120px;display:inline-block;vertical-align:middle}
  .mini-bar > span{display:block;height:8px;border-radius:4px}
  .footer-note{font-size:12px;color:#7e8a8d;margin-top:8px}
</style>
</head>
<body>
<h1>⚽ Prediksi — v29.6 Ultra Precision AutoCR (Full)</h1>
<p class="small">Versi penuh: Auto CR, Auto TI, Odds Trap Pro, Market Anomaly, Histogram, Precision+ Monte Carlo, rekomendasi card & confidence.</p>

<div class="grid">
  <div>
    <div class="block">
      <h3>Input Utama</h3>
      <label>Home Team: <input id="teamHome" type="text" value="Home FC"></label>
      <label>Away Team: <input id="teamAway" type="text" value="Away FC"></label>

      <label>H2H (5 hasil, contoh WDLWL): <input id="h2hResults" type="text" maxlength="5"></label>

      <label>xG per Game: <input id="xgHome" type="number" step="0.01"> <input id="xgAway" type="number" step="0.01"></label>
      <label>Shots on Target (SOT): <input id="sotHome" type="number" step="0.1"> <input id="sotAway" type="number" step="0.1"></label>
      <label>Goals (untuk Auto CR): <input id="goalsHome" type="number" step="1"> <input id="goalsAway" type="number" step="1"></label>
      <label>Conversion Rate (0–1): <input id="convHome" type="number" step="0.01"> <input id="convAway" type="number" step="0.01"></label>

      <label>Big chances / Missed: <input id="bigHome" type="number" step="0.1"> <input id="missHome" type="number" step="0.1"> <input id="bigAway" type="number" step="0.1"> <input id="missAway" type="number" step="0.1"></label>

      <label>Tackles: <input id="tackleHome" type="number" step="0.1"> <input id="tackleAway" type="number" step="0.1"></label>
      <label>Interceptions: <input id="interHome" type="number" step="0.1"> <input id="interAway" type="number" step="0.1"></label>
      <label>Tackles + Interceptions <span class="inline-note">(otomatis)</span>: <input id="tiHome" type="number" readonly> <input id="tiAway" type="number" readonly></label>

      <label>Possession %: <input id="possHome" type="number" step="0.1"> <input id="possAway" type="number" step="0.1"></label>

      <h4>Defending Metrics</h4>
      <label>Clean Sheet / Game: <input id="csHome" type="number" step="0.01"> <input id="csAway" type="number" step="0.01"></label>
      <label>Goals Conceded / Game: <input id="gcHome" type="number" step="0.1"> <input id="gcAway" type="number" step="0.1"></label>
      <label>Saves / Game: <input id="saveHome" type="number" step="0.1"> <input id="saveAway" type="number" step="0.1"></label>
      <label>Errors leading to goal / season (est): <input id="errHome" type="number" step="0.1"> <input id="errAway" type="number" step="0.1"></label>

      <label>Performa 5 laga (W,D,W,L,D) atau skor (0-1): <input id="formRawHome" type="text" placeholder="W,D,W,D,W"> <input id="formRawAway" type="text"></label>
      <label>Atau skor performa (0–1): <input id="formHome" type="number" step="0.01"> <input id="formAway" type="number" step="0.01"></label>

      <h4>Absensi posisi (jumlah)</h4>
      <label>Home — Defender <input id="absDfHome" type="number" step="1" min="0"> Midfielder <input id="absMfHome" type="number" step="1" min="0"> Forward <input id="absFwHome" type="number" step="1" min="0"></label>
      <label>Away — Defender <input id="absDfAway" type="number" step="1" min="0"> Midfielder <input id="absMfAway" type="number" step="1" min="0"> Forward <input id="absFwAway" type="number" step="1" min="0"></label>

      <label>ELO Rating: <input id="eloHome" type="number" value="1500"> <input id="eloAway" type="number" value="1480"></label>

      <h4>Odds (HDP + OU) — Open & Now</h4>
      <label>HDP Line <input id="hdpLine" type="number" step="0.25" value="0.25"></label>
      <label>Home Open <input id="hdpHomeOpen" type="number" step="0.01"> Home Now <input id="hdpHomeNow" type="number" step="0.01"> | Away Open <input id="hdpAwayOpen" type="number" step="0.01"> Away Now <input id="hdpAwayNow" type="number" step="0.01"></label>

      <label>OU Line <input id="ouLine" type="number" step="0.25" value="2.5"></label>
      <label>Over Open <input id="ouOverOpen" type="number" step="0.01"> Over Now <input id="ouOverNow" type="number" step="0.01"> | Under Open <input id="ouUnderOpen" type="number" step="0.01"> Under Now <input id="ouUnderNow" type="number" step="0.01"></label>

      <label>Monte Carlo runs: <input id="mcRuns" type="number" value="8000" step="100"></label>

      <div style="margin-top:10px" class="controls">
        <button id="btnExample">Isi Contoh</button>
        <button id="btnAutoCR">Hitung CR Otomatis</button>
        <button id="btnReset">Reset</button>
        <button id="btnAnalyze">Analisis Ultra Precision</button>
      </div>
      <div class="small" style="margin-top:6px">Tips: isi Goals & SOT → lalu klik "Hitung CR Otomatis".</div>
    </div>
  </div>

  <div>
    <div class="block">
      <div id="anomalyTop" style="display:none" class="anomaly"></div>

      <h3>Rekomendasi Terbaik</h3>
      <div id="bestRec">
        <div class="result">Klik "Analisis Ultra Precision" untuk rekomendasi.</div>
      </div>

      <h3>Ringkasan</h3>
      <div id="summary" class="result">Ringkasan hasil muncul di sini.</div>

      <h3>Odds Trap & Market Moves (Pro)</h3>
      <table id="trapTable"><tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Arah</th><th>Prob Model</th><th>Edge%</th><th>Status</th></tr></table>

      <h3>Histogram Total Gol</h3>
      <canvas id="hist" width="520" height="140"></canvas>

      <div id="debug" class="result small">--</div>
    </div>
  </div>
</div>

<script>
// --- Utilities
function safe(v,d=0){const x=parseFloat(v);return isNaN(x)?d:x;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function randNormal(mu=0,sigma=1){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return mu+sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}
function poisson(k){let L=Math.exp(-k),p=1,c=0;while(p>L){c++;p*=Math.random();if(c>1000)break;}return c-1;}
function ln(x){return Math.log(Math.max(1e-6,x));}
function percent(x){return (100*x).toFixed(1)+'%';}

// --- Auto TI
function autoTI(){ tiHome.value = (safe(tackleHome.value)+safe(interHome.value)).toFixed(1); tiAway.value = (safe(tackleAway.value)+safe(interAway.value)).toFixed(1); }
['tackleHome','interHome','tackleAway','interAway'].forEach(id=>document.getElementById(id).addEventListener('input',autoTI));

// --- Auto CR
function autoCR(){
  const gh = safe(goalsHome.value, NaN), sh = safe(sotHome.value, NaN);
  const ga = safe(goalsAway.value, NaN), sa = safe(sotAway.value, NaN);
  if(sh>0) convHome.value = (gh/sh).toFixed(2);
  if(sa>0) convAway.value = (ga/sa).toFixed(2);
  alert('Conversion Rate otomatis terisi dari Goals ÷ SOT.');
}

// --- Form parser
function formScoreFromRaw(raw){
  if(!raw) return null;
  const parts = raw.toString().split(',').map(s=>s.trim().toUpperCase()).filter(Boolean).slice(0,5);
  if(parts.length===0) return null;
  const weights = [0.35,0.25,0.20,0.12,0.08];
  let score=0,total=0;
  for(let i=0;i<parts.length;i++){ const p=parts[i]; let val=0; if(p==='W') val=1; else if(p==='D') val=0.5; score+=val*weights[i]; total+=weights[i]; }
  return score/total;
}

// --- Precision+ calculations (attack, defense, lambdas) ---
function computeAttackSharp(team){
  const sotFactor = Math.min(1.2, 1 + Math.max(0, (team.sot - 4))/15);
  const possFactor = Math.min(1.15, 1 + Math.max(0, (team.poss - 50))/200);
  const bigChanceFactor = 1 + Math.max(0, (team.big||0) - (team.miss||0))*0.03;
  const base = 0.35*team.xg + 0.25*(team.sot/5) + 0.15*(team.conv*100) + 0.10*(team.form||0.5);
  const missPenalty = 0.06*(team.miss||0)/3;
  const dynamic = (sotFactor * possFactor * bigChanceFactor) - 1.0;
  const attack = Math.max(0.15, base - missPenalty) * (1 + dynamic*0.12);
  return attack;
}
function computeDefenseSharp(team){
  const errPerGame = safe(team.err,7)/38.0;
  const savesFactor = Math.log(1 + Math.max(0, team.saves))/Math.log(1+6);
  let val = 1 + (0.28 * ln(team.gc + 1)) - 0.20*team.cs - 0.10*(team.ti/25) + 0.05*(team.absDf||0) + 0.03*errPerGame - 0.08*savesFactor;
  return clamp(val,0.45,2.8);
}
function computeLambdasSharp(h,a){
  const atkH = computeAttackSharp(h), atkA = computeAttackSharp(a);
  const defH = computeDefenseSharp(h), defA = computeDefenseSharp(a);
  const sfH = clamp(1 + (h.elo - a.elo)/1400, 0.75, 1.25);
  const sfA = clamp(1 + (a.elo - h.elo)/1400, 0.75, 1.25);
  const leagueAvg = Math.max(0.6, (h.xg + a.xg)/2);

  let lambdaH = leagueAvg * (atkH / Math.max(0.3, leagueAvg)) * (1/defA) * sfH;
  let lambdaA = leagueAvg * (atkA / Math.max(0.3, leagueAvg)) * (1/defH) * sfA;

  const h2hRaw = (function(s){ if(!s) return 0; const t=s.toUpperCase().replace(/[^WDL]/g,'').slice(0,5); if(!t) return 0; let w=(t.match(/W/g)||[]).length; let l=(t.match(/L/g)||[]).length; return (w - l)/Math.max(1,t.length); })(h.h2h||'');
  const momentum = 0.15*(h.form - a.form) + 0.05*h2hRaw;
  lambdaH *= (1 + momentum);
  lambdaA *= (1 - momentum);

  const penaltyH = 1 - (0.04*(h.absDf||0) + 0.03*(h.absMf||0) + 0.05*(h.absFw||0));
  const penaltyA = 1 - (0.04*(a.absDf||0) + 0.03*(a.absMf||0) + 0.05*(a.absFw||0));
  const pH = clamp(penaltyH,0.7,1.0), pA = clamp(penaltyA,0.7,1.0);
  lambdaH *= pH; lambdaA *= pA;

  const avgLam = (lambdaH + lambdaA)/2;
  if(avgLam > 3.0){ lambdaH *= 0.86; lambdaA *= 0.86; } else if(avgLam > 2.0){ lambdaH *= 0.94; lambdaA *= 0.94; }

  const shrinkW = 0.55;
  lambdaH = shrinkW*lambdaH + (1-shrinkW)*h.xg;
  lambdaA = shrinkW*lambdaA + (1-shrinkW)*a.xg;

  lambdaH *= 0.99; lambdaA *= 0.99;

  return {lambdaH, lambdaA, atkH, atkA, defH, defA};
}

// --- Monte Carlo adaptive sampling
function sampleBivarAdaptive(lambdaH,lambdaA,rho,sigmaFactor){
  const sigma = 0.22 + sigmaFactor*0.12;
  const z1 = randNormal(0,sigma); const z2 = rho*z1 + Math.sqrt(Math.max(0,1-rho*rho))*randNormal(0,sigma);
  const lamH = Math.max(0.01, lambdaH * Math.exp(z1 - 0.5*sigma*sigma));
  const lamA = Math.max(0.01, lambdaA * Math.exp(z2 - 0.5*sigma*sigma));
  return [poisson(lamH), poisson(lamA)];
}
function monteCarloAdaptive(lambdaH,lambdaA,rho,sigmaFactor,runs){
  const scoreFreq={}, totals={}; let h=0,d=0,a=0;
  for(let i=0;i<runs;i++){
    const [gh,ga] = sampleBivarAdaptive(lambdaH,lambdaA,rho,sigmaFactor);
    const key = `${gh}-${ga}`;
    scoreFreq[key] = (scoreFreq[key]||0) + 1;
    totals[gh+ga] = (totals[gh+ga]||0) + 1;
    if(gh>ga) h++; else if(gh===ga) d++; else a++;
  }
  return {scoreFreq,totals,pHome:h/runs,pDraw:d/runs,pAway:a/runs};
}

// --- Probabilities helpers
function probCoverFromScores(scoreFreq,handicap,runs){
  let win=0,push=0,lose=0;
  for(const sc in scoreFreq){
    const v = scoreFreq[sc];
    const [gh,ga] = sc.split('-').map(x=>parseInt(x));
    const diff = gh - ga - handicap;
    if(diff>0) win+=v; else if(diff===0) push+=v; else lose+=v;
  }
  return (win + 0.5*push)/runs;
}
function probOUFromTotals(totals,line,runs){
  let over=0,under=0;
  const isInt = Number.isInteger(line);
  for(const t in totals){
    const g = parseInt(t), v = totals[t];
    if(isInt){
      if(g>line) over+=v; else if(g<line) under+=v; else { over+=0.5*v; under+=0.5*v; }
    } else {
      if(g>line) over+=v; else under+=v;
    }
  }
  return {over: over/runs, under: under/runs};
}
function impliedProb(odds){ if(!odds||odds<=0) return null; return 1/odds; }
function shrinkEdge(e){ if(e===null) return null; const cap=0.22; return Math.sign(e)*Math.min(Math.abs(e),cap); }
function deltaPercent(open,now){ if(!open || !now) return null; return ((now - open)/open*100); }
function directionLabel(open,now,market){
  if(!open || !now) return '';
  const diff = now - open;
  if(market==='OU'){
    if(diff < -0.03) return 'Money → Over';
    if(diff > 0.03) return 'Money → Under';
    return 'Stable';
  } else if(market==='HDP'){
    if(diff < -0.03) return 'Money → Home';
    if(diff > 0.03) return 'Money → Away';
    return 'Stable';
  }
  return '';
}
function statusFromDelta(d){ if(d===null) return {label:'N/A',className:''}; const ad=Math.abs(d); if(ad>=15) return {label:'Trap',className:'status-red'}; if(ad>=5) return {label:'Warning',className:'status-yellow'}; return {label:'Stable',className:'status-green'}; }

// --- Confidence calibration with market influence
function computeConfidenceAdaptive(totals, candidates){
  let mean=0,varv=0,count=0;
  for(const t in totals){ const g=parseInt(t), v=totals[t]; mean += g*v; count += v; }
  if(count===0) return {score:0.5,label:'Low'};
  mean /= count;
  for(const t in totals){ const g=parseInt(t), v=totals[t]; varv += ((g-mean)**2)*v; }
  varv /= count;
  let conf = clamp(1 - Math.min(1, varv/8), 0.15, 0.97);
  let trapCount=0; candidates.forEach(c=>{ if(c.status && c.status.label==='Trap') trapCount++; });
  if(trapCount>=2) conf *= 0.85;
  const allStable = candidates.every(c=> c.status && c.status.label==='Stable');
  if(allStable) conf = Math.min(0.99, conf * 1.08);
  const label = conf>0.8? 'High' : (conf>0.55? 'Medium' : 'Low');
  return {score:conf,label};
}

// --- Main analysis (full)
function analyzeUltraPrecisionAutoCR(){
  const runs = Math.max(2000, safe(mcRuns.value,8000));
  const rho = 0.12;

  const h = {
    xg: safe(xgHome.value,1.1), sot: safe(sotHome.value,3.4), conv: clamp(safe(convHome.value,0.12),0,1),
    big: safe(bigHome.value,0), miss: safe(missHome.value,0), poss: safe(possHome.value,52),
    ti: safe(tiHome.value,25), cs: safe(csHome.value,0.32), gc: safe(gcHome.value,1.2), saves: safe(saveHome.value,3.6), err: safe(errHome.value,7),
    formRaw: formRawHome.value||'', form: Number.isFinite(parseFloat(formHome.value))? safe(formHome.value): null,
    absDf: safe(absDfHome.value,0), absMf: safe(absMfHome.value,0), absFw: safe(absFwHome.value,0),
    elo: safe(eloHome.value,1500)
  };
  const a = {
    xg: safe(xgAway.value,1.0), sot: safe(sotAway.value,3.0), conv: clamp(safe(convAway.value,0.11),0,1),
    big: safe(bigAway.value,0), miss: safe(missAway.value,0), poss: safe(possAway.value,48),
    ti: safe(tiAway.value,20), cs: safe(csAway.value,0.28), gc: safe(gcAway.value,1.3), saves: safe(saveAway.value,3.7), err: safe(errAway.value,8),
    formRaw: formRawAway.value||'', form: Number.isFinite(parseFloat(formAway.value))? safe(formAway.value): null,
    absDf: safe(absDfAway.value,0), absMf: safe(absMfAway.value,0), absFw: safe(absFwAway.value,0),
    elo: safe(eloAway.value,1480)
  };

  // derive form & h2h
  h.form = (Number.isFinite(h.form) && h.form>0)? clamp(h.form,0,1): (formScoreFromRaw(h.formRaw) || 0.5);
  a.form = (Number.isFinite(a.form) && a.form>0)? clamp(a.form,0,1): (formScoreFromRaw(a.formRaw) || 0.5);
  h.h2h = h2hResults.value||''; a.h2h = h2hResults.value||'';

  if(!Number.isFinite(h.ti) || h.ti===0) h.ti = safe(tackleHome.value,0) + safe(interHome.value,0);
  if(!Number.isFinite(a.ti) || a.ti===0) a.ti = safe(tackleAway.value,0) + safe(interAway.value,0);

  const r = computeLambdasSharp(h,a);
  let lambdaH = r.lambdaH, lambdaA = r.lambdaA, atkH=r.atkH, atkA=r.atkA, defH=r.defH, defA=r.defA;

  const formSpread = Math.abs(h.form - a.form);
  const xgSpread = Math.abs(h.xg - a.xg);
  const sigmaFactor = clamp((formSpread + xgSpread)/4, 0, 1);

  const mc = monteCarloAdaptive(lambdaH,lambdaA,rho,sigmaFactor,runs);

  const avgH = Object.entries(mc.scoreFreq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[0])*v,0)/runs;
  const avgA = Object.entries(mc.scoreFreq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[1])*v,0)/runs;

  const ouLine = safe(ouLine.value,2.5);
  const ouProb = probOUFromTotals(mc.totals,ouLine,runs);

  const hdpLine = safe(hdpLine.value,0.25);
  const coverHome = probCoverFromScores(mc.scoreFreq, hdpLine, runs);
  const coverAway = probCoverFromScores(mc.scoreFreq, -hdpLine, runs);

  const implied = {
    ouOver: impliedProb(safe(ouOverNow.value,NaN)),
    ouUnder: impliedProb(safe(ouUnderNow.value,NaN)),
    hdpHome: impliedProb(safe(hdpHomeNow.value,NaN)),
    hdpAway: impliedProb(safe(hdpAwayNow.value,NaN))
  };
  const edges = {
    ouOver: (implied.ouOve<script>
/* =====================
   ⚙️ UTILITIES
===================== */
function safe(v,d=0){const x=parseFloat(v);return isNaN(x)?d:x;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function randNormal(mu=0,sigma=1){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return mu+sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}
function poisson(k){let L=Math.exp(-k),p=1,c=0;while(p>L){c++;p*=Math.random();if(c>1000)break;}return c-1;}
function percent(x){return (100*x).toFixed(1)+'%';}

/* =====================
   ⚙️ AUTO CALCULATION
===================== */
function autoTI(){tiHome.value=(safe(tackleHome.value)+safe(interHome.value)).toFixed(1);tiAway.value=(safe(tackleAway.value)+safe(interAway.value)).toFixed(1);}
['tackleHome','interHome','tackleAway','interAway'].forEach(id=>document.getElementById(id).addEventListener('input',autoTI));

function autoCR(){
  const gh=safe(goalsHome.value,NaN),sh=safe(sotHome.value,NaN);
  const ga=safe(goalsAway.value,NaN),sa=safe(sotAway.value,NaN);
  if(sh>0)convHome.value=(gh/sh).toFixed(2);
  if(sa>0)convAway.value=(ga/sa).toFixed(2);
  alert('Conversion Rate otomatis diisi dari Goals ÷ SOT.');
}

/* =====================
   ⚙️ CORE MODEL
===================== */
function formScoreFromRaw(raw){
  if(!raw)return 0.5;
  const parts=raw.toUpperCase().split(',').map(s=>s.trim()).filter(Boolean).slice(0,5);
  const w=[0.35,0.25,0.2,0.12,0.08];
  let s=0,t=0;
  for(let i=0;i<parts.length;i++){const p=parts[i];let val=p==='W'?1:p==='D'?0.5:0;s+=val*w[i];t+=w[i];}
  return s/t;
}
function computeAttack(t){
  const base=0.35*t.xg+0.25*(t.sot/5)+0.15*(t.conv*100)+0.1*(t.form||0.5);
  const boost=(1+(t.poss-50)/200)*(1+Math.max(0,(t.big-t.miss)*0.03));
  return clamp(base*boost,0.1,4.5);
}
function computeDefense(t){
  let val=1+(0.25*Math.log(t.gc+1))-0.2*t.cs-0.1*(t.ti/25)+0.05*(t.absDf||0)+0.03*(safe(t.err,7)/38);
  return clamp(val,0.45,3);
}
function computeLambda(h,a){
  const atkH=computeAttack(h),atkA=computeAttack(a);
  const defH=computeDefense(h),defA=computeDefense(a);
  const eloF=(1+(h.elo-a.elo)/1400);
  let lH=((h.xg+a.xg)/2)*(atkH/defA)*eloF;
  let lA=((h.xg+a.xg)/2)*(atkA/defH)*(2-eloF);
  const momentum=(0.15*(h.form-a.form));
  lH*=(1+momentum);lA*=(1-momentum);
  return {lH:clamp(lH,0.2,4),lA:clamp(lA,0.2,4)};
}

/* =====================
   ⚙️ MONTE CARLO
===================== */
function sampleGoals(lH,lA,rho){
  const z1=randNormal(),z2=rho*z1+Math.sqrt(1-rho*rho)*randNormal();
  const lh=Math.max(0.01,lH*Math.exp(0.25*z1));
  const la=Math.max(0.01,lA*Math.exp(0.25*z2));
  return [poisson(lh),poisson(la)];
}
function simulate(lH,lA,rho,runs){
  const scores={},tot={};let h=0,d=0,a=0;
  for(let i=0;i<runs;i++){
    const [gh,ga]=sampleGoals(lH,lA,rho);
    scores[`${gh}-${ga}`]=(scores[`${gh}-${ga}`]||0)+1;
    tot[gh+ga]=(tot[gh+ga]||0)+1;
    if(gh>ga)h++;else if(gh===ga)d++;else a++;
  }
  return {scores,tot,pH:h/runs,pD:d/runs,pA:a/runs};
}
function probOU(tot,line,runs){
  let over=0,under=0;
  for(const k in tot){const g=parseInt(k),v=tot[k];if(g>line)over+=v;else under+=v;}
  return {over:over/runs,under:under/runs};
}

/* =====================
   ⚙️ MARKET VOLATILITY
===================== */
function marketVolatility(open,now){
  if(!open||!now)return 0;
  return Math.abs((now-open)/open*100);
}
function volatilityScore(){
  const vals=[
    marketVolatility(safe(hdpHomeOpen.value),safe(hdpHomeNow.value)),
    marketVolatility(safe(hdpAwayOpen.value),safe(hdpAwayNow.value)),
    marketVolatility(safe(ouOverOpen.value),safe(ouOverNow.value)),
    marketVolatility(safe(ouUnderOpen.value),safe(ouUnderNow.value))
  ].filter(x=>x>0);
  if(vals.length===0)return 0;
  return clamp(vals.reduce((a,b)=>a+b,0)/vals.length,0,100);
}

/* =====================
   ⚙️ ANALYSIS MAIN
===================== */
function analyzeUltra(){
  const rho=0.12,runs=8000;
  const h={xg:safe(xgHome.value),sot:safe(sotHome.value),conv:safe(convHome.value),
    big:safe(bigHome.value),miss:safe(missHome.value),poss:safe(possHome.value),ti:safe(tiHome.value),
    cs:safe(csHome.value),gc:safe(gcHome.value),err:safe(errHome.value),elo:safe(eloHome.value),
    absDf:safe(absDfHome.value),absMf:safe(absMfHome.value),absFw:safe(absFwHome.value),
    form:formScoreFromRaw(formRawHome.value)};
  const a={xg:safe(xgAway.value),sot:safe(sotAway.value),conv:safe(convAway.value),
    big:safe(bigAway.value),miss:safe(bigAway.value),poss:safe(possAway.value),ti:safe(tiAway.value),
    cs:safe(csAway.value),gc:safe(gcAway.value),err:safe(errAway.value),elo:safe(eloAway.value),
    absDf:safe(absDfAway.value),absMf:safe(absMfAway.value),absFw:safe(absFwAway.value),
    form:formScoreFromRaw(formRawAway.value)};

  const {lH,lA}=computeLambda(h,a);
  const sim=simulate(lH,lA,rho,runs);
  const ouLine=safe(ouLine.value,2.5);
  const hdpLine=safe(hdpLine.value,0.25);
  const ou=probOU(sim.tot,ouLine,runs);

  const recOU=(ou.over>0.58?'Over':'Under');
  const recHDP=(sim.pH>sim.pA?'Home +'+hdpLine:'Away +'+hdpLine);
  const confOUVal=Math.max(ou.over,ou.under);
  const confHDPVal=Math.max(sim.pH,sim.pA);
  const confOU=(confOUVal>0.7?'High':confOUVal>0.55?'Medium':'Low');
  const confHDP=(confHDPVal>0.7?'High':confHDPVal>0.55?'Medium':'Low');

  const trapWarning=(Math.abs(confOUVal-confHDPVal)<0.05)?'⚠️ Trap Warning: peluang terlalu seimbang.':'';
  const vScore=volatilityScore();
  const vLabel=vScore<5?'🟩 Stable':vScore<12?'🟨 Shifting':'🔴 Volatile';

  const summary=`ExpGoals: H${lH.toFixed(2)} - A${lA.toFixed(2)}
1X2: H${percent(sim.pH)} D${percent(sim.pD)} A${percent(sim.pA)}
OU(${ouLine}): Over ${percent(ou.over)} / Under ${percent(ou.under)}
Rekomendasi: HDP → ${recHDP} (${confHDP}) | OU → ${recOU} (${confOU})
${trapWarning}
📊 Volatility Score: ${vScore.toFixed(1)} (${vLabel})`;
  document.getElementById('summary').textContent=summary;

  const barColor=vScore<5?'#22c55e':vScore<12?'#ca8a04':'#ef4444';
  const barWidth=Math.min(100,vScore);
  const barHTML=`<div style="background:#1e293b;width:100%;height:6px;border-radius:4px;overflow:hidden;margin-top:6px;">
    <div style="width:${barWidth}%;background:${barColor};height:100%;"></div></div>`;

  document.getElementById('bestRec').innerHTML=
    `<div class="card"><b>🏆 HDP Terbaik:</b> ${recHDP} (${confHDP})</div>
     <div class="card"><b>🔥 Over/Under:</b> ${recOU} (${confOU})</div>
     ${trapWarning?'<div style="color:#f87171;margin-top:8px;">'+trapWarning+'</div>':''}
     <div style="margin-top:8px">${barHTML}</div>
     <div style="font-size:13px;color:#93c5fd;margin-top:4px;">${vLabel}</div>`;

  document.getElementById('trapTable').innerHTML=
  `<tr><th>Pasar</th><th>Prob</th><th>Confidence</th></tr>
   <tr><td>${recHDP}</td><td>${percent(confHDPVal)}</td><td>${confHDP}</td></tr>
   <tr><td>${recOU}</td><td>${percent(confOUVal)}</td><td>${confOU}</td></tr>`;
}

/* =====================
   ⚙️ UI CONTROL
===================== */
function fillExample(){
  xgHome.value=2.1;xgAway.value=1.3;sotHome.value=6;sotAway.value=4;goalsHome.value=8;goalsAway.value=5;
  convHome.value='';convAway.value='';possHome.value=61;possAway.value=39;
  tackleHome.value=23;interHome.value=8;tackleAway.value=18;interAway.value=6;autoTI();
  csHome.value=0.4;csAway.value=0.28;gcHome.value=0.9;gcAway.value=1.4;errHome.value=6;errAway.value=8;
  formRawHome.value='W,W,D,W,L';formRawAway.value='L,D,L,D,W';eloHome.value=1820;eloAway.value=1690;
  ouLine.value=2.5;hdpLine.value=0.25;
  hdpHomeOpen.value=1.95;hdpHomeNow.value=1.88;hdpAwayOpen.value=1.95;hdpAwayNow.value=2.05;
  ouOverOpen.value=1.95;ouOverNow.value=2.02;ouUnderOpen.value=1.90;ouUnderNow.value=1.93;
  alert('Contoh diisi. Klik "Analisis Ultra Precision".');
}
function resetAll(){
  document.querySelectorAll('input').forEach(i=>{if(i.type!=='button')i.value='';});
  summary.textContent='Direset';bestRec.innerHTML='';trapTable.innerHTML='';
}

/* =====================
   ⚙️ BUTTON CONNECTOR
===================== */
(function(){
  const bind=(id,fn)=>{const el=document.getElementById(id);if(el)el.onclick=fn;};
  bind('btnAnalyze',analyzeUltra);
  bind('btnExample',fillExample);
  bind('btnReset',resetAll);
  bind('btnAutoCR',autoCR);
  console.log('✅ Semua tombol aktif (Trap + Volatility Score)');
})();
</script>
</body>
</html>
