<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Football Analyzer Pro v52B ‚Äî Full Dark (Odds Visible)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#0b0f14;--panel:#07121a;--card:#0d1b21;--accent:#06b6d4;--muted:#9fd6ee;--text:#e6f9ff;--danger:#ff6b6b;}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:12px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
h1{font-size:18px;margin:0}
.small{font-size:13px;color:var(--muted)}
.block{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.02)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
label{display:block;font-size:13px;color:var(--muted);margin:6px 0}
input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:#071a20;color:var(--text)}
button{background:var(--accent);border:0;color:#022;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn-muted{background:#0f3942;color:var(--text);border:1px solid rgba(255,255,255,0.02)}
.kv{font-size:13px;color:var(--muted)}
.card{background:var(--card);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.tactical-row{display:flex;gap:12px;align-items:center}
.bar-wrap{flex:1;background:#071a20;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.bar-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:13px;color:var(--muted)}
.bar-bg{height:18px;background:#122126;border-radius:6px;overflow:hidden;position:relative}
.bar-fill{height:100%;width:0%;transition:width .45s ease, background-color .25s ease}
.bar-value{font-size:12px;color:var(--muted);margin-left:8px}
.side{width:46%;min-width:200px}
.center-vert{display:flex;flex-direction:column;align-items:center;justify-content:center}
.canvas{background:#02121a;border-radius:6px;border:1px solid rgba(255,255,255,0.02);display:block}
.footer{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
.pre{background:#02131a;padding:10px;border-radius:8px;font-family:ui-monospace,monospace;margin-top:8px;white-space:pre-wrap}
.accordion{background:#071a20;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.02)}
.acc-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:6px}
.acc-body{display:block;padding-top:8px} /* Always visible in this build */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px;text-align:center}
.corner{position:fixed;right:16px;top:14px;z-index:999}
.small-btn{padding:6px 8px;border-radius:6px;background:#08323a;border:1px solid rgba(255,255,255,0.02);color:var(--text);cursor:pointer}
</style>
</head>
<body>
<div class="corner"><div id="geoStatus" class="kv">Geo: Local DB</div></div>
<div class="container">
  <div class="header">
    <div>
      <h1>Football Analyzer Pro v52B ‚Äî Full Dark (Odds Visible)</h1>
      <div class="small">Full features ‚Ä¢ Odds HDP & O/U visible ‚Ä¢ Auto example on load ‚Ä¢ Auto CSV</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnClearCache" class="small-btn">üßπ Hapus Cache Sesi</button>
      <button id="btnDownloadLast" class="small-btn">üì• Download CSV Terakhir</button>
    </div>
  </div>

  <div class="block">
    <div class="row">
      <div class="col"><label>League Home: <select id="leagueHome"></select></label></div>
      <div class="col"><label>Team Home: <select id="teamHome"></select></label></div>
      <div class="col"><label>League Away: <select id="leagueAway"></select></label></div>
      <div class="col"><label>Team Away: <select id="teamAway"></select></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Stadium Home: <input id="stadHome" readonly></label></div>
      <div class="col"><label>Lat Home: <input id="latHome" type="number" step="0.0001"></label></div>
      <div class="col"><label>Lon Home: <input id="lonHome" type="number" step="0.0001"></label></div>
      <div class="col"><label>Country Home: <input id="countryHome" readonly></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Stadium Away: <input id="stadAway" readonly></label></div>
      <div class="col"><label>Lat Away: <input id="latAway" type="number" step="0.0001"></label></div>
      <div class="col"><label>Lon Away: <input id="lonAway" type="number" step="0.0001"></label></div>
      <div class="col"><label>Country Away: <input id="countryAway" readonly></label></div>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button id="btnFillFromDB" class="btn-muted">Isi Stadion dari DB</button>
      <button id="btnStadiumOnline" class="btn-muted">üîç Cari Stadion (Online)</button>
      <button id="btnFillExample" class="btn-muted">Isi Contoh</button>
      <div style="margin-left:auto" class="kv">Travel (km): <span id="travelKm">‚Äî</span> ‚Ä¢ Impact: <span id="travelImpact">‚Äî</span></div>
    </div>
  </div>

  <div class="block">
    <h3>Attack & Defense Inputs</h3>
    <div class="row">
      <div class="col"><label>xG Home: <input id="xgHome" type="number" step="0.01" value="1.6"></label></div>
      <div class="col"><label>xG Away: <input id="xgAway" type="number" step="0.01" value="1.1"></label></div>
      <div class="col"><label>SOT Home: <input id="sotHome" type="number" value="5"></label></div>
      <div class="col"><label>SOT Away: <input id="sotAway" type="number" value="3"></label></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Conv Home: <input id="convHome" type="number" step="0.01" value="0.18"></label></div>
      <div class="col"><label>Conv Away: <input id="convAway" type="number" step="0.01" value="0.14"></label></div>
      <div class="col"><label>Poss Home %: <input id="possHome" type="number" step="0.1" value="62"></label></div>
      <div class="col"><label>Poss Away %: <input id="possAway" type="number" step="0.1" value="38"></label></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Tackles Home: <input id="tackleHome" type="number" value="18"></label></div>
      <div class="col"><label>Inter Home: <input id="interHome" type="number" value="8"></label></div>
      <div class="col"><label>TI Home (auto): <input id="tiHome" readonly></label></div>
      <div class="col"><label>CS Home: <input id="csHome" type="number" step="0.01" value="0.28"></label></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Tackles Away: <input id="tackleAway" type="number" value="16"></label></div>
      <div class="col"><label>Inter Away: <input id="interAway" type="number" value="6"></label></div>
      <div class="col"><label>TI Away (auto): <input id="tiAway" readonly></label></div>
      <div class="col"><label>CS Away: <input id="csAway" type="number" step="0.01" value="0.22"></label></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Goals Home (recent total): <input id="goalsHome" type="number" value="8"></label></div>
      <div class="col"><label>Goals Away (recent total): <input id="goalsAway" type="number" value="6"></label></div>
      <div class="col"><label>Saves Home: <input id="saveHome" type="number" step="0.1" value="3.6"></label></div>
      <div class="col"><label>Saves Away: <input id="saveAway" type="number" step="0.1" value="3.1"></label></div>
    </div>
  </div>

  <!-- Odds Market visible by default -->
  <div class="block">
    <h3>üíµ Odds Market (HDP & Over/Under) ‚Äî Visible</h3>
    <div class="row">
      <div class="col"><label>HDP Line: <input id="hdpLine" type="number" step="0.25" value="0.25"></label></div>
      <div class="col"><label>HDP Home Open: <input id="hdpHomeOpen" type="number" step="0.01" value="1.95"></label></div>
      <div class="col"><label>HDP Home Now: <input id="hdpHomeNow" type="number" step="0.01" value="1.88"></label></div>
      <div class="col"><label>HDP Away Open: <input id="hdpAwayOpen" type="number" step="0.01" value="1.95"></label></div>
      <div class="col"><label>HDP Away Now: <input id="hdpAwayNow" type="number" step="0.01" value="2.05"></label></div>
    </div>
    <div style="height:8px"></div>
    <div class="row">
      <div class="col"><label>OU Line: <input id="ouLine" type="number" step="0.25" value="2.5"></label></div>
      <div class="col"><label>OU Over Open: <input id="ouOverOpen" type="number" step="0.01" value="1.95"></label></div>
      <div class="col"><label>OU Over Now: <input id="ouOverNow" type="number" step="0.01" value="1.88"></label></div>
      <div class="col"><label>OU Under Open: <input id="ouUnderOpen" type="number" step="0.01" value="1.90"></label></div>
      <div class="col"><label>OU Under Now: <input id="ouUnderNow" type="number" step="0.01" value="2.00"></label></div>
    </div>
  </div>

  <div class="block tactical-row">
    <div class="side card">
      <div style="display:flex;justify-content:space-between;align-items:center"><div><strong id="teamHomeLabel">Home</strong><div class="small" id="teamHomeLeague"></div></div><div class="small kv" id="homePercLabel">‚Äî</div></div>
      <div style="height:8px"></div>
      <div class="bar-wrap">
        <div class="bar-label"><div>‚öîÔ∏è Attack Strength</div><div class="bar-value" id="atkHomeVal">0%</div></div>
        <div class="bar-bg"><div id="atkHomeFill" class="bar-fill" style="background:linear-gradient(90deg,#2dd36f,#f7b731)"></div></div>
        <div style="height:10px"></div>
        <div class="bar-label"><div>üõ°Ô∏è Defense Solidity</div><div class="bar-value" id="defHomeVal">0%</div></div>
        <div class="bar-bg"><div id="defHomeFill" class="bar-fill" style="background:linear-gradient(90deg,#66d3ff,#9fd6ee)"></div></div>
      </div>
    </div>

    <div class="center-vert"><div class="small kv">Comparison</div><div style="height:6px"></div><div class="small kv">Auto-update saat input berubah</div></div>

    <div class="side card">
      <div style="display:flex;justify-content:space-between;align-items:center"><div><strong id="teamAwayLabel">Away</strong><div class="small" id="teamAwayLeague"></div></div><div class="small kv" id="awayPercLabel">‚Äî</div></div>
      <div style="height:8px"></div>
      <div class="bar-wrap">
        <div class="bar-label"><div>‚öîÔ∏è Attack Strength</div><div class="bar-value" id="atkAwayVal">0%</div></div>
        <div class="bar-bg"><div id="atkAwayFill" class="bar-fill" style="background:linear-gradient(90deg,#2dd36f,#f7b731)"></div></div>
        <div style="height:10px"></div>
        <div class="bar-label"><div>üõ°Ô∏è Defense Solidity</div><div class="bar-value" id="defAwayVal">0%</div></div>
        <div class="bar-bg"><div id="defAwayFill" class="bar-fill" style="background:linear-gradient(90deg,#66d3ff,#9fd6ee)"></div></div>
      </div>
    </div>
  </div>

  <div class="block">
    <h3>Controls</h3>
    <div class="row">
      <div class="col"><label>ELO Home: <input id="eloHome" type="number" value="1820"></label></div>
      <div class="col"><label>ELO Away: <input id="eloAway" type="number" value="1690"></label></div>
      <div class="col"><label>Days rest Home: <input id="daysRestHome" type="number" value="5"></label></div>
      <div class="col"><label>Days rest Away: <input id="daysRestAway" type="number" value="3"></label></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="btnAnalyze" class="btn-muted">Analisis & Download CSV</button>
      <button id="btnReset" class="btn-muted">Reset</button>
      <div class="kv" style="margin-left:auto">Session Cache: <span id="cacheCount">0</span> entri</div>
    </div>
  </div>

  <div class="block">
    <div class="row">
      <div class="col"><div class="card"><strong id="matchTitle">-</strong><div id="matchMeta" class="small">-</div><pre id="summary" class="pre">‚Äî</pre></div></div>
      <div class="col"><div class="card"><h4 class="small">Recommendations</h4><div id="valueList"></div></div></div>
    </div>
    <div style="margin-top:8px"><canvas id="hist" width="720" height="140" class="canvas"></canvas></div>
  </div>

  <div class="footer">v52B ‚Ä¢ Full Dark ‚Ä¢ Odds visible ‚Ä¢ Auto example on load</div>
</div>

<script>
/* Utilities */
function safe(v,d=0){const x=parseFloat(v);return isNaN(x)?d:x;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function nowISO(){const d=new Date();return d.toISOString().replace(/:/g,'-').split('.')[0];}
function percent(x){return (100*x).toFixed(1)+'%';}
function poisson(lambda){let L=Math.exp(-lambda),p=1,k=0; while(p> L){k++; p*=Math.random(); if(k>2000)break;} return Math.max(0,k-1);}

/* Embedded DB sample */
const STADIUM_DB = [
  {league:'Premier League', team:'Manchester City', stadium:'Etihad Stadium', lat:53.4831, lon:-2.2004, country:'England'},
  {league:'Premier League', team:'Tottenham Hotspur', stadium:'Tottenham Hotspur Stadium', lat:51.6044, lon:-0.0663, country:'England'},
  {league:'LaLiga', team:'Barcelona', stadium:'Camp Nou', lat:41.3809, lon:2.1228, country:'Spain'},
  {league:'Serie A', team:'Juventus', stadium:'Allianz Stadium', lat:45.1096, lon:7.6413, country:'Italy'},
  {league:'Indonesia', team:'Persija Jakarta', stadium:'Gelora Bung Karno', lat:-6.2187, lon:106.8020, country:'Indonesia'}
];

/* Session cache */
const CACHE_KEY = 'v52b_session_cache';
function getCache(){try{return JSON.parse(sessionStorage.getItem(CACHE_KEY)||'[]')}catch(e){return []}}
function setCache(v){sessionStorage.setItem(CACHE_KEY, JSON.stringify(v)); updateCacheCount()}
function addToCache(e){const arr=getCache(); if(!arr.find(x=>x.team===e.team&&x.league===e.league)){arr.push(e); setCache(arr);}}
function clearCache(){sessionStorage.removeItem(CACHE_KEY); updateCacheCount()}
function updateCacheCount(){document.getElementById('cacheCount').textContent=getCache().length}

/* Populate leagues/teams */
function unique(arr,key){return Array.from(new Set(arr.map(x=>x[key]))).sort()}
const leagues = unique(STADIUM_DB,'league');
function populateLeague(id){const sel=document.getElementById(id); sel.innerHTML=''; const o=document.createElement('option'); o.value=''; o.textContent='-- pilih liga --'; sel.appendChild(o); leagues.forEach(l=>{const opt=document.createElement('option');opt.value=l;opt.textContent=l;sel.appendChild(opt);});}
function populateTeams(league, selId){const sel=document.getElementById(selId); sel.innerHTML=''; const teams=STADIUM_DB.filter(s=>s.league===league).map(s=>s.team).sort(); if(teams.length===0){sel.innerHTML='<option value=\"\">(kosong)</option>';return;} const o=document.createElement('option'); o.value=''; o.textContent='-- pilih tim --'; sel.appendChild(o); teams.forEach(t=>{const opt=document.createElement('option');opt.value=t;opt.textContent=t;sel.appendChild(opt);});}
populateLeague('leagueHome'); populateLeague('leagueAway');
document.getElementById('leagueHome').addEventListener('change', ()=> populateTeams(document.getElementById('leagueHome').value,'teamHome'));
document.getElementById('leagueAway').addEventListener('change', ()=> populateTeams(document.getElementById('leagueAway').value,'teamAway'));

/* Fill stadium from DB or cache */
function findInDB(team){return STADIUM_DB.find(s=>s.team.toLowerCase()===team.toLowerCase())}
function findInCache(team){const arr=getCache(); return arr.find(s=>s.team.toLowerCase()===team.toLowerCase())}
function applyStadium(side, stadium, lat, lon, league, country, source){
  if(side==='Home'){document.getElementById('stadHome').value=stadium; document.getElementById('latHome').value=lat; document.getElementById('lonHome').value=lon; document.getElementById('countryHome').value=country; document.getElementById('geoStatus').textContent='Geo: '+source; document.getElementById('teamHomeLeague').textContent=league||''; document.getElementById('teamHomeLabel').textContent=document.getElementById('teamHome').value||'Home';}
  else {document.getElementById('stadAway').value=stadium; document.getElementById('latAway').value=lat; document.getElementById('lonAway').value=lon; document.getElementById('countryAway').value=country; document.getElementById('geoStatus').textContent='Geo: '+source; document.getElementById('teamAwayLeague').textContent=league||''; document.getElementById('teamAwayLabel').textContent=document.getElementById('teamAway').value||'Away';}
  calcTravel();
}

function fillFromDB(side){
  const team = (side==='Home')? document.getElementById('teamHome').value : document.getElementById('teamAway').value;
  if(!team){ alert('Pilih tim terlebih dahulu.'); return; }
  const cacheRec = findInCache(team);
  if(cacheRec){ applyStadium(side, cacheRec.stadium, cacheRec.lat, cacheRec.lon, cacheRec.league, cacheRec.country, 'Cached (session)'); return; }
  const rec = findInDB(team);
  if(rec){ applyStadium(side, rec.stadium, rec.lat, rec.lon, rec.league, rec.country, 'Local DB'); return; }
  alert('Tidak ditemukan di DB lokal. Gunakan Cari Stadion (Online).');
}

document.getElementById('btnFillFromDB').addEventListener('click', ()=>{ fillFromDB('Home'); setTimeout(()=> fillFromDB('Away'),250); });

/* Online geocode fallback */
async function geocode(q){ try{ const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q)+'&limit=5'); if(!res.ok) return null; return await res.json(); }catch(e){ return null; } }
document.getElementById('btnStadiumOnline').addEventListener('click', async ()=>{
  const teamH = document.getElementById('teamHome').value || document.getElementById('leagueHome').value;
  const teamA = document.getElementById('teamAway').value || document.getElementById('leagueAway').value;
  if(teamH){ document.getElementById('geoStatus').textContent='Geo: Searching online...'; const r = await geocode(teamH + ' stadium'); if(r && r.length>0){ const top=r[0]; applyStadium('Home', top.display_name, parseFloat(top.lat).toFixed(4), parseFloat(top.lon).toFixed(4), document.getElementById('leagueHome').value||'', ''); addToCache({team:teamH, stadium: top.display_name, lat: parseFloat(top.lat), lon: parseFloat(top.lon), league: document.getElementById('leagueHome').value||'', country:''}); } else { alert('Pencarian online Home gagal'); document.getElementById('geoStatus').textContent='Geo: Online failed'; } }
  if(teamA){ document.getElementById('geoStatus').textContent='Geo: Searching online...'; const r2 = await geocode(teamA + ' stadium'); if(r2 && r2.length>0){ const top2=r2[0]; applyStadium('Away', top2.display_name, parseFloat(top2.lat).toFixed(4), parseFloat(top2.lon).toFixed(4), document.getElementById('leagueAway').value||'', ''); addToCache({team:teamA, stadium: top2.display_name, lat: parseFloat(top2.lat), lon: parseFloat(top2.lon), league: document.getElementById('leagueAway').value||'', country:''}); } else { alert('Pencarian online Away gagal'); document.getElementById('geoStatus').textContent='Geo: Online failed'; } }
  updateCacheCount();
});

/* Auto TI */
function autoTI(){ document.getElementById('tiHome').value = (safe(document.getElementById('tackleHome').value)+safe(document.getElementById('interHome').value)).toFixed(1); document.getElementById('tiAway').value = (safe(document.getElementById('tackleAway').value)+safe(document.getElementById('interAway').value)).toFixed(1); }
['tackleHome','interHome','tackleAway','interAway'].forEach(id=>document.getElementById(id).addEventListener('input',autoTI));

/* Travel calc */
function calcTravel(){ const latH = safe(document.getElementById('latHome').value, NaN), lonH = safe(document.getElementById('lonHome').value, NaN); const latA = safe(document.getElementById('latAway').value, NaN), lonA = safe(document.getElementById('lonAway').value, NaN); if(isNaN(latH)||isNaN(lonH)||isNaN(latA)||isNaN(lonA)){ document.getElementById('travelKm').textContent='‚Äî'; document.getElementById('travelImpact').textContent='‚Äî'; return null; } const R=6371; const toRad=x=>x*Math.PI/180; const dLat=toRad(latA-latH), dLon=toRad(lonA-lonH); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(latH))*Math.cos(toRad(latA))*Math.sin(dLon/2)**2; const km=Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))); document.getElementById('travelKm').textContent=km; const impact=(km<50)? 'Negligible' : (km<500? '-2% stamina' : (km<1000? '-4% stamina' : (km<3000? '-7% stamina' : '-10% stamina'))); document.getElementById('travelImpact').textContent=impact; return km; }
['latHome','lonHome','latAway','lonAway'].forEach(id=>document.getElementById(id).addEventListener('input',calcTravel));

/* Attack/Defense index and bar update */
function computeAttackIndex(xg,sot,conv,poss){ const base = 0.35*xg + 0.25*(sot/5) + 0.15*(conv*100); const possFactor = (poss/50); const score = Math.max(0.05, base * (0.9 + 0.2*Math.min(1, possFactor))); return clamp(score,0.05,3.5); }
function computeDefenseIndex(cs,gc,saves,ti,err){ const errPerGame = err/38.0; let val = 1.2 - (0.28*gc) + (0.25*cs) + 0.05*(saves/4) - 0.02*(ti/30) + 0.03*errPerGame; return clamp(val,0.3,2.8); }
function normalizeToPct(v, min, max){ const p = (v - min)/(max-min); return clamp(Math.round(p*100), 0, 100); }

function updateTacticalBars(){
  const xgH = safe(document.getElementById('xgHome').value,1.2), sotH = safe(document.getElementById('sotHome').value,4), convH = safe(document.getElementById('convHome').value,0.14), possH = safe(document.getElementById('possHome').value,50);
  const xgA = safe(document.getElementById('xgAway').value,1.0), sotA = safe(document.getElementById('sotAway').value,3), convA = safe(document.getElementById('convAway').value,0.12), possA = safe(document.getElementById('possAway').value,48);
  const atkH = computeAttackIndex(xgH,sotH,convH,possH), atkA = computeAttackIndex(xgA,sotA,convA,possA);
  const defH = computeDefenseIndex(safe(document.getElementById('csHome').value,0.28), safe(document.getElementById('gcHome')?.value,1.1), safe(document.getElementById('saveHome')?.value,3.4), safe(document.getElementById('tiHome').value,20), safe(document.getElementById('errHome').value,6));
  const defA = computeDefenseIndex(safe(document.getElementById('csAway').value,0.25), safe(document.getElementById('gcAway')?.value,1.3), safe(document.getElementById('saveAway')?.value,3.2), safe(document.getElementById('tiAway').value,18), safe(document.getElementById('errAway').value,7));
  const atkHpct = normalizeToPct(atkH, 0.1, 3.0), atkApct = normalizeToPct(atkA, 0.1, 3.0);
  const defHpct = normalizeToPct(defH, 0.3, 2.5), defApct = normalizeToPct(defA, 0.3, 2.5);
  document.getElementById('atkHomeVal').textContent = atkHpct + '%'; document.getElementById('atkHomeFill').style.width = atkHpct+'%';
  document.getElementById('atkAwayVal').textContent = atkApct + '%'; document.getElementById('atkAwayFill').style.width = atkApct+'%';
  document.getElementById('defHomeVal').textContent = defHpct + '%'; document.getElementById('defHomeFill').style.width = defHpct+'%';
  document.getElementById('defAwayVal').textContent = defApct + '%'; document.getElementById('defAwayFill').style.width = defApct+'%';
  function colorFor(p, type){ if(type==='atk'){ if(p>=80) return 'linear-gradient(90deg,#2dd36f,#07c2d4)'; if(p>=60) return 'linear-gradient(90deg,#f7b731,#ffd54d)'; return 'linear-gradient(90deg,#ff6b6b,#ff8a8a)'; } else { if(p>=80) return 'linear-gradient(90deg,#66d3ff,#2dd3b5)'; if(p>=60) return 'linear-gradient(90deg,#9fd6ee,#ffd54d)'; return 'linear-gradient(90deg,#ff8aa0,#ff6b6b)'; } }
  document.getElementById('atkHomeFill').style.background = colorFor(atkHpct,'atk'); document.getElementById('atkAwayFill').style.background = colorFor(atkApct,'atk');
  document.getElementById('defHomeFill').style.background = colorFor(defHpct,'def'); document.getElementById('defAwayFill').style.background = colorFor(defApct,'def');
  document.getElementById('homePercLabel').textContent = `ATK ${atkHpct}% ‚Ä¢ DEF ${defHpct}%`; document.getElementById('awayPercLabel').textContent = `ATK ${atkApct}% ‚Ä¢ DEF ${defApct}%`;
  window._v52_atkH = atkH; window._v52_atkA = atkA; window._v52_defH = defH; window._v52_defA = defA;
  window._v52_atkH_pct = atkHpct; window._v52_atkA_pct = atkApct; window._v52_defH_pct = defHpct; window._v52_defA_pct = defApct;
}

/* inputs updating bars */
['xgHome','sotHome','convHome','possHome','xgAway','sotAway','convAway','possAway','csHome','gcHome','saveHome','tiHome','errHome','csAway','gcAway','saveAway','tiAway','errAway','tackleHome','interHome','tackleAway','interAway'].forEach(id=>document.getElementById(id).addEventListener('input', updateTacticalBars));

/* Analysis with odds calculations */
function impliedProbFromOdds(odds){ if(!odds || odds<=0) return null; return 1/odds; }
function shrinkEdge(e){ if(e===null) return null; const cap=0.22; return Math.sign(e)*Math.min(Math.abs(e),cap); }
function deltaPercent(open,now){ if(!open || !now) return null; return ((now - open)/open*100); }
function directionLabel(open,now,market){ if(!open || !now) return ''; const diff = now - open; if(market==='OU'){ if(diff < -0.03) return 'Money ‚Üí Over'; if(diff > 0.03) return 'Money ‚Üí Under'; return 'Stable'; } if(market==='HDP'){ if(diff < -0.03) return 'Money ‚Üí Home'; if(diff > 0.03) return 'Money ‚Üí Away'; return 'Stable'; } return ''; }

function analyzeAndExport(){ try{
  const latH = safe(document.getElementById('latHome').value, NaN), lonH = safe(document.getElementById('lonHome').value, NaN);
  const latA = safe(document.getElementById('latAway').value, NaN), lonA = safe(document.getElementById('lonAway').value, NaN);
  if(isNaN(latH)||isNaN(lonH)||isNaN(latA)||isNaN(lonA)){ alert('Isi koordinat stadion (DB atau Online) sebelum analisis.'); return; }
  const teamH = document.getElementById('teamHome').value || 'Home', teamA = document.getElementById('teamAway').value || 'Away';
  const eloH = safe(document.getElementById('eloHome').value,1500), eloA = safe(document.getElementById('eloAway').value,1500);
  const daysH = safe(document.getElementById('daysRestHome').value,4), daysA = safe(document.getElementById('daysRestAway').value,3);
  const atkH = window._v52_atkH || computeAttackIndex(safe(document.getElementById('xgHome').value,1.2), safe(document.getElementById('sotHome').value,4), safe(document.getElementById('convHome').value,0.14), safe(document.getElementById('possHome').value,50));
  const atkA = window._v52_atkA || computeAttackIndex(safe(document.getElementById('xgAway').value,1.0), safe(document.getElementById('sotAway').value,3), safe(document.getElementById('convAway').value,0.12), safe(document.getElementById('possAway').value,48));
  const defH = window._v52_defH || computeDefenseIndex(safe(document.getElementById('csHome').value,0.28), safe(document.getElementById('gcHome')?.value,1.1), safe(document.getElementById('saveHome')?.value,3.4), safe(document.getElementById('tiHome').value,20), safe(document.getElementById('errHome').value,6));
  const defA = window._v52_defA || computeDefenseIndex(safe(document.getElementById('csAway').value,0.25), safe(document.getElementById('gcAway')?.value,1.3), safe(document.getElementById('saveAway')?.value,3.2), safe(document.getElementById('tiAway').value,18), safe(document.getElementById('errAway').value,7));
  const km = calcTravel()||0;
  const stamH = clamp(1 - Math.max(0,(3-daysH))*0.035 - Math.max(0,(km-200))*0.00016, 0.65, 1.06);
  const stamA = clamp(1 - Math.max(0,(3-daysA))*0.035 - Math.max(0,(km-200))*0.00016, 0.65, 1.06);
  const efH = clamp(1 + (eloH-eloA)/1400, 0.75, 1.25), efA = clamp(1 + (eloA-eloH)/1400, 0.75, 1.25);
  let lambdaH = Math.max(0.03, 1.02 * (atkH / Math.max(0.3, defA)) * efH * stamH);
  let lambdaA = Math.max(0.03, 0.98 * (atkA / Math.max(0.3, defH)) * efA * stamA);
  const avgLam = (lambdaH + lambdaA)/2; if(avgLam>3.0){ lambdaH *= 0.86; lambdaA *= 0.86; } else if(avgLam>2.0){ lambdaH *= 0.94; lambdaA *= 0.94; }
  const runs = 4000; const scoreFreq={}; let h=0,d=0,a=0; const totals={};
  for(let i=0;i<runs;i++){ const gh=poisson(lambdaH); const ga=poisson(lambdaA); scoreFreq[`${gh}-${ga}`]=(scoreFreq[`${gh}-${ga}`]||0)+1; totals[gh+ga]=(totals[gh+ga]||0)+1; if(gh>ga) h++; else if(gh===ga) d++; else a++; }
  const pHome=h/runs, pDraw=d/runs, pAway=a/runs;
  const ouLine = safe(document.getElementById('ouLine').value,2.5);
  let over=0, totalcount=0; for(const t in totals){ totalcount += totals[t]; if(parseInt(t)>ouLine) over += totals[t]; } const overProb = totalcount? over/totalcount : 0;
  const hdpLine = safe(document.getElementById('hdpLine').value,0.25);
  const hdpCover = (function(){ let win=0,push=0; for(const sc in scoreFreq){ const v=scoreFreq[sc]; const [gh,ga]=sc.split('-').map(x=>parseInt(x)); const diff = gh-ga - hdpLine; if(diff>0) win+=v; else if(Math.abs(diff) < 1e-9) push+=v; } return (win + 0.5*push)/runs; })();
  const ouOverOpen = safe(document.getElementById('ouOverOpen').value,NaN), ouOverNow = safe(document.getElementById('ouOverNow').value,NaN);
  const ouUnderOpen = safe(document.getElementById('ouUnderOpen').value,NaN), ouUnderNow = safe(document.getElementById('ouUnderNow').value,NaN);
  const hdpHomeOpen = safe(document.getElementById('hdpHomeOpen').value,NaN), hdpHomeNow = safe(document.getElementById('hdpHomeNow').value,NaN);
  const hdpAwayOpen = safe(document.getElementById('hdpAwayOpen').value,NaN), hdpAwayNow = safe(document.getElementById('hdpAwayNow').value,NaN);
  const implied = { ouOver: impliedProbFromOdds(ouOverNow), ouUnder: impliedProbFromOdds(ouUnderNow), hdpHome: impliedProbFromOdds(hdpHomeNow), hdpAway: impliedProbFromOdds(hdpAwayNow) };
  const edges = { ouOver: (implied.ouOver? (overProb - implied.ouOver) : null), hdpHome: (implied.hdpHome? (hdpCover - implied.hdpHome) : null) };
  const candidates = [ {tag:`OU Over ${ouLine}`, prob: overProb, edge: edges.ouOver, market:'OU', open:ouOverOpen, now:ouOverNow}, {tag:`OU Under ${ouLine}`, prob: 1-overProb, edge: null, market:'OU', open:ouUnderOpen, now:ouUnderNow}, {tag:`HDP Home ${hdpLine}`, prob: hdpCover, edge: edges.hdpHome, market:'HDP', open:hdpHomeOpen, now:hdpHomeNow}, {tag:`HDP Away ${-hdpLine}`, prob: 1-hdpCover, edge: null, market:'HDP', open:hdpAwayOpen, now:hdpAwayNow} ];
  candidates.forEach(c=>{ c.edgeShr = (c.edge===null? null: shrinkEdge(c.edge)); c.delta = deltaPercent(c.open,c.now); c.direction = directionLabel(c.open,c.now,c.market); c.score = ((c.edgeShr||0)*(c.prob||0)) + (c.prob*0.6); });
  candidates.sort((a,b)=> (b.score||0) - (a.score||0));
  const best = candidates.slice(0,2);
  let mean=0,cnt=0; for(const t in totals){ mean += parseInt(t)*totals[t]; cnt += totals[t]; } mean/=cnt; let varv=0; for(const t in totals){ varv += ((parseInt(t)-mean)**2)*totals[t]; } varv/=cnt; let conf = clamp(1 - Math.min(1,varv/8), 0.12, 0.97); const confLabel = conf>0.8? 'High' : (conf>0.55? 'Medium' : 'Low');
  document.getElementById('matchTitle').textContent = `${teamH} vs ${teamA}`;
  document.getElementById('matchMeta').textContent = `${document.getElementById('stadHome').value||''} ‚Äî ${document.getElementById('stadAway').value||''}`;
  const expH = (Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[0])*v,0)/runs).toFixed(2);
  const expA = (Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[1])*v,0)/runs).toFixed(2);
  const summaryTxt = `Œª H:${lambdaH.toFixed(2)} | Œª A:${lambdaA.toFixed(2)}
Exp Goals H:${expH} A:${expA}
1X2 ‚Äî Home ${percent(pHome)} Draw ${percent(pDraw)} Away ${percent(pAway)}
OU(${ouLine}) Over ${percent(overProb)}
HDP (${hdpLine}) Home cover ${percent(hdpCover)}
Attack% H:${window._v52_atkH_pct||0}% A:${window._v52_atkA_pct||0}%
Defense% H:${window._v52_defH_pct||0}% A:${window._v52_defA_pct||0}%
Confidence: ${confLabel} (${(conf*100).toFixed(1)}%)
`;
  document.getElementById('summary').textContent = summaryTxt;
  drawHistogram(totals,'hist');
  let valHTML=''; best.forEach(bc=>{ const edgeTxt = bc.edgeShr===null? 'N/A' : ((bc.edgeShr*100).toFixed(2)+'%'); valHTML += `<div class="card" style="margin-bottom:6px"><strong>${bc.tag}</strong><div class="kv">Prob: ${percent(bc.prob)} ‚Ä¢ Edge: ${edgeTxt} ‚Ä¢ ${bc.direction||''}</div></div>`; });
  document.getElementById('valueList').innerHTML = valHTML;
  const csvData = { time: nowISO(), home: teamH, away: teamA, stadionH: document.getElementById('stadHome').value, stadionA: document.getElementById('stadAway').value, latH: document.getElementById('latHome').value, lonH: document.getElementById('lonHome').value, latA: document.getElementById('latAway').value, lonA: document.getElementById('lonAway').value, lambdaH: lambdaH, lambdaA: lambdaA, expH: parseFloat(expH), expA: parseFloat(expA), pHome: pHome, pDraw: pDraw, pAway: pAway, overProb: overProb, hdpCover: hdpCover, atkH: atkH, atkA: atkA, defH: defH, defA: defA, atkH_pct: window._v52_atkH_pct, atkA_pct: window._v52_atkA_pct, defH_pct: window._v52_defH_pct, defA_pct: window._v52_defA_pct, confidence: conf, confidenceLabel: confLabel, travelKm: km, impact: document.getElementById('travelImpact').textContent, odds:{hdpLine:hdpLine, hdpHomeOpen:hdpHomeOpen, hdpHomeNow:hdpHomeNow, hdpAwayOpen:hdpAwayOpen, hdpAwayNow:hdpAwayNow, ouLine:ouLine, ouOverOpen:ouOverOpen, ouOverNow:ouOverNow, ouUnderOpen:ouUnderOpen, ouUnderNow:ouUnderNow} };
  sessionStorage.setItem('v52b_last_csv', JSON.stringify(csvData));
  downloadCSV(csvData);
  addToCache({team: teamH, stadium: document.getElementById('stadHome').value, lat: parseFloat(document.getElementById('latHome').value)||0, lon: parseFloat(document.getElementById('lonHome').value)||0, league: document.getElementById('leagueHome').value||'', country: document.getElementById('countryHome').value||''});
  addToCache({team: teamA, stadium: document.getElementById('stadAway').value, lat: parseFloat(document.getElementById('latAway').value)||0, lon: parseFloat(document.getElementById('lonAway').value)||0, league: document.getElementById('leagueAway').value||'', country: document.getElementById('countryAway').value||''});
  updateCacheCount(); } catch(e){ console.error(e); alert('Error saat analisis: '+e.message); } }

/* CSV download and helper functions (same as earlier) */
function downloadCSV(data){
  const header = ['Match','Date','Home','Away','StadiumH','StadiumA','LatH','LonH','LatA','LonA','LambdaH','LambdaA','ExpH','ExpA','P_Home','P_Draw','P_Away','OverProb','HDP_Cover','AtkIdxH','AtkIdxA','DefIdxH','DefIdxA','AtkPctH','AtkPctA','DefPctH','DefPctA','Confidence','ConfidenceLabel','TravelKm','Impact','HDP_Line','HDP_Home_Open','HDP_Home_Now','HDP_Away_Open','HDP_Away_Now','OU_Line','OU_Over_Open','OU_Over_Now','OU_Under_Open','OU_Under_Now'];
  const row = [ `${data.home} vs ${data.away}`, data.time, data.home, data.away, data.stadionH, data.stadionA, data.latH, data.lonH, data.latA, data.lonA, data.lambdaH.toFixed(3), data.lambdaA.toFixed(3), data.expH.toFixed(3), data.expA.toFixed(3), data.pHome.toFixed(4), data.pDraw.toFixed(4), data.pAway.toFixed(4), data.overProb.toFixed(4), data.hdpCover.toFixed(4), data.atkH.toFixed(4), data.atkA.toFixed(4), data.defH.toFixed(4), data.defA.toFixed(4), data.atkH_pct, data.atkA_pct, data.defH_pct, data.defA_pct, data.confidence.toFixed(4), data.confidenceLabel, data.travelKm, data.impact, data.odds.hdpLine, data.odds.hdpHomeOpen, data.odds.hdpHomeNow, data.odds.hdpAwayOpen, data.odds.hdpAwayNow, data.odds.ouLine, data.odds.ouOverOpen, data.odds.ouOverNow, data.odds.ouUnderOpen, data.odds.ouUnderNow ];
  const rows = [header, row];
  const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `analysis_v52B_${nowISO()}_${data.home.replace(/\s+/g,'')}_vs_${data.away.replace(/\s+/g,'')}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function drawHistogram(totals, canvasId){ const c=document.getElementById(canvasId); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#02121a'; ctx.fillRect(0,0,c.width,c.height); const keys = Object.keys(totals).map(k=>parseInt(k)).sort((a,b)=>a-b); const maxV = Math.max(...keys.map(k=>totals[k]||0),1); const left=20,right=c.width-20,w=(right-left)/Math.max(1,keys.length); keys.forEach((k,i)=>{ const v=totals[k]||0, h=(v/maxV)*(c.height-30); ctx.fillStyle='#0b74de'; ctx.fillRect(left + i*w, c.height-10-h, w*0.8, h); ctx.fillStyle='#9fd6ee'; ctx.font='10px Arial'; ctx.fillText(String(k), left + i*w + 2, c.height-2); }); }

/* Buttons wiring */
document.getElementById('btnAnalyze').addEventListener('click', analyzeAndExport);
document.getElementById('btnClearCache').addEventListener('click', ()=>{ if(confirm('Hapus semua cache sesi sekarang?')){ clearCache(); alert('Cache sesi dihapus'); } });
document.getElementById('btnDownloadLast').addEventListener('click', ()=>{ const d=sessionStorage.getItem('v52b_last_csv'); if(!d){ alert('Belum ada hasil analisis.'); return; } downloadCSV(JSON.parse(d)); });
document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('Reset semua input?')) return; document.querySelectorAll('input,select').forEach(i=>{ if(i.type!=='button') i.value=''; }); document.getElementById('summary').textContent='‚Äî'; document.getElementById('matchTitle').textContent='-'; document.getElementById('matchMeta').textContent='-'; document.getElementById('hist').getContext('2d').clearRect(0,0,720,140); updateCacheCount(); });

/* Example auto-fill on load */
function fillExampleAuto(){
  document.getElementById('leagueHome').value='Premier League'; populateTeams('Premier League','teamHome'); document.getElementById('teamHome').value='Manchester City';
  document.getElementById('leagueAway').value='Premier League'; populateTeams('Premier League','teamAway'); document.getElementById('teamAway').value='Tottenham Hotspur';
  fillFromDB('Home'); setTimeout(()=> fillFromDB('Away'),300);
  document.getElementById('xgHome').value=2.10; document.getElementById('sotHome').value=6.2; document.getElementById('convHome').value=''; document.getElementById('possHome').value=62;
  document.getElementById('xgAway').value=1.45; document.getElementById('sotAway').value=4.1; document.getElementById('convAway').value=''; document.getElementById('possAway').value=38;
  document.getElementById('tackleHome').value=22; document.getElementById('interHome').value=9; document.getElementById('tackleAway').value=17; document.getElementById('interAway').value=7; autoTI();
  document.getElementById('csHome').value=0.48; document.getElementById('csAway').value=0.30; document.getElementById('gcHome')?.value=0.8; document.getElementById('gcAway')?.value=1.3; document.getElementById('saveHome').value=3.6; document.getElementById('saveAway').value=3.1;
  document.getElementById('errHome').value=5; document.getElementById('errAway').value=8;
  document.getElementById('goalsHome').value=8; document.getElementById('goalsAway').value=6;
  document.getElementById('hdpLine').value=0.25; document.getElementById('hdpHomeOpen').value=1.95; document.getElementById('hdpHomeNow').value=1.88; document.getElementById('hdpAwayOpen').value=1.95; document.getElementById('hdpAwayNow').value=2.05;
  document.getElementById('ouLine').value=2.5; document.getElementById('ouOverOpen').value=1.95; document.getElementById('ouOverNow').value=1.88; document.getElementById('ouUnderOpen').value=1.90; document.getElementById('ouUnderNow').value=2.00;
  document.getElementById('eloHome').value=1820; document.getElementById('eloAway').value=1690;
  calcTravel(); updateTacticalBars(); // do not auto-run analysis, wait for user click
}

/* init */
autoTI(); updateTacticalBars(); updateCacheCount(); setTimeout(fillExampleAuto,200);
</script>
</body>
</html>
