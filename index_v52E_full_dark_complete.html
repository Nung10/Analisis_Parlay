<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Football Analyzer Pro v52E ‚Äî Ultra Precision (Dark) - Absence Enabled</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#071015;--panel:#0d1b21;--card:#08161a;--accent:#06b6d4;--muted:#9fd6ee;--text:#e8fbff;--warn:#f7b731;--danger:#ff6b6b;}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:1280px;margin:12px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
h1{font-size:20px;margin:0}
.small{font-size:13px;color:var(--muted)}
.block{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
label{display:block;font-size:13px;color:var(--muted);margin:6px 0}
input[type="text"],input[type="number"],select,textarea,button{font-family:inherit}
input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:#071a20;color:var(--text)}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#001f24;cursor:pointer}
.btn-muted{background:#0e3b45;color:var(--text);border:1px solid rgba(255,255,255,0.02)}
.kv{font-size:13px;color:var(--muted)}
.card{background:var(--card);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.pre{background:#02131a;padding:10px;border-radius:8px;font-family:ui-monospace,monospace;margin-top:8px;white-space:pre-wrap}
.canvas{background:#02121a;border-radius:6px;border:1px solid rgba(255,255,255,0.02);display:block}
.small-log{font-size:13px;color:#b7f5e6;margin-top:8px}
.btn-working{filter:brightness(1.15);box-shadow:0 0 0 3px rgba(6,182,212,0.08) inset}
.trap-red{color:var(--danger)}
.trap-yellow{color:var(--warn)}
.footer{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px;text-align:left}
.badge{display:inline-block;padding:4px 8px;border-radius:6px;background:#062f33;color:#bff3ef;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>Football Analyzer Pro ‚Äî v52E Ultra Precision (Dark)</h1>
      <div class="small">Absence (DF/MF/FW) optional ‚Ä¢ Hitung TI tombol di bawah Tackles ‚Ä¢ Odds trap & MC analysis</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="geoStatus" class="kv">Geo: Ready</div>
      <button id="btnDownloadLast" class="btn-muted">üì• Download CSV Terakhir</button>
    </div>
  </div>

  <div class="block">
    <h3>Match & Team Info (manual)</h3>
    <div class="row">
      <div class="col"><label>League Home: <input id="leagueHome" type="text" placeholder="ketik liga"></label></div>
      <div class="col"><label>Team Home: <input id="teamHome" type="text" placeholder="ketik tim"></label></div>
      <div class="col"><label>League Away: <input id="leagueAway" type="text" placeholder="ketik liga"></label></div>
      <div class="col"><label>Team Away: <input id="teamAway" type="text" placeholder="ketik tim"></label></div>
    </div>

    <div style="margin-top:8px" class="row">
      <div class="col"><label>Absence DF Home (kosong=0): <input id="absDfHome" type="number" min="0" step="1" placeholder="jumlah DF absen"></label></div>
      <div class="col"><label>Absence MF Home (kosong=0): <input id="absMfHome" type="number" min="0" step="1" placeholder="jumlah MF absen"></label></div>
      <div class="col"><label>Absence FW Home (kosong=0): <input id="absFwHome" type="number" min="0" step="1" placeholder="jumlah FW absen"></label></div>
      <div class="col"><label>ELO Home: <input id="eloHome" type="number" value="1820"></label></div>
    </div>

    <div style="margin-top:8px" class="row">
      <div class="col"><label>Absence DF Away (kosong=0): <input id="absDfAway" type="number" min="0" step="1" placeholder="jumlah DF absen"></label></div>
      <div class="col"><label>Absence MF Away (kosong=0): <input id="absMfAway" type="number" min="0" step="1" placeholder="jumlah MF absen"></label></div>
      <div class="col"><label>Absence FW Away (kosong=0): <input id="absFwAway" type="number" min="0" step="1" placeholder="jumlah FW absen"></label></div>
      <div class="col"><label>ELO Away: <input id="eloAway" type="number" value="1690"></label></div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button id="btnFillFromDB" class="btn-muted">Isi Stadion dari Local DB</button>
      <button id="btnStadiumOnline" class="btn-muted">üîç Cari Stadion (Online)</button>
      <button id="btnSaveStadium" class="btn-muted">üíæ Simpan Stadion ke Cache</button>
      <div style="margin-left:auto" class="kv">Travel: <span id="travelKm">‚Äî</span> km ‚Ä¢ <span id="travelImpact">‚Äî</span></div>
    </div>
  </div>

  <div class="block">
    <h3>Stadium (manual/auto)</h3>
    <div class="row">
      <div class="col"><label>Stadium Home: <input id="stadHome" type="text"></label></div>
      <div class="col"><label>Lat Home: <input id="latHome" type="number" step="0.0001"></label></div>
      <div class="col"><label>Lon Home: <input id="lonHome" type="number" step="0.0001"></label></div>
      <div class="col"><label>Country Home: <input id="countryHome" type="text"></label></div>
    </div>

    <div style="margin-top:8px" class="row">
      <div class="col"><label>Stadium Away: <input id="stadAway" type="text"></label></div>
      <div class="col"><label>Lat Away: <input id="latAway" type="number" step="0.0001"></label></div>
      <div class="col"><label>Lon Away: <input id="lonAway" type="number" step="0.0001"></label></div>
      <div class="col"><label>Country Away: <input id="countryAway" type="text"></label></div>
    </div>
  </div>

  <div class="block">
    <h3>Attack & Defense Inputs</h3>
    <div class="row">
      <div class="col"><label>xG Home: <input id="xgHome" type="number" step="0.01" value="1.6"></label></div>
      <div class="col"><label>xG Away: <input id="xgAway" type="number" step="0.01" value="1.1"></label></div>
      <div class="col"><label>SOT Home: <input id="sotHome" type="number" value="5"></label></div>
      <div class="col"><label>SOT Away: <input id="sotAway" type="number" value="3"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Conv Rate Home (Goals/SOT): <input id="convHome" type="number" step="0.01" placeholder="otomatis jika kosong"></label></div>
      <div class="col"><label>Conv Rate Away: <input id="convAway" type="number" step="0.01" placeholder="otomatis jika kosong"></label></div>
      <div class="col"><label>Poss Home %: <input id="possHome" type="number" step="0.1" value="62"></label></div>
      <div class="col"><label>Poss Away %: <input id="possAway" type="number" step="0.1" value="38"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Tackles Home: <input id="tackleHome" type="number" value="18"></label></div>
      <div class="col"><label>Interceptions Home: <input id="interHome" type="number" value="8"></label></div>
      <div class="col"><label>TI Home (auto): <input id="tiHome" readonly></label></div>
      <div class="col"><label>Clean Sheet per Game Home: <input id="csHome" type="number" step="0.01" value="0.28"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Tackles Away: <input id="tackleAway" type="number" value="16"></label></div>
      <div class="col"><label>Interceptions Away: <input id="interAway" type="number" value="6"></label></div>
      <div class="col"><label>TI Away (auto): <input id="tiAway" readonly></label></div>
      <div class="col"><label>Clean Sheet per Game Away: <input id="csAway" type="number" step="0.01" value="0.22"></label></div>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button id="btnCalcTI" class="btn-muted">Hitung Semua TI</button>
      <div class="kv" style="margin-left:8px">(Tackles + Interceptions otomatis)</div>
    </div>
  </div>

  <div class="block">
    <h3>Odds Market (HDP & Over/Under) ‚Äî Trap Detection</h3>
    <div class="row">
      <div class="col"><label>HDP Line: <input id="hdpLine" type="number" step="0.25" value="0.25"></label></div>
      <div class="col"><label>HDP Home Open: <input id="hdpHomeOpen" type="number" step="0.01" value="1.95"></label></div>
      <div class="col"><label>HDP Home Now: <input id="hdpHomeNow" type="number" step="0.01" value="1.88"></label></div>
      <div class="col"><label>HDP Away Now: <input id="hdpAwayNow" type="number" step="0.01" value="2.05"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>OU Line: <input id="ouLine" type="number" step="0.25" value="2.5"></label></div>
      <div class="col"><label>OU Over Open: <input id="ouOverOpen" type="number" step="0.01" value="1.95"></label></div>
      <div class="col"><label>OU Over Now: <input id="ouOverNow" type="number" step="0.01" value="1.88"></label></div>
      <div class="col"><label>OU Under Now: <input id="ouUnderNow" type="number" step="0.01" value="2.00"></label></div>
    </div>

    <div style="margin-top:8px" class="row">
      <div class="col">
        <button id="btnDetectTrap" class="btn-muted">Detect Odds Trap</button>
      </div>
      <div class="col">
        <div id="trapResult" class="kv">Status trap: ‚Äî</div>
      </div>
      <div class="col">
        <div id="deltaInfo" class="kv">Œî OU: ‚Äî ‚Ä¢ Œî HDP: ‚Äî</div>
      </div>
    </div>
  </div>

  <div class="block">
    <h3>Controls & Analysis</h3>
    <div class="row">
      <div class="col"><label>Days rest Home: <input id="daysRestHome" type="number" value="5"></label></div>
      <div class="col"><label>Days rest Away: <input id="daysRestAway" type="number" value="3"></label></div>
      <div class="col"><label>Monte Carlo runs: <input id="mcRuns" type="number" value="8000" step="500"></label></div>
      <div class="col"><label>Correlation rho: <input id="rho" type="number" step="0.01" value="0.12"></label></div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button id="btnAnalyze" class="btn-muted">Analisis (MC) & Download CSV</button>
      <button id="btnReset" class="btn-muted">Reset</button>
      <button id="btnClearCache" class="btn-muted">Hapus Cache</button>
      <div style="margin-left:auto" class="kv">Session cache: <span id="cacheCount">0</span></div>
    </div>

    <div id="saveLog" class="small-log"></div>
  </div>

  <div class="block">
    <div class="row">
      <div class="col card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong id="matchTitle">-</strong><div class="small" id="matchMeta">-</div></div>
          <div>
            <div class="badge" id="confBadge">Conf: ‚Äî</div>
          </div>
        </div>
        <pre id="summary" class="pre">‚Äî</pre>
      </div>

      <div class="col card">
        <h4 class="small">Recommendations (Top 2)</h4>
        <div id="valueList">‚Äî</div>
        <div style="height:12px"></div>
        <h4 class="small">Trap Table</h4>
        <table class="table" id="trapTable"><thead><tr><th>Market</th><th>Open</th><th>Now</th><th>Œî%</th><th>Status</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div style="margin-top:10px"><canvas id="hist" width="900" height="140" class="canvas"></canvas></div>
  </div>

  <div class="footer">v52E Ultra Precision ‚Ä¢ Dark ‚Ä¢ Desktop ‚Äî Absence fields optional</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

const $ = id => document.getElementById(id);
function safe(v,d=0){const x=parseFloat(v);return isNaN(x)?d:x;}
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function percent(x){return (100*x).toFixed(1)+'%';}
function nowDate(){const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function poisson(lambda){let L=Math.exp(-lambda), p=1, k=0; while(p> L){k++; p*=Math.random(); if(k>2000) break;} return Math.max(0,k-1);}

// Small stadium DB
const STADIUM_DB = [
  {league:'Premier League', team:'Manchester City', stadium:'Etihad Stadium', lat:53.4831, lon:-2.2004, country:'England'},
  {league:'Premier League', team:'Tottenham Hotspur', stadium:'Tottenham Hotspur Stadium', lat:51.6044, lon:-0.0663, country:'England'},
  {league:'World Cup', team:'Latvia', stadium:'Daugava Stadium', lat:56.9522, lon:24.1089, country:'Latvia'},
  {league:'World Cup', team:'Andorra', stadium:'Estadi Nacional', lat:42.5078, lon:1.5216, country:'Andorra'}
];

// Cache helpers
const CACHE_KEY = 'v52e_cache';
function getCache(){try{return JSON.parse(sessionStorage.getItem(CACHE_KEY)||'[]')}catch(e){return []}}
function setCache(v){sessionStorage.setItem(CACHE_KEY, JSON.stringify(v)); updateCacheCount();}
function addToCache(rec){ const arr=getCache(); if(!arr.find(x=>x.team===rec.team)){ arr.push(rec); setCache(arr);} }
function clearCache(){ sessionStorage.removeItem(CACHE_KEY); updateCacheCount(); }
function updateCacheCount(){ $('cacheCount').textContent = getCache().length; }

// Fill stadium from local db if exists
function findLocal(team){ if(!team) return null; const c = getCache().find(x=>x.team.toLowerCase()===team.toLowerCase()); if(c) return c; const r = STADIUM_DB.find(s=>s.team.toLowerCase()===team.toLowerCase()); return r || null; }
$('btnFillFromDB').addEventListener('click', ()=>{
  const th = $('teamHome').value.trim(), ta = $('teamAway').value.trim();
  const rH = findLocal(th), rA = findLocal(ta);
  if(rH) { $('stadHome').value = rH.stadium; $('latHome').value = rH.lat; $('lonHome').value = rH.lon; $('countryHome').value = rH.country; $('geoStatus').textContent='Geo: Local DB'; }
  else alert('Team Home tidak ditemukan di DB lokal.');
  if(rA) { $('stadAway').value = rA.stadium; $('latAway').value = rA.lat; $('lonAway').value = rA.lon; $('countryAway').value = rA.country; $('geoStatus').textContent='Geo: Local DB'; }
  else alert('Team Away tidak ditemukan di DB lokal.');
  calcTravel();
});

// Online lookup (Nominatim)
async function geocode(q){ try{ const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q)+'&limit=3'); if(!res.ok) return null; const j = await res.json(); return j.length? j[0] : null; }catch(e){return null;} }
$('btnStadiumOnline').addEventListener('click', async ()=>{
  const th = $('teamHome').value || $('leagueHome').value; const ta = $('teamAway').value || $('leagueAway').value;
  if(th){ $('geoStatus').textContent='Geo: searching...'; const r = await geocode(th+' stadium'); if(r){ $('stadHome').value = r.display_name; $('latHome').value = parseFloat(r.lat).toFixed(4); $('lonHome').value = parseFloat(r.lon).toFixed(4); $('geoStatus').textContent='Geo: Online'; addToCache({team:th, stadium:r.display_name, lat:parseFloat(r.lat), lon:parseFloat(r.lon), league:$('leagueHome').value||''}); } else { alert('Online search Home gagal'); $('geoStatus').textContent='Geo: Ready'; } }
  if(ta){ $('geoStatus').textContent='Geo: searching...'; const r2 = await geocode(ta+' stadium'); if(r2){ $('stadAway').value = r2.display_name; $('latAway').value = parseFloat(r2.lat).toFixed(4); $('lonAway').value = parseFloat(r2.lon).toFixed(4); $('geoStatus').textContent='Geo: Online'; addToCache({team:ta, stadium:r2.display_name, lat:parseFloat(r2.lat), lon:parseFloat(r2.lon), league:$('leagueAway').value||''}); } else { alert('Online search Away gagal'); $('geoStatus').textContent='Geo: Ready'; } }
  updateCacheCount();
});
$('btnSaveStadium').addEventListener('click', ()=>{ const th = $('teamHome').value; if(!th) return alert('Isi team Home untuk simpan.'); addToCache({team:th, stadium:$('stadHome').value, lat:parseFloat($('latHome').value)||0, lon:parseFloat($('lonHome').value)||0, league:$('leagueHome').value||''}); updateCacheCount(); alert('Stadium Home disimpan ke cache sesi.'); });

// Auto TI
function calcTI(){ $('tiHome').value = (safe($('tackleHome').value) + safe($('interHome').value)).toFixed(1); $('tiAway').value = (safe($('tackleAway').value) + safe($('interAway').value)).toFixed(1); }
$('btnCalcTI').addEventListener('click', ()=>{ flashButton('btnCalcTI'); calcTI(); });

// Travel calc (haversine)
function calcTravel(){
  const latH = safe($('latHome').value, NaN), lonH = safe($('lonHome').value, NaN);
  const latA = safe($('latAway').value, NaN), lonA = safe($('lonAway').value, NaN);
  if(isNaN(latH)||isNaN(lonH)||isNaN(latA)||isNaN(lonA)){ $('travelKm').textContent='‚Äî'; $('travelImpact').textContent='‚Äî'; return; }
  const R=6371; const toRad=x=>x*Math.PI/180; const dLat=toRad(latA-latH), dLon=toRad(lonA-lonH); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(latH))*Math.cos(toRad(latA))*Math.sin(dLon/2)**2; const km=Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
  $('travelKm').textContent = km;
  const impact = (km<50)? 'Negligible' : (km<500? '-2% stamina' : (km<1000? '-4% stamina' : (km<3000? '-7% stamina' : '-10% stamina')));
  $('travelImpact').textContent = impact;
  return km;
}
['latHome','lonHome','latAway','lonAway'].forEach(id=>{ const el = $(id); if(el) el.addEventListener('input', calcTravel); });

// Index computations
function computeAttackIndex(xg,sot,conv,poss, absMf=0, absFw=0){
  let base = 0.35*xg + 0.25*(sot/5) + 0.15*(conv*100);
  // penalties for absences: MF reduces attacking control, FW reduces finishing
  const mfPenalty = 1 - (0.03 * absMf);
  const fwPenalty = 1 - (0.05 * absFw);
  const possFactor = Math.min(1.15, Math.max(0.85, 1 + (poss-50)/100));
  return Math.max(0.05, base * possFactor * mfPenalty * fwPenalty);
}
function computeDefenseIndex(cs,gc,saves,ti,err, absDf=0){
  const errPerGame = err/38.0;
  let val = 1.0 + (-0.22*gc) + (0.28*cs) + 0.06*(saves/4) - 0.02*(ti/30) + 0.03*errPerGame;
  // DF absence increases vulnerability
  const dfPenalty = 1 + (0.04 * absDf);
  return clamp(val * dfPenalty, 0.25, 2.8);
}

// Button flash
function flashButton(id){ const b = $(id); if(!b) return; b.classList.add('btn-working'); setTimeout(()=> b.classList.remove('btn-working'), 700); }

// Trap detection
function detectTraps(){
  flashButton('btnDetectTrap');
  const ouOpen = safe($('ouOverOpen').value, NaN), ouNow = safe($('ouOverNow').value, NaN);
  const hdpOpen = safe($('hdpHomeOpen').value, NaN), hdpNow = safe($('hdpHomeNow').value, NaN);
  const deltaOU = (ouOpen && ouNow)? ((ouNow - ouOpen)/ouOpen*100).toFixed(1) : null;
  const deltaHDP = (hdpOpen && hdpNow)? ((hdpNow - hdpOpen)/hdpOpen*100).toFixed(1) : null;
  $('deltaInfo').textContent = `Œî OU: ${deltaOU===null? '‚Äî': deltaOU+'%'} ‚Ä¢ Œî HDP: ${deltaHDP===null? '‚Äî': deltaHDP+'%'}`;
  let trapMsg = 'Stable', statusClass='';
  if(deltaOU!==null && Math.abs(deltaOU) >= 15) { trapMsg = 'TRAP (OU)'; statusClass='trap-red'; }
  else if(deltaHDP!==null && Math.abs(deltaHDP) >= 15) { trapMsg = 'TRAP (HDP)'; statusClass='trap-red'; }
  else if((deltaOU!==null && Math.abs(deltaOU)>=5) || (deltaHDP!==null && Math.abs(deltaHDP)>=5)) { trapMsg = 'Warning'; statusClass='trap-yellow'; }
  $('trapResult').textContent = 'Status trap: ' + trapMsg;
  $('trapResult').className = 'kv ' + statusClass;
  // update trap table
  const tbody = document.querySelector('#trapTable tbody'); tbody.innerHTML = '';
  function addRow(m,o,n,d,s){ const tr = document.createElement('tr'); tr.innerHTML = `<td>${m}</td><td>${o||''}</td><td>${n||''}</td><td>${d||''}</td><td>${s||''}</td>`; tbody.appendChild(tr); }
  addRow('OU Over', ouOpen, ouNow, deltaOU? deltaOU+'%':'' , trapMsg);
  addRow('HDP Home', hdpOpen, hdpNow, deltaHDP? deltaHDP+'%':'' , trapMsg);
}
$('btnDetectTrap').addEventListener('click', detectTraps);

// Analysis
$('btnAnalyze').addEventListener('click', async ()=>{
  flashButton('btnAnalyze');
  try{
    // require coords
    if(!($('latHome').value && $('latAway').value)){ alert('Isi Lat/Lon stadion Home & Away (atau gunakan Cari Stadion).'); return; }
    calcTI(); calcTravel();
    // read inputs (absences default 0 if empty)
    const teamH = $('teamHome').value || 'Home', teamA = $('teamAway').value || 'Away';
    const xgH = safe($('xgHome').value,1.2), xgA = safe($('xgAway').value,1.0);
    const sotH = safe($('sotHome').value,4), sotA = safe($('sotAway').value,3);
    const convH = safe($('convHome').value,0.12), convA = safe($('convAway').value,0.11);
    const tiH = safe($('tiHome').value, 20), tiA = safe($('tiAway').value, 18);
    const csH = safe($('csHome').value, 0.28), csA = safe($('csAway').value, 0.22);
    const errH = safe($('errHome')?.value,6), errA = safe($('errAway')?.value,7);
    const savesH = safe($('saveHome')?.value,3.4), savesA = safe($('saveAway')?.value,3.2);
    const eloH = safe($('eloHome').value,1500), eloA = safe($('eloAway').value,1500);
    const daysH = safe($('daysRestHome').value,4), daysA = safe($('daysRestAway').value,3);
    const absDfH = Math.max(0, safe($('absDfHome').value,0)), absMfH = Math.max(0, safe($('absMfHome').value,0)), absFwH = Math.max(0, safe($('absFwHome').value,0));
    const absDfA = Math.max(0, safe($('absDfAway').value,0)), absMfA = Math.max(0, safe($('absMfAway').value,0)), absFwA = Math.max(0, safe($('absFwAway').value,0));
    // compute indices with absence impacts
    const atkH = computeAttackIndex(xgH,sotH,convH,safe($('possHome').value,50), absMfH, absFwH);
    const atkA = computeAttackIndex(xgA,sotA,convA,safe($('possAway').value,48), absMfA, absFwA);
    const defH = computeDefenseIndex(csH, safe($('gcHome')?.value,1.1), savesH, tiH, errH, absDfH);
    const defA = computeDefenseIndex(csA, safe($('gcAway')?.value,1.3), savesA, tiA, errA, absDfA);
    // absence impact summary
    const impactH = {df:absDfH, mf:absMfH, fw:absFwH};
    const impactA = {df:absDfA, mf:absMfA, fw:absFwA};
    // stamina/travel factors
    const km = calcTravel()||0;
    const stamH = clamp(1 - Math.max(0,(3-daysH))*0.035 - Math.max(0,(km-200))*0.00016, 0.65, 1.06);
    const stamA = clamp(1 - Math.max(0,(3-daysA))*0.035 - Math.max(0,(km-200))*0.00016, 0.65, 1.06);
    // elo influence
    const sfH = clamp(1 + (eloH-eloA)/1400, 0.75, 1.25);
    const sfA = clamp(1 + (eloA-eloH)/1400, 0.75, 1.25);
    // lambda
    let lambdaH = Math.max(0.03, 1.02 * (atkH/Math.max(0.3,defA)) * sfH * stamH);
    let lambdaA = Math.max(0.03, 0.98 * (atkA/Math.max(0.3,defH)) * sfA * stamA);
    const avgLam = (lambdaH+lambdaA)/2;
    if(avgLam>3.0){ lambdaH *= 0.86; lambdaA *= 0.86; } else if(avgLam>2.0){ lambdaH *= 0.94; lambdaA *= 0.94; }
    // Monte Carlo
    const runs = Math.max(2000, safe($('mcRuns').value,8000));
    const scoreFreq = {}; const totals = {}; let winH=0, draw=0, winA=0;
    for(let i=0;i<runs;i++){
      const gh = poisson(lambdaH); const ga = poisson(lambdaA);
      scoreFreq[`${gh}-${ga}`] = (scoreFreq[`${gh}-${ga}`]||0) + 1;
      totals[gh+ga] = (totals[gh+ga]||0) + 1;
      if(gh>ga) winH++; else if(gh===ga) draw++; else winA++;
    }
    const pH = winH/runs, pD = draw/runs, pA = winA/runs;
    // OU prob
    const ouLine = safe($('ouLine').value,2.5);
    let overCount=0, totalCount=0; for(const t in totals){ totalCount += totals[t]; if(parseInt(t)>ouLine) overCount += totals[t]; }
    const overProb = totalCount? overCount/totalCount : 0;
    // HDP cover prob for home
    const hdpLine = safe($('hdpLine').value,0.25);
    let cover=0,push=0;
    for(const sc in scoreFreq){ const v = scoreFreq[sc]; const [gh,ga] = sc.split('-').map(x=>parseInt(x)); const diff = gh - ga - hdpLine; if(diff>0) cover += v; else if(Math.abs(diff) < 1e-9) push += v; }
    const coverHome = (cover + 0.5*push)/runs;
    // edges vs odds
    const impliedOver = (safe($('ouOverNow').value,NaN)>0)? 1/safe($('ouOverNow').value): null;
    const impliedHdpHome = (safe($('hdpHomeNow').value,NaN)>0)? 1/safe($('hdpHomeNow').value): null;
    const edgeOver = impliedOver? (overProb - impliedOver) : null;
    const edgeHdp = impliedHdpHome? (coverHome - impliedHdpHome) : null;
    // recommendations
    const candidates = [
      {tag:`OU Over ${ouLine}`, prob: overProb, edge: edgeOver, market:'OU'},
      {tag:`OU Under ${ouLine}`, prob: 1-overProb, edge: null, market:'OU'},
      {tag:`HDP Home ${hdpLine}`, prob: coverHome, edge: edgeHdp, market:'HDP'},
      {tag:`HDP Away ${-hdpLine}`, prob: 1-coverHome, edge: null, market:'HDP'}
    ];
    candidates.forEach(c=>{ c.edgeShr = c.edge===null? null : Math.sign(c.edge) * Math.min(Math.abs(c.edge), 0.22); c.score = (c.prob*0.65) + ((c.edgeShr||0)*0.35); });
    candidates.sort((a,b)=>b.score - a.score);
    const best = candidates.slice(0,2);
    // confidence
    let mean=0,count=0; for(const t in totals){ mean += parseInt(t)*totals[t]; count += totals[t]; } mean /= Math.max(1,count);
    let varv=0; for(const t in totals){ varv += ((parseInt(t)-mean)**2)*totals[t]; } varv /= Math.max(1,count);
    let conf = clamp(1 - Math.min(1,varv/8), 0.12, 0.98);
    const confLabel = conf>0.85? 'High' : (conf>0.6? 'Medium' : 'Low');
    // render
    $('matchTitle').textContent = `${teamH} vs ${teamA}`;
    $('matchMeta').textContent = `${$('stadHome').value||''} ‚Äî ${$('stadAway').value||''}`;
    const expH = (Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[0])*v,0)/runs).toFixed(2);
    const expA = (Object.entries(scoreFreq).reduce((s,[sc,v])=> s + parseInt(sc.split('-')[1])*v,0)/runs).toFixed(2);
    const absenceText = `Absence Home: DF ${absDfH} MF ${absMfH} FW ${absFwH} ‚Ä¢ Away: DF ${absDfA} MF ${absMfA} FW ${absFwA}`;
    const summary = `Œª H:${lambdaH.toFixed(2)} | Œª A:${lambdaA.toFixed(2)}
Exp Goals H:${expH} A:${expA}
1X2 ‚Äî Home ${percent(pH)} Draw ${percent(pD)} Away ${percent(pA)}
OU(${ouLine}) Over ${percent(overProb)}
HDP (${hdpLine}) Home cover ${percent(coverHome)}
${absenceText}
AtkIdx H:${atkH.toFixed(2)} A:${atkA.toFixed(2)} ‚Ä¢ DefIdx H:${defH.toFixed(2)} A:${defA.toFixed(2)}
Confidence: ${confLabel} (${(conf*100).toFixed(1)}%)`;
    $('summary').textContent = summary;
    drawHistogram(totals);
    // recs
    let valHtml = '';
    best.forEach(b=>{ valHtml += `<div class="card" style="margin-bottom:8px"><strong>${b.tag}</strong><div class="kv">Prob: ${percent(b.prob)} ‚Ä¢ Edge: ${b.edgeShr!==null? ((b.edgeShr*100).toFixed(2)+'%') : 'N/A'}</div></div>`; });
    $('valueList').innerHTML = valHtml;
    detectTraps();
    // save CSV
    const payload = { date: nowDate(), home: teamH, away: teamA, stadiumHome: $('stadHome').value, stadiumAway: $('stadAway').value, lambdaH: lambdaH.toFixed(3), lambdaA: lambdaA.toFixed(3), expH, expA, pHome:pH, pDraw:pD, pAway:pA, overProb, coverHome, absHome:{df:absDfH,mf:absMfH,fw:absFwH}, absAway:{df:absDfA,mf:absMfA,fw:absFwA}, confidence: conf, confidenceLabel: confLabel };
    sessionStorage.setItem('v52e_last', JSON.stringify(payload));
    downloadCSV(payload, `Prediction_${sanitize(teamH)}_vs_${sanitize(teamA)}_${nowDate()}`);
    $('saveLog').textContent = `‚úÖ Analisis & CSV siap: Prediction_${sanitize(teamH)}_vs_${sanitize(teamA)}_${nowDate()}.csv`;
    addToCache({team:teamH, stadium:$('stadHome').value, lat:parseFloat($('latHome').value)||0, lon:parseFloat($('lonHome').value)||0});
    addToCache({team:teamA, stadium:$('stadAway').value, lat:parseFloat($('latAway').value)||0, lon:parseFloat($('lonAway').value)||0});
    updateCacheCount();
    $('confBadge').textContent = `Conf: ${confLabel} ${(conf*100).toFixed(0)}%`;
  }catch(err){ console.error(err); alert('Error saat analisis: '+err.message); }
});

// Helpers
function downloadCSV(obj, name){
  const header = Object.keys(obj).join(',');
  const row = Object.keys(obj).map(k=>`"${String(obj[k]).replace(/"/g,'""')}"`).join(',');
  const csv = header + '\n' + row;
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function sanitize(s){ return s? s.replace(/[^\w\-_. ]+/g,'').replace(/\s+/g,'_') : 'match'; }

// histogram
function drawHistogram(totals){
  const c = $('hist'); const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle='#02121a'; ctx.fillRect(0,0,c.width,c.height);
  const keys = Object.keys(totals).map(k=>parseInt(k)).sort((a,b)=>a-b);
  const maxV = Math.max(...keys.map(k=>totals[k]||0),1);
  const left = 20, right = c.width-20, w=(right-left)/Math.max(1,keys.length);
  keys.forEach((k,i)=>{ const v = totals[k]||0, h=(v/maxV)*(c.height-30); ctx.fillStyle='#0b74de'; ctx.fillRect(left + i*w, c.height-10-h, w*0.8, h); ctx.fillStyle='#9fd6ee'; ctx.font='10px Arial'; ctx.fillText(String(k), left + i*w + 2, c.height-2); });
}

// Reset / cache / download last
$('btnReset').addEventListener('click', ()=>{ if(!confirm('Reset semua input?')) return; document.querySelectorAll('input').forEach(i=>{ if(i.type!=='button') i.value=''; }); $('summary').textContent='‚Äî'; $('valueList').innerHTML='‚Äî'; $('hist').getContext('2d').clearRect(0,0,900,140); $('saveLog').textContent=''; updateCacheCount(); });
$('btnClearCache').addEventListener('click', ()=>{ if(confirm('Hapus cache sesi?')){ clearCache(); alert('Cache cleared'); } });
$('btnDownloadLast').addEventListener('click', ()=>{ const d = sessionStorage.getItem('v52e_last'); if(!d) return alert('Belum ada analisis tersimpan.'); const obj = JSON.parse(d); downloadCSV(obj, `Prediction_${sanitize(obj.home)}_vs_${sanitize(obj.away)}_${obj.date}`); });

// init
detectTraps(); calcTI(); calcTravel(); updateCacheCount();

}); // DOMContentLoaded end
</script>
</body>
</html>
