<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kalkulator HDP Advanced (Auto Value Bet + Liga/Cup + H2H)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f6f8;padding:14px}
  .container{max-width:980px;margin:12px auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  h2{text-align:center;margin:6px 0 12px}
  label{display:block;margin-top:8px;font-weight:700}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .row>div{flex:1 1 140px}
  input,select,textarea,button{width:100%;padding:8px;border-radius:6px;border:1px solid #d0d7de;box-sizing:border-box}
  textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #d0d7de;box-sizing:border-box}
  button{background:#1976d2;color:#fff;border:none;cursor:pointer;font-weight:700;padding:10px}
  .result{margin-top:12px;padding:12px;background:#f1f8e9;border-radius:6px;white-space:pre-wrap}
  table.table{width:100%;border-collapse:collapse;margin-top:12px}
  table.table th, table.table td{border:1px solid #e7eef6;padding:8px;text-align:center}
  .reco{margin-top:12px;padding:10px;border-radius:8px;background:#fff8e1;border-left:6px solid #ffb300}
  .good{background:#e8f5e9;padding:8px;border-radius:6px;margin-top:8px}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e3f2fd;color:#0d47a1;font-weight:700;margin-left:6px}
  .small{font-size:13px;color:#556}
</style>
</head>
<body>
<div class="container">
  <h2>Kalkulator HDP Advanced + Auto Value Bet + H2H</h2>

  <label>Odds 1X2 (Home / Draw / Away)</label>
  <div class="row">
    <div><input id="oddsHome" type="number" step="0.01" placeholder="Home"></div>
    <div><input id="oddsDraw" type="number" step="0.01" placeholder="Draw"></div>
    <div><input id="oddsAway" type="number" step="0.01" placeholder="Away"></div>
  </div>

  <label>Odds HDP (Line / Odds Home / Odds Away)</label>
  <div class="row">
    <div><input id="hdpLine" type="number" step="0.25" placeholder="HDP line"></div>
    <div><input id="hdpHomeOdd" type="number" step="0.01" placeholder="Odds HDP Home"></div>
    <div><input id="hdpAwayOdd" type="number" step="0.01" placeholder="Odds HDP Away"></div>
  </div>

  <label>Over/Under — Line & Odds</label>
  <div class="row">
    <div><input id="ouLine" type="number" step="0.1" placeholder="Line O/U"></div>
    <div><input id="overOdd" type="number" step="0.01" placeholder="Odds Over"></div>
    <div><input id="underOdd" type="number" step="0.01" placeholder="Odds Under"></div>
  </div>

  <label>Total Gol & Kebobolan (X laga terakhir per tim)</label>
  <div class="row">
    <div><input id="golHome" type="number" placeholder="Total gol Home"></div>
    <div><input id="kebHome" type="number" placeholder="Kebobolan Home"></div>
    <div><input id="golAway" type="number" placeholder="Total gol Away"></div>
    <div><input id="kebAway" type="number" placeholder="Kebobolan Away"></div>
  </div>

  <label>Head-to-Head (H2H, format: Home-Away, pisahkan koma)</label>
  <textarea id="h2h" rows="2" placeholder="Contoh: 2-1,0-3,1-1"></textarea>

  <label>Rata-rata Gol Liga (per match)</label>
  <input id="leagueAvg" type="number" step="0.01" value="2.9">

  <label>Tipe Kompetisi</label>
  <select id="compType">
    <option value="liga">Liga</option>
    <option value="cup">Cup</option>
  </select>

  <div class="row">
    <div><input id="matchCount" type="number" value="5" min="1" placeholder="Jumlah laga"></div>
    <div><input id="bankroll" type="number" value="100" min="1" placeholder="Bankroll Kelly"></div>
    <div>
      <select id="modelType">
        <option value="negbin">Negative Binomial</option>
        <option value="poisson">Poisson</option>
      </select>
    </div>
  </div>

  <div style="margin-top:12px">
    <button id="btn">Analisis & Rekomendasi</button>
  </div>

  <div id="output" class="result">Hasil akan tampil di sini</div>

  <table class="table" id="tbl" style="display:none">
    <thead>
      <tr><th>Metode</th><th>Home</th><th>Draw</th><th>Away</th><th>Over</th><th>Under</th><th>HDP Home</th><th>HDP Away</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="recom" class="reco" style="display:none"></div>
</div>

<script>
function safe(v,d=null){const x=parseFloat(v);return isNaN(x)?d:x;}
function factorial(n){return n<=1?1:n*factorial(n-1);}
function poisson(k,lambda){return Math.exp(-lambda)*Math.pow(lambda,k)/factorial(k);}
function negbinPmf(k, mean, r=0.9){const p=r/(r+mean);function comb(n,k){let res=1;for(let i=1;i<=k;i++){res=res*(n-k+i)/i;}return res;}return comb(k+r-1,k)*Math.pow(1-p,k)*Math.pow(p,r);}
function computeMatrix(lambdaH,lambdaA,maxGoals,model){const matrix={},dist=[];let pH=0,pD=0,pA=0;for(let i=0;i<=maxGoals;i++){for(let j=0;j<=maxGoals;j++){const p=(model==='poisson')?poisson(i,lambdaH)*poisson(j,lambdaA):negbinPmf(i,lambdaH)*negbinPmf(j,lambdaA);matrix[`${i}-${j}`]=p;dist[i+j]=(dist[i+j]||0)+p;if(i>j)pH+=p;else if(i===j)pD+=p;else pA+=p;}}return{matrix,totalDist:dist,pHome:pH,pDraw:pD,pAway:pA};}
function computeOU(dist,line){let over=0,under=0;const isInt=Number.isInteger(line);for(let g=0;g<dist.length;g++){const p=dist[g]||0;if(isInt){if(g>line)over+=p;else if(g<line)under+=p;else{over+=0.5*p;under+=0.5*p;}}else{if(g>line)over+=p;else under+=p;}}return{over,under};}
function computeHDP(matrix,line){let ph=0,pa=0,push=0;for(const k in matrix){const p=matrix[k];const[i,j]=k.split('-').map(Number);const diff=i-j+line;if(diff>0)ph+=p;else if(diff<0)pa+=p;else push+=p;}return{ph,pa,push};}
function fairifyOdds(arr){const inv=arr.map(o=>o?1/Number(o):0);const s=inv.reduce((a,b)=>a+b,0);return s?inv.map(x=>x/s):arr.map(()=>null);}
function kelly(p,mkt,odd){const b=odd-1;if(!odd||b<=0)return 0;const q=1-p;return Math.max(0,(b*p-q)/b);}

document.getElementById('btn').addEventListener('click',()=>{
  const oddsH=safe(document.getElementById('oddsHome').value),oddsD=safe(document.getElementById('oddsDraw').value),oddsA=safe(document.getElementById('oddsAway').value);
  const hdpLine=safe(document.getElementById('hdpLine').value,0),hdpHO=safe(document.getElementById('hdpHomeOdd').value),hdpAO=safe(document.getElementById('hdpAwayOdd').value);
  const ouLine=safe(document.getElementById('ouLine').value,2.5),ovO=safe(document.getElementById('overOdd').value),unO=safe(document.getElementById('underOdd').value);
  const gH=safe(document.getElementById('golHome').value,0),kH=safe(document.getElementById('kebHome').value,0),gA=safe(document.getElementById('golAway').value,0),kA=safe(document.getElementById('kebAway').value,0);
  const mc=Math.max(1,parseInt(document.getElementById('matchCount').value||5)),bank=safe(document.getElementById('bankroll').value,100);
  const leagueAvg=safe(document.getElementById('leagueAvg').value,null);
  const compType=document.getElementById('compType').value;
  const modelType=document.getElementById('modelType').value;

  // baseline
  let avgGH=gH/mc,avgCH=kH/mc,avgGA=gA/mc,avgCA=kA/mc;
  let lambdaH=(avgGH+avgCA)/2+0.12,lambdaA=(avgGA+avgCH)/2;

  // H2H adjust
  const h2hRaw=document.getElementById('h2h').value.trim();
  if(h2hRaw){
    const scores=h2hRaw.split(',').map(s=>s.trim()).filter(Boolean);
    const weights=[0.5,0.3,0.2];
    let gHH=0,gAA=0,totW=0;
    scores.slice(-3).reverse().forEach((sc,i)=>{
      const[h,a]=sc.split('-').map(Number);
      if(!isNaN(h)&&!isNaN(a)){const w=weights[i]||0.1;gHH+=h*w;gAA+=a*w;totW+=w;}
    });
    if(totW>0){
      lambdaH=0.7*lambdaH+0.3*(gHH/totW);
      lambdaA=0.7*lambdaA+0.3*(gAA/totW);
    }
  }

  if(leagueAvg){const scale=leagueAvg/(lambdaH+lambdaA);lambdaH*=scale;lambdaA*=scale;}
  const maxGoals=Math.max(12,Math.ceil((lambdaH+lambdaA)*4+6));
  const M=computeMatrix(lambdaH,lambdaA,maxGoals,modelType);
  const ou=computeOU(M.totalDist,ouLine);
  const hdp=computeHDP(M.matrix,hdpLine);
  const fair123=fairifyOdds([oddsH,oddsD,oddsA]),fairOU=fairifyOdds([ovO,unO]),fairHDP=fairifyOdds([hdpHO,hdpAO]);

  const blended={home:0.6*M.pHome+0.4*(fair123[0]||M.pHome),draw:0.6*M.pDraw+0.4*(fair123[1]||M.pDraw),away:0.6*M.pAway+0.4*(fair123[2]||M.pAway),over:0.6*ou.over+0.4*(fairOU[0]||ou.over),under:0.6*ou.under+0.4*(fairOU[1]||ou.under),hdpHome:0.6*(hdp.ph+0.5*hdp.push)+0.4*(fairHDP[0]||hdp.ph),hdpAway:0.6*(hdp.pa+0.5*hdp.push)+0.4*(fairHDP[1]||hdp.pa)};

  function pct(x){return x==null?'--':(x*100).toFixed(1)+'%';}
  document.getElementById('tbody').innerHTML=`<tr><td>Model</td><td>${pct(M.pHome)}</td><td>${pct(M.pDraw)}</td><td>${pct(M.pAway)}</td><td>${pct(ou.over)}</td><td>${pct(ou.under)}</td><td>${pct(hdp.ph)}</td><td>${pct(hdp.pa)}</td></tr>
  <tr><td>Market</td><td>${pct(fair123[0])}</td><td>${pct(fair123[1])}</td><td>${pct(fair123[2])}</td><td>${pct(fairOU[0])}</td><td>${pct(fairOU[1])}</td><td>${pct(fairHDP[0])}</td><td>${pct(fairHDP[1])}</td></tr>
  <tr><td>Blended</td><td>${pct(blended.home)}</td><td>${pct(blended.draw)}</td><td>${pct(blended.away)}</td><td>${pct(blended.over)}</td><td>${pct(blended.under)}</td><td>${pct(blended.hdpHome)}</td><td>${pct(blended.hdpAway)}</td></tr>`;
  document.getElementById('tbl').style.display='table';

  const candidates=[
    {label:'Home Win',model:M.pHome,market:fair123[0],blended:blended.home,odd:oddsH},
    {label:'Draw',model:M.pDraw,market:fair123[1],blended:blended.draw,odd:oddsD},
    {label:'Away Win',model:M.pAway,market:fair123[2],blended:blended.away,odd:oddsA},
    {label:'Over '+ouLine,model:ou.over,market:fairOU[0],blended:blended.over,odd:ovO},
    {label:'Under '+ouLine,model:ou.under,market:fairOU[1],blended:blended.under,odd:unO},
    {label:'HDP Home '+hdpLine,model:hdp.ph+0.5*hdp.push,market:fairHDP[0],blended:blended.hdpHome,odd:hdpHO},
    {label:'HDP Away '+hdpLine,model:hdp.pa+0.5*hdp.push,market:fairHDP[1],blended:blended.hdpAway,odd:hdpAO}
  ];

  // auto threshold
  const diffs=candidates.filter(e=>e.model!=null&&e.market!=null).map(e=>e.model-e.market);
  let autoThresh=0.05;if(diffs.length){const mean=diffs.reduce((a,b)=>a+b,0)/diffs.length;const varc=diffs.reduce((a,b)=>a+(b-mean)**2,0)/diffs.length;autoThresh=Math.max(0.02,Math.sqrt(varc));}
  if(compType==='cup')autoThresh*=1.3;

  const valueBets=candidates.filter(e=>e.model-(e.market||0)>autoThresh);
  candidates.sort((a,b)=>b.blended-a.blended);
  const top3=candidates.slice(0,3);

  let recomHTML=`<strong>Top rekomendasi</strong><br>(Ambang value bet otomatis: ${(autoThresh*100).toFixed(1)}%)<hr>`;
  top3.forEach((t,i)=>{const val=t.model-(t.market||0)>autoThresh;recomHTML+=`<div class="good">${i+1}. ${t.label} — ${(t.blended*100).toFixed(1)}% ${val?'<span class="badge">VALUE</span>':''}</div>`;});
  if(valueBets.length){recomHTML+='<hr><strong>Value bets:</strong>';valueBets.forEach(v=>{const k=kelly(v.model,v.market,v.odd),stake=(k*bank).toFixed(2);recomHTML+=`<div>${v.label} — Model ${(v.model*100).toFixed(1)}% • Market ${(v.market*100).toFixed(1)}% • Odd ${v.odd||'--'} • Kelly ${(k*100).toFixed(1)}% (Rp ${stake})</div>`;});}
  document.getElementById('recom').style.display='block';document.getElementById('recom').innerHTML=recomHTML;

  document.getElementById('output').innerText=`Lambda H: ${lambdaH.toFixed(2)}, Lambda A: ${lambdaA.toFixed(2)}\nExpected goals total: ${(lambdaH+lambdaA).toFixed(2)}`;
});
</script>
</body>
           </html>
