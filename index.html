<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kalkulator HDP — Final (Export JSON, Prefs, Chart)</title>
<style>
  :root{--blue:#1976d2;--muted:#667;--card:#fff}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f3f6f8;margin:0;padding:18px;color:#111}
  .wrap{max-width:1200px;margin:12px auto;padding:16px;background:var(--card);border-radius:10px;box-shadow:0 8px 28px rgba(10,20,30,0.06)}
  h1{margin:0 0 8px;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  label{display:block;font-weight:700;margin-top:8px}
  .row{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
  .row>div{flex:1 1 120px}
  input,select,textarea,button{width:100%;padding:8px;border-radius:8px;border:1px solid #d6dde6;box-sizing:border-box}
  textarea{min-height:72px;resize:vertical}
  button{background:var(--blue);color:#fff;border:none;cursor:pointer;font-weight:700}
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
  .result{margin-top:10px;padding:10px;background:#eef7ff;border-radius:8px;white-space:pre-wrap}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border:1px solid #ecf3fb;text-align:center}
  .controls{background:#fafafa;padding:10px;border-radius:8px;border:1px solid #eef2f6}
  .small{font-size:13px;color:#445}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e3f2fd;color:#0d47a1;font-weight:700;margin-left:6px}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .secondary{background:#f5f7fa;color:#0b4b83;border:1px solid #dbe7f5}
  .flex{display:flex;gap:8px;align-items:center}
  .rangeVal{min-width:48px;text-align:center}
  footer{margin-top:14px;color:#666;font-size:13px}
  canvas{width:100%;height:200px;background:#fff;border-radius:8px;border:1px solid #eef3f8}
  @media(max-width:980px){ .grid{grid-template-columns:1fr;} .row>div{flex:1 1 200px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Kalkulator HDP — Final (Export JSON, Prefs, Chart)</h1>
  <div class="grid">
    <!-- LEFT -->
    <div>
      <label>Mode Input</label>
      <select id="inputMode">
        <option value="manual">Manual (total gol & kebobolan)</option>
        <option value="scores">Auto dari daftar skor</option>
      </select>

      <div id="manualBlock">
        <label>Total gol & kebobolan (X laga terakhir per tim)</label>
        <div class="row">
          <div><input id="golHome" type="number" placeholder="Total gol Home"></div>
          <div><input id="kebHome" type="number" placeholder="Kebobolan Home"></div>
          <div><input id="golAway" type="number" placeholder="Total gol Away"></div>
          <div><input id="kebAway" type="number" placeholder="Kebobolan Away"></div>
        </div>
        <div class="row">
          <div><input id="matchCount" type="number" value="5" min="1" placeholder="Jumlah laga"></div>
        </div>
      </div>

      <div id="scoresBlock" style="display:none">
        <label>Daftar skor TIM HOME (format: gol-law, pisahkan koma)</label>
        <textarea id="scoresHome" placeholder="Contoh: 2-1,1-0,3-2"></textarea>
        <label>Daftar skor TIM AWAY (format: gol-law, pisahkan koma)</label>
        <textarea id="scoresAway" placeholder="Contoh: 0-2,1-1,2-2"></textarea>
        <div class="muted">Masukkan dari perspektif masing-masing tim (golTim - gol lawan).</div>
      </div>

      <label>Head-to-Head (H2H) — format: Home-Away, pisahkan koma</label>
      <textarea id="h2h" placeholder="Contoh: 2-1,0-3,1-1"></textarea>

      <label>Rata-rata gol liga (per match)</label>
      <input id="leagueAvg" type="number" step="0.01" value="2.9">

      <label>Tipe kompetisi</label>
      <select id="compType">
        <option value="liga">Liga</option>
        <option value="cup">Cup</option>
      </select>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef3f8">

      <label>Odds 1X2 (Home / Draw / Away)</label>
      <div class="row">
        <div><input id="oddsHome" type="number" step="0.01" placeholder="Home (1.90)"></div>
        <div><input id="oddsDraw" type="number" step="0.01" placeholder="Draw (3.40)"></div>
        <div><input id="oddsAway" type="number" step="0.01" placeholder="Away (4.50)"></div>
      </div>

      <label>Odds HDP (Line / Odds Home / Odds Away)</label>
      <div class="row">
        <div><input id="hdpLine" type="number" step="0.25" placeholder="Line (eg -0.5)"></div>
        <div><input id="hdpHomeOdd" type="number" step="0.01" placeholder="HDP Home"></div>
        <div><input id="hdpAwayOdd" type="number" step="0.01" placeholder="HDP Away"></div>
      </div>

      <label>Over/Under — Line & Odds</label>
      <div class="row">
        <div><input id="ouLine" type="number" step="0.1" placeholder="Line (eg 2.5)"></div>
        <div><input id="overOdd" type="number" step="0.01" placeholder="Odds Over"></div>
        <div><input id="underOdd" type="number" step="0.01" placeholder="Odds Under"></div>
      </div>

      <label>Model distribusi</label>
      <select id="modelType">
        <option value="negbin">Negative Binomial</option>
        <option value="poisson">Poisson</option>
      </select>

      <div style="margin-top:10px" class="row">
        <div><input id="bankroll" type="number" value="100" placeholder="Bankroll (untuk Kelly)"></div>
        <div><button id="btnAnalyze">Analisis & Rekomendasi</button></div>
      </div>

      <div class="controls" style="margin-top:10px">
        <div class="small">Pra-isian contoh: <button id="btnFillExample" class="secondary">Isi contoh</button></div>
        <div class="muted small">Setelah isi contoh, klik <b>Analisis</b>.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="controls">
        <label>H2H weights (enter 3 numbers, akan dinormalisasi)</label>
        <div class="row">
          <div><input id="w1" type="number" step="0.01" value="0.5" min="0"></div>
          <div><input id="w2" type="number" step="0.01" value="0.3" min="0"></div>
          <div><input id="w3" type="number" step="0.01" value="0.2" min="0"></div>
        </div>

        <label>Blending Model vs Market</label>
        <div class="row">
          <div class="flex"><input id="blendModel" type="range" min="0" max="100" value="60"><div class="rangeVal"><span id="blendVal">60</span>%</div></div>
        </div>

        <div class="muted small">Threshold value-bet dihitung otomatis dari stddev(model - market). Cup menaikkan threshold ×1.3.</div>

        <hr style="margin:10px 0;border:none;border-top:1px solid #eef3f8">

        <div class="small">Preferensi</div>
        <div class="row">
          <div><button id="btnSavePrefs" class="secondary">Simpan Preferensi</button></div>
          <div><button id="btnLoadPrefs" class="secondary">Muat Preferensi</button></div>
          <div><button id="btnResetPrefs" class="secondary">Reset Preferensi</button></div>
        </div>

        <div class="small" style="margin-top:8px">Ekspor / Salin hasil</div>
        <div class="actions">
          <button id="btnCopy" class="secondary">Copy rekomendasi</button>
          <button id="btnExportCSV" class="secondary">Export CSV</button>
          <button id="btnExportJSON" class="secondary">Export JSON</button>
        </div>
      </div>

      <div id="diagnostics" class="result" style="margin-top:12px">
        Hasil analisis akan muncul di sini.
      </div>

      <div style="margin-top:8px">
        <table id="resultTable" class="table" style="display:none">
          <thead><tr><th>Metode</th><th>Home</th><th>Draw</th><th>Away</th><th>Over</th><th>Under</th><th>HDP Home</th><th>HDP Away</th></tr></thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>

      <div id="recoBox" class="reco" style="display:none;margin-top:8px"></div>

      <div style="margin-top:12px">
        <label>Grafik distribusi total gol (totalDist)</label>
        <canvas id="distChart" width="600" height="200"></canvas>
        <div class="muted small">Chart menampilkan peluang tiap total gol (0,1,2,...).</div>
      </div>
    </div>
  </div>

  <footer class="muted" style="margin-top:12px">File ini dibuat otomatis — simpan sebagai <b>index.html</b>.</footer>
</div>

<script>
/* ---------------- Utilities ---------------- */
function safe(v,d=null){const x=parseFloat(v);return isNaN(x)?d:x;}
function factorial(n){return n<=1?1:n*factorial(n-1);}
function poisson(k,lambda){return Math.exp(-lambda)*Math.pow(lambda,k)/factorial(k);}
function negbinPmf(k, mean, r=0.9){
  const p = r/(r+mean);
  function comb(n,k){let res=1; for(let i=1;i<=k;i++){ res = res*(n-k+i)/i; } return res;}
  return comb(k+r-1,k)*Math.pow(1-p,k)*Math.pow(p,r);
}
function pct(x){ return x==null ? '--' : (x*100).toFixed(1)+'%'; }

/* compute matrix */
function computeMatrix(lambdaH,lambdaA,maxGoals,model){
  const matrix={}, totalDist=[];
  let pHome=0,pDraw=0,pAway=0;
  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const p = (model === 'poisson') ? poisson(i,lambdaH)*poisson(j,lambdaA)
                                      : negbinPmf(i,lambdaH)*negbinPmf(j,lambdaA);
      matrix[`${i}-${j}`] = p;
      totalDist[i+j] = (totalDist[i+j] || 0) + p;
      if(i>j) pHome += p; else if(i===j) pDraw += p; else pAway += p;
    }
  }
  return {matrix, totalDist, pHome, pDraw, pAway};
}
function computeOUFromDist(totalDist, line){
  let over=0, under=0;
  const isInt = Number.isInteger(line);
  for(let g=0; g<totalDist.length; g++){
    const p = totalDist[g] || 0;
    if(isInt){
      if(g>line) over += p;
      else if(g<line) under += p;
      else { over += 0.5*p; under += 0.5*p;}
    } else { if(g>line) over += p; else under += p; }
  }
  return {over, under};
}
function computeHDPFromMatrix(matrix, line){
  let ph=0, pa=0, push=0;
  for(const k in matrix){
    const p = matrix[k];
    const [i,j] = k.split('-').map(Number);
    const diff = i - j + line;
    if(diff>0) ph += p;
    else if(diff<0) pa += p;
    else push += p;
  }
  return {ph, pa, push};
}
function fairifyOdds(arr){
  const inv = arr.map(o => o ? 1/Number(o) : 0);
  const sum = inv.reduce((a,b)=>a+b,0);
  if(sum === 0) return arr.map(()=>null);
  return inv.map(x => x/sum);
}
function kellyFraction(p, marketProb, decimalOdd){
  const b = decimalOdd - 1;
  if(!decimalOdd || b<=0) return 0;
  const q = 1 - p;
  const f = (b*p - q) / b;
  return Math.max(0, f);
}
function avgFromScores(raw){
  const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
  let totFor=0, totAgainst=0, cnt=0;
  for(const p of parts){
    const m = p.match(/^(\d+)\s*-\s*(\d+)$/);
    if(!m) continue;
    const f = parseInt(m[1]), a = parseInt(m[2]);
    totFor += f; totAgainst += a; cnt++;
  }
  if(cnt === 0) return {for:0, against:0, cnt:0};
  return {for: totFor/cnt, against: totAgainst/cnt, cnt};
}

/* ---------------- UI wiring ---------------- */
const inputModeEl = document.getElementById('inputMode');
inputModeEl.addEventListener('change', ()=> {
  const mode = inputModeEl.value;
  document.getElementById('manualBlock').style.display = mode === 'manual' ? 'block' : 'none';
  document.getElementById('scoresBlock').style.display = mode === 'scores' ? 'block' : 'none';
});
const blendEl = document.getElementById('blendModel'), blendVal = document.getElementById('blendVal');
blendEl.addEventListener('input', ()=> blendVal.innerText = blendEl.value);

/* Fill example */
document.getElementById('btnFillExample').addEventListener('click', ()=>{
  document.getElementById('inputMode').value = 'scores';
  inputModeEl.dispatchEvent(new Event('change'));
  document.getElementById('scoresHome').value = "2-1,3-2,1-2";
  document.getElementById('scoresAway').value = "1-2,0-3,2-3";
  document.getElementById('h2h').value = "2-1,1-3,3-2";
  document.getElementById('leagueAvg').value = "3.1";
  document.getElementById('oddsHome').value = "2.05"; document.getElementById('oddsDraw').value = "3.40"; document.getElementById('oddsAway').value = "3.60";
  document.getElementById('hdpLine').value = "-0.5"; document.getElementById('hdpHomeOdd').value = "1.92"; document.getElementById('hdpAwayOdd').value = "1.96";
  document.getElementById('ouLine').value = "2.5"; document.getElementById('overOdd').value = "1.85"; document.getElementById('underOdd').value = "2.05";
  document.getElementById('modelType').value = 'negbin';
  document.getElementById('w1').value = "0.5"; document.getElementById('w2').value = "0.3"; document.getElementById('w3').value = "0.2";
  blendEl.value = 60; blendVal.innerText = 60;
});

/* ---------------- Analysis ---------------- */
document.getElementById('btnAnalyze').addEventListener('click', runAnalysis);

function runAnalysis(){
  // inputs -> compute avg goals
  const mode = document.getElementById('inputMode').value;
  let avgGH=0, avgCH=0, avgGA=0, avgCA=0;

  if(mode === 'manual'){
    const gH = safe(document.getElementById('golHome').value, 0);
    const kH = safe(document.getElementById('kebHome').value, 0);
    const gA = safe(document.getElementById('golAway').value, 0);
    const kA = safe(document.getElementById('kebAway').value, 0);
    const mc = Math.max(1, parseInt(document.getElementById('matchCount').value || 5));
    avgGH = gH / mc; avgCH = kH / mc; avgGA = gA / mc; avgCA = kA / mc;
  } else {
    const resH = avgFromScores(document.getElementById('scoresHome').value.trim());
    const resA = avgFromScores(document.getElementById('scoresAway').value.trim());
    avgGH = resH.for; avgCH = resH.against; avgGA = resA.for; avgCA = resA.against;
  }

  // baseline lambda
  let lambdaH = Math.max(0.03, (avgGH + avgCA)/2 + 0.12);
  let lambdaA = Math.max(0.03, (avgGA + avgCH)/2);

  // H2H weights normalized
  const h2hRaw = document.getElementById('h2h').value.trim();
  if(h2hRaw){
    const scores = h2hRaw.split(',').map(s=>s.trim()).filter(Boolean);
    const w1 = Math.max(0, safe(document.getElementById('w1').value, 0));
    const w2 = Math.max(0, safe(document.getElementById('w2').value, 0));
    const w3 = Math.max(0, safe(document.getElementById('w3').value, 0));
    const weights = [w1,w2,w3];
    const sumW = weights.reduce((a,b)=>a+b,0) || 1;
    const norm = weights.map(w=>w/sumW);
    let gHH=0,gAA=0,totW=0;
    scores.slice(-3).reverse().forEach((sc,i)=>{
      const m = sc.match(/^(\d+)\s*-\s*(\d+)$/);
      if(!m) return;
      const h = Number(m[1]), a = Number(m[2]);
      const w = norm[i] || (1/3);
      gHH += h * w; gAA += a * w; totW += w;
    });
    if(totW>0){
      const avgH2H_H = gHH / totW;
      const avgH2H_A = gAA / totW;
      lambdaH = 0.7 * lambdaH + 0.3 * avgH2H_H;
      lambdaA = 0.7 * lambdaA + 0.3 * avgH2H_A;
    }
  }

  // league normalization
  const leagueAvg = safe(document.getElementById('leagueAvg').value, null);
  if(leagueAvg){
    const totalLambda = lambdaH + lambdaA;
    if(totalLambda>0){
      const scale = leagueAvg / totalLambda;
      lambdaH *= scale; lambdaA *= scale;
    }
  }

  lambdaH = Math.min(Math.max(0.03, lambdaH), 8);
  lambdaA = Math.min(Math.max(0.03, lambdaA), 8);

  // compute model
  const modelType = document.getElementById('modelType').value;
  const maxGoals = Math.max(12, Math.ceil((lambdaH + lambdaA) * 4 + 6));
  const M = computeMatrix(lambdaH, lambdaA, maxGoals, modelType);

  // OU / HDP
  const ouLine = safe(document.getElementById('ouLine').value, 2.5);
  const ouProb = computeOUFromDist(M.totalDist, ouLine);
  const hdpLine = safe(document.getElementById('hdpLine').value, 0);
  const hdpProb = computeHDPFromMatrix(M.matrix, hdpLine);

  // fairify market
  const oddsH = safe(document.getElementById('oddsHome').value, null);
  const oddsD = safe(document.getElementById('oddsDraw').value, null);
  const oddsA = safe(document.getElementById('oddsAway').value, null);
  const fair123 = fairifyOdds([oddsH,oddsD,oddsA]);

  const overOdd = safe(document.getElementById('overOdd').value, null);
  const underOdd = safe(document.getElementById('underOdd').value, null);
  const fairOU = fairifyOdds([overOdd, underOdd]);

  const hdpHO = safe(document.getElementById('hdpHomeOdd').value, null);
  const hdpAO = safe(document.getElementById('hdpAwayOdd').value, null);
  const fairHDP = fairifyOdds([hdpHO, hdpAO]);

  // blending
  const modelPct = Number(document.getElementById('blendModel').value) / 100;
  const marketPct = 1 - modelPct;

  const blended = {
    home: modelPct * M.pHome + marketPct * (fair123[0] != null ? fair123[0] : M.pHome),
    draw: modelPct * M.pDraw + marketPct * (fair123[1] != null ? fair123[1] : M.pDraw),
    away: modelPct * M.pAway + marketPct * (fair123[2] != null ? fair123[2] : M.pAway),
    over: modelPct * ouProb.over + marketPct * (fairOU[0] != null ? fairOU[0] : ouProb.over),
    under: modelPct * ouProb.under + marketPct * (fairOU[1] != null ? fairOU[1] : ouProb.under),
    hdpHome: modelPct * (hdpProb.ph + 0.5*hdpProb.push) + marketPct * (fairHDP[0] != null ? fairHDP[0] : (hdpProb.ph + 0.5*hdpProb.push)),
    hdpAway: modelPct * (hdpProb.pa + 0.5*hdpProb.push) + marketPct * (fairHDP[1] != null ? fairHDP[1] : (hdpProb.pa + 0.5*hdpProb.push))
  };

  // table
  document.getElementById('resultBody').innerHTML =
    `<tr><td>Model</td><td>${pct(M.pHome)}</td><td>${pct(M.pDraw)}</td><td>${pct(M.pAway)}</td><td>${pct(ouProb.over)}</td><td>${pct(ouProb.under)}</td><td>${pct(hdpProb.ph)}</td><td>${pct(hdpProb.pa)}</td></tr>` +
    `<tr><td>Market (fair)</td><td>${pct(fair123[0])}</td><td>${pct(fair123[1])}</td><td>${pct(fair123[2])}</td><td>${pct(fairOU[0])}</td><td>${pct(fairOU[1])}</td><td>${pct(fairHDP[0])}</td><td>${pct(fairHDP[1])}</td></tr>` +
    `<tr><td>Blended</td><td>${pct(blended.home)}</td><td>${pct(blended.draw)}</td><td>${pct(blended.away)}</td><td>${pct(blended.over)}</td><td>${pct(blended.under)}</td><td>${pct(blended.hdpHome)}</td><td>${pct(blended.hdpAway)}</td></tr>`;
  document.getElementById('resultTable').style.display = 'table';

  // candidates
  const candidates = [
    {label:'🏠 Home Win', key:'Home', model:M.pHome, market:fair123[0], blended:blended.home, odd:oddsH},
    {label:'🤝 Draw', key:'Draw', model:M.pDraw, market:fair123[1], blended:blended.draw, odd:oddsD},
    {label:'🚩 Away Win', key:'Away', model:M.pAway, market:fair123[2], blended:blended.away, odd:oddsA},
    {label:`⬆️ Over ${ouLine}`, key:'Over', model:ouProb.over, market:fairOU[0], blended:blended.over, odd:overOdd},
    {label:`⬇️ Under ${ouLine}`, key:'Under', model:ouProb.under, market:fairOU[1], blended:blended.under, odd:underOdd},
    {label:`📊 HDP Home ${hdpLine}`, key:'HDP_H', model:hdpProb.ph + 0.5*hdpProb.push, market:fairHDP[0], blended:blended.hdpHome, odd:hdpHO},
    {label:`📊 HDP Away ${hdpLine}`, key:'HDP_A', model:hdpProb.pa + 0.5*hdpProb.push, market:fairHDP[1], blended:blended.hdpAway, odd:hdpAO}
  ];

  // auto threshold
  const diffs = candidates.filter(e=>e.model!=null && e.market!=null).map(e=>e.model - e.market);
  let autoThresh = 0.05;
  if(diffs.length){
    const mean = diffs.reduce((a,b)=>a+b,0)/diffs.length;
    const variance = diffs.reduce((a,b)=>a+(b-mean)**2,0)/diffs.length;
    const std = Math.sqrt(variance);
    autoThresh = Math.max(0.02, std);
  }
  if(document.getElementById('compType').value === 'cup') autoThresh *= 1.3;

  // value bets
  const valueBets = candidates.filter(e => e.model!=null && e.market!=null && (e.model - e.market) > autoThresh);

  // rank
  const ranked = candidates.slice().sort((a,b)=>b.blended - a.blended);
  const top3 = ranked.slice(0,3);

  // kelly
  const bank = safe(document.getElementById('bankroll').value, 100);
  const kellys = candidates.map(e => {
    const k = (e.odd && e.model!=null) ? kellyFraction(e.model, e.market || 0, e.odd) : 0;
    return { label: e.label, k: k, stake: (k * bank).toFixed(2) };
  });

  // build HTML
  let recomHTML = `<strong>Top rekomendasi (Blended)</strong><div class="small">Lambda H: ${lambdaH.toFixed(2)} • Lambda A: ${lambdaA.toFixed(2)} • Expected total: ${(lambdaH+lambdaA).toFixed(2)}</div><hr>`;
  top3.forEach((t,i)=>{
    const isValue = (t.model - (t.market||0) > autoThresh);
    recomHTML += `<div class="good">${i+1}. ${t.label} — ${(t.blended*100).toFixed(1)}% ${isValue?'<span class="badge">VALUE</span>':''}<div class="small">Model ${(t.model*100).toFixed(1)}% • Market ${((t.market||0)*100).toFixed(1)}% • Odd ${t.odd||'--'}</div></div>`;
  });
  if(valueBets.length){
    recomHTML += `<hr><strong>Value bets (Model > Market + ${(autoThresh*100).toFixed(1)}%)</strong>`;
    valueBets.forEach(v=>{
      const kobj = kellys.find(x=>x.label===v.label);
      const kel = kobj ? kobj.k : 0;
      const stake = kobj ? kobj.stake : '0.00';
      recomHTML += `<div style="margin-top:6px">${v.label} — Model ${(v.model*100).toFixed(1)}% • Market ${((v.market||0)*100).toFixed(1)}% • Odd ${v.odd||'--'} • Kelly ${(kel*100).toFixed(1)}% (Rp ${stake})</div>`;
    });
  }
  recomHTML += `<hr><div class="small"><strong>Semua kandidat:</strong> ${ranked.map(e=>`${e.label} ${(e.blended*100).toFixed(1)}%`).join(' • ')}</div>`;

  document.getElementById('recoBox').style.display = 'block';
  document.getElementById('recoBox').innerHTML = recomHTML;

  // diagnostics
  document.getElementById('diagnostics').innerText =
    `Lambda Home: ${lambdaH.toFixed(2)}, Lambda Away: ${lambdaA.toFixed(2)}\nModel 1X2 => Home ${(M.pHome*100).toFixed(1)}% | Draw ${(M.pDraw*100).toFixed(1)}% | Away ${(M.pAway*100).toFixed(1)}%\nO/U ${ouLine} => Over ${(ouProb.over*100).toFixed(1)}% | Under ${(ouProb.under*100).toFixed(1)}%\nHDP ${hdpLine} => Home ${(hdpProb.ph*100).toFixed(1)}% | Away ${(hdpProb.pa*100).toFixed(1)}% | Push ${(hdpProb.push*100).toFixed(1)}%\n(Auto threshold: ${(autoThresh*100).toFixed(2)}%)`;

  // chart totalDist
  drawDistChart(M.totalDist);

  // store last results
  window._lastResults = { ranked, top3, valueBets, blended, M, ouProb, hdpProb, autoThresh, kellys, lambdaH, lambdaA };
}

/* ---------------- Copy / Export ---------------- */
document.getElementById('btnCopy').addEventListener('click', ()=>{
  const r = window._lastResults;
  if(!r){ alert('Jalankan analisis dulu.'); return; }
  let text = 'Rekomendasi:\\n';
  r.top3.forEach((t,i)=> text += `${i+1}. ${t.label} — Blended ${(t.blended*100).toFixed(1)}% (Model ${(t.model*100).toFixed(1)}%, Market ${((t.market||0)*100).toFixed(1)}%)\\n`);
  if(r.valueBets.length){ text += '\\nValue bets:\\n'; r.valueBets.forEach(v=> text += `${v.label} — Model ${(v.model*100).toFixed(1)}% • Market ${((v.market||0)*100).toFixed(1)}%\\n`); }
  navigator.clipboard.writeText(text).then(()=> alert('Rekomendasi disalin ke clipboard.'), ()=> alert('Gagal menyalin.'));
});

document.getElementById('btnExportCSV').addEventListener('click', ()=>{
  const r = window._lastResults;
  if(!r){ alert('Jalankan analisis dulu.'); return; }
  const rows = [];
  rows.push(['label','type','model_prob','market_prob','blended_prob','odd','kelly_frac','kelly_stake']);
  r.ranked.forEach(item=>{
    const k = r.kellys.find(k=>k.label===item.label) || {k:0, stake:'0.00'};
    rows.push([item.label, item.key, (item.model||'').toFixed(6), (item.market||'').toFixed(6), (item.blended||'').toFixed(6), item.odd||'', (k.k||0).toFixed(6), k.stake||'0.00']);
  });
  const csv = rows.map(rw => rw.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'rekomendasi_kalkulator_hdp.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

document.getElementById('btnExportJSON').addEventListener('click', ()=>{
  const r = window._lastResults;
  if(!r){ alert('Jalankan analisis dulu.'); return; }
  const payload = {
    generatedAt: new Date().toISOString(),
    lambdaH: r.lambdaH, lambdaA: r.lambdaA,
    top3: r.top3.map(t => ({ label: t.label, model: t.model, market: t.market, blended: t.blended, odd: t.odd })),
    valueBets: r.valueBets.map(v => ({ label: v.label, model: v.model, market: v.market, odd: v.odd })),
    candidates: r.ranked.map(c => ({ label:c.label, key:c.key, model:c.model, market:c.market, blended:c.blended, odd:c.odd }))
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'rekomendasi_kalkulator_hdp.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ------------- Preferences (localStorage) ------------- */
const PREF_KEY = 'kalk_hdp_prefs_v1';
document.getElementById('btnSavePrefs').addEventListener('click', ()=>{
  const prefs = {
    w1: document.getElementById('w1').value,
    w2: document.getElementById('w2').value,
    w3: document.getElementById('w3').value,
    blend: document.getElementById('blendModel').value,
    modelType: document.getElementById('modelType').value,
    compType: document.getElementById('compType').value,
    leagueAvg: document.getElementById('leagueAvg').value,
    bankroll: document.getElementById('bankroll').value,
    inputMode: document.getElementById('inputMode').value
  };
  localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
  alert('Preferensi tersimpan.');
});

document.getElementById('btnLoadPrefs').addEventListener('click', loadPrefs);
document.getElementById('btnResetPrefs').addEventListener('click', ()=>{
  localStorage.removeItem(PREF_KEY);
  alert('Preferensi dihapus. Muat ulang halaman untuk nilai default.');
});

function loadPrefs(){
  const raw = localStorage.getItem(PREF_KEY);
  if(!raw){ alert('Tidak ada preferensi tersimpan.'); return; }
  try{
    const p = JSON.parse(raw);
    if(p.w1) document.getElementById('w1').value = p.w1;
    if(p.w2) document.getElementById('w2').value = p.w2;
    if(p.w3) document.getElementById('w3').value = p.w3;
    if(p.blend) { document.getElementById('blendModel').value = p.blend; document.getElementById('blendVal').innerText = p.blend; }
    if(p.modelType) document.getElementById('modelType').value = p.modelType;
    if(p.compType) document.getElementById('compType').value = p.compType;
    if(p.leagueAvg) document.getElementById('leagueAvg').value = p.leagueAvg;
    if(p.bankroll) document.getElementById('bankroll').value = p.bankroll;
    if(p.inputMode){ document.getElementById('inputMode').value = p.inputMode; inputModeEl.dispatchEvent(new Event('change')); }
    alert('Preferensi dimuat.');
  }catch(e){ alert('Gagal memuat preferensi.'); }
}

// auto-load prefs on start
window.addEventListener('load', ()=> {
  const raw = localStorage.getItem(PREF_KEY);
  if(raw) loadPrefs();
});

/* ------------- Chart drawing (simple bar chart) ------------- */
const canvas = document.getElementById('distChart');
const ctx = canvas.getContext('2d');
function drawDistChart(totalDist){
  // resize canvas to device pixel ratio for clarity
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  canvas.width = Math.floor(w * DPR);
  canvas.height = Math.floor(h * DPR);
  ctx.scale(DPR, DPR);

  // clear
  ctx.clearRect(0,0,w,h);

  // prepare data (only first N bins)
  const bins = totalDist.slice(0, Math.min(totalDist.length, 20));
  const labels = bins.map((_,i)=>i);
  const maxP = Math.max(...bins, 0.001);

  // padding
  const pad = 24;
  const chartW = w - pad*2;
  const chartH = h - pad*2;
  const barW = chartW / bins.length * 0.8;
  const gap = chartW / bins.length * 0.2;

  // axes
  ctx.strokeStyle = '#cfe6ff';
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad+chartH); ctx.lineTo(pad+chartW, pad+chartH); ctx.stroke();

  // bars
  for(let i=0;i<bins.length;i++){
    const p = bins[i] || 0;
    const barH = (p / maxP) * (chartH - 20);
    const x = pad + i*(barW + gap) + gap/2;
    const y = pad + chartH - barH;
    // fill
    ctx.fillStyle = '#7fb3ff';
    ctx.fillRect(x, y, barW, barH);
    // label
    ctx.fillStyle = '#0b3a6b';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(String(labels[i]), x + barW/2, pad + chartH + 14);
    // percent above
    ctx.fillStyle = '#033963';
    ctx.font = '11px Arial';
    const pctText = (p*100).toFixed(1)+'%';
    ctx.fillText(pctText, x + barW/2, y - 6);
  }
}

/* ------------- End ------------- */
</script>
</body>
</html>

