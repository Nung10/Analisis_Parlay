<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Prediksi v45 — Full AutoIndex (Dark)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#041022;--panel:#071a2a;--card:#05232f;--accent:#06b6d4;--muted:#9fd6ee;--text:#eaf6ff;--danger:#eb3b5a}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);line-height:1.35}
.container{max-width:980px;margin:12px auto;padding:14px}
h1{font-size:20px;margin:4px 0 8px}
.small{font-size:13px;color:var(--muted);margin-bottom:6px}
.block{background:var(--panel);border:1px solid rgba(11,78,94,0.2);padding:12px;border-radius:10px;margin-bottom:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1;min-width:120px}
label{display:block;font-size:13px;color:var(--muted);margin:6px 0}
input[type="text"],input[type="number"],select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(11,78,94,0.2);background:#02161d;color:var(--text)}
button{background:var(--accent);border:0;color:#022;padding:8px 10px;border-radius:8px;cursor:pointer}
.btn-muted{background:#0b2f3a;color:var(--text);border:1px solid rgba(255,255,255,0.02)}
.pre{background:#021425;padding:10px;border-radius:8px;border:1px dashed rgba(11,78,94,0.2);font-family:ui-monospace,monospace;margin-top:8px}
.card{background:var(--card);padding:10px;border-radius:8px;border:1px solid rgba(11,78,94,0.2);margin-top:8px}
.mini-bar{height:10px;border-radius:6px;background:#031a22;overflow:hidden;margin-top:6px}
.mini-bar > i{display:block;height:100%;background:var(--accent);}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center}
canvas{background:#02121a;border-radius:6px;border:1px solid rgba(11,78,94,0.2);width:100%}
.footer{font-size:13px;color:var(--muted);margin-top:6px;text-align:center}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.switch{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="container">
  <h1>⚽ Prediksi Full-Time Precision — v45 (AutoIndex)</h1>
  <div class="small">Mode: 1 kolom panjang • Tema: solid dark navy • Auto Index: Home/Away terpisah • Toggle International Break</div>

  <!-- INPUT BLOCK -->
  <div class="block" id="inputBlock">
    <h3>Input Data Tim (isi sebanyak mungkin)</h3>
    <label>Home Team: <input id="teamHome" type="text" value="France"></label>
    <label>Away Team: <input id="teamAway" type="text" value="Argentina"></label>

    <h4 class="small">xG / Shots / Goals</h4>
    <div class="row">
      <div class="col"><label>xG Home: <input id="xgHome" type="number" step="0.01"></label></div>
      <div class="col"><label>xG Away: <input id="xgAway" type="number" step="0.01"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>SOT Home: <input id="sotHome" type="number" step="0.1"></label></div>
      <div class="col"><label>SOT Away: <input id="sotAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Total Shots Home: <input id="shotsHome" type="number"></label></div>
      <div class="col"><label>Total Shots Away: <input id="shotsAway" type="number"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Goals (avg recent) Home: <input id="goalsHome" type="number"></label></div>
      <div class="col"><label>Goals (avg recent) Away: <input id="goalsAway" type="number"></label></div>
    </div>
    <div class="row" style="align-items:center">
      <div class="col"><button id="btnAutoCR" class="btn-muted">Hitung CR Otomatis</button></div>
      <div class="col"><label>Conv Home: <input id="convHome" type="number" step="0.01"></label></div>
      <div class="col"><label>Conv Away: <input id="convAway" type="number" step="0.01"></label></div>
    </div>

    <h4 class="small">Shot / Set-piece / Tempo / Finishing (sumber mentah)</h4>
    <div class="row">
      <div class="col"><label>Corners Home: <input id="cornersHome" type="number" step="0.1" value=""></label></div>
      <div class="col"><label>Corners Away: <input id="cornersAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Free Kicks Home: <input id="freeHome" type="number" step="0.1"></label></div>
      <div class="col"><label>Free Kicks Away: <input id="freeAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Crosses Home: <input id="crossesHome" type="number" step="0.1"></label></div>
      <div class="col"><label>Crosses Away: <input id="crossesAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Counter Attacks Home: <input id="counterHome" type="number" step="0.1"></label></div>
      <div class="col"><label>Counter Attacks Away: <input id="counterAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Long Balls Home: <input id="longHome" type="number" step="0.1"></label></div>
      <div class="col"><label>Long Balls Away: <input id="longAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Possession % Home: <input id="possHome" type="number" step="0.1" value=""></label></div>
      <div class="col"><label>Possession % Away: <input id="possAway" type="number" step="0.1"></label></div>
    </div>

    <div class="row" style="margin-top:8px;align-items:center">
      <div class="col"><button id="btnAutoIndexHome">Auto Index Home</button></div>
      <div class="col"><div id="autoIndexHomeDisplay" class="card small">Hasil Auto Index Home: -</div></div>
    </div>
    <div class="row" style="margin-top:6px;align-items:center">
      <div class="col"><button id="btnAutoIndexAway">Auto Index Away</button></div>
      <div class="col"><div id="autoIndexAwayDisplay" class="card small">Hasil Auto Index Away: -</div></div>
    </div>

    <h4 class="small">Def & TI</h4>
    <div class="row">
      <div class="col"><label>Tackles Home: <input id="tackleHome" type="number"></label></div>
      <div class="col"><label>Tackles Away: <input id="tackleAway" type="number"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Interceptions Home: <input id="interHome" type="number"></label></div>
      <div class="col"><label>Interceptions Away: <input id="interAway" type="number"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Tackles+Inter Home (auto): <input id="tiHome" type="number" readonly></label></div>
      <div class="col"><label>Tackles+Inter Away (auto): <input id="tiAway" type="number" readonly></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Clean Sheets Home: <input id="csHome" type="number" step="0.01"></label></div>
      <div class="col"><label>Clean Sheets Away: <input id="csAway" type="number" step="0.01"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Goals Conceded Home: <input id="gcHome" type="number" step="0.1"></label></div>
      <div class="col"><label>Goals Conceded Away: <input id="gcAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Saves Home: <input id="saveHome" type="number" step="0.1"></label></div>
      <div class="col"><label>Saves Away: <input id="saveAway" type="number" step="0.1"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Errors→goal est/season Home: <input id="errHome" type="number" step="0.1"></label></div>
      <div class="col"><label>Errors→goal est/season Away: <input id="errAway" type="number" step="0.1"></label></div>
    </div>

    <h4 class="small">Fatigue / Travel / Absensi</h4>
    <div class="row">
      <div class="col"><label>Days rest Home: <input id="daysRestHome" type="number" value="4"></label></div>
      <div class="col"><label>Days rest Away: <input id="daysRestAway" type="number" value="3"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>Travel km Home: <input id="travelKmHome" type="number" value="30"></label></div>
      <div class="col"><label>Travel km Away: <input id="travelKmAway" type="number" value="600"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>DF abs Home: <input id="absDfHome" type="number" value="0"></label></div>
      <div class="col"><label>DF abs Away: <input id="absDfAway" type="number" value="0"></label></div>
    </div>

    <h4 class="small">Form / H2H / ELO</h4>
    <label>Form 5 Home: <input id="formRawHome" type="text" placeholder="W,W,D,L,W"></label>
    <label>Form 5 Away: <input id="formRawAway" type="text" placeholder="L,D,W,L,D"></label>
    <label>H2H (single field): <input id="h2hResults" type="text" placeholder="W,D,L"></label>
    <div class="row">
      <div class="col"><label>ELO Home: <input id="eloHome" type="number" value="1700"></label></div>
      <div class="col"><label>ELO Away: <input id="eloAway" type="number" value="1650"></label></div>
    </div>

    <h4 class="small">Odds & Market</h4>
    <label>HDP Line: <input id="hdpLine" type="number" step="0.25" value="0.25"></label>
    <div class="row">
      <div class="col"><label>HDP Home Open: <input id="hdpHomeOpen" type="number" step="0.01"></label></div>
      <div class="col"><label>HDP Home Now: <input id="hdpHomeNow" type="number" step="0.01"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>HDP Away Open: <input id="hdpAwayOpen" type="number" step="0.01"></label></div>
      <div class="col"><label>HDP Away Now: <input id="hdpAwayNow" type="number" step="0.01"></label></div>
    </div>
    <label>OU Line: <input id="ouLine" type="number" step="0.25" value="2.5"></label>
    <div class="row">
      <div class="col"><label>OU Over Open: <input id="ouOverOpen" type="number" step="0.01"></label></div>
      <div class="col"><label>OU Over Now: <input id="ouOverNow" type="number" step="0.01"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>OU Under Open: <input id="ouUnderOpen" type="number" step="0.01"></label></div>
      <div class="col"><label>OU Under Now: <input id="ouUnderNow" type="number" step="0.01"></label></div>
    </div>

    <div class="row" style="margin-top:10px;align-items:center">
      <div class="col"><label>Monte Carlo runs: <input id="mcRuns" type="number" value="8000"></label></div>
      <div class="col flex-between"><button id="btnExample" class="btn-muted">Isi Contoh</button><button id="btnAnalyze">Analisis v45 Ultra Precision</button></div>
    </div>

    <div style="margin-top:10px" class="flex-between">
      <div class="switch"><label><input type="checkbox" id="autoBreak" checked> Auto International Break (toggle)</label></div>
      <div><label><input type="checkbox" id="autoDownload" checked> Auto-download log saat analisis</label></div>
    </div>
  </div>

  <!-- OUTPUT / VISUAL -->
  <div class="block" id="outputBlock">
    <h3>Ringkasan & Rekomendasi</h3>
    <pre id="summary" class="pre">Klik "Analisis v45 Ultra Precision" untuk memulai...</pre>

    <h3>Rekomendasi Terbaik</h3>
    <div id="bestRec" class="card">Belum ada rekomendasi.</div>

    <h3>Trap / Market Table</h3>
    <table class="table" id="trapTable"><tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Arah</th><th>Prob</th><th>Edge%</th><th>Status</th></tr></table>

    <h3>Distribusi Skor (Monte Carlo)</h3>
    <canvas id="hist" width="900" height="160"></canvas>

    <h3>Confidence Meter</h3>
    <canvas id="gauge" width="300" height="140"></canvas>

    <h3>LOG EVALUASI (persisten)</h3>
    <div class="row" style="gap:8px;margin-bottom:6px">
      <button id="btnExportCSV" class="btn-muted">Ekspor CSV</button>
      <button id="btnExportJSON" class="btn-muted">Ekspor JSON</button>
      <button id="btnResetLog" class="btn-muted">Reset Log</button>
      <button id="btnResetAll" class="btn-muted">Reset Form</button>
    </div>
    <div id="evalLog" class="card small">Belum ada data.</div>

    <div style="margin-top:8px" class="row">
      <input id="actualScore" type="text" placeholder="Masukkan hasil actual 2-2" style="flex:1;padding:8px;border-radius:6px;background:#02121a;border:1px solid rgba(11,78,94,0.2);color:var(--text)">
      <button id="btnEnterActual" class="btn-muted">Simpan Actual</button>
    </div>
  </div>

  <div class="footer">v45 • Full AutoIndex • Dark Navy • Single-column • Built-in log & gauge</div>
</div>

<script>
// --- Utilities ---
function safe(v,d=0){ const x=parseFloat(v); return isNaN(x)?d:x; }
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }
function percent(x){ return (100*x).toFixed(1)+'%'; }
function randNormal(mu=0,sigma=1){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return mu + sigma*Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v); }
function poisson(lambda){ let L=Math.exp(-lambda), p=1, k=0; while(p> L){ k++; p *= Math.random(); if(k>2000) break; } return Math.max(0,k-1); }

// --- Auto CR ---
document.getElementById('btnAutoCR').addEventListener('click', ()=>{
  const gh=safe(document.getElementById('goalsHome').value,NaN), sh=safe(document.getElementById('sotHome').value,NaN);
  const ga=safe(document.getElementById('goalsAway').value,NaN), sa=safe(document.getElementById('sotAway').value,NaN);
  if(sh>0) document.getElementById('convHome').value = (gh/sh).toFixed(2);
  if(sa>0) document.getElementById('convAway').value = (ga/sa).toFixed(2);
  alert('Conversion Rate otomatis terisi dari Goals ÷ SOT (jika tersedia).');
});

// --- Auto TI ---
function autoTI(){ document.getElementById('tiHome').value = (safe(document.getElementById('tackleHome').value)+safe(document.getElementById('interHome').value)).toFixed(1); document.getElementById('tiAway').value = (safe(document.getElementById('tackleAway').value)+safe(document.getElementById('interAway').value)).toFixed(1); }
['tackleHome','interHome','tackleAway','interAway'].forEach(id=>document.getElementById(id).addEventListener('input',autoTI));

// --- Auto Index functions ---
function computeAutoIndex(prefix){ // prefix 'Home' or 'Away'
  const suf = prefix==='Home'?'Home':'Away';
  const totalShots = safe(document.getElementById('shots'+suf).value, 0);
  const sot = safe(document.getElementById('sot'+suf).value, 0);
  const xg = safe(document.getElementById('xg'+suf).value, 0);
  const goals = safe(document.getElementById('goals'+suf).value, NaN);
  const corners = safe(document.getElementById('corners'+suf).value, 0);
  const frees = safe(document.getElementById('free'+suf).value, 0);
  const crosses = safe(document.getElementById('crosses'+suf).value, 0);
  const counter = safe(document.getElementById('counter'+suf).value, 0);
  const longb = safe(document.getElementById('long'+suf).value, 0);
  const poss = safe(document.getElementById('poss'+suf).value, 50);

  // Finishing: goals / SOT fallback to goals/xG
  let finishingRaw = (sot>0)? (goals/Math.max(1,sot)) : ((xg>0)? (goals/Math.max(0.1,xg)) : 0.35);
  let finishingIndex = 1 + (finishingRaw - 0.35) * 1.4;
  finishingIndex = clamp(finishingIndex, 0.75, 1.35);

  // Shot index
  let shotScore = (xg/2) + (sot/5) + (totalShots/10);
  let shotIndex = shotScore / 3.3;
  shotIndex = clamp(shotIndex, 0.7, 1.4);

  // Set-piece index
  let setpieceScore = (corners + 0.5*frees + 0.3*crosses) / 10;
  let setpieceIndex = clamp(setpieceScore, 0.6, 1.4);

  // Tempo index
  let basePos = poss/50;
  let counterFactor = 1 + (counter/15);
  let longPenalty = 1 - Math.min(0.25, longb/120);
  let tempoRaw = basePos * counterFactor * longPenalty;
  let tempoIndex = clamp(tempoRaw * 0.92, 0.8, 1.3);

  return {finishingIndex: Number(finishingIndex.toFixed(3)), shotIndex: Number(shotIndex.toFixed(3)), setpieceIndex: Number(setpieceIndex.toFixed(3)), tempoIndex: Number(tempoIndex.toFixed(3))};
}

function formatMiniBar(val){ // val in 0..2 roughly -> map to %
  const p = Math.round((clamp(val,0.6,1.4)-0.6)/(1.4-0.6)*100);
  return `<div class="mini-bar"><i style="width:${p}%"></i></div>`;
}

document.getElementById('btnAutoIndexHome').addEventListener('click', ()=>{
  try{
    const idx = computeAutoIndex('Home');
    const disp = `Shots: ${idx.shotIndex} ${formatMiniBar(idx.shotIndex)} Set-piece: ${idx.setpieceIndex} ${formatMiniBar(idx.setpieceIndex)} Tempo: ${idx.tempoIndex} ${formatMiniBar(idx.tempoIndex)} Fin: ${idx.finishingIndex} ${formatMiniBar(idx.finishingIndex)}`;
    document.getElementById('autoIndexHomeDisplay').innerHTML = '<strong>Home</strong> • '+disp;
    // write to model fields (if exist)
    if(document.getElementById('finHome')) document.getElementById('finHome').value = idx.finishingIndex;
    if(document.getElementById('tempoHome')) document.getElementById('tempoHome').value = idx.tempoIndex;
    if(document.getElementById('sqiHome')) document.getElementById('sqiHome').value = idx.shotIndex;
    if(document.getElementById('speHome')) document.getElementById('speHome').value = idx.setpieceIndex;
    alert('Auto Index Home dihitung dan diterapkan.');
  }catch(e){ alert('Error Auto Index Home: '+e.message); }
});

document.getElementById('btnAutoIndexAway').addEventListener('click', ()=>{
  try{
    const idx = computeAutoIndex('Away');
    const disp = `Shots: ${idx.shotIndex} ${formatMiniBar(idx.shotIndex)} Set-piece: ${idx.setpieceIndex} ${formatMiniBar(idx.setpieceIndex)} Tempo: ${idx.tempoIndex} ${formatMiniBar(idx.tempoIndex)} Fin: ${idx.finishingIndex} ${formatMiniBar(idx.finishingIndex)}`;
    document.getElementById('autoIndexAwayDisplay').innerHTML = '<strong>Away</strong> • '+disp;
    if(document.getElementById('finAway')) document.getElementById('finAway').value = idx.finishingIndex;
    if(document.getElementById('tempoAway')) document.getElementById('tempoAway').value = idx.tempoIndex;
    if(document.getElementById('sqiAway')) document.getElementById('sqiAway').value = idx.shotIndex;
    if(document.getElementById('speAway')) document.getElementById('speAway').value = idx.setpieceIndex;
    alert('Auto Index Away dihitung dan diterapkan.');
  }catch(e){ alert('Error Auto Index Away: '+e.message); }
});

// --- Core compute (simplified but sharp) ---
function computeAttack(team){
  const base = 0.42*safe(team.xg,0) + 0.18*(safe(team.sot,0)/5) + 0.10*(safe(team.conv,0)*100) + 0.07*(team.form||0.5);
  const final = clamp(base * (team.sqi||1) * (1 + 0.04*(team.spe?team.spe-1:0)) * (team.tempo||1) * (team.fin||1), 0.05, 12.0);
  return final;
}
function computeDefense(team){
  const tiNorm = clamp(safe(team.ti,0)/28,0,2);
  const savesNorm = Math.log(1+Math.max(0,safe(team.saves,0)))/Math.log(7);
  let val = 1 + 0.28*Math.log(Math.max(1,safe(team.gc,0))+1) - 0.27*(safe(team.cs,0)) - 0.13*tiNorm + 0.07*(1 + safe(team.err,7)/40) - 0.11*savesNorm;
  return clamp(val,0.25,5.0);
}

function computeLambdas(h,a){
  const atkH = computeAttack(h), atkA = computeAttack(a);
  const defH = computeDefense(h), defA = computeDefense(a);
  const eloH = clamp(1 + (safe(h.elo,1500)-safe(a.elo,1480))/2400,0.78,1.22);
  const eloA = clamp(1 + (safe(a.elo,1480)-safe(h.elo,1500))/2400,0.78,1.22);
  const homeAdv = 1.06;
  let rawH = ((safe(h.xg,1.2) + safe(h.sot,0)/6)/2) * (atkH / Math.max(0.45, defA)) * eloH * homeAdv;
  let rawA = ((safe(a.xg,1.0) + safe(a.sot,0)/6)/2) * (atkA / Math.max(0.45, defH)) * eloA;
  rawH *= clamp(1 + (h.fin-1)*0.09, 0.88, 1.28);
  rawA *= clamp(1 + (a.fin-1)*0.09, 0.88, 1.28);
  // stamina
  const penH = computeStaminaPenalty(safe(document.getElementById('daysRestHome').value,4), safe(document.getElementById('travelKmHome').value,30), safe(document.getElementById('benchHome')?.value,5));
  const penA = computeStaminaPenalty(safe(document.getElementById('daysRestAway').value,4), safe(document.getElementById('travelKmAway').value,30), safe(document.getElementById('benchAway')?.value,5));
  rawH *= penH; rawA *= penA;
  // shrink to league prior
  const shrinkW = 0.65;
  let lambdaH = shrinkW*rawH + (1-shrinkW)*1.25;
  let lambdaA = shrinkW*rawA + (1-shrinkW)*1.25;
  if((lambdaH+lambdaA)/2 > 3.2){ lambdaH *= 0.9; lambdaA *= 0.9; }
  return {lambdaH:Math.max(0.01,lambdaH), lambdaA:Math.max(0.01,lambdaA), atkH, atkA, defH, defA};
}

function computeStaminaPenalty(daysRest, travelKm, benchDepth){
  const restPenalty = Math.max(0, (3 - daysRest))*0.035;
  const travelPenalty = Math.max(0, (travelKm - 200))*0.00014;
  const benchBonus = Math.max(0, (benchDepth - 5))*0.008;
  return clamp(1 - restPenalty - travelPenalty + benchBonus, 0.78, 1.06);
}

// --- Monte Carlo ---
function monteCarlo(lambdaH,lambdaA,rho,sigmaFactor,runs){
  const freq={}, totals={}; let home=0,draw=0,away=0;
  const sigma = clamp(0.10 + sigmaFactor*0.28, 0.06, 1.1);
  for(let i=0;i<runs;i++){
    const z1 = randNormal(0,sigma); const z2 = rho*z1 + Math.sqrt(Math.max(0,1-rho*rho))*randNormal(0,sigma);
    const lH = Math.max(0.01, lambdaH * Math.exp(z1 - 0.5*sigma*sigma));
    const lA = Math.max(0.01, lambdaA * Math.exp(z2 - 0.5*sigma*sigma));
    const gh = poisson(lH), ga = poisson(lA);
    const k=`${gh}-${ga}`; freq[k]=(freq[k]||0)+1; totals[gh+ga]=(totals[gh+ga]||0)+1;
    if(gh>ga) home++; else if(gh===ga) draw++; else away++;
  }
  return {freq, totals, pHome:home/runs, pDraw:draw/runs, pAway:away/runs};
}

// --- Confidence ---
function computeConfidence(totals){ let meanT=0,varv=0,count=0; for(const t in totals){ const g=parseInt(t), v=totals[t]; meanT += g*v; count += v; } if(count===0) return {score:0.5,label:'Low'}; meanT /= count; for(const t in totals){ const g=parseInt(t), v=totals[t]; varv += ((g-meanT)**2)*v; } varv /= count; let conf = clamp(1 - Math.min(1,varv/8), 0.15, 0.98); const label = conf>0.80? 'High' : (conf>0.55? 'Medium' : 'Low'); return {score:conf,label}; }

// --- Logging ---
const LOG_KEY = 'v45_logs';
function getLogs(){ return JSON.parse(localStorage.getItem(LOG_KEY)||'[]'); }
function setLogs(logs){ localStorage.setItem(LOG_KEY, JSON.stringify(logs)); renderEvalLog(); }
function saveLogEntry(pred, meta){ const logs = getLogs(); const entry = {time:new Date().toISOString(), match:`${document.getElementById('teamHome').value} vs ${document.getElementById('teamAway').value}`, pred, meta}; logs.unshift(entry); if(logs.length>3000) logs.pop(); localStorage.setItem(LOG_KEY, JSON.stringify(logs)); renderEvalLog(); if(document.getElementById('autoDownload').checked){ try{ exportLogsJSON(entry); exportLogsCSV(); }catch(e){} } }
function renderEvalLog(){ const logs=getLogs(); const el=document.getElementById('evalLog'); if(!logs||logs.length===0){ el.innerHTML='Belum ada data.'; return; } let html='<table style="width:100%;border-collapse:collapse"><tr><th>Waktu</th><th>Match</th><th>λH</th><th>λA</th><th>Break</th><th>Best</th><th>Conf</th></tr>'; logs.forEach(l=>{ const p=l.pred||{}; html += `<tr><td style="font-size:12px">${l.time}</td><td style="font-size:12px">${l.match}</td><td style="font-size:12px">${p.lambdaH?p.lambdaH.toFixed(2):'-'}</td><td style="font-size:12px">${p.lambdaA?p.lambdaA.toFixed(2):'-'}</td><td style="font-size:12px">${l.meta&&l.meta.break? 'Yes':'No'}</td><td style="font-size:12px">${p.best||'-'}</td><td style="font-size:12px">${p.conf||'-'}</td></tr>`; }); html += '</table>'; el.innerHTML = html; }

// --- Export ---
function exportLogsJSON(single){ const logs=getLogs(); const data = single? single : logs; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='v45_logs_'+(new Date()).toISOString().replace(/[:.]/g,'')+'.json'; document.body.appendChild(a); a.click(); a.remove(); }
function exportLogsCSV(){ const logs=getLogs(); if(!logs||logs.length===0){ alert('Tidak ada log'); return; } const header=['time','match','lambdaH','lambdaA','break','best','conf','meta']; const rows = logs.map(l=>[l.time,l.match,(l.pred&&l.pred.lambdaH)||'', (l.pred&&l.pred.lambdaA)||'', (l.meta&&l.meta.break)?'Yes':'No', (l.pred&&l.pred.best)||'', (l.pred&&l.pred.conf)||'', JSON.stringify(l.meta||{})]); const csv=[header.join(','), ...rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(','))].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='v45_logs_'+(new Date()).toISOString().replace(/[:.]/g,'')+'.csv'; document.body.appendChild(a); a.click(); a.remove(); }

document.getElementById('btnExportJSON').addEventListener('click', ()=>exportLogsJSON());
document.getElementById('btnExportCSV').addEventListener('click', exportLogsCSV);
document.getElementById('btnResetLog').addEventListener('click', ()=>{ if(confirm('Reset log?')){ localStorage.removeItem(LOG_KEY); renderEvalLog(); } });
document.getElementById('btnResetAll').addEventListener('click', ()=>{ if(!confirm('Reset semua input?')) return; document.querySelectorAll('input').forEach(i=>{ if(i.type==='checkbox') i.checked=false; else i.value=''; }); document.getElementById('summary').textContent='Direset.'; document.getElementById('bestRec').innerHTML='Belum ada rekomendasi.'; document.getElementById('trapTable').innerHTML='<tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Arah</th><th>Prob</th><th>Edge%</th><th>Status</th></tr>'; renderEvalLog(); const c=document.getElementById('hist').getContext('2d'); c.clearRect(0,0,900,160); const g=document.getElementById('gauge').getContext('2d'); g.clearRect(0,0,300,140); });

// --- Analyze ---
document.getElementById('btnAnalyze').addEventListener('click', ()=>{
  try{
    const h = {
      xg: safe(document.getElementById('xgHome').value,1.2),
      sot: safe(document.getElementById('sotHome').value,3.5),
      shots: safe(document.getElementById('shotsHome').value,10),
      goals: safe(document.getElementById('goalsHome').value,1.2),
      conv: clamp(safe(document.getElementById('convHome').value,0.12),0,1),
      sqi: safe(document.getElementById('sqiHome')?.value,1),
      spe: safe(document.getElementById('speHome')?.value,1),
      tempo: safe(document.getElementById('tempoHome')?.value,1),
      fin: safe(document.getElementById('finHome')?.value,1),
      ti: safe(document.getElementById('tiHome').value,20),
      cs: safe(document.getElementById('csHome').value,0.3),
      gc: safe(document.getElementById('gcHome').value,1.1),
      saves: safe(document.getElementById('saveHome').value,3.5),
      err: safe(document.getElementById('errHome').value,6),
      elo: safe(document.getElementById('eloHome').value,1500)
    };
    const a = {
      xg: safe(document.getElementById('xgAway').value,1.0),
      sot: safe(document.getElementById('sotAway').value,3.0),
      shots: safe(document.getElementById('shotsAway').value,9),
      goals: safe(document.getElementById('goalsAway').value,1.0),
      conv: clamp(safe(document.getElementById('convAway').value,0.11),0,1),
      sqi: safe(document.getElementById('sqiAway')?.value,1),
      spe: safe(document.getElementById('speAway')?.value,1),
      tempo: safe(document.getElementById('tempoAway')?.value,1),
      fin: safe(document.getElementById('finAway')?.value,1),
      ti: safe(document.getElementById('tiAway').value,18),
      cs: safe(document.getElementById('csAway').value,0.25),
      gc: safe(document.getElementById('gcAway').value,1.3),
      saves: safe(document.getElementById('saveAway').value,3.2),
      err: safe(document.getElementById('errAway').value,7),
      elo: safe(document.getElementById('eloAway').value,1480)
    };
    const r = computeLambdas(h,a);
    let lambdaH = r.lambdaH, lambdaA = r.lambdaA;
    const diffElo = Math.abs(h.elo - a.elo);
    const rho = clamp(0.05 + 0.18*(diffElo/800) + 0.12*Math.abs(h.sqi - a.sqi), 0.03, 0.5);
    const sigmaFactor = clamp((Math.abs(h.sqi - a.sqi) + Math.abs(h.fin - a.fin))/4, 0, 1);
    const mcRuns = Math.max(2000, safe(document.getElementById('mcRuns').value,8000));
    const mc = monteCarlo(lambdaH, lambdaA, rho, sigmaFactor, mcRuns);
    const avgH = Object.entries(mc.freq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[0])*v,0)/mcRuns;
    const avgA = Object.entries(mc.freq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[1])*v,0)/mcRuns;

    // OU & HDP
    const ouLine = safe(document.getElementById('ouLine').value,2.5);
    function probOUFromTotals(totals,line,runs){ let over=0,under=0; const isInt = Number.isInteger(line); for(const t in totals){ const g=parseInt(t), v=totals[t]; if(isInt){ if(g>line) over+=v; else if(g<line) under+=v; else { over+=0.5*v; under+=0.5*v; } } else { if(g>line) over+=v; else under+=v; } } return {over: over/runs, under: under/runs}; }
    const ouProb = probOUFromTotals(mc.totals, ouLine, mcRuns);
    const hdpLine = safe(document.getElementById('hdpLine').value,0.25);
    function probCoverFromScores(scoreFreq,handicap,runs){ let win=0,push=0,lose=0; for(const sc in scoreFreq){ const v=scoreFreq[sc]; const [gh,ga]=sc.split('-').map(x=>parseInt(x)); const diff=gh-ga-handicap; if(diff>0) win+=v; else if(diff===0) push+=v; else lose+=v; } return (win + 0.5*push)/runs; }
    const coverHome = probCoverFromScores(mc.freq, hdpLine, mcRuns);
    const coverAway = probCoverFromScores(mc.freq, -hdpLine, mcRuns);

    // confidence + autoBreak adjustments
    let conf = computeConfidence(mc.totals);
    const autoBreak = document.getElementById('autoBreak').checked;
    let breakMeta = {break:false,pen:0};
    if(autoBreak){
      breakMeta.break=true; breakMeta.pen=0.08;
      conf.score = Math.max(0.03, conf.score * (1 - breakMeta.pen));
      const travelH = safe(document.getElementById('travelKmHome').value,0);
      const travelA = safe(document.getElementById('travelKmAway').value,0);
      const daysH = safe(document.getElementById('daysRestHome').value,4);
      const daysA = safe(document.getElementById('daysRestAway').value,4);
      const extra = Math.max(travelH>3000?0.05:(travelH>1500?0.02:0), travelA>3000?0.05:(travelA>1500?0.02:0)) + (daysH<=2?0.03:0) + (daysA<=2?0.03:0);
      if(extra>0) conf.score = Math.max(0.03, conf.score * (1 - extra));
    }

    // market blending (implied)
    function impliedProb(odds){ return odds && odds>0? 1/odds : null; }
    const implied = {ouOver:impliedProb(safe(document.getElementById('ouOverNow').value,NaN)), hdpHome:impliedProb(safe(document.getElementById('hdpHomeNow').value,NaN))};
    const alpha = clamp(conf.score,0.25,0.92);
    const final_over = (implied.ouOver? (alpha*ouProb.over + (1-alpha)*implied.ouOver) : ouProb.over);
    const final_hdpHome = (implied.hdpHome? (alpha*coverHome + (1-alpha)*implied.hdpHome) : coverHome);

    // build summary
    let summary = `λ (FT): Home ${lambdaH.toFixed(2)} | Away ${lambdaA.toFixed(2)}\n`;
    summary += `Attack idx H:${r.atkH.toFixed(2)} A:${r.atkA.toFixed(2)} | Def idx H:${r.defH.toFixed(2)} A:${r.defA.toFixed(2)}\n`;
    summary += `Exp goals(sim) H:${avgH.toFixed(2)} A:${avgA.toFixed(2)}\n`;
    summary += `Prob 1X2 — Home ${(100*mc.pHome).toFixed(1)}% Draw ${(100*mc.pDraw).toFixed(1)}% Away ${(100*mc.pAway).toFixed(1)}%\n`;
    summary += `OU(${ouLine}) → Over ${percent(final_over)} | Under ${percent(1-final_over)}\n`;
    summary += `HDP(${hdpLine}) → Home ${percent(final_hdpHome)} | Away ${percent(1-final_hdpHome)}\n`;
    summary += `Confidence: ${conf.label} (${(100*conf.score).toFixed(1)}%)\n`;
    if(breakMeta.break) summary += `⚠️ International Break Adjust active (base -8%).\n`;
    document.getElementById('summary').textContent = summary;

    // recommendations
    const candidates = [
      {tag:`OU Over ${ouLine}`, prob: final_over, open:safe(document.getElementById('ouOverOpen').value,NaN), now:safe(document.getElementById('ouOverNow').value,NaN)},
      {tag:`HDP Home ${hdpLine}`, prob: final_hdpHome, open:safe(document.getElementById('hdpHomeOpen').value,NaN), now:safe(document.getElementById('hdpHomeNow').value,NaN)}
    ];
    candidates.forEach(c=> c.edge = c.open? (c.prob - (1/c.open)) : null);
    candidates.sort((a,b)=>b.prob - a.prob);
    let recHtml=''; candidates.forEach(c=>{ const sig = c.prob>=0.6? 'High': (c.prob>=0.55? 'Medium':'Low'); recHtml += `<div class="card"><div style="font-weight:700">${c.tag}</div><div class="small">Prob ${percent(c.prob)} • Edge ${c.edge?((c.edge*100).toFixed(2)+'%'):'-'}</div><div style="float:right">${sig}</div><div style="clear:both"></div></div>`; });
    document.getElementById('bestRec').innerHTML = recHtml || '<div class="small">Tidak ada rekomendasi signifikan.</div>';

    // trap table
    let tbl = '<tr><th>Pasar</th><th>Open</th><th>Now</th><th>Δ%</th><th>Arah</th><th>Prob</th><th>Edge%</th><th>Status</th></tr>';
    candidates.forEach(c=>{ const d = c.open && c.now? ((c.now-c.open)/c.open*100).toFixed(1)+'%':''; tbl += `<tr><td>${c.tag}</td><td>${c.open||''}</td><td>${c.now||''}</td><td>${d}</td><td>${c.now && c.open? (c.now<c.open? 'Money → Favor':'Money → Against') : ''}</td><td>${percent(c.prob)}</td><td>${c.edge?((c.edge*100).toFixed(2)+'%'):'-'}</td><td>${Math.abs(d)>=15? 'Trap' : (Math.abs(d)>=5? 'Warning':'Stable')}</td></tr>`; });
    document.getElementById('trapTable').innerHTML = tbl;

    // visuals
    drawHistogram(mc.totals, ouLine);
    drawGauge(conf);

    // save log
    const pred = {lambdaH, lambdaA, avgH, avgA, pHome:mc.pHome, pDraw:mc.pDraw, pAway:mc.pAway, best:candidates.map(x=>x.tag).join(' | '), conf:(100*conf.score).toFixed(1)+'%'};
    saveLogEntry(pred, {break: breakMeta.break});

  }catch(e){ alert('Error saat analisis: '+e.message); }
});

// histogram & gauge
function drawHistogram(totals, ouLine){ const c=document.getElementById('hist'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const keys=Object.keys(totals).map(x=>parseInt(x)).sort((a,b)=>a-b); if(keys.length===0) return; const maxV=Math.max(...keys.map(k=>totals[k]||0),1); const pad=30; const w=(c.width-pad*2)/Math.max(1,keys.length); keys.forEach((k,i)=>{ const v=totals[k]||0; const h=(v/maxV)*(c.height-60); ctx.fillStyle=(k<=ouLine)?'#0b74de':'#de3f3f'; ctx.fillRect(pad+i*w,c.height-40-h,Math.max(6,w-6),h); ctx.fillStyle='#9fd6ee'; ctx.font='11px Arial'; ctx.fillText(String(k),pad+i*w,c.height-18); }); }
function drawGauge(conf){ const c=document.getElementById('gauge'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const cx=c.width/2, cy=c.height*0.85, r=Math.min(c.width,c.height)*0.34; ctx.beginPath(); ctx.lineWidth=14; ctx.strokeStyle='#082733'; ctx.arc(cx,cy,r,Math.PI,2*Math.PI,false); ctx.stroke(); const val=clamp(conf.score,0,1), end= Math.PI + val*Math.PI; ctx.beginPath(); ctx.lineWidth=14; ctx.strokeStyle = val>0.8? '#2dd36f' : (val>0.55? '#f7b731' : '#eb3b5a'); ctx.arc(cx,cy,r,Math.PI,end,false); ctx.stroke(); ctx.font='16px Arial'; ctx.fillStyle='#cfe8ff'; ctx.textAlign='center'; ctx.fillText((val*100).toFixed(1)+'%',cx,cy-r-6); ctx.font='12px Arial'; ctx.fillText(conf.label,cx,cy-r+14); }

// example fill
document.getElementById('btnExample').addEventListener('click', ()=>{
  document.getElementById('teamHome').value='France'; document.getElementById('teamAway').value='Andorra';
  document.getElementById('xgHome').value='2.05'; document.getElementById('xgAway').value='1.45';
  document.getElementById('sotHome').value='6.4'; document.getElementById('sotAway').value='4.2';
  document.getElementById('shotsHome').value='14'; document.getElementById('shotsAway').value='9';
  document.getElementById('goalsHome').value='2'; document.getElementById('goalsAway').value='1';
  document.getElementById('cornersHome').value='5.7'; document.getElementById('cornersAway').value='2.1';
  document.getElementById('freeHome').value='12.3'; document.getElementById('freeAway').value='4.2';
  document.getElementById('crossesHome').value='4.3'; document.getElementById('crossesAway').value='2.0';
  document.getElementById('counterHome').value='8'; document.getElementById('counterAway').value='3';
  document.getElementById('longHome').value='22.3'; document.getElementById('longAway').value='10';
  document.getElementById('possHome').value='65.3'; document.getElementById('possAway').value='34.7';
  document.getElementById('tackleHome').value='18'; document.getElementById('interHome').value='9'; document.getElementById('tackleAway').value='12'; document.getElementById('interAway').value='5';
  autoTI(); alert('Contoh terisi. Klik Auto Index Home/Away lalu Analisis.'); 
});

// actual save
document.getElementById('btnEnterActual').addEventListener('click', ()=>{
  const txt=document.getElementById('actualScore').value.trim(); if(!txt){ alert('Masukkan hasil actual (format gh-ga).'); return; }
  const parts=txt.split('-').map(x=>parseInt(x.trim())); if(parts.length!==2||isNaN(parts[0])||isNaN(parts[1])){ alert('Format salah.'); return; }
  const logs=getLogs(); if(!logs||logs.length===0){ alert('Belum ada prediksi. Jalankan analisis dulu.'); return; }
  logs[0].actual = {gh:parts[0], ga:parts[1], total: parts[0]+parts[1]}; localStorage.setItem(LOG_KEY, JSON.stringify(logs)); renderEvalLog(); alert('Actual disimpan pada entry terakhir.'); 
});

// init
renderEvalLog();
</script>
</body>
</html>
